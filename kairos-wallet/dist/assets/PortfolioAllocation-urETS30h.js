import{d as b,j as e,e as G,N as F,G as U,aG as M,m as T,ac as J,ag as V,b as I,k as W,l as Y}from"./ui-BteoE537.js";import{U as E,G as q,a9 as Q,aa as X,C as g,E as $,D as Z,F as ee,u as se,K as te,I as v,T as ae,H as le,W as R}from"./index-rYYAUsyQ.js";import{formatEther as ne,Contract as re,formatUnits as oe}from"./crypto-1JBTrmrY.js";import"./vendor-cxSnwWPt.js";const S="0x14D41707269c7D8b8DFa5095b38824a46dA05da3".toLowerCase(),_="kairos_crosschain_portfolio",ce=6e4;async function ie(r,a){try{const o=$(r),u=g[r],l=await o.getBalance(a);return{chainId:r,symbol:u.nativeCurrency.symbol,balance:ne(l),isNative:!0}}catch{return{chainId:r,symbol:g[r]?.nativeCurrency?.symbol||"?",balance:"0",isNative:!0}}}async function de(r,a){const o=Z[r]||[],u=[],l=$(r);for(const n of o.slice(0,6))try{const p=await new re(n.address,ee,l).balanceOf(a),j=oe(p,n.decimals);parseFloat(j)>1e-4&&u.push({chainId:r,address:n.address,symbol:n.symbol,balance:j,decimals:n.decimals,isNative:!1})}catch{}return u}async function O(r){try{const l=JSON.parse(localStorage.getItem(_)||"{}");if(l.address===r&&Date.now()-l.timestamp<ce)return l}catch{}const a={chains:{},totalUSD:0,address:r,timestamp:Date.now()},o=E.map(async l=>{const n=g[l];try{const[f,p,j]=await Promise.all([ie(l,r),de(l,r),q(l)]),d=p.filter(c=>!c.isNative).map(c=>c.address);let x={};if(d.length>0)try{const c=d.filter(N=>N.toLowerCase()!==S);c.length>0&&(x=await Q(l,c))}catch{}if(p.some(c=>c.address?.toLowerCase()===S))try{const c=await X();x[S]={usd:c.usd,change24h:c.change24h||0}}catch{x[S]={usd:1,change24h:0}}const m=parseFloat(f.balance)*j;let k=0;const D=p.map(c=>{const N=x[c.address?.toLowerCase()]?.usd||0,s=parseFloat(c.balance)*N;return k+=s,{...c,price:N,usd:s}}),y=m+k;return{chainId:l,chainName:n.name,shortName:n.shortName,color:n.color,native:{...f,price:j,usd:m},tokens:D,totalUSD:y}}catch(f){return{chainId:l,chainName:n.name,shortName:n.shortName,color:n.color,native:{balance:"0",usd:0},tokens:[],totalUSD:0,error:f.message}}}),u=await Promise.allSettled(o);for(const l of u)if(l.status==="fulfilled"&&l.value){const n=l.value;a.chains[n.chainId]=n,a.totalUSD+=n.totalUSD}try{localStorage.setItem(_,JSON.stringify(a))}catch{}return a}const K=["#D4AF37","#22d3ee","#a78bfa","#f472b6","#34d399","#fb923c","#60a5fa","#facc15","#f87171","#94a3b8"],B="kairos_pnl_history";function H(){try{return JSON.parse(localStorage.getItem(B)||"[]")}catch{return[]}}function xe(r){const a=H(),o=Date.now();a.length>0&&o-a[a.length-1].t<36e5||(a.push({t:o,v:r}),a.length>720&&a.splice(0,a.length-720),localStorage.setItem(B,JSON.stringify(a)))}function z({slices:r,size:a=160,stroke:o=28}){const u=(a-o)/2,l=2*Math.PI*u,n=a/2,f=a/2;let p=0;return e.jsxs("svg",{width:a,height:a,viewBox:`0 0 ${a} ${a}`,children:[r.map((j,d)=>{const x=l*j.pct,w=`${x} ${l-x}`,m=e.jsx("circle",{cx:n,cy:f,r:u,fill:"none",stroke:j.color,strokeWidth:o,strokeDasharray:w,strokeDashoffset:-p,strokeLinecap:"round",className:"transition-all duration-700"},d);return p+=x,m}),e.jsx("circle",{cx:n,cy:f,r:u-o/2+2,fill:"transparent"})]})}function pe(){const{activeChainId:r,activeAddress:a,balances:o,tokenPrices:u,nativePrice:l,goBack:n,getTotalPortfolioValue:f,navigate:p,setTokenDetailData:j}=se(),d=f(),[x,w]=b.useState("allocation"),[m,k]=b.useState(null),[D,y]=b.useState(!1);b.useEffect(()=>{d>0&&xe(d)},[d]),b.useEffect(()=>{x==="crosschain"&&!m&&a&&(y(!0),O(a).then(s=>k(s)).catch(()=>{}).finally(()=>y(!1)))},[x,a]);const c=b.useMemo(()=>{const s=[];if(o.native){const t=parseFloat(o.native.balance||0),i=t*l;i>.01&&s.push({symbol:o.native.symbol,balance:t,value:i,isNative:!0,token:o.native})}if(o.tokens)for(const t of o.tokens){if(!t.hasBalance)continue;const i=t.address.toLowerCase(),P=i===te.address.toLowerCase()||t.symbol==="KAIROS",A=u[i]?.usd||(P?1:0),C=parseFloat(t.balance||0),L=C*A;L>.01&&s.push({symbol:t.symbol,balance:C,value:L,price:A,change24h:u[t.address.toLowerCase()]?.change24h||0,isNative:!1,token:t})}s.sort((t,i)=>i.value-t.value);const h=s.reduce((t,i)=>t+i.value,0);return s.map((t,i)=>({...t,pct:h>0?t.value/h:0,color:K[i%K.length]}))},[o,u,l]),N=b.useMemo(()=>{const s=H();if(s.length===0)return{day:0,week:0,month:0};const h=Date.now(),t=i=>{const P=h-i;return(s.find(C=>C.t>=P)||s[0]).v};return{day:d-t(864e5),week:d-t(6048e5),month:d-t(2592e6)}},[d]);return e.jsxs("div",{className:"screen-container",children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 border-b border-dark-800",children:[e.jsx("button",{onClick:n,className:"text-dark-300 hover:text-white",children:e.jsx(G,{size:20})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"text-kairos-400",size:20}),e.jsx("h1",{className:"text-lg font-bold text-white",children:"Portfolio"})]})]}),e.jsx("div",{className:"flex gap-1 p-1 mx-4 mt-4 rounded-xl bg-white/5",children:[{key:"allocation",label:"Tokens",icon:F},{key:"crosschain",label:"Multi-Chain",icon:U},{key:"pnl",label:"P&L",icon:M}].map(s=>e.jsxs("button",{onClick:()=>w(s.key),className:`flex-1 py-2.5 rounded-lg text-xs font-medium transition-all flex items-center justify-center gap-1 ${x===s.key?"bg-kairos-500/15 text-kairos-400":"text-dark-400"}`,children:[e.jsx(s.icon,{size:12})," ",s.label]},s.key))}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[x==="allocation"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex justify-center py-4 relative",children:c.length>0?e.jsxs("div",{className:"relative",children:[e.jsx(z,{slices:c}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[e.jsx("p",{className:"text-dark-400 text-xs",children:"Total"}),e.jsx("p",{className:"text-white font-bold text-lg",children:v(d)})]})]}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(F,{className:"mx-auto text-dark-600",size:48}),e.jsx("p",{className:"text-dark-500 text-sm mt-2",children:"Sin activos con valor"})]})}),e.jsx("div",{className:"space-y-2",children:c.map((s,h)=>e.jsxs(T.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:h*.05},className:"flex items-center gap-3 bg-dark-800/50 rounded-xl p-3 border border-dark-700/50 cursor-pointer active:scale-[0.98] active:bg-dark-700/50 transition-all",onClick:()=>{j(s.token),p("tokenDetail")},children:[e.jsx("div",{className:"w-3 h-3 rounded-full flex-shrink-0",style:{backgroundColor:s.color}}),e.jsx(ae,{token:s.token,chainId:r,size:28}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-white text-sm font-semibold",children:s.symbol}),e.jsx("p",{className:"text-dark-500 text-xs",children:le(s.balance.toString())})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-white text-sm font-bold",children:v(s.value)}),e.jsxs("p",{className:"text-dark-400 text-xs",children:[(s.pct*100).toFixed(1),"%"]})]}),e.jsx("div",{className:"w-12 h-1.5 bg-dark-700 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full transition-all duration-500",style:{width:`${s.pct*100}%`,backgroundColor:s.color}})}),e.jsx(J,{size:14,className:"text-dark-500 flex-shrink-0"})]},s.symbol))}),c.length>0&&e.jsx("p",{className:"text-center text-dark-500 text-[10px] mt-1",children:"Toca un token para Enviar, Recibir o Swap"})]}),x==="crosschain"&&e.jsx(e.Fragment,{children:D?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(T.div,{animate:{rotate:360},transition:{repeat:1/0,duration:1.5,ease:"linear"},children:e.jsx(V,{className:"mx-auto text-kairos-400",size:32})}),e.jsx("p",{className:"text-dark-400 text-sm mt-3",children:"Escaneando 6 blockchains..."})]}):m?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-dark-400 text-xs",children:"Portfolio Total (6 Chains)"}),e.jsx("p",{className:"text-white font-bold text-2xl mt-1",children:v(m.totalUSD)})]}),(()=>{const s=E.map(h=>({chainId:h,...m.chains[h],pct:m.totalUSD>0?(m.chains[h]?.totalUSD||0)/m.totalUSD:0,color:g[h]?.color||"#888"})).filter(h=>h.totalUSD>.01);return s.length>0?e.jsx("div",{className:"flex justify-center py-2 relative",children:e.jsxs("div",{className:"relative",children:[e.jsx(z,{slices:s,size:140,stroke:24}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[e.jsx(U,{className:"text-dark-500",size:16}),e.jsx("p",{className:"text-dark-400 text-[10px]",children:"6 chains"})]})]})}):null})(),e.jsx("div",{className:"space-y-2",children:E.map((s,h)=>{const t=m.chains[s];return!t||t.totalUSD<.01?e.jsxs("div",{className:"flex items-center gap-3 bg-dark-800/30 rounded-xl p-3 border border-dark-700/30 opacity-50",children:[e.jsx(R,{chainId:s,size:24}),e.jsx("div",{className:"flex-1",children:e.jsx("p",{className:"text-dark-400 text-sm",children:g[s].shortName})}),e.jsx("p",{className:"text-dark-600 text-xs",children:"$0.00"})]},s):e.jsxs(T.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:h*.05},className:"bg-dark-800/50 rounded-xl p-3 border border-dark-700/50",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(R,{chainId:s,size:24}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-white text-sm font-semibold",children:t.chainName}),e.jsxs("p",{className:"text-dark-500 text-xs",children:[t.tokens?.length||0," token",(t.tokens?.length||0)!==1?"s":""," con balance"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-white text-sm font-bold",children:v(t.totalUSD)}),e.jsxs("p",{className:"text-dark-400 text-xs",children:[m.totalUSD>0?(t.totalUSD/m.totalUSD*100).toFixed(1):0,"%"]})]})]}),e.jsxs("div",{className:"ml-9 space-y-1",children:[t.native&&parseFloat(t.native.balance)>1e-4&&e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{className:"text-dark-400",children:t.native.symbol}),e.jsxs("span",{className:"text-dark-300",children:[parseFloat(t.native.balance).toFixed(4)," ¬∑ ",v(t.native.usd)]})]}),(t.tokens||[]).map(i=>e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{className:"text-dark-400",children:i.symbol}),e.jsxs("span",{className:"text-dark-300",children:[parseFloat(i.balance).toFixed(4)," ¬∑ ",v(i.usd)]})]},i.address))]})]},s)})}),e.jsxs("button",{onClick:()=>{k(null),y(!0),O(a).then(s=>k(s)).finally(()=>y(!1))},className:"w-full py-2.5 rounded-xl bg-dark-800/50 text-dark-400 text-xs flex items-center justify-center gap-1.5 border border-dark-700/30",children:[e.jsx(I,{size:12})," Actualizar portfolio multi-chain"]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(U,{className:"mx-auto text-dark-600",size:40}),e.jsx("p",{className:"text-dark-500 text-sm mt-2",children:"Error cargando datos multi-chain"})]})}),x==="pnl"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-center py-4",children:[e.jsx("p",{className:"text-dark-400 text-xs",children:"Valor del Portfolio"}),e.jsx("p",{className:"text-white font-bold text-2xl mt-1",children:v(d)})]}),e.jsx("div",{className:"space-y-3",children:[{label:"√öltimas 24h",value:N.day,emoji:"üìÖ"},{label:"√öltimos 7 d√≠as",value:N.week,emoji:"üìÜ"},{label:"√öltimos 30 d√≠as",value:N.month,emoji:"üóìÔ∏è"}].map(s=>e.jsxs("div",{className:`flex items-center justify-between p-4 rounded-xl border ${s.value>=0?"bg-green-500/5 border-green-500/20":"bg-red-500/5 border-red-500/20"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-xl",children:s.emoji}),e.jsxs("div",{children:[e.jsx("p",{className:"text-white text-sm font-medium",children:s.label}),e.jsx("p",{className:"text-dark-500 text-xs",children:"Ganancia/P√©rdida"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[s.value>=0?e.jsx(W,{size:14,className:"text-green-400"}):e.jsx(Y,{size:14,className:"text-red-400"}),e.jsxs("span",{className:`font-bold text-sm ${s.value>=0?"text-green-400":"text-red-400"}`,children:[s.value>=0?"+":"",v(Math.abs(s.value))]})]}),d>0&&e.jsxs("p",{className:`text-xs ${s.value>=0?"text-green-500/60":"text-red-500/60"}`,children:[s.value>=0?"+":"",(s.value/d*100).toFixed(2),"%"]})]})]},s.label))}),e.jsx("div",{className:"bg-dark-800/30 rounded-xl p-3 border border-dark-700/30",children:e.jsx("p",{className:"text-dark-500 text-xs text-center",children:"üí° Los datos P&L se calculan desde snapshots de tu portfolio. Cuanto m√°s uses la wallet, m√°s preciso ser√°."})})]})]})]})}export{pe as default};
