import{d as c,j as e,e as te,T as ae,a8 as B,Y as ne,ag as q,G,an as re,ao as ie,S as ce,A as K,m as z,aj as U,L as oe}from"./ui-Bym_0wSS.js";import{E as le,u as de,R as xe,U as me,p as pe}from"./index-Cv82Q9rX.js";import{b as ue,i as he,G as we,z as T}from"./walletconnect-BmxPmw_-.js";import{Wallet as ge,getBytes as H,isHexString as fe}from"./crypto-1JBTrmrY.js";import"./vendor-CCYniLZC.js";const be="2b0ddf4a2e6e6a53f52d2bcb9a0c2e0f";let f=null,M=null,W=null,L=null,F=null;async function p(){if(f)return f;try{return M=new ue({projectId:be}),f=await he.init({core:M,metadata:{name:"Kairos Wallet",description:"Billetera DeFi multi-chain",url:"https://kairos-wallet.netlify.app",icons:["https://kairos-wallet.netlify.app/icons/logo-192.png"]}}),f.on("session_proposal",t=>{W&&W(t)}),f.on("session_request",t=>{L&&L(t)}),f.on("session_delete",t=>{F&&F(t)}),f}catch(t){throw console.error("WalletConnect init error:",t),t}}function je({onProposal:t,onRequest:o,onDelete:x}){W=t,L=o,F=x}async function Ne(t){await(await p()).pair({uri:t})}async function ye(t,o,x){const n=await p(),j=x.map(i=>`eip155:${i}`),u=x.map(i=>`eip155:${i}:${o}`),l=["eth_sendTransaction","eth_signTransaction","eth_sign","personal_sign","eth_signTypedData","eth_signTypedData_v4"],m=["chainChanged","accountsChanged"],h=we({proposal:t.params,supportedNamespaces:{eip155:{chains:j,methods:l,events:m,accounts:u}}});return await n.approveSession({id:t.id,namespaces:h})}async function ke(t){await(await p()).rejectSession({id:t,reason:T("USER_REJECTED")})}async function ve(t,o){const x=await p(),{topic:n,id:j,params:u}=t,{request:l,chainId:m}=u,h=parseInt(m.split(":")[1]),N=le(h),i=new ge(o,N);let d;try{switch(l.method){case"personal_sign":{const a=l.params[0];d=await i.signMessage(fe(a)?H(a):a);break}case"eth_sign":{const a=l.params[1];d=await i.signMessage(H(a));break}case"eth_signTypedData":case"eth_signTypedData_v4":{const a=JSON.parse(l.params[1]),{domain:y,types:A,message:D}=a,k={...A};delete k.EIP712Domain,d=await i.signTypedData(y,k,D);break}case"eth_sendTransaction":{const a=l.params[0];d=(await i.sendTransaction({to:a.to,value:a.value||"0x0",data:a.data||"0x",gasLimit:a.gas||a.gasLimit})).hash;break}case"eth_signTransaction":{const a=l.params[0];d=await i.signTransaction({to:a.to,value:a.value||"0x0",data:a.data||"0x",gasLimit:a.gas||a.gasLimit});break}default:throw new Error(`Método no soportado: ${l.method}`)}return await x.respondSessionRequest({topic:n,response:{id:j,jsonrpc:"2.0",result:d}}),{success:!0,result:d}}catch(a){return await x.respondSessionRequest({topic:n,response:{id:j,jsonrpc:"2.0",error:T("USER_REJECTED")}}),{success:!1,error:a.message}}}async function Se(t,o){await(await p()).respondSessionRequest({topic:t,response:{id:o,jsonrpc:"2.0",error:T("USER_REJECTED")}})}async function Ce(){const t=await p();return Object.values(t.getActiveSessions())}async function Ee(t){await(await p()).disconnectSession({topic:t,reason:T("USER_DISCONNECTED")})}function De(){const{activeAddress:t,activeChainId:o,goBack:x,showToast:n,navigate:j}=de(),[u,l]=c.useState([]),[m,h]=c.useState(""),[N,i]=c.useState(!1),[d,a]=c.useState(!1),[y,A]=c.useState(""),[D,k]=c.useState(!1),[w,I]=c.useState(null),[g,S]=c.useState(null),[b,C]=c.useState(""),[O,P]=c.useState(""),[E,R]=c.useState(!1);c.useEffect(()=>{(async()=>{try{je({onProposal:r=>I(r),onRequest:r=>S(r),onDelete:()=>_()}),await p(),a(!0),_()}catch(r){A(r.message||"Error inicializando WalletConnect")}})()},[]);const _=async()=>{try{const s=await Ce();l(s)}catch{}},Q=async()=>{if(m.trim()){i(!0);try{await Ne(m.trim()),h(""),n("Conectando con dApp...","info")}catch(s){n("Error: "+(s.message||"URI inválido"),"error")}i(!1)}},V=async()=>{if(w){R(!0);try{await ye(w,t,me),n("dApp conectada","success"),I(null),_()}catch(s){n("Error: "+s.message,"error")}R(!1)}},Y=async()=>{if(w){try{await ke(w.id)}catch{}I(null)}},$=async()=>{if(!(!g||!b)){P(""),R(!0);try{const s=await pe(b),v=[...s.accounts||[],...s.importedAccounts||[]].find(se=>se.address.toLowerCase()===t.toLowerCase());if(!v)throw new Error("Cuenta no encontrada");const J=await ve(g,v.privateKey);J.success?n("Solicitud aprobada","success"):n("Error: "+J.error,"error"),S(null),C("")}catch(s){s.message==="Contraseña incorrecta"?P("Contraseña incorrecta"):(n("Error: "+s.message,"error"),S(null),C(""))}R(!1)}},X=async()=>{if(g){try{await Se(g.topic,g.id)}catch{}S(null),C("")}},Z=async s=>{try{await Ee(s),n("dApp desconectada","success"),_()}catch{n("Error desconectando","error")}},ee=s=>{if(!s)return"";const r=s.params?.request?.method||"";return{personal_sign:"Firmar mensaje",eth_sign:"Firmar mensaje",eth_signTypedData:"Firmar datos tipados",eth_signTypedData_v4:"Firmar datos tipados (v4)",eth_sendTransaction:"Enviar transacción",eth_signTransaction:"Firmar transacción"}[r]||r};return e.jsxs("div",{className:"screen-container",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4",children:[e.jsx("button",{onClick:x,className:"p-2 -ml-2 rounded-xl hover:bg-white/5",children:e.jsx(te,{size:20,className:"text-dark-300"})}),e.jsx("h1",{className:"font-bold text-white",children:"WalletConnect"}),e.jsx("div",{className:"w-8"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto px-5 pb-8",children:[y&&e.jsxs("div",{className:"mb-4 flex items-center gap-2 px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/20",children:[e.jsx(ae,{size:14,className:"text-red-400 shrink-0"}),e.jsx("span",{className:"text-xs text-red-300",children:y})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(B,{size:16,className:"text-kairos-400"}),e.jsx("span",{className:"text-sm font-semibold text-white",children:"Conectar dApp"})]}),e.jsx("p",{className:"text-xs text-dark-400 mb-3",children:"Pega el URI de WalletConnect de cualquier dApp (OpenSea, Uniswap, Aave, etc.)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:m,onChange:s=>h(s.target.value),placeholder:"wc:...",className:"flex-1 bg-white/[0.04] rounded-xl px-4 py-3 text-sm text-white placeholder-dark-500 outline-none border border-white/5 focus:border-kairos-500/50 font-mono text-xs min-w-0",disabled:!d}),e.jsx("button",{onClick:()=>k(!0),className:"px-3 py-3 rounded-xl bg-white/[0.06] hover:bg-white/10 transition-colors shrink-0",children:e.jsx(ne,{size:16,className:"text-kairos-400"})}),e.jsx("button",{onClick:Q,disabled:!m.trim()||N||!d,className:`px-4 py-3 rounded-xl font-bold text-sm shrink-0 transition-all ${m.trim()&&d?"bg-kairos-500 text-dark-950":"bg-white/[0.06] text-dark-500 cursor-not-allowed"}`,children:N?e.jsx(q,{size:16,className:"animate-spin"}):"Conectar"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(G,{size:16,className:"text-kairos-400"}),e.jsxs("span",{className:"text-sm font-semibold text-white",children:["Sesiones activas (",u.length,")"]})]}),u.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-4",children:e.jsx(re,{size:24,className:"text-dark-400"})}),e.jsx("p",{className:"text-dark-400 text-sm mb-1",children:"Sin conexiones"}),e.jsx("p",{className:"text-dark-500 text-xs",children:"Conecta una dApp usando el URI de arriba"})]}):e.jsx("div",{className:"space-y-2",children:u.map(s=>{const r=s.peer?.metadata||{};return e.jsx("div",{className:"bg-white/[0.03] rounded-xl p-3 border border-white/5",children:e.jsxs("div",{className:"flex items-center gap-3",children:[r.icons?.[0]?e.jsx("img",{src:r.icons[0],alt:"",className:"w-10 h-10 rounded-xl bg-white/5",onError:v=>{v.target.style.display="none"}}):e.jsx("div",{className:"w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center",children:e.jsx(G,{size:20,className:"text-dark-400"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-semibold text-sm text-white truncate",children:r.name||"dApp"}),e.jsx("p",{className:"text-[10px] text-dark-500 truncate",children:r.url||""})]}),e.jsx("button",{onClick:()=>Z(s.topic),className:"p-2 rounded-lg hover:bg-red-500/10 transition-colors",title:"Desconectar",children:e.jsx(ie,{size:16,className:"text-red-400"})})]})},s.topic)})})]}),e.jsxs("div",{className:"mt-6 flex items-start gap-2 px-3 py-2 rounded-xl bg-kairos-500/5 border border-kairos-500/10",children:[e.jsx(ce,{size:14,className:"text-kairos-400 shrink-0 mt-0.5"}),e.jsx("p",{className:"text-[10px] text-dark-400",children:"Siempre verifica la URL y nombre de la dApp antes de aprobar. Kairos Wallet te pedirá contraseña para cada firma."})]})]}),e.jsx(K,{children:w&&e.jsx(z.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 z-50 bg-dark-950/95 backdrop-blur-xl flex items-center justify-center px-5",children:e.jsxs(z.div,{initial:{scale:.9},animate:{scale:1},exit:{scale:.9},className:"w-full max-w-sm bg-dark-800 rounded-2xl p-6 border border-white/10",children:[e.jsxs("div",{className:"text-center mb-5",children:[e.jsx("div",{className:"w-14 h-14 rounded-2xl bg-kairos-500/10 flex items-center justify-center mx-auto mb-3",children:e.jsx(B,{size:24,className:"text-kairos-400"})}),e.jsx("h3",{className:"font-bold text-white text-lg",children:"Solicitud de conexión"}),e.jsxs("p",{className:"text-xs text-dark-400 mt-1",children:[w.params?.proposer?.metadata?.name||"dApp"," quiere conectarse"]}),e.jsx("p",{className:"text-[10px] text-dark-500 mt-1",children:w.params?.proposer?.metadata?.url||""})]}),e.jsxs("div",{className:"mb-4 p-3 rounded-xl bg-white/[0.03] border border-white/5",children:[e.jsx("p",{className:"text-[10px] text-dark-400 mb-2",children:"Permisos solicitados:"}),e.jsxs("ul",{className:"space-y-1",children:[e.jsxs("li",{className:"text-xs text-dark-300 flex items-center gap-1",children:[e.jsx(U,{size:10,className:"text-green-400"})," Ver tu dirección"]}),e.jsxs("li",{className:"text-xs text-dark-300 flex items-center gap-1",children:[e.jsx(U,{size:10,className:"text-green-400"})," Solicitar firmas"]}),e.jsxs("li",{className:"text-xs text-dark-300 flex items-center gap-1",children:[e.jsx(U,{size:10,className:"text-green-400"})," Enviar transacciones"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:Y,className:"flex-1 py-3 rounded-xl bg-white/[0.06] text-dark-300 font-medium text-sm",children:"Rechazar"}),e.jsx("button",{onClick:V,disabled:E,className:"flex-1 py-3 rounded-xl bg-kairos-500 text-dark-950 font-bold text-sm flex items-center justify-center",children:E?e.jsx(q,{size:16,className:"animate-spin"}):"Aprobar"})]})]})})}),e.jsx(K,{children:g&&e.jsx(z.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 z-50 bg-dark-950/95 backdrop-blur-xl flex items-center justify-center px-5",children:e.jsxs(z.div,{initial:{scale:.9},animate:{scale:1},exit:{scale:.9},className:"w-full max-w-sm bg-dark-800 rounded-2xl p-6 border border-white/10",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("div",{className:"w-14 h-14 rounded-2xl bg-orange-500/10 flex items-center justify-center mx-auto mb-3",children:e.jsx(oe,{size:24,className:"text-orange-400"})}),e.jsx("h3",{className:"font-bold text-white text-lg",children:ee(g)}),e.jsx("p",{className:"text-xs text-dark-400 mt-1",children:"Confirma con tu contraseña para aprobar"})]}),e.jsx("input",{type:"password",value:b,onChange:s=>{C(s.target.value),P("")},onKeyDown:s=>s.key==="Enter"&&b&&$(),placeholder:"Contraseña de la wallet",className:"w-full bg-white/[0.04] rounded-xl px-4 py-3 text-sm text-white placeholder-dark-500 outline-none border border-white/5 focus:border-kairos-500/50 mb-2",autoFocus:!0}),O&&e.jsx("p",{className:"text-red-400 text-xs mb-2",children:O}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx("button",{onClick:X,className:"flex-1 py-3 rounded-xl bg-white/[0.06] text-dark-300 font-medium text-sm",children:"Rechazar"}),e.jsx("button",{onClick:$,disabled:!b||E,className:`flex-1 py-3 rounded-xl font-bold text-sm flex items-center justify-center ${b?"bg-kairos-500 text-dark-950":"bg-white/[0.06] text-dark-500 cursor-not-allowed"}`,children:E?e.jsx(q,{size:16,className:"animate-spin"}):"Aprobar"})]})]})})}),e.jsx(xe,{isOpen:D,onClose:()=>k(!1),onScan:s=>{s.startsWith("wc:")?(h(s),n("URI de WalletConnect escaneado","success"),setTimeout(()=>Q(),300)):n("QR no es un URI de WalletConnect","error")},title:"Escanear WalletConnect QR"})]})}export{De as default};
