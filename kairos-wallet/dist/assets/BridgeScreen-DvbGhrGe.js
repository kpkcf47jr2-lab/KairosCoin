import{d as n,j as e,e as me,y as J,u as X,ai as ue,m as v,O as he,T as Y,ax as fe,S as Z,w as pe,C as Ne,A as je}from"./ui-Bym_0wSS.js";import{b as ge,u as we,C as O,G as be,p as ye,W as D,I as ve}from"./index-CtS2HjSl.js";import{formatUnits as ke,JsonRpcProvider as T,formatEther as P,parseEther as Ce,Wallet as Se}from"./crypto-1JBTrmrY.js";import"./vendor-CCYniLZC.js";const te="https://li.quest/v1",F="0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE",Ee=[56,1,137,42161,8453];async function Re({fromChainId:i,toChainId:f,fromToken:o=F,toToken:c=F,fromAmount:p,fromAddress:a,slippage:R=.03}){const x=new URLSearchParams({fromChain:i.toString(),toChain:f.toString(),fromToken:o,toToken:c,fromAmount:p,fromAddress:a,toAddress:a,slippage:R.toString()}),k=await fetch(`${te}/quote?${x}`);if(!k.ok){const j=await k.text();throw new Error(`Bridge quote failed: ${j}`)}const r=await k.json();return{raw:r,bridge:r.tool||"unknown",fromAmount:r.estimate.fromAmount,toAmount:r.estimate.toAmount,toAmountMin:r.estimate.toAmountMin,gasCostUSD:r.estimate.gasCosts?.reduce((j,C)=>j+parseFloat(C.amountUSD||0),0).toFixed(2),feeCostUSD:r.estimate.feeCosts?.reduce((j,C)=>j+parseFloat(C.amountUSD||0),0).toFixed(2),executionDuration:r.estimate.executionDuration||60,transactionRequest:r.transactionRequest}}async function Ie(i,f){const o=i.transactionRequest;if(!o)throw new Error("No transaction request in quote");const c=await f.sendTransaction({to:o.to,data:o.data,value:o.value,gasLimit:o.gasLimit||5e5,gasPrice:o.gasPrice}),p=await c.wait();return{hash:c.hash,blockNumber:p.blockNumber,gasUsed:p.gasUsed.toString(),status:p.status===1?"success":"failed"}}async function Ae(i,f,o){try{const c=new URLSearchParams({txHash:i,fromChain:f.toString(),toChain:o.toString()}),p=await fetch(`${te}/status?${c}`);if(!p.ok)return{status:"PENDING"};const a=await p.json();return{status:a.status||"PENDING",substatus:a.substatus,receiving:a.receiving,sending:a.sending}}catch{return{status:"PENDING"}}}function ee(i,f=18){const o=ke(i,f),c=parseFloat(o);return c===0?"0":c<1e-6?"<0.000001":c<1?c.toFixed(6):c<1e3?c.toFixed(4):c.toLocaleString(void 0,{maximumFractionDigits:2})}const s={FORM:"form",QUOTE:"quote",CONFIRM:"confirm",PASSWORD:"password",BRIDGING:"bridging",MONITORING:"monitoring",SUCCESS:"success",ERROR:"error"};function Te(){ge();const{activeAddress:i,activeChainId:f,navigate:o,showToast:c,getActiveAccount:p}=we(),[a,R]=n.useState(f),[x,k]=n.useState(f===56?8453:56),[r,j]=n.useState(""),[C,U]=n.useState("0"),[se,ae]=n.useState(0),[S,I]=n.useState(""),[m,b]=n.useState(null),[G,M]=n.useState(!1),[q,A]=n.useState(null),[g,d]=n.useState(s.FORM),[ne,$]=n.useState(!1),[re,L]=n.useState(!1),[Q,z]=n.useState(null),[W,ie]=n.useState(null),[ce,B]=n.useState(null),[H,K]=n.useState(null),N=O[a],w=O[x];n.useEffect(()=>{if(!i||!a)return;const t=O[a];if(!t)return;new T(t.rpcUrls[0]).getBalance(i).then(h=>{U(P(h))}).catch(()=>U("0")),be(a).then(h=>{ae(h)}).catch(()=>{})},[i,a]);const le=n.useCallback(()=>{R(x),k(a),b(null),A(null)},[a,x]),oe=n.useCallback(async()=>{if(!r||parseFloat(r)<=0){c("Ingresa una cantidad válida","error");return}M(!0),A(null),b(null);try{const t=Ce(r).toString(),u=await Re({fromChainId:a,toChainId:x,fromToken:F,toToken:F,fromAmount:t,fromAddress:i});b(u),d(s.QUOTE)}catch(t){console.error("[Bridge] Quote error:",t),A(t.message||"No se pudo obtener cotización")}finally{M(!1)}},[r,a,x,i]),_=n.useCallback(async()=>{if(!S){c("Ingresa tu contraseña","error");return}d(s.BRIDGING),B(null);try{await ye(S);const t=p();if(!t?.privateKey)throw new Error("Account not found");const u=new T(N.rpcUrls[0]),h=new Se(t.privateKey,u),y=await Ie(m,h);if(z(y.hash),y.status==="success")d(s.MONITORING),de(y.hash);else throw new Error("Transaction failed on source chain")}catch(t){console.error("[Bridge] Execute error:",t),B(t.message||"Bridge failed"),d(s.ERROR)}},[S,m,i,N]),de=n.useCallback(async t=>{const u=new T(w.rpcUrls[0]),h=await u.getBalance(i);for(let y=0;y<120;y++){await new Promise(l=>setTimeout(l,5e3));try{const l=await u.getBalance(i);if(l>h){const E=l-h;K(P(E)),d(s.SUCCESS);return}}catch{}try{const l=await Ae(t,a,x);if(ie(l.status),l.status==="DONE"){const xe=await u.getBalance(i)-h;K(P(xe)),d(s.SUCCESS);return}if(l.status==="FAILED"){B("Bridge transfer failed"),d(s.ERROR);return}}catch{}}c("Bridge en proceso — puede tardar más","warning"),d(s.SUCCESS)},[i,w,a,x]),V=({isOpen:t,onClose:u,onSelect:h,excludeChainId:y})=>t?e.jsx(v.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/70 flex items-end justify-center",onClick:u,children:e.jsxs(v.div,{initial:{y:300},animate:{y:0},exit:{y:300},className:"w-full max-w-md bg-dark-800 rounded-t-3xl p-6",onClick:l=>l.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Seleccionar Red"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-auto",children:Ee.filter(l=>l!==y).map(l=>{const E=O[l];return e.jsxs("button",{onClick:()=>{h(l),u()},className:"w-full flex items-center gap-3 p-3 rounded-xl hover:bg-dark-700 transition-colors",children:[e.jsx(D,{chainId:l,size:32}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-white font-medium",children:E.name}),e.jsx("div",{className:"text-dark-400 text-xs",children:E.nativeCurrency.symbol})]})]},l)})})]})}):null;return e.jsxs("div",{className:"screen-container",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("button",{onClick:()=>o("dashboard"),className:"icon-btn",children:e.jsx(me,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h1",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-kairos-400"}),"Bridge"]}),e.jsx("p",{className:"text-dark-400 text-xs",children:"Mueve tokens entre cadenas"})]})]}),(g===s.FORM||g===s.QUOTE)&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"card-dark p-4",children:[e.jsx("div",{className:"text-dark-400 text-xs mb-2",children:"Desde"}),e.jsxs("button",{onClick:()=>$(!0),className:"w-full flex items-center gap-3 p-3 rounded-xl bg-dark-700 hover:bg-dark-600 transition-colors",children:[e.jsx(D,{chainId:a,size:28}),e.jsx("span",{className:"text-white font-medium flex-1 text-left",children:N?.name}),e.jsx(X,{className:"w-4 h-4 text-dark-400"})]}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",value:r,onChange:t=>{j(t.target.value),b(null),A(null)},placeholder:"0.0",className:"flex-1 bg-transparent text-2xl text-white font-bold outline-none placeholder-dark-600"}),e.jsx("span",{className:"text-dark-300 font-medium",children:N?.nativeCurrency?.symbol})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsxs("span",{className:"text-dark-400 text-xs",children:["≈ ",ve(parseFloat(r||0)*se)]}),e.jsxs("button",{onClick:()=>{const t=Math.max(0,parseFloat(C)-.002);j(t.toFixed(6)),b(null)},className:"text-kairos-400 text-xs font-medium hover:text-kairos-300",children:["MAX: ",parseFloat(C).toFixed(4)," ",N?.nativeCurrency?.symbol]})]})]})]}),e.jsx("div",{className:"flex justify-center -my-1 relative z-10",children:e.jsx("button",{onClick:le,className:`w-10 h-10 rounded-full bg-kairos-500 flex items-center justify-center
                         hover:bg-kairos-400 transition-colors shadow-lg shadow-kairos-500/30`,children:e.jsx(ue,{className:"w-5 h-5 text-black"})})}),e.jsxs("div",{className:"card-dark p-4",children:[e.jsx("div",{className:"text-dark-400 text-xs mb-2",children:"Hacia"}),e.jsxs("button",{onClick:()=>L(!0),className:"w-full flex items-center gap-3 p-3 rounded-xl bg-dark-700 hover:bg-dark-600 transition-colors",children:[e.jsx(D,{chainId:x,size:28}),e.jsx("span",{className:"text-white font-medium flex-1 text-left",children:w?.name}),e.jsx(X,{className:"w-4 h-4 text-dark-400"})]}),m&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"text-2xl text-white font-bold",children:["~",ee(m.toAmount)," ",w?.nativeCurrency?.symbol]}),e.jsxs("div",{className:"text-dark-400 text-xs",children:["Min: ",ee(m.toAmountMin)," ",w?.nativeCurrency?.symbol]})]})]}),m&&e.jsxs(v.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"card-dark p-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-dark-400",children:"Bridge"}),e.jsx("span",{className:"text-white font-medium capitalize",children:m.bridge})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-dark-400",children:"Gas estimado"}),e.jsxs("span",{className:"text-white",children:["$",m.gasCostUSD]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-dark-400",children:"Fee del bridge"}),e.jsxs("span",{className:"text-white",children:["$",m.feeCostUSD]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-dark-400 flex items-center gap-1",children:[e.jsx(he,{className:"w-3 h-3"})," Tiempo estimado"]}),e.jsxs("span",{className:"text-white",children:[m.executionDuration,"s"]})]})]}),q&&e.jsx("div",{className:"card-dark p-3 border border-red-500/30",children:e.jsxs("p",{className:"text-red-400 text-sm flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"}),q]})}),m?e.jsx("button",{onClick:()=>d(s.PASSWORD),className:"btn-primary w-full py-4 text-lg",children:e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(Z,{className:"w-5 h-5"}),"Bridge ",r," ",N?.nativeCurrency?.symbol]})}):e.jsx("button",{onClick:oe,disabled:G||!r||parseFloat(r)<=0,className:"btn-primary w-full py-4 text-lg disabled:opacity-50",children:G?e.jsxs("span",{className:"flex items-center justify-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5 animate-spin"}),"Obteniendo cotización..."]}):"Obtener Cotización"})]}),g===s.PASSWORD&&e.jsxs(v.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-4",children:[e.jsxs("div",{className:"card-dark p-6 text-center",children:[e.jsx(Z,{className:"w-12 h-12 text-kairos-400 mx-auto mb-3"}),e.jsx("h3",{className:"text-white font-bold text-lg mb-1",children:"Confirmar Bridge"}),e.jsxs("p",{className:"text-dark-300 text-sm mb-4",children:[r," ",N?.nativeCurrency?.symbol," (",N?.name,") → ",w?.name]}),e.jsx("input",{type:"password",value:S,onChange:t=>I(t.target.value),placeholder:"Contraseña de tu wallet",className:"input-dark w-full text-center",autoFocus:!0,onKeyDown:t=>t.key==="Enter"&&_()})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{d(s.QUOTE),I("")},className:"flex-1 btn-secondary py-3",children:"Cancelar"}),e.jsx("button",{onClick:_,disabled:!S,className:"flex-1 btn-primary py-3 disabled:opacity-50",children:"Confirmar"})]})]}),(g===s.BRIDGING||g===s.MONITORING)&&e.jsxs(v.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12 space-y-6",children:[e.jsx(v.div,{animate:{rotate:360},transition:{duration:2,repeat:1/0,ease:"linear"},children:e.jsx(J,{className:"w-16 h-16 text-kairos-400"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-white font-bold text-xl mb-2",children:g===s.BRIDGING?"Enviando transacción...":"Bridge en progreso..."}),e.jsx("p",{className:"text-dark-300 text-sm",children:g===s.MONITORING?`Esperando confirmación en ${w?.name}...`:`Confirmando en ${N?.name}...`}),W&&e.jsxs("p",{className:"text-kairos-400 text-xs mt-2",children:["Status: ",W]})]}),Q&&e.jsxs("a",{href:`${N?.blockExplorerUrl}/tx/${Q}`,target:"_blank",rel:"noopener noreferrer",className:"text-kairos-400 text-sm flex items-center gap-1 hover:text-kairos-300",children:["Ver en explorador ",e.jsx(pe,{className:"w-3 h-3"})]})]}),g===s.SUCCESS&&e.jsxs(v.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex flex-col items-center justify-center py-12 space-y-6",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-green-500/10 flex items-center justify-center",children:e.jsx(Ne,{className:"w-10 h-10 text-green-400"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-white font-bold text-xl mb-2",children:"¡Bridge Exitoso!"}),e.jsx("p",{className:"text-dark-300 text-sm",children:H?`Recibido: ${parseFloat(H).toFixed(6)} ${w?.nativeCurrency?.symbol}`:`Transferencia completada a ${w?.name}`})]}),e.jsxs("div",{className:"flex gap-3 w-full",children:[e.jsx("button",{onClick:()=>{d(s.FORM),j(""),b(null),z(null),I("")},className:"flex-1 btn-secondary py-3",children:"Otro Bridge"}),e.jsx("button",{onClick:()=>o("dashboard"),className:"flex-1 btn-primary py-3",children:"Dashboard"})]})]}),g===s.ERROR&&e.jsxs(v.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex flex-col items-center justify-center py-12 space-y-6",children:[e.jsx("div",{className:"w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center",children:e.jsx(Y,{className:"w-10 h-10 text-red-400"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-white font-bold text-xl mb-2",children:"Error"}),e.jsx("p",{className:"text-dark-300 text-sm max-w-xs",children:ce})]}),e.jsx("button",{onClick:()=>{d(s.FORM),B(null),I("")},className:"btn-primary py-3 px-8",children:"Reintentar"})]}),e.jsxs(je,{children:[e.jsx(V,{isOpen:ne,onClose:()=>$(!1),onSelect:t=>{R(t),b(null)},excludeChainId:x}),e.jsx(V,{isOpen:re,onClose:()=>L(!1),onSelect:t=>{k(t),b(null)},excludeChainId:a})]})]})}export{Te as default};
