{"version":3,"file":"kairosScript-DOo_Z8wV.js","sources":["../../src/services/kairosScript.js"],"sourcesContent":["// Kairos Trade — Kairos Script Engine\n// Sandboxed strategy execution — users paste code, bots execute trades\n// Simpler than Pine Script, more powerful than MQL4\n\nimport { calculateEMA, calculateSMA, calculateRSI, calculateMACD, calculateBollingerBands, calculateVWAP, detectCrossover } from './indicators';\nimport { feeService } from './feeService';\n\n// ─── Indicator Result wrapper (auto-converts to number in comparisons) ───\nclass Indicator {\n  constructor(series) {\n    this._series = series.map(v => v ?? 0);\n    this._value = this._series[this._series.length - 1] || 0;\n  }\n  valueOf() { return this._value; }\n  toString() { return String(this._value); }\n  get value() { return this._value; }\n  get series() { return this._series; }\n  prev(n = 1) { return this._series[this._series.length - 1 - n] || 0; }\n  toFixed(d) { return this._value.toFixed(d); }\n}\n\n// ─── Build the sandboxed context from market data ───\nfunction buildContext(candles) {\n  const closes = candles.map(c => c.close);\n  const opens = candles.map(c => c.open);\n  const highs = candles.map(c => c.high);\n  const lows = candles.map(c => c.low);\n  const volumes = candles.map(c => c.volume);\n  const len = closes.length;\n\n  // Signal accumulator\n  let signal = null;\n  let scriptConfig = { stopLoss: 2, takeProfit: 4 };\n  const logs = [];\n\n  // ─── Indicator functions (return Indicator objects) ───\n  const ema = (period = 20) => new Indicator(calculateEMA(closes, period));\n  const sma = (period = 20) => new Indicator(calculateSMA(closes, period));\n  const rsi = (period = 14) => new Indicator(calculateRSI(closes, period));\n\n  const macd = (fast = 12, slow = 26, sig = 9) => {\n    const result = calculateMACD(closes, fast, slow, sig);\n    return {\n      line: new Indicator(result.macd),\n      signal: new Indicator(result.signal),\n      histogram: new Indicator(result.histogram),\n      valueOf() { return result.histogram[len - 1] || 0; },\n    };\n  };\n\n  const bb = (period = 20, stdDev = 2) => {\n    const result = calculateBollingerBands(closes, period, stdDev);\n    return {\n      upper: new Indicator(result.upper),\n      middle: new Indicator(result.middle),\n      lower: new Indicator(result.lower),\n    };\n  };\n\n  const vwap = () => new Indicator(calculateVWAP(candles));\n\n  // ─── Crossover detection ───\n  const crossover = (a, b) => {\n    // Accept Indicator objects or numbers\n    const seriesA = a instanceof Indicator ? a.series : (typeof a === 'number' ? [a, a] : []);\n    const seriesB = b instanceof Indicator ? b.series : (typeof b === 'number' ? [b, b] : []);\n    if (seriesA.length < 2 || seriesB.length < 2) return false;\n    const i = Math.min(seriesA.length, seriesB.length) - 1;\n    return seriesA[i - 1] <= seriesB[i - 1] && seriesA[i] > seriesB[i];\n  };\n\n  const crossunder = (a, b) => {\n    const seriesA = a instanceof Indicator ? a.series : (typeof a === 'number' ? [a, a] : []);\n    const seriesB = b instanceof Indicator ? b.series : (typeof b === 'number' ? [b, b] : []);\n    if (seriesA.length < 2 || seriesB.length < 2) return false;\n    const i = Math.min(seriesA.length, seriesB.length) - 1;\n    return seriesA[i - 1] >= seriesB[i - 1] && seriesA[i] < seriesB[i];\n  };\n\n  // ─── Action functions ───\n  const buy = (opts = {}) => {\n    signal = { type: 'buy', ...opts };\n  };\n\n  const sell = (opts = {}) => {\n    signal = { type: 'sell', ...opts };\n  };\n\n  const config = (opts = {}) => {\n    Object.assign(scriptConfig, opts);\n  };\n\n  const log = (msg) => {\n    logs.push(String(msg));\n  };\n\n  const alert = (msg) => {\n    logs.push(`⚠️ ${String(msg)}`);\n  };\n\n  // ─── Data access ───\n  const close = new Indicator(closes);\n  const open = new Indicator(opens);\n  const high = new Indicator(highs);\n  const low = new Indicator(lows);\n  const volume = new Indicator(volumes);\n  const price = closes[len - 1] || 0;\n  const barIndex = len - 1;\n\n  // ─── Utility math functions ───\n  const highest = (ind, period) => {\n    const s = ind instanceof Indicator ? ind.series : closes;\n    const slice = s.slice(-period);\n    return Math.max(...slice.filter(v => v != null));\n  };\n\n  const lowest = (ind, period) => {\n    const s = ind instanceof Indicator ? ind.series : closes;\n    const slice = s.slice(-period);\n    return Math.min(...slice.filter(v => v != null));\n  };\n\n  const avg = (ind, period) => {\n    const s = ind instanceof Indicator ? ind.series : closes;\n    const slice = s.slice(-period).filter(v => v != null);\n    return slice.reduce((a, b) => a + b, 0) / (slice.length || 1);\n  };\n\n  const change = (ind, period = 1) => {\n    const s = ind instanceof Indicator ? ind.series : closes;\n    const curr = s[s.length - 1] || 0;\n    const prev = s[s.length - 1 - period] || 0;\n    return curr - prev;\n  };\n\n  const percentChange = (ind, period = 1) => {\n    const s = ind instanceof Indicator ? ind.series : closes;\n    const curr = s[s.length - 1] || 0;\n    const prev = s[s.length - 1 - period] || 0;\n    return prev !== 0 ? ((curr - prev) / prev) * 100 : 0;\n  };\n\n  // All available sandbox variables\n  const sandbox = {\n    // Indicators\n    ema, sma, rsi, macd, bb, vwap,\n    // Series data\n    close, open, high, low, volume, price, barIndex,\n    // Signal detection\n    crossover, crossunder,\n    // Actions\n    buy, sell, config, log, alert,\n    // Utilities\n    highest, lowest, avg, change, percentChange,\n    // Safe math\n    Math, Number, parseInt, parseFloat,\n    isNaN, isFinite,\n    // No access to: window, document, fetch, eval, Function, setTimeout, etc.\n  };\n\n  return { sandbox, getSignal: () => signal, getConfig: () => scriptConfig, getLogs: () => logs };\n}\n\n// ─── Execute a Kairos Script ───\nexport function executeScript(code, candles) {\n  if (!code || !candles || candles.length < 2) {\n    return { signal: null, config: { stopLoss: 2, takeProfit: 4 }, logs: ['No hay datos suficientes'] };\n  }\n\n  const { sandbox, getSignal, getConfig, getLogs } = buildContext(candles);\n\n  try {\n    // Block dangerous globals by passing them as undefined parameters\n    const blockedGlobals = [\n      'window', 'document', 'globalThis', 'self',\n      'fetch', 'XMLHttpRequest', 'WebSocket',\n      'eval', 'Function', 'setTimeout', 'setInterval',\n      'importScripts', 'localStorage', 'sessionStorage',\n      'indexedDB', 'crypto', 'navigator', 'location',\n      'history', 'process', 'require', 'module', 'exports',\n      '__dirname', '__filename',\n    ];\n\n    const argNames = [...Object.keys(sandbox), ...blockedGlobals];\n    const argValues = [\n      ...Object.values(sandbox),\n      ...blockedGlobals.map(() => undefined),\n    ];\n\n    const fn = new Function(...argNames, code);\n    fn(...argValues);\n\n    return {\n      signal: getSignal(),\n      config: getConfig(),\n      logs: getLogs(),\n      error: null,\n    };\n  } catch (err) {\n    return {\n      signal: null,\n      config: getConfig(),\n      logs: [...getLogs(), `❌ Error: ${err.message}`],\n      error: err.message,\n    };\n  }\n}\n\n// ─── Validate a script (check syntax without executing) ───\nexport function validateScript(code) {\n  if (!code || !code.trim()) return { valid: false, error: 'El script está vacío' };\n\n  try {\n    // Check for dangerous patterns\n    const dangerous = [\n      /\\beval\\s*\\(/,\n      /\\bFunction\\s*\\(/,\n      /\\bimport\\s*\\(/,\n      /\\brequire\\s*\\(/,\n      /\\bfetch\\s*\\(/,\n      /\\bXMLHttpRequest\\b/,\n      /\\bWebSocket\\b/,\n      /\\bwindow\\b/,\n      /\\bdocument\\b/,\n      /\\bprocess\\b/,\n      /\\b__proto__\\b/,\n      /\\bconstructor\\s*\\[/,\n      /\\bprototype\\b/,\n    ];\n\n    for (const pattern of dangerous) {\n      if (pattern.test(code)) {\n        return { valid: false, error: `Código no permitido: ${pattern.source}` };\n      }\n    }\n\n    // Try to parse (syntax check)\n    new Function(code);\n    return { valid: true, error: null };\n  } catch (err) {\n    return { valid: false, error: `Error de sintaxis: ${err.message}` };\n  }\n}\n\n// ─── Backtest a script against historical data ───\nexport function backtestScript(code, candles, config = {}) {\n  const { initialBalance = 1000, riskPercent = 2 } = config;\n  let balance = initialBalance;\n  let position = null;\n  const trades = [];\n  const equityCurve = [initialBalance];\n  const logs = [];\n\n  // Need at least 50 bars for indicators to warm up\n  const minBars = 50;\n  if (candles.length < minBars) {\n    return { trades: [], equityCurve: [initialBalance], finalBalance: initialBalance, logs: ['Se necesitan al menos 50 velas'] };\n  }\n\n  // Slide through history, executing the script on each bar\n  for (let i = minBars; i < candles.length; i++) {\n    const slice = candles.slice(0, i + 1);\n    const currentPrice = slice[slice.length - 1].close;\n\n    const result = executeScript(code, slice);\n\n    if (result.error) {\n      logs.push(`Bar ${i}: ${result.error}`);\n      continue;\n    }\n\n    const stopLoss = result.config?.stopLoss || 2;\n    const takeProfit = result.config?.takeProfit || 4;\n\n    // Check stop loss / take profit on open position\n    if (position) {\n      const pnlPercent = position.side === 'buy'\n        ? ((currentPrice - position.entryPrice) / position.entryPrice) * 100\n        : ((position.entryPrice - currentPrice) / position.entryPrice) * 100;\n\n      if (pnlPercent <= -stopLoss || pnlPercent >= takeProfit) {\n        const rawPnl = position.quantity * (currentPrice - position.entryPrice) * (position.side === 'buy' ? 1 : -1);\n        const fee = feeService.calculateFee(currentPrice, position.quantity);\n        const pnl = rawPnl - fee;\n        balance += pnl;\n        trades.push({\n          ...position,\n          exitPrice: currentPrice,\n          exitBar: i,\n          pnl,\n          pnlPercent,\n          reason: pnlPercent >= takeProfit ? 'Take Profit' : 'Stop Loss',\n        });\n        position = null;\n      }\n    }\n\n    // Process signal\n    if (result.signal) {\n      if (result.signal.type === 'buy' && !position) {\n        const quantity = (balance * (riskPercent / 100)) / currentPrice;\n        position = {\n          side: 'buy',\n          entryPrice: currentPrice,\n          quantity,\n          entryBar: i,\n        };\n      } else if (result.signal.type === 'sell' && position?.side === 'buy') {\n        const rawPnl = position.quantity * (currentPrice - position.entryPrice);\n        const fee = feeService.calculateFee(currentPrice, position.quantity);\n        const pnl = rawPnl - fee;\n        balance += pnl;\n        const pnlPercent = ((currentPrice - position.entryPrice) / position.entryPrice) * 100;\n        trades.push({\n          ...position,\n          exitPrice: currentPrice,\n          exitBar: i,\n          pnl,\n          pnlPercent,\n          reason: 'Signal',\n        });\n        position = null;\n      } else if (result.signal.type === 'sell' && !position) {\n        const quantity = (balance * (riskPercent / 100)) / currentPrice;\n        position = {\n          side: 'sell',\n          entryPrice: currentPrice,\n          quantity,\n          entryBar: i,\n        };\n      } else if (result.signal.type === 'buy' && position?.side === 'sell') {\n        const rawPnl = position.quantity * (position.entryPrice - currentPrice);\n        const fee = feeService.calculateFee(currentPrice, position.quantity);\n        const pnl = rawPnl - fee;\n        balance += pnl;\n        const pnlPercent = ((position.entryPrice - currentPrice) / position.entryPrice) * 100;\n        trades.push({\n          ...position,\n          exitPrice: currentPrice,\n          exitBar: i,\n          pnl,\n          pnlPercent,\n          reason: 'Signal',\n        });\n        position = null;\n      }\n    }\n\n    // Record equity\n    const unrealizedPnl = position\n      ? position.quantity * (\n          position.side === 'buy'\n            ? (currentPrice - position.entryPrice)\n            : (position.entryPrice - currentPrice)\n        )\n      : 0;\n    equityCurve.push(balance + unrealizedPnl);\n  }\n\n  // Close any remaining position\n  if (position) {\n    const lastPrice = candles[candles.length - 1].close;\n    const rawPnl = position.quantity * (\n      position.side === 'buy'\n        ? (lastPrice - position.entryPrice)\n        : (position.entryPrice - lastPrice)\n    );\n    const fee = feeService.calculateFee(lastPrice, position.quantity);\n    const pnl = rawPnl - fee;\n    balance += pnl;\n    trades.push({\n      ...position,\n      exitPrice: lastPrice,\n      exitBar: candles.length - 1,\n      pnl,\n      pnlPercent: ((pnl / position.entryPrice) / position.quantity) * 100,\n      reason: 'End of Data',\n    });\n  }\n\n  const wins = trades.filter(t => t.pnl > 0).length;\n  const losses = trades.filter(t => t.pnl <= 0).length;\n  const totalPnl = trades.reduce((s, t) => s + t.pnl, 0);\n  const maxDrawdown = calculateMaxDrawdown(equityCurve);\n\n  return {\n    trades,\n    equityCurve,\n    finalBalance: balance,\n    totalTrades: trades.length,\n    wins,\n    losses,\n    winRate: trades.length > 0 ? (wins / trades.length) * 100 : 0,\n    totalPnl,\n    maxDrawdown,\n    profitFactor: losses > 0 ? (trades.filter(t => t.pnl > 0).reduce((s, t) => s + t.pnl, 0) / Math.abs(trades.filter(t => t.pnl <= 0).reduce((s, t) => s + t.pnl, 0) || 1)) : wins > 0 ? Infinity : 0,\n    logs,\n  };\n}\n\nfunction calculateMaxDrawdown(equity) {\n  let peak = equity[0];\n  let maxDD = 0;\n  for (const val of equity) {\n    if (val > peak) peak = val;\n    const dd = ((peak - val) / peak) * 100;\n    if (dd > maxDD) maxDD = dd;\n  }\n  return maxDD;\n}\n\n// ─── Pre-built script templates ───\nexport const SCRIPT_TEMPLATES = [\n  {\n    id: 'ema_cross',\n    name: 'EMA Crossover',\n    description: 'Compra cuando EMA rápida cruza arriba de EMA lenta, vende al cruce inverso',\n    difficulty: 'Principiante',\n    code: `// EMA Crossover Strategy\n// Señal de compra: EMA rápida cruza arriba de EMA lenta\n// Señal de venta: EMA rápida cruza abajo de EMA lenta\n\nconst fast = ema(12);\nconst slow = ema(26);\n\nif (crossover(fast, slow)) {\n  buy();\n}\n\nif (crossunder(fast, slow)) {\n  sell();\n}\n\nconfig({ stopLoss: 2, takeProfit: 4 });`,\n  },\n  {\n    id: 'rsi_reversal',\n    name: 'RSI Reversal',\n    description: 'Compra en sobreventa (RSI < 30), vende en sobrecompra (RSI > 70)',\n    difficulty: 'Principiante',\n    code: `// RSI Reversal Strategy\n// Compra cuando RSI está sobrevendido\n// Vende cuando RSI está sobrecomprado\n\nconst rsiVal = rsi(14);\n\nif (rsiVal < 30) {\n  buy();\n}\n\nif (rsiVal > 70) {\n  sell();\n}\n\nconfig({ stopLoss: 1.5, takeProfit: 3 });`,\n  },\n  {\n    id: 'macd_momentum',\n    name: 'MACD Momentum',\n    description: 'Opera el cruce de la línea MACD con su señal',\n    difficulty: 'Intermedio',\n    code: `// MACD Momentum Strategy\n// Señal de compra: línea MACD cruza arriba de señal\n// Señal de venta: línea MACD cruza abajo de señal\n\nconst m = macd(12, 26, 9);\n\nif (crossover(m.line, m.signal)) {\n  buy();\n}\n\nif (crossunder(m.line, m.signal)) {\n  sell();\n}\n\nconfig({ stopLoss: 2, takeProfit: 5 });`,\n  },\n  {\n    id: 'bb_squeeze',\n    name: 'Bollinger Bands Squeeze',\n    description: 'Compra cuando el precio toca la banda inferior, vende en la superior',\n    difficulty: 'Intermedio',\n    code: `// Bollinger Bands Bounce Strategy\n// Compra en banda inferior, vende en banda superior\n\nconst bands = bb(20, 2);\nconst rsiVal = rsi(14);\n\n// Comprar cerca de banda inferior con RSI sobrevendido\nif (close < bands.lower && rsiVal < 35) {\n  buy();\n}\n\n// Vender cerca de banda superior con RSI sobrecomprado\nif (close > bands.upper && rsiVal > 65) {\n  sell();\n}\n\nconfig({ stopLoss: 1.5, takeProfit: 3 });`,\n  },\n  {\n    id: 'triple_confirmation',\n    name: 'Triple Confirmación',\n    description: 'EMA + RSI + MACD confirman la señal de entrada — alta probabilidad',\n    difficulty: 'Avanzado',\n    code: `// Triple Confirmation Strategy\n// Requiere 3 indicadores para confirmar entrada\n// Alta probabilidad, menos trades pero más precisos\n\nconst ema20 = ema(20);\nconst ema50 = ema(50);\nconst rsiVal = rsi(14);\nconst m = macd(12, 26, 9);\n\n// COMPRA: EMA cruce alcista + RSI < 45 + MACD positivo\nif (crossover(ema20, ema50) && rsiVal < 45 && m.histogram > 0) {\n  buy();\n  log(\"Triple confirmación alcista\");\n}\n\n// VENTA: EMA cruce bajista + RSI > 55 + MACD negativo\nif (crossunder(ema20, ema50) && rsiVal > 55 && m.histogram < 0) {\n  sell();\n  log(\"Triple confirmación bajista\");\n}\n\nconfig({ stopLoss: 2.5, takeProfit: 6 });`,\n  },\n  {\n    id: 'vwap_scalper',\n    name: 'VWAP Scalper',\n    description: 'Scalping basado en VWAP con EMA como filtro de tendencia',\n    difficulty: 'Avanzado',\n    code: `// VWAP Scalper Strategy\n// Compra cuando precio cruza arriba de VWAP con tendencia alcista\n// Scalping rápido con stops ajustados\n\nconst v = vwap();\nconst trend = ema(50);\nconst momentum = rsi(10);\n\n// Tendencia alcista + precio cruza VWAP hacia arriba\nif (crossover(close, v) && close > trend && momentum > 50) {\n  buy();\n  log(\"Long VWAP bounce en tendencia alcista\");\n}\n\n// Tendencia bajista + precio cruza VWAP hacia abajo\nif (crossunder(close, v) && close < trend && momentum < 50) {\n  sell();\n  log(\"Short VWAP rejection en tendencia bajista\");\n}\n\nconfig({ stopLoss: 0.8, takeProfit: 1.5 });`,\n  },\n  {\n    id: 'custom_blank',\n    name: 'Script Vacío',\n    description: 'Empieza desde cero — escribe tu propia estrategia',\n    difficulty: 'Cualquiera',\n    code: `// Mi Estrategia Personalizada\n// ─────────────────────────────\n// Funciones disponibles:\n//   ema(periodo), sma(periodo), rsi(periodo)\n//   macd(fast, slow, signal), bb(periodo, stdDev), vwap()\n//   crossover(a, b), crossunder(a, b)\n//   highest(indicador, periodo), lowest(indicador, periodo)\n//   avg(indicador, periodo), change(indicador, periodos)\n//   percentChange(indicador, periodos)\n//\n// Variables: close, open, high, low, volume, price\n// Acciones: buy(), sell(), config({ stopLoss, takeProfit })\n//           log(\"mensaje\"), alert(\"alerta\")\n//\n// Tip: Pídele a ChatGPT que te genere una estrategia\n//      usando estas funciones!\n\n// Escribe tu estrategia aquí:\n\n\nconfig({ stopLoss: 2, takeProfit: 4 });`,\n  },\n];\n\n// ─── ChatGPT Prompt Generator ───\nexport const CHATGPT_PROMPT = `Eres un experto creando estrategias de trading para Kairos Script. Genera código usando SOLO estas funciones:\n\nINDICADORES (retornan valores numéricos):\n- ema(periodo) — Media Móvil Exponencial\n- sma(periodo) — Media Móvil Simple\n- rsi(periodo) — Índice de Fuerza Relativa (0-100)\n- macd(fast, slow, signal) — retorna { line, signal, histogram }\n- bb(periodo, stdDev) — retorna { upper, middle, lower }\n- vwap() — Volume Weighted Average Price\n\nDATOS:\n- close, open, high, low, volume — valores actuales\n- price — precio actual (número)\n\nDETECCIÓN DE CRUCES:\n- crossover(a, b) — true si A cruza arriba de B\n- crossunder(a, b) — true si A cruza abajo de B\n\nUTILIDADES:\n- highest(indicador, periodo) — valor más alto en N períodos\n- lowest(indicador, periodo) — valor más bajo en N períodos\n- avg(indicador, periodo) — promedio en N períodos\n- change(indicador, periodos) — cambio absoluto\n- percentChange(indicador, periodos) — cambio porcentual\n\nACCIONES:\n- buy() — señal de compra\n- sell() — señal de venta\n- config({ stopLoss: %, takeProfit: % }) — configurar SL/TP\n- log(\"mensaje\") — registrar mensaje\n\nREGLAS:\n1. NO uses window, document, fetch, eval, require, import\n2. Solo JavaScript simple (if/else, const/let, operadores)\n3. El código se ejecuta en cada vela nueva\n4. Siempre incluye config() con stopLoss y takeProfit\n5. Las comparaciones con indicadores funcionan directamente (ej: rsi(14) < 30)\n\nGenera SOLO el código, sin explicaciones fuera del código. Usa comentarios en español.`;\n\nexport default { executeScript, validateScript, backtestScript, SCRIPT_TEMPLATES, CHATGPT_PROMPT };\n"],"names":["Indicator","series","v","n","d","buildContext","candles","closes","c","opens","highs","lows","volumes","len","signal","scriptConfig","logs","ema","period","calculateEMA","sma","calculateSMA","rsi","calculateRSI","macd","fast","slow","sig","result","calculateMACD","bb","stdDev","calculateBollingerBands","vwap","calculateVWAP","crossover","a","b","seriesA","seriesB","i","crossunder","buy","opts","sell","config","log","msg","alert","close","open","high","low","volume","price","barIndex","ind","slice","s","curr","prev","executeScript","code","sandbox","getSignal","getConfig","getLogs","blockedGlobals","argNames","argValues","err","validateScript","dangerous","pattern","backtestScript","initialBalance","riskPercent","balance","position","trades","equityCurve","minBars","currentPrice","stopLoss","_a","takeProfit","_b","pnlPercent","rawPnl","fee","feeService","pnl","quantity","unrealizedPnl","lastPrice","wins","t","losses","totalPnl","maxDrawdown","calculateMaxDrawdown","equity","peak","maxDD","val","dd","SCRIPT_TEMPLATES","CHATGPT_PROMPT"],"mappings":"wHAQA,MAAMA,CAAU,CACd,YAAYC,EAAQ,CAClB,KAAK,QAAUA,EAAO,IAAIC,GAAKA,GAAK,CAAC,EACrC,KAAK,OAAS,KAAK,QAAQ,KAAK,QAAQ,OAAS,CAAC,GAAK,CACzD,CACA,SAAU,CAAE,OAAO,KAAK,MAAQ,CAChC,UAAW,CAAE,OAAO,OAAO,KAAK,MAAM,CAAG,CACzC,IAAI,OAAQ,CAAE,OAAO,KAAK,MAAQ,CAClC,IAAI,QAAS,CAAE,OAAO,KAAK,OAAS,CACpC,KAAKC,EAAI,EAAG,CAAE,OAAO,KAAK,QAAQ,KAAK,QAAQ,OAAS,EAAIA,CAAC,GAAK,CAAG,CACrE,QAAQC,EAAG,CAAE,OAAO,KAAK,OAAO,QAAQA,CAAC,CAAG,CAC9C,CAGA,SAASC,EAAaC,EAAS,CAC7B,MAAMC,EAASD,EAAQ,IAAIE,GAAKA,EAAE,KAAK,EACjCC,EAAQH,EAAQ,IAAIE,GAAKA,EAAE,IAAI,EAC/BE,EAAQJ,EAAQ,IAAIE,GAAKA,EAAE,IAAI,EAC/BG,EAAOL,EAAQ,IAAIE,GAAKA,EAAE,GAAG,EAC7BI,EAAUN,EAAQ,IAAIE,GAAKA,EAAE,MAAM,EACnCK,EAAMN,EAAO,OAGnB,IAAIO,EAAS,KACTC,EAAe,CAAE,SAAU,EAAG,WAAY,CAAC,EAC/C,MAAMC,EAAO,CAAA,EAGPC,EAAM,CAACC,EAAS,KAAO,IAAIlB,EAAUmB,EAAaZ,EAAQW,CAAM,CAAC,EACjEE,EAAM,CAACF,EAAS,KAAO,IAAIlB,EAAUqB,EAAad,EAAQW,CAAM,CAAC,EACjEI,EAAM,CAACJ,EAAS,KAAO,IAAIlB,EAAUuB,EAAahB,EAAQW,CAAM,CAAC,EAEjEM,EAAO,CAACC,EAAO,GAAIC,EAAO,GAAIC,EAAM,IAAM,CAC9C,MAAMC,EAASC,EAActB,EAAQkB,EAAMC,EAAMC,CAAG,EACpD,MAAO,CACL,KAAM,IAAI3B,EAAU4B,EAAO,IAAI,EAC/B,OAAQ,IAAI5B,EAAU4B,EAAO,MAAM,EACnC,UAAW,IAAI5B,EAAU4B,EAAO,SAAS,EACzC,SAAU,CAAE,OAAOA,EAAO,UAAUf,EAAM,CAAC,GAAK,CAAG,CACzD,CACE,EAEMiB,EAAK,CAACZ,EAAS,GAAIa,EAAS,IAAM,CACtC,MAAMH,EAASI,EAAwBzB,EAAQW,EAAQa,CAAM,EAC7D,MAAO,CACL,MAAO,IAAI/B,EAAU4B,EAAO,KAAK,EACjC,OAAQ,IAAI5B,EAAU4B,EAAO,MAAM,EACnC,MAAO,IAAI5B,EAAU4B,EAAO,KAAK,CACvC,CACE,EAEMK,EAAO,IAAM,IAAIjC,EAAUkC,EAAc5B,CAAO,CAAC,EAGjD6B,EAAY,CAACC,EAAGC,IAAM,CAE1B,MAAMC,EAAUF,aAAapC,EAAYoC,EAAE,OAAU,OAAOA,GAAM,SAAW,CAACA,EAAGA,CAAC,EAAI,CAAA,EAChFG,EAAUF,aAAarC,EAAYqC,EAAE,OAAU,OAAOA,GAAM,SAAW,CAACA,EAAGA,CAAC,EAAI,CAAA,EACtF,GAAIC,EAAQ,OAAS,GAAKC,EAAQ,OAAS,EAAG,MAAO,GACrD,MAAMC,EAAI,KAAK,IAAIF,EAAQ,OAAQC,EAAQ,MAAM,EAAI,EACrD,OAAOD,EAAQE,EAAI,CAAC,GAAKD,EAAQC,EAAI,CAAC,GAAKF,EAAQE,CAAC,EAAID,EAAQC,CAAC,CACnE,EAEMC,EAAa,CAACL,EAAGC,IAAM,CAC3B,MAAMC,EAAUF,aAAapC,EAAYoC,EAAE,OAAU,OAAOA,GAAM,SAAW,CAACA,EAAGA,CAAC,EAAI,CAAA,EAChFG,EAAUF,aAAarC,EAAYqC,EAAE,OAAU,OAAOA,GAAM,SAAW,CAACA,EAAGA,CAAC,EAAI,CAAA,EACtF,GAAIC,EAAQ,OAAS,GAAKC,EAAQ,OAAS,EAAG,MAAO,GACrD,MAAMC,EAAI,KAAK,IAAIF,EAAQ,OAAQC,EAAQ,MAAM,EAAI,EACrD,OAAOD,EAAQE,EAAI,CAAC,GAAKD,EAAQC,EAAI,CAAC,GAAKF,EAAQE,CAAC,EAAID,EAAQC,CAAC,CACnE,EAGME,EAAM,CAACC,EAAO,KAAO,CACzB7B,EAAS,CAAE,KAAM,MAAO,GAAG6B,CAAI,CACjC,EAEMC,EAAO,CAACD,EAAO,KAAO,CAC1B7B,EAAS,CAAE,KAAM,OAAQ,GAAG6B,CAAI,CAClC,EAEME,EAAS,CAACF,EAAO,KAAO,CAC5B,OAAO,OAAO5B,EAAc4B,CAAI,CAClC,EAEMG,EAAOC,GAAQ,CACnB/B,EAAK,KAAK,OAAO+B,CAAG,CAAC,CACvB,EAEMC,EAASD,GAAQ,CACrB/B,EAAK,KAAK,MAAM,OAAO+B,CAAG,CAAC,EAAE,CAC/B,EAGME,EAAQ,IAAIjD,EAAUO,CAAM,EAC5B2C,EAAO,IAAIlD,EAAUS,CAAK,EAC1B0C,EAAO,IAAInD,EAAUU,CAAK,EAC1B0C,EAAM,IAAIpD,EAAUW,CAAI,EACxB0C,EAAS,IAAIrD,EAAUY,CAAO,EAC9B0C,EAAQ/C,EAAOM,EAAM,CAAC,GAAK,EAC3B0C,EAAW1C,EAAM,EAqDvB,MAAO,CAAE,QAjBO,CAEd,IAAAI,EAAK,IAAAG,EAAK,IAAAE,EAAK,KAAAE,EAAM,GAAAM,EAAI,KAAAG,EAEzB,MAAAgB,EAAO,KAAAC,EAAM,KAAAC,EAAM,IAAAC,EAAK,OAAAC,EAAQ,MAAAC,EAAO,SAAAC,EAEvC,UAAApB,EAAW,WAAAM,EAEX,IAAAC,EAAK,KAAAE,EAAM,OAAAC,EAAQ,IAAAC,EAAK,MAAAE,EAExB,QA3Cc,CAACQ,EAAKtC,IAAW,CAE/B,MAAMuC,GADID,aAAexD,EAAYwD,EAAI,OAASjD,GAClC,MAAM,CAACW,CAAM,EAC7B,OAAO,KAAK,IAAI,GAAGuC,EAAM,OAAOvD,GAAKA,GAAK,IAAI,CAAC,CACjD,EAuCW,OArCI,CAACsD,EAAKtC,IAAW,CAE9B,MAAMuC,GADID,aAAexD,EAAYwD,EAAI,OAASjD,GAClC,MAAM,CAACW,CAAM,EAC7B,OAAO,KAAK,IAAI,GAAGuC,EAAM,OAAOvD,GAAKA,GAAK,IAAI,CAAC,CACjD,EAiCmB,IA/BP,CAACsD,EAAKtC,IAAW,CAE3B,MAAMuC,GADID,aAAexD,EAAYwD,EAAI,OAASjD,GAClC,MAAM,CAACW,CAAM,EAAE,OAAOhB,GAAKA,GAAK,IAAI,EACpD,OAAOuD,EAAM,OAAO,CAACrB,EAAGC,IAAMD,EAAIC,EAAG,CAAC,GAAKoB,EAAM,QAAU,EAC7D,EA2BwB,OAzBT,CAACD,EAAKtC,EAAS,IAAM,CAClC,MAAMwC,EAAIF,aAAexD,EAAYwD,EAAI,OAASjD,EAC5CoD,EAAOD,EAAEA,EAAE,OAAS,CAAC,GAAK,EAC1BE,EAAOF,EAAEA,EAAE,OAAS,EAAIxC,CAAM,GAAK,EACzC,OAAOyC,EAAOC,CAChB,EAoBgC,cAlBV,CAACJ,EAAKtC,EAAS,IAAM,CACzC,MAAMwC,EAAIF,aAAexD,EAAYwD,EAAI,OAASjD,EAC5CoD,EAAOD,EAAEA,EAAE,OAAS,CAAC,GAAK,EAC1BE,EAAOF,EAAEA,EAAE,OAAS,EAAIxC,CAAM,GAAK,EACzC,OAAO0C,IAAS,GAAMD,EAAOC,GAAQA,EAAQ,IAAM,CACrD,EAeE,KAAM,OAAQ,SAAU,WACxB,MAAO,QAEX,EAEoB,UAAW,IAAM9C,EAAQ,UAAW,IAAMC,EAAc,QAAS,IAAMC,CAAI,CAC/F,CAGO,SAAS6C,EAAcC,EAAMxD,EAAS,CAC3C,GAAI,CAACwD,GAAQ,CAACxD,GAAWA,EAAQ,OAAS,EACxC,MAAO,CAAE,OAAQ,KAAM,OAAQ,CAAE,SAAU,EAAG,WAAY,CAAC,EAAI,KAAM,CAAC,0BAA0B,CAAC,EAGnG,KAAM,CAAE,QAAAyD,EAAS,UAAAC,EAAW,UAAAC,EAAW,QAAAC,CAAO,EAAK7D,EAAaC,CAAO,EAEvE,GAAI,CAEF,MAAM6D,EAAiB,CACrB,SAAU,WAAY,aAAc,OACpC,QAAS,iBAAkB,YAC3B,OAAQ,WAAY,aAAc,cAClC,gBAAiB,eAAgB,iBACjC,YAAa,SAAU,YAAa,WACpC,UAAW,UAAW,UAAW,SAAU,UAC3C,YAAa,YACnB,EAEUC,EAAW,CAAC,GAAG,OAAO,KAAKL,CAAO,EAAG,GAAGI,CAAc,EACtDE,EAAY,CAChB,GAAG,OAAO,OAAON,CAAO,EACxB,GAAGI,EAAe,IAAI,IAAA,EAAe,CAC3C,EAGI,OADW,IAAI,SAAS,GAAGC,EAAUN,CAAI,EACtC,GAAGO,CAAS,EAER,CACL,OAAQL,EAAS,EACjB,OAAQC,EAAS,EACjB,KAAMC,EAAO,EACb,MAAO,IACb,CACE,OAASI,EAAK,CACZ,MAAO,CACL,OAAQ,KACR,OAAQL,EAAS,EACjB,KAAM,CAAC,GAAGC,EAAO,EAAI,YAAYI,EAAI,OAAO,EAAE,EAC9C,MAAOA,EAAI,OACjB,CACE,CACF,CAGO,SAASC,GAAeT,EAAM,CACnC,GAAI,CAACA,GAAQ,CAACA,EAAK,KAAI,EAAI,MAAO,CAAE,MAAO,GAAO,MAAO,sBAAsB,EAE/E,GAAI,CAEF,MAAMU,EAAY,CAChB,cACA,kBACA,gBACA,iBACA,eACA,qBACA,gBACA,aACA,eACA,cACA,gBACA,qBACA,eACN,EAEI,UAAWC,KAAWD,EACpB,GAAIC,EAAQ,KAAKX,CAAI,EACnB,MAAO,CAAE,MAAO,GAAO,MAAO,wBAAwBW,EAAQ,MAAM,EAAE,EAK1E,WAAI,SAASX,CAAI,EACV,CAAE,MAAO,GAAM,MAAO,IAAI,CACnC,OAASQ,EAAK,CACZ,MAAO,CAAE,MAAO,GAAO,MAAO,sBAAsBA,EAAI,OAAO,EAAE,CACnE,CACF,CAGO,SAASI,GAAeZ,EAAMxD,EAASuC,EAAS,CAAA,EAAI,SACzD,KAAM,CAAE,eAAA8B,EAAiB,IAAM,YAAAC,EAAc,CAAC,EAAK/B,EACnD,IAAIgC,EAAUF,EACVG,EAAW,KACf,MAAMC,EAAS,CAAA,EACTC,EAAc,CAACL,CAAc,EAC7B3D,EAAO,CAAA,EAGPiE,EAAU,GAChB,GAAI3E,EAAQ,OAAS2E,EACnB,MAAO,CAAE,OAAQ,GAAI,YAAa,CAACN,CAAc,EAAG,aAAcA,EAAgB,KAAM,CAAC,gCAAgC,CAAC,EAI5H,QAASnC,EAAIyC,EAASzC,EAAIlC,EAAQ,OAAQkC,IAAK,CAC7C,MAAMiB,EAAQnD,EAAQ,MAAM,EAAGkC,EAAI,CAAC,EAC9B0C,EAAezB,EAAMA,EAAM,OAAS,CAAC,EAAE,MAEvC7B,EAASiC,EAAcC,EAAML,CAAK,EAExC,GAAI7B,EAAO,MAAO,CAChBZ,EAAK,KAAK,OAAOwB,CAAC,KAAKZ,EAAO,KAAK,EAAE,EACrC,QACF,CAEA,MAAMuD,IAAWC,EAAAxD,EAAO,SAAP,YAAAwD,EAAe,WAAY,EACtCC,IAAaC,EAAA1D,EAAO,SAAP,YAAA0D,EAAe,aAAc,EAGhD,GAAIR,EAAU,CACZ,MAAMS,EAAaT,EAAS,OAAS,OAC/BI,EAAeJ,EAAS,YAAcA,EAAS,WAAc,KAC7DA,EAAS,WAAaI,GAAgBJ,EAAS,WAAc,IAEnE,GAAIS,GAAc,CAACJ,GAAYI,GAAcF,EAAY,CACvD,MAAMG,EAASV,EAAS,UAAYI,EAAeJ,EAAS,aAAeA,EAAS,OAAS,MAAQ,EAAI,IACnGW,EAAMC,EAAW,aAAaR,EAAcJ,EAAS,QAAQ,EAC7Da,EAAMH,EAASC,EACrBZ,GAAWc,EACXZ,EAAO,KAAK,CACV,GAAGD,EACH,UAAWI,EACX,QAAS1C,EACT,IAAAmD,EACA,WAAAJ,EACA,OAAQA,GAAcF,EAAa,cAAgB,WAC7D,CAAS,EACDP,EAAW,IACb,CACF,CAGA,GAAIlD,EAAO,QACT,GAAIA,EAAO,OAAO,OAAS,OAAS,CAACkD,EAAU,CAC7C,MAAMc,EAAYf,GAAWD,EAAc,KAAQM,EACnDJ,EAAW,CACT,KAAM,MACN,WAAYI,EACZ,SAAAU,EACA,SAAUpD,CACpB,CACM,SAAWZ,EAAO,OAAO,OAAS,SAAUkD,GAAA,YAAAA,EAAU,QAAS,MAAO,CACpE,MAAMU,EAASV,EAAS,UAAYI,EAAeJ,EAAS,YACtDW,EAAMC,EAAW,aAAaR,EAAcJ,EAAS,QAAQ,EAC7Da,EAAMH,EAASC,EACrBZ,GAAWc,EACX,MAAMJ,GAAeL,EAAeJ,EAAS,YAAcA,EAAS,WAAc,IAClFC,EAAO,KAAK,CACV,GAAGD,EACH,UAAWI,EACX,QAAS1C,EACT,IAAAmD,EACA,WAAAJ,EACA,OAAQ,QAClB,CAAS,EACDT,EAAW,IACb,SAAWlD,EAAO,OAAO,OAAS,QAAU,CAACkD,EAAU,CACrD,MAAMc,EAAYf,GAAWD,EAAc,KAAQM,EACnDJ,EAAW,CACT,KAAM,OACN,WAAYI,EACZ,SAAAU,EACA,SAAUpD,CACpB,CACM,SAAWZ,EAAO,OAAO,OAAS,QAASkD,GAAA,YAAAA,EAAU,QAAS,OAAQ,CACpE,MAAMU,EAASV,EAAS,UAAYA,EAAS,WAAaI,GACpDO,EAAMC,EAAW,aAAaR,EAAcJ,EAAS,QAAQ,EAC7Da,EAAMH,EAASC,EACrBZ,GAAWc,EACX,MAAMJ,GAAeT,EAAS,WAAaI,GAAgBJ,EAAS,WAAc,IAClFC,EAAO,KAAK,CACV,GAAGD,EACH,UAAWI,EACX,QAAS1C,EACT,IAAAmD,EACA,WAAAJ,EACA,OAAQ,QAClB,CAAS,EACDT,EAAW,IACb,EAIF,MAAMe,EAAgBf,EAClBA,EAAS,UACPA,EAAS,OAAS,MACbI,EAAeJ,EAAS,WACxBA,EAAS,WAAaI,GAE7B,EACJF,EAAY,KAAKH,EAAUgB,CAAa,CAC1C,CAGA,GAAIf,EAAU,CACZ,MAAMgB,EAAYxF,EAAQA,EAAQ,OAAS,CAAC,EAAE,MACxCkF,EAASV,EAAS,UACtBA,EAAS,OAAS,MACbgB,EAAYhB,EAAS,WACrBA,EAAS,WAAagB,GAEvBL,EAAMC,EAAW,aAAaI,EAAWhB,EAAS,QAAQ,EAC1Da,EAAMH,EAASC,EACrBZ,GAAWc,EACXZ,EAAO,KAAK,CACV,GAAGD,EACH,UAAWgB,EACX,QAASxF,EAAQ,OAAS,EAC1B,IAAAqF,EACA,WAAcA,EAAMb,EAAS,WAAcA,EAAS,SAAY,IAChE,OAAQ,aACd,CAAK,CACH,CAEA,MAAMiB,EAAOhB,EAAO,OAAOiB,GAAKA,EAAE,IAAM,CAAC,EAAE,OACrCC,EAASlB,EAAO,OAAOiB,GAAKA,EAAE,KAAO,CAAC,EAAE,OACxCE,EAAWnB,EAAO,OAAO,CAAC,EAAGiB,IAAM,EAAIA,EAAE,IAAK,CAAC,EAC/CG,EAAcC,EAAqBpB,CAAW,EAEpD,MAAO,CACL,OAAAD,EACA,YAAAC,EACA,aAAcH,EACd,YAAaE,EAAO,OACpB,KAAAgB,EACA,OAAAE,EACA,QAASlB,EAAO,OAAS,EAAKgB,EAAOhB,EAAO,OAAU,IAAM,EAC5D,SAAAmB,EACA,YAAAC,EACA,aAAcF,EAAS,EAAKlB,EAAO,OAAOiB,GAAKA,EAAE,IAAM,CAAC,EAAE,OAAO,CAAC,EAAGA,IAAM,EAAIA,EAAE,IAAK,CAAC,EAAI,KAAK,IAAIjB,EAAO,OAAOiB,GAAKA,EAAE,KAAO,CAAC,EAAE,OAAO,CAAC,EAAGA,IAAM,EAAIA,EAAE,IAAK,CAAC,GAAK,CAAC,EAAKD,EAAO,EAAI,IAAW,EACjM,KAAA/E,CACJ,CACA,CAEA,SAASoF,EAAqBC,EAAQ,CACpC,IAAIC,EAAOD,EAAO,CAAC,EACfE,EAAQ,EACZ,UAAWC,KAAOH,EAAQ,CACpBG,EAAMF,IAAMA,EAAOE,GACvB,MAAMC,GAAOH,EAAOE,GAAOF,EAAQ,IAC/BG,EAAKF,IAAOA,EAAQE,EAC1B,CACA,OAAOF,CACT,CAGY,MAACG,GAAmB,CAC9B,CACE,GAAI,YACJ,KAAM,gBACN,YAAa,6EACb,WAAY,eACZ,KAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wCAgBV,EACE,CACE,GAAI,eACJ,KAAM,eACN,YAAa,mEACb,WAAY,eACZ,KAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0CAeV,EACE,CACE,GAAI,gBACJ,KAAM,gBACN,YAAa,+CACb,WAAY,aACZ,KAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wCAeV,EACE,CACE,GAAI,aACJ,KAAM,0BACN,YAAa,uEACb,WAAY,aACZ,KAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0CAiBV,EACE,CACE,GAAI,sBACJ,KAAM,sBACN,YAAa,qEACb,WAAY,WACZ,KAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0CAsBV,EACE,CACE,GAAI,eACJ,KAAM,eACN,YAAa,2DACb,WAAY,WACZ,KAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,4CAqBV,EACE,CACE,GAAI,eACJ,KAAM,eACN,YAAa,oDACb,WAAY,aACZ,KAAM;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wCAqBV,CACA,EAGaC,GAAiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;"}