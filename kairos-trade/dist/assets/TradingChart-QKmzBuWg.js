import{a as c,j as l,a8 as Q,T as q}from"./ui-CUucduZ3.js";import{V as _,a as G,I as J}from"./charts-UjLl1g-4.js";import{u as K,b as F,c as j,P as X,T as Y}from"./index-BhWCJaKV.js";import{c as z,a as Z,b as ee}from"./indicators-DJQYQkcq.js";import{m as B}from"./marketData-BLmQAKAn.js";import"./vendor-B3xyLMQT.js";function oe(){const E=c.useRef(null),u=c.useRef(null),f=c.useRef(null),p=c.useRef(null),x=c.useRef([]),g=c.useRef(null),{selectedPair:h,selectedTimeframe:y,setSelectedPair:W,setSelectedTimeframe:O,setCurrentPrice:N,setPriceChange24h:k}=K(),[D,b]=c.useState(!0),[S,v]=c.useState(null),[R,V]=c.useState(!1),[L,A]=c.useState(""),[C,U]=c.useState(["ema20"]);c.useEffect(()=>{const e=E.current;if(!e)return;let n=!1;const r=[];let s=null;const o=e.getBoundingClientRect(),i=o.width||e.clientWidth||800,t=o.height||e.clientHeight||500,a=_(e,{width:i,height:t,layout:{background:{type:J.Solid,color:"#0B0E11"},textColor:"#848E9C",fontFamily:"Inter, sans-serif",fontSize:11},grid:{vertLines:{color:"#1E222D"},horzLines:{color:"#1E222D"}},crosshair:{mode:G.Normal,vertLine:{color:"#3B82F6",width:1,style:2,labelBackgroundColor:"#3B82F6"},horzLine:{color:"#3B82F6",width:1,style:2,labelBackgroundColor:"#3B82F6"}},timeScale:{borderColor:"#1E222D",timeVisible:!0,secondsVisible:!1,rightOffset:5,barSpacing:8},rightPriceScale:{borderColor:"#1E222D",scaleMargins:{top:.05,bottom:.2}},handleScroll:{mouseWheel:!0,pressedMouseMove:!0},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}}),d=a.addCandlestickSeries({upColor:"#0ECB81",downColor:"#F6465D",borderUpColor:"#0ECB81",borderDownColor:"#F6465D",wickUpColor:"#0ECB81",wickDownColor:"#F6465D"}),H=a.addHistogramSeries({color:"#3B82F622",priceFormat:{type:"volume"},priceScaleId:"volume"});a.priceScale("volume").applyOptions({scaleMargins:{top:.8,bottom:0}}),u.current=a,f.current=d,p.current=H;const w=()=>{if(!n)try{const m=e.getBoundingClientRect();m.width>0&&m.height>0&&a.applyOptions({width:m.width,height:m.height})}catch{}};s=requestAnimationFrame(w),r.push(setTimeout(w,100)),r.push(setTimeout(w,300));const P=new ResizeObserver(m=>{if(n||!m||!m[0])return;const{width:I,height:T}=m[0].contentRect;if(I>0&&T>0)try{a.applyOptions({width:I,height:T})}catch{}});return P.observe(e),()=>{n=!0,r.forEach(clearTimeout),s&&cancelAnimationFrame(s),P.disconnect();try{a.remove()}catch{}u.current=null,f.current=null,p.current=null}},[]),c.useEffect(()=>{let e=!1;return(async()=>{b(!0),v(null);try{const r=F(h),[s,o]=await Promise.all([B.getCandles(r,y,500),B.get24hrTicker(r)]);if(e)return;if(!s||s.length===0){v("No se recibieron datos de Binance"),b(!1);return}const i=s.filter(t=>t&&t.time&&isFinite(t.open)&&isFinite(t.high)&&isFinite(t.low)&&isFinite(t.close));if(i.length===0){v("Sin datos vÃ¡lidos"),b(!1);return}if(f.current)try{f.current.setData(i)}catch{}if(p.current)try{p.current.setData(i.map(t=>({time:t.time,value:t.volume||0,color:t.close>=t.open?"rgba(14,203,129,0.2)":"rgba(246,70,93,0.2)"})))}catch{}N(o.price),k(o.changePercent);try{M(i)}catch(t){console.warn("Indicator error (non-fatal):",t)}if(u.current)try{u.current.timeScale().fitContent()}catch{}}catch(r){console.error("Chart data load error:",r),e||v(`Error cargando datos: ${r.message}`)}e||b(!1)})(),g.current&&g.current(),g.current=B.connectStream(F(h),{onTicker:r=>{N(r.price),k(r.changePercent)},onCandle:r=>{try{f.current&&f.current.update(r),p.current&&p.current.update({time:r.time,value:r.volume||0,color:r.close>=r.open?"rgba(14,203,129,0.2)":"rgba(246,70,93,0.2)"})}catch{}}}),()=>{e=!0,g.current&&(g.current(),g.current=null)}},[h,y]);const M=e=>{if(!u.current)return;x.current.forEach(s=>{var o;try{(o=u.current)==null||o.removeSeries(s)}catch{}}),x.current=[];const n=e.map(s=>s.close),r=e.map(s=>s.time);C.forEach(s=>{try{if(s==="ema20"){const i=z(n,20).map((t,a)=>t!=null&&isFinite(t)?{time:r[a],value:t}:null).filter(Boolean);if(i.length>0){const t=u.current.addLineSeries({color:"#3B82F6",lineWidth:1.5,title:"EMA 20",lastValueVisible:!1,priceLineVisible:!1});t.setData(i),x.current.push(t)}}if(s==="ema50"){const i=z(n,50).map((t,a)=>t!=null&&isFinite(t)?{time:r[a],value:t}:null).filter(Boolean);if(i.length>0){const t=u.current.addLineSeries({color:"#8B5CF6",lineWidth:1.5,title:"EMA 50",lastValueVisible:!1,priceLineVisible:!1});t.setData(i),x.current.push(t)}}if(s==="sma200"){const i=Z(n,200).map((t,a)=>t!=null&&isFinite(t)?{time:r[a],value:t}:null).filter(Boolean);if(i.length>0){const t=u.current.addLineSeries({color:"#FF6D00",lineWidth:1,title:"SMA 200",lastValueVisible:!1,priceLineVisible:!1});t.setData(i),x.current.push(t)}}if(s==="bb"){const o=ee(n),i=o.upper.map((a,d)=>a!=null&&isFinite(a)?{time:r[d],value:a}:null).filter(Boolean),t=o.lower.map((a,d)=>a!=null&&isFinite(a)?{time:r[d],value:a}:null).filter(Boolean);if(i.length>0){const a=u.current.addLineSeries({color:"#9C27B0",lineWidth:1,lineStyle:2,title:"BB Upper",lastValueVisible:!1,priceLineVisible:!1}),d=u.current.addLineSeries({color:"#9C27B0",lineWidth:1,lineStyle:2,title:"BB Lower",lastValueVisible:!1,priceLineVisible:!1});a.setData(i),d.setData(t),x.current.push(a,d)}}}catch(o){console.warn(`Indicator ${s} error:`,o)}})};c.useEffect(()=>{if(!f.current)return;(async()=>{try{const n=await B.getCandles(F(h),y,500);M(n)}catch{}})()},[C]);const $=e=>{U(n=>n.includes(e)?n.filter(r=>r!==e):[...n,e])};return l.jsxs("div",{className:"flex flex-col w-full flex-1 min-h-0",children:[l.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 shrink-0 flex-wrap",style:{borderBottom:"1px solid var(--border)"},children:[l.jsxs("div",{className:"relative",children:[l.jsxs("button",{onClick:()=>V(!R),className:"flex items-center gap-1.5 px-3 py-1.5 bg-[var(--dark-3)] rounded-lg text-sm font-bold hover:bg-[var(--dark-4)] transition-colors",children:[l.jsx(Q,{size:13,className:"text-[var(--text-dim)]"}),j(h)]}),R&&l.jsxs("div",{className:"absolute top-full left-0 mt-1 w-64 bg-[var(--dark-3)] border border-[var(--border)] rounded-xl shadow-xl z-50 p-2",children:[l.jsx("input",{type:"text",value:L,onChange:e=>A(e.target.value.toUpperCase()),placeholder:"Buscar par...",className:"w-full text-sm mb-2",autoFocus:!0}),l.jsx("div",{className:"max-h-48 overflow-y-auto space-y-0.5",children:X.filter(e=>e.includes(L)).map(e=>l.jsx("button",{onClick:()=>{W(e),V(!1),A("")},className:`w-full text-left px-3 py-1.5 text-sm rounded-lg transition-colors
                        ${e===h?"bg-[var(--gold)]/15 text-[var(--gold)]":"text-[var(--text-dim)] hover:bg-[var(--dark-4)] hover:text-[var(--text)]"}`,children:j(e)},e))})]})]}),l.jsx("div",{className:"flex items-center gap-0.5 bg-[var(--dark-3)] rounded-lg p-0.5",children:Y.map(e=>l.jsx("button",{onClick:()=>O(e.value),className:`px-2.5 py-1 text-xs rounded-md transition-colors
                ${y===e.value?"bg-[var(--gold)] text-white font-bold":"text-[var(--text-dim)] hover:text-[var(--text)]"}`,children:e.label},e.value))}),l.jsxs("div",{className:"flex items-center gap-1 ml-auto",children:[l.jsx(q,{size:13,className:"text-[var(--text-dim)]"}),[{id:"ema20",label:"EMA 20",color:"#3B82F6"},{id:"ema50",label:"EMA 50",color:"#8B5CF6"},{id:"sma200",label:"SMA 200",color:"#FF6D00"},{id:"bb",label:"BB",color:"#9C27B0"}].map(e=>l.jsx("button",{onClick:()=>$(e.id),className:`px-2 py-0.5 text-[11px] rounded transition-all
                ${C.includes(e.id)?"font-semibold":"text-[var(--text-dim)] hover:text-[var(--text)]"}`,style:C.includes(e.id)?{color:e.color,background:`${e.color}15`}:{},children:e.label},e.id))]})]}),l.jsxs("div",{ref:E,className:"relative",style:{flex:"1 1 0%",minHeight:0,overflow:"hidden"},children:[D&&l.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-20",style:{background:"rgba(11,14,17,0.85)"},children:l.jsxs("div",{className:"flex flex-col items-center gap-2",children:[l.jsx("div",{className:"w-8 h-8 border-2 border-[var(--gold)] border-t-transparent rounded-full animate-spin"}),l.jsxs("span",{className:"text-xs text-[var(--text-dim)]",children:["Cargando ",j(h),"..."]})]})}),S&&!D&&l.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-20",style:{background:"rgba(11,14,17,0.9)"},children:l.jsxs("div",{className:"text-center",children:[l.jsx("p",{className:"text-sm text-[var(--red)] mb-2",children:typeof S=="string"?S:String(S)}),l.jsx("button",{onClick:()=>{v(null),b(!0)},className:"px-4 py-2 text-xs bg-[var(--gold)] text-white rounded-lg font-semibold",children:"Reintentar"})]})})]})]})}export{oe as default};
//# sourceMappingURL=TradingChart-QKmzBuWg.js.map
