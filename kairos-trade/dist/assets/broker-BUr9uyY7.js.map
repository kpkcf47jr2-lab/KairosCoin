{"version":3,"mappings":";8DAUA,MAAMA,EAAgB,CACpB,KAAM,KACN,UAAW,CACT,GAAO,yBACP,EAAO,qBACP,IAAO,6BACP,MAAO,8BACP,KAAO,yBACX,CACA,EAGMC,EAAmB,CACvB,KAAM,QACN,UAAW,CACT,GAAO,qCACP,EAAO,oCACP,IAAO,sCACP,MAAO,wCACP,KAAO,sCACX,CACA,EAGMC,EAAsB,CAC1B,KAAM,WACN,UAAW,CACT,GAAO,4BACP,EAAO,4BACP,IAAO,4BACP,MAAO,4BACP,KAAO,2BACX,CACA,EAMMC,EAAuB,6CACvBC,GAAiB,GAKjBC,EAAa,CACjB,iBAAkB,IAClB,mBAAoB,IACpB,YAAa,EACb,eAAgB,IAChB,iBAAkB,KAClB,0BAA2B,EAC3B,yBAA0B,KAC1B,eAAgB,IAChB,gBAAiB,EACnB,EAGMC,EAAgB,CACpB,KAAY,CAAE,SAAU,EAAG,SAAU,EAAG,KAAM,EAAK,EACnD,QAAY,CAAE,SAAU,EAAG,SAAU,EAAG,KAAM,EAAK,EACnD,SAAY,CAAE,SAAU,EAAG,SAAU,EAAG,KAAM,EAAK,CACrD,EAEA,SAASC,GAAeC,EAAS,CAC3BF,EAAcE,CAAO,IACvBF,EAAcE,CAAO,EAAE,SAAW,EAClCF,EAAcE,CAAO,EAAE,KAAO,GAElC,CAEA,SAASC,GAAeD,EAAS,CAC/B,MAAME,EAAQJ,EAAcE,CAAO,EAC9BE,IACLA,EAAM,WACNA,EAAM,SAAW,KAAK,IAAG,EACrBA,EAAM,UAAYL,EAAW,4BAC/BK,EAAM,KAAO,GACb,QAAQ,KAAK,qBAAqBF,CAAO,iBAAiBE,EAAM,QAAQ,wBAAwB,GAEpG,CAEA,SAASC,GAAeH,EAAS,CAC/B,MAAME,EAAQJ,EAAcE,CAAO,EACnC,MAAI,CAACE,GAAS,CAACA,EAAM,KAAa,GAE9B,KAAK,IAAG,EAAKA,EAAM,SAAWL,EAAW,0BAC3CK,EAAM,KAAO,GACbA,EAAM,SAAW,EACjB,QAAQ,IAAI,qBAAqBF,CAAO,mCAAmC,EACpE,IAEF,EACT,CAGA,SAASI,EAAkBC,EAAKC,EAASC,EAAW,CAClD,OAAO,QAAQ,KAAK,CAClB,MAAMF,EAAKC,CAAO,EAClB,IAAI,QAAQ,CAACE,EAAGC,IACd,WAAW,IAAMA,EAAO,IAAI,MAAM,iBAAiBF,CAAS,IAAI,CAAC,EAAGA,CAAS,CACnF,CACA,CAAG,CACH,CAGA,eAAeG,GAAWC,EAAIC,EAAYC,EAASC,EAAO,CACxD,IAAIC,EACJ,QAASC,EAAU,EAAGA,GAAWJ,EAAYI,IAC3C,GAAI,CACF,OAAO,MAAML,EAAE,CACjB,OAASM,EAAK,CACZF,EAAYE,EACRD,EAAUJ,IACZ,QAAQ,KAAK,WAAWE,CAAK,YAAYE,EAAU,CAAC,IAAIJ,CAAU,YAAYK,EAAI,OAAO,iBAAiBJ,CAAO,OAAO,EACxH,MAAM,IAAI,QAAQK,GAAK,WAAWA,EAAGL,CAAO,CAAC,EAEjD,CAEF,MAAME,CACR,CAGA,IAAII,GAAiB,aAErB,MAAMC,EAAe,CACnB,GAAI,CACF,KAAM,MACN,IAAK,CAAC,oCAAqC,oCAAqC,mCAAmC,EACnH,OAAQ,6CACR,QAAS,6CACT,QAAS,6CACT,QAAS,cACT,SAAU,sBACV,aAAc,KAClB,EACE,EAAG,CACD,KAAM,WACN,IAAK,CAAC,2BAA4B,0BAA0B,EAC5D,OAAQ,6CACR,QAAS,6CACT,QAAS,6CACT,QAAS,UACT,SAAU,uBACV,aAAc,KAClB,EACE,IAAK,CACH,KAAM,UACN,IAAK,CAAC,0BAA2B,8BAA8B,EAC/D,OAAQ,6CACR,QAAS,6CACT,QAAS,6CACT,QAAS,YACT,SAAU,0BACV,aAAc,OAClB,EACE,MAAO,CACL,KAAM,WACN,IAAK,CAAC,+BAAgC,+BAA+B,EACrE,OAAQ,6CACR,QAAS,6CACT,QAAS,6CACT,QAAS,YACT,SAAU,sBACV,aAAc,KAClB,EACE,MAAO,CACL,KAAM,YACN,IAAK,CAAC,wCAAyC,gCAAgC,EAC/E,OAAQ,6CACR,QAAS,6CACT,QAAS,6CACT,QAAS,aACT,SAAU,uBACV,aAAc,MAClB,EACE,KAAM,CACJ,KAAM,OACN,IAAK,CAAC,2BAA4B,2BAA2B,EAC7D,OAAQ,6CACR,QAAS,6CACT,QAAS,6CACT,QAAS,WACT,SAAU,uBACV,aAAc,KAClB,CACA,EAGMC,GAAkB,CACtB,GAAI,CACF,KAAM,6CACN,KAAM,6CACN,KAAM,6CACN,IAAK,6CACL,IAAK,6CACL,OAAQ,6CACR,IAAK,4CACT,EACE,EAAG,CACD,KAAM,6CACN,KAAM,6CACN,KAAM,4CACV,EACE,IAAK,CACH,KAAM,6CACN,KAAM,6CACN,OAAQ,6CACR,OAAQ,4CACZ,EACE,MAAO,CACL,KAAM,6CACN,KAAM,6CACN,OAAQ,6CACR,KAAM,4CACV,EACE,MAAO,CACL,KAAM,6CACN,KAAM,6CACN,MAAO,4CACX,EACE,KAAM,CACJ,KAAM,6CACN,KAAM,6CACN,OAAQ,4CACZ,CACA,EAGMC,EAAY,CAChB,qDACA,2CACA,0CACA,wCACA,4EACA,kEACF,EAEMC,GAAa,CACjB,sFACA,0IACA,gIACA,uIACA,8IACA,wCACF,EAGA,IAAIC,EAAY,KAChB,eAAeC,GAAY,CACzB,GAAID,EAAW,OAAOA,EACtB,GAAI,CACF,OAAAA,EAAY,MAAKE,EAAA,IAAC,OAAO,qBAAQ,kCAC1BF,CACT,MAAQ,CAEN,GAAI,OAAO,OACT,OAAAA,EAAY,OAAO,OACZA,EAET,MAAM,IAAI,MAAM,2DAA2D,CAC7E,CACF,CAEA,MAAMG,EAAoB,CACxB,aAAc,CACZ,KAAK,UAAY,GACjB,KAAK,QAAU,GACf,KAAK,cAAgBR,EACvB,CAMA,iBAAiBS,EAAM,CACrB,GAAI,CAAC,CAAC,aAAc,QAAQ,EAAE,SAASA,CAAI,EAAG,MAAM,IAAI,MAAM,4CAA4C,EAC1G,KAAK,cAAgBA,EACrBT,GAAiBS,EACjB,QAAQ,IAAI,6BAA6BA,IAAS,aAAe,6BAA+B,wBAAwB,EAAE,CAC5H,CAEA,kBAAmB,CACjB,OAAO,KAAK,aACd,CAMA,MAAM,oBAAoBC,EAASC,EAASC,EAAUC,EAAa,CAEjE,MAAMC,EAAc,CAClB,CAAE,GAAGzC,EAAe,OAAQ,UAAU,EACtC,CAAE,GAAGC,EAAkB,OAAQ,aAAa,EAC5C,CAAE,GAAGC,EAAqB,OAAQ,gBAAgB,CACxD,EAEoC,CAE9B,MAAMwC,EAAYD,EAAY,OAAOE,GAAK,CAAChC,GAAegC,EAAE,IAAI,GAAKA,EAAE,UAAUN,CAAO,CAAC,EACzF,GAAIK,EAAU,SAAW,EACvB,eAAQ,KAAK,kEAAkE,EACxE,KAwBT,MAAME,GArBU,MAAM,QAAQ,WAC5BF,EAAU,IAAIG,GACZ3B,GACE,IAAM,KAAK2B,EAAI,MAAM,EAAER,EAASC,EAASC,EAAUC,CAAW,EAC9DnC,EAAW,YACXA,EAAW,eACXwC,EAAI,IAChB,EAAY,KAAKC,GAAS,CACd,GAAIA,EACF,OAAAvC,GAAesC,EAAI,IAAI,EAChB,CAAE,GAAGC,EAAO,WAAYD,EAAI,IAAI,EAEzC,MAAM,IAAI,MAAM,aAAa,CAC/B,CAAC,EAAE,MAAMpB,GAAO,CACd,MAAAhB,GAAeoC,EAAI,IAAI,EACjBpB,CACR,CAAC,CACX,CACA,GAIS,OAAOC,GAAKA,EAAE,SAAW,WAAW,EACpC,IAAIA,GAAKA,EAAE,KAAK,EAChB,KAAK,CAACiB,EAAGI,IAAM,CACd,MAAMC,EAAO,OAAOL,EAAE,WAAa,GAAG,EAChCM,EAAO,OAAOF,EAAE,WAAa,GAAG,EACtC,OAAOE,EAAOD,EAAO,EAAIC,EAAOD,EAAO,GAAK,CAC9C,CAAC,EAEH,GAAIJ,EAAY,OAAS,EAAG,CAC1B,MAAMM,EAAON,EAAY,CAAC,EAC1B,eAAQ,IAAI,gCAAgCM,EAAK,UAAU,KAAKN,EAAY,MAAM,qBAAqB,EACnGA,EAAY,OAAS,GACvB,QAAQ,IAAI,0BAA0BA,EAAY,IAAIO,GAAK,GAAGA,EAAE,UAAU,IAAIA,EAAE,SAAS,EAAE,EAAE,KAAK,MAAM,CAAC,EAAE,EAEtGD,CACT,CAEA,eAAQ,KAAK,yCAAyC,EAC/C,IACT,CAyBF,CAGA,MAAM,SAASb,EAASC,EAASC,EAAUC,EAAa,CACtD,MAAMY,EAAWpD,EAAc,UAAUqC,CAAO,EAChD,GAAI,CAACe,EAAU,OAAO,KAEtB,MAAMC,EAAS,IAAI,gBAAgB,CACjC,UAAWf,EACX,SAAUC,EACV,WAAYC,EAAY,SAAQ,EAChC,mBAAoB,QACpB,aAAcrC,EACd,uBAAwBC,GAAiB,KAAO,SAAQ,EACxD,yBAA0B,MAChC,CAAK,EAEKkD,EAAW,MAAM1C,EACrB,GAAGwC,CAAQ,kBAAkBC,CAAM,GACnC,CAAE,QAAS,CAAE,aAAc,GAAI,EAC/BhD,EAAW,gBACjB,EAEI,GAAI,CAACiD,EAAS,GAAI,CAChB,MAAMC,EAAQ,MAAMD,EAAS,KAAI,EAAG,MAAM,KAAO,GAAG,EACpD,MAAM,IAAI,MAAM,oBAAoBA,EAAS,MAAM,OAAMC,GAAA,YAAAA,EAAO,SAAU,SAAS,EAAE,CACvF,CAEA,MAAMC,EAAO,MAAMF,EAAS,KAAI,EAC1BG,GAAWD,EAAK,SAAW,IAC9B,OAAOE,GAAK,WAAWA,EAAE,UAAU,EAAI,CAAC,EACxC,IAAIA,IAAM,CAAE,KAAMA,EAAE,KAAM,IAAK,KAAK,MAAM,WAAWA,EAAE,UAAU,EAAI,GAAG,CAAC,EAAG,EAC5E,KAAK,CAACf,EAAGI,IAAMA,EAAE,IAAMJ,EAAE,GAAG,EAE/B,MAAO,CACL,UAAWa,EAAK,UAChB,GAAIA,EAAK,GACT,KAAMA,EAAK,KACX,MAAOA,EAAK,OAAS,IACrB,YAAaA,EAAK,aAClB,gBAAiBA,EAAK,gBACtB,QAAAC,EACA,cAAeA,EAAQ,IAAIC,GAAK,GAAGA,EAAE,IAAI,IAAIA,EAAE,GAAG,GAAG,EAAE,KAAK,KAAK,GAAK,SACtE,MAAOF,EAAK,MACZ,gBAAiBA,EAAK,gBACtB,SAAU,KAAK,IAAG,CACxB,CACE,CAGA,MAAM,YAAYnB,EAASC,EAASC,EAAUC,EAAa,eACzD,MAAMY,EAAWnD,EAAiB,UAAUoC,CAAO,EACnD,GAAI,CAACe,EAAU,OAAO,KAEtB,MAAMC,EAAS,IAAI,gBAAgB,CACjC,IAAKf,EACL,IAAKC,EACL,OAAQC,EAAY,SAAQ,EAC5B,KAAMrC,EACN,SAAU,MACV,KAAMC,GAAiB,KAAK,SAAQ,EACpC,gBAAiBD,EACjB,gBAAiB,MACvB,CAAK,EAEKmD,EAAW,MAAM1C,EACrB,GAAGwC,CAAQ,SAASC,CAAM,GAC1B,CAAE,QAAS,CAAE,OAAU,mBAAoB,EAC3ChD,EAAW,gBACjB,EAEI,GAAI,CAACiD,EAAS,GACZ,MAAM,IAAI,MAAM,uBAAuBA,EAAS,MAAM,GAAG,EAG3D,MAAME,EAAO,MAAMF,EAAS,KAAI,EAEhC,MAAO,CACL,UAAWE,EAAK,WAAaA,EAAK,UAAY,IAC9C,KAAIG,EAAAH,EAAK,KAAL,YAAAG,EAAS,KAAMH,EAAK,GACxB,OAAMI,EAAAJ,EAAK,KAAL,YAAAI,EAAS,OAAQJ,EAAK,KAC5B,QAAOK,EAAAL,EAAK,KAAL,YAAAK,EAAS,QAAS,IACzB,cAAaC,EAAAN,EAAK,KAAL,YAAAM,EAAS,MAAON,EAAK,cAAgB,SAClD,kBAAiBO,EAAAP,EAAK,KAAL,YAAAO,EAAS,KAAMP,EAAK,GACrC,QAAS,CAAC,CAAE,KAAM,eAAgB,IAAK,GAAG,CAAE,EAC5C,cAAe,oBACf,MAAO,KACP,gBAAiB,KACjB,SAAU,KAAK,IAAG,CACxB,CACE,CAGA,MAAM,eAAenB,EAASC,EAASC,EAAUC,EAAa,eAC5D,MAAMY,EAAWlD,EAAoB,UAAUmC,CAAO,EACtD,GAAI,CAACe,EAAU,OAAO,KAGtB,MAAMY,EAAc,IAAI,gBAAgB,CACtC,SAAU1B,EACV,UAAWC,EACX,OAAQC,EAAY,SAAQ,EAC5B,YAAa,KACb,aAAc,KACd,KAAM,OACN,QAASH,EAAQ,SAAQ,EACzB,QAAS,SACT,QAAS,KACf,CAAK,EAEK4B,EAAY,MAAMrD,EACtB,GAAGwC,CAAQ,WAAWY,CAAW,GACjC,CAAE,QAAS,CAAE,OAAU,mBAAoB,EAC3C3D,EAAW,gBACjB,EAEI,GAAI,CAAC4D,EAAU,GACb,MAAM,IAAI,MAAM,0BAA0BA,EAAU,MAAM,GAAG,EAI/D,MAAMC,GADY,MAAMD,EAAU,KAAI,GACV,WAC5B,GAAI,CAACC,EAAW,MAAM,IAAI,MAAM,0BAA0B,EAE1D,MAAO,CACL,UAAWA,EAAU,YAAc,IACnC,GAAI,KACJ,KAAM,KACN,MAAO,IACP,YAAaA,EAAU,SAAW,SAClC,gBAAiBA,EAAU,mBAC3B,QAAS,CAAC,CAAE,KAAM,WAAY,IAAK,GAAG,CAAE,EACxC,cAAe,eAAaH,GAAAD,GAAAD,GAAAD,GAAAD,EAAAO,EAAU,YAAV,YAAAP,EAAsB,KAAtB,YAAAC,EAA0B,QAA1B,YAAAC,EAAkC,KAAlC,YAAAC,EAAsC,gBAAtC,YAAAC,EAAqD,IAAII,GAAKA,EAAE,UAAU,KAAK,OAAQ,OAAO,IAC1H,MAAO,KACP,gBAAiB,KACjB,WAAYD,EACZ,SAAU,KAAK,IAAG,EAClB,aAAc,EACpB,CACE,CAMA,MAAM,uBAAuBE,EAAQ/B,EAASC,EAASE,EAAaM,EAAO,CACzE,MAAMuB,EAAS,MAAMpC,EAAS,EACxBqC,EAAS1C,EAAaS,CAAO,EAC7BkC,EAAajC,EAAQ,YAAW,IAAOgC,EAAO,QAAQ,YAAW,EAGvE,IAAIE,EAAc1B,EAClB,GAAI,KAAK,IAAG,GAAMA,EAAM,UAAY,GAAKzC,EAAW,iBAAkB,CACpE,QAAQ,IAAI,4CAA4C,EACxD,MAAMoE,EAAa,MAAM,KAAK,oBAAoBpC,EAASC,EAASQ,EAAM,WAAaR,EAASE,CAAW,EACvGiC,GAAcA,EAAW,MAC3BD,EAAcC,EACd,QAAQ,IAAI,gCAAgC,GAE5C,QAAQ,KAAK,wDAAwD,CAEzE,CAGA,GAAID,EAAY,cAAgBA,EAAY,WAC1C,GAAI,CACF,MAAME,EAAS,MAAM9D,EACnB,GAAGV,EAAoB,UAAUmC,CAAO,CAAC,iBAAiBA,CAAO,GACjE,CACE,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAkB,EAC7C,KAAM,KAAK,UAAU,CACnB,SAAUC,EACV,UAAWkC,EAAY,UACvB,UAAWhC,EAAY,SAAQ,EAC/B,WAAYgC,EAAY,UACxB,WAAYA,EAAY,WACxB,YAAaJ,EAAO,QACpB,QAAS,QACvB,CAAa,CACb,EACU/D,EAAW,gBACrB,EACQ,GAAIqE,EAAO,GAAI,CACb,MAAMC,EAAS,MAAMD,EAAO,KAAI,EAChCF,EAAY,GAAKG,EAAO,GACxBH,EAAY,KAAOG,EAAO,KAC1BH,EAAY,MAAQG,EAAO,OAAS,IACpCH,EAAY,YAAcG,EAAO,KAAOH,EAAY,WACtD,KACE,OAAM,IAAI,MAAM,0BAA0B,CAE9C,OAAS/C,EAAK,CACZ,cAAQ,KAAK,8BAA+BA,EAAI,OAAO,EACjDA,CACR,CAGF,GAAI,CAAC+C,EAAY,IAAM,CAACA,EAAY,KAClC,MAAM,IAAI,MAAM,6BAA6B,EAI/C,GAAI,CAACD,GAAcC,EAAY,gBAAiB,CAC9C,MAAMI,EAAgB,IAAIP,EAAO,SAAS/B,EAASR,EAAWsC,CAAM,EAClD,MAAMQ,EAAc,UAAUR,EAAO,QAASI,EAAY,eAAe,EAC3E,OAAOhC,CAAW,IAChC,QAAQ,IAAI,oCAAoCgC,EAAY,aAAa,KAAK,EAE9E,MADkB,MAAMI,EAAc,QAAQJ,EAAY,gBAAiBH,EAAO,UAAU,GAC5E,KAAI,EACpB,QAAQ,IAAI,iCAAiC,EAEjD,CAGA,MAAMQ,EAAW,KAAK,KAAK,OAAOL,EAAY,aAAe,GAAM,EAAInE,EAAW,cAAc,EAC1FyE,EAAK,MAAMV,EAAO,gBAAgB,CACtC,GAAII,EAAY,GAChB,KAAMA,EAAY,KAClB,MAAOA,EAAY,MACnB,SAAAK,CACN,CAAK,EAED,QAAQ,IAAI,yBAAyBC,EAAG,IAAI,QAAQN,EAAY,aAAa,gBAAgBK,CAAQ,GAAG,EACxG,MAAME,EAAU,MAAMD,EAAG,KAAI,EAE7B,GAAIC,EAAQ,SAAW,EACrB,MAAM,IAAI,MAAM,yBAAyBD,EAAG,IAAI,EAAE,EAGpD,MAAO,CAAE,GAAAA,EAAI,QAAAC,EAAS,QAASP,EAAY,QAAS,cAAeA,EAAY,cAAe,WAAYA,EAAY,UAAU,CAClI,CAGA,MAAM,aAAanC,EAAS,CAC1B,GAAI,KAAK,UAAUA,CAAO,EAAG,OAAO,KAAK,UAAUA,CAAO,EAC1D,MAAMgC,EAAS,MAAMpC,EAAS,EACxBqC,EAAS1C,EAAaS,CAAO,EACnC,GAAI,CAACiC,EAAQ,MAAM,IAAI,MAAM,sBAAsBjC,CAAO,EAAE,EAG5D,UAAW2C,KAAOV,EAAO,IACvB,GAAI,CACF,MAAMW,EAAW,IAAIZ,EAAO,gBAAgBW,EAAK3C,CAAO,EACxD,aAAM4C,EAAS,iBACf,KAAK,UAAU5C,CAAO,EAAI4C,EACnBA,CACT,MAAQ,CACN,QACF,CAEF,MAAM,IAAI,MAAM,wBAAwBX,EAAO,IAAI,MAAM,CAC3D,CAGA,MAAM,WAAWY,EAAY7C,EAAS,CACpC,MAAM8C,EAAM,GAAG9C,CAAO,IAAI6C,EAAW,MAAM,EAAE,CAAC,GAC9C,GAAI,KAAK,QAAQC,CAAG,EAAG,OAAO,KAAK,QAAQA,CAAG,EAC9C,MAAMd,EAAS,MAAMpC,EAAS,EACxBgD,EAAW,MAAM,KAAK,aAAa5C,CAAO,EAC1C+B,EAAS,IAAIC,EAAO,OAAOa,EAAYD,CAAQ,EACrD,YAAK,QAAQE,CAAG,EAAIf,EACbA,CACT,CAGA,cAAcgB,EAAiB/C,EAAS,CACtC,GAAI+C,GAAA,MAAAA,EAAiB,WAAW,OAASA,EAAgB,SAAW,GAAI,OAAOA,EAC/E,MAAMC,EAASxD,GAAgBQ,CAAO,GAAK,GACrCiD,GAASF,GAAmB,IAAI,YAAW,EAE3CG,EAAUD,EAAM,QAAQ,SAAU,EAAE,EAAE,QAAQ,OAAQ,EAAE,EAAE,QAAQ,OAAQ,EAAE,EAClF,OAAOD,EAAOC,CAAK,GAAKD,EAAOE,CAAO,GAAK,IAC7C,CAGA,MAAM,QAAQC,EAAeN,EAAY7C,EAAU,GAAI,CACrD,GAAI,CACF,MAAMgC,EAAS,MAAMpC,EAAS,EACxBqC,EAAS1C,EAAaS,CAAO,EACnC,GAAI,CAACiC,EAAQ,MAAO,CAAE,QAAS,GAAO,QAAS,qBAAqBjC,CAAO,EAAE,EAG7E,GAAI,CAACgC,EAAO,UAAUmB,CAAa,EACjC,MAAO,CAAE,QAAS,GAAO,QAAS,8BAA8B,EAIlE,GAAI,CAEF,GADe,IAAInB,EAAO,OAAOa,CAAU,EAChC,QAAQ,YAAW,IAAOM,EAAc,YAAW,EAC5D,MAAO,CAAE,QAAS,GAAO,QAAS,gDAAgD,CAEtF,MAAQ,CACN,MAAO,CAAE,QAAS,GAAO,QAAS,wBAAwB,CAC5D,CAIA,MAAMC,EAAU,MADC,MAAM,KAAK,aAAapD,CAAO,GACjB,WAAWmD,CAAa,EACjDE,EAAgBrB,EAAO,YAAYoB,CAAO,EAEhD,MAAO,CACL,QAAS,GACT,QAAS,eAAenB,EAAO,IAAI,QAAQ,KAAK,gBAAkB,aAAe,+BAAiCA,EAAO,OAAO,KAAK,WAAWoB,CAAa,EAAE,QAAQ,CAAC,CAAC,IAAIpB,EAAO,YAAY,IAChM,MAAOA,EAAO,KACd,IAAK,KAAK,gBAAkB,aAAe,kBAAoBA,EAAO,QACtE,cAAe,KAAK,cACpB,cAAAoB,CACR,CACI,OAASjE,EAAK,CACZ,MAAO,CAAE,QAAS,GAAO,QAAS,UAAUA,EAAI,OAAO,EAAE,CAC3D,CACF,CAGA,MAAM,YAAY+D,EAAenD,EAAU,GAAI,CAC7C,MAAMgC,EAAS,MAAMpC,EAAS,EACxBgD,EAAW,MAAM,KAAK,aAAa5C,CAAO,EAC1CiC,EAAS1C,EAAaS,CAAO,EAC7BgD,EAASxD,GAAgBQ,CAAO,GAAK,GACrCsD,EAAW,GAGjB,GAAI,CACF,MAAMF,EAAU,MAAMR,EAAS,WAAWO,CAAa,EACjDI,EAAYvB,EAAO,YAAYoB,CAAO,EACxC,WAAWG,CAAS,EAAI,GAC1BD,EAAS,KAAK,CACZ,MAAOrB,EAAO,aACd,KAAMsB,EACN,OAAQ,IACR,MAAOA,EACP,OAAQ,EAClB,CAAS,CAEL,OAASnE,EAAK,CACZ,QAAQ,KAAK,wBAAyBA,EAAI,OAAO,CACnD,CAGA,SAAW,CAACoE,EAAQC,CAAO,IAAK,OAAO,QAAQT,CAAM,EACnD,GAAIS,EAAQ,YAAW,IAAOxB,EAAO,QAAQ,YAAW,EACxD,GAAI,CACF,MAAMyB,EAAW,IAAI1B,EAAO,SAASyB,EAAShE,EAAWmD,CAAQ,EAC3D,CAACQ,EAASO,CAAQ,EAAI,MAAM,QAAQ,IAAI,CAC5CD,EAAS,UAAUP,CAAa,EAChCO,EAAS,SAAQ,CAC3B,CAAS,EACKH,EAAYvB,EAAO,YAAYoB,EAASO,CAAQ,EAClD,WAAWJ,CAAS,EAAI,MAC1BD,EAAS,KAAK,CACZ,MAAOE,EACP,KAAMD,EACN,OAAQ,IACR,MAAOA,CACnB,CAAW,CAEL,OAASnE,EAAK,CACZ,QAAQ,KAAK,SAASoE,CAAM,kBAAmBpE,EAAI,OAAO,CAC5D,CAGF,OAAOkE,CACT,CAIA,MAAM,SAAStD,EAASC,EAASC,EAAU0D,EAAU,CACnD,MAAM5B,EAAS,MAAMpC,EAAS,EACxBgD,EAAW,MAAM,KAAK,aAAa5C,CAAO,EAC1CiC,EAAS1C,EAAaS,CAAO,EAE7B6D,EAAc,KAAK,cAAc5D,EAASD,CAAO,EACjD8D,EAAe,KAAK,cAAc5D,EAAUF,CAAO,EACzD,GAAI,CAAC6D,GAAe,CAACC,EAAc,MAAM,IAAI,MAAM,oBAAoB7D,CAAO,OAAOC,CAAQ,EAAE,EAG/F,IAAI6D,EAAa,GACbF,EAAY,YAAW,IAAO5B,EAAO,QAAQ,YAAW,IAE1D8B,EAAa,MADS,IAAI/B,EAAO,SAAS6B,EAAapE,EAAWmD,CAAQ,EACzC,SAAQ,GAE3C,IAAIoB,EAAc,GACdF,EAAa,YAAW,IAAO7B,EAAO,QAAQ,YAAW,IAE3D+B,EAAc,MADM,IAAIhC,EAAO,SAAS8B,EAAcrE,EAAWmD,CAAQ,EACzC,SAAQ,GAE1C,MAAMzC,EAAc6B,EAAO,WAAW4B,EAAS,SAAQ,EAAIG,CAAU,EAGrE,GAAI,KAAK,gBAAkB,aACzB,GAAI,CACF,MAAME,EAAW,MAAM,KAAK,oBAAoBjE,EAAS6D,EAAaC,EAAc3D,CAAW,EAC/F,GAAI8D,EAAU,CACZA,EAAS,UAAYH,EACrB,MAAMI,EAAelC,EAAO,YAAYiC,EAAS,UAAWD,CAAW,EACjEG,EAAiB,WAAWD,CAAY,EAAI,WAAWN,CAAQ,EACrE,QAAQ,IAAI,wBAAwBM,CAAY,QAAQD,EAAS,aAAa,EAAE,EAGhF,IAAIG,EAAc,KAClB,GAAI,CAAEA,EAAc,MAAM,KAAK,gBAAgBpE,EAAS6D,EAAaC,EAAc3D,EAAa6D,EAAa/B,CAAM,CAAG,MAAQ,CAAC,CAC/H,MAAMoC,EAAUD,IACV,WAAWF,CAAY,EAAIE,EAAY,cAAgBA,EAAY,aAAe,KAAK,QAAQ,CAAC,EAClG,KAEJ,MAAO,CACL,SAAUR,EAAS,SAAQ,EAC3B,UAAWM,EACX,eAAAC,EACA,IAAK,kBACL,KAAM,aACN,QAASF,EAAS,QAClB,cAAeA,EAAS,cACxB,YAAa,YACb,gBAAiBI,EAAU,GAAGA,EAAU,EAAI,IAAM,EAAE,GAAGA,CAAO,IAAM,KACpE,WAAWD,GAAA,YAAAA,EAAa,MAAO,KAC/B,cAAeH,CAC3B,CACQ,CACF,OAAS7E,EAAK,CACZ,QAAQ,KAAK,yDAA0DA,EAAI,OAAO,CACpF,CAIF,MAAMkF,EAAe,MAAM,KAAK,gBAAgBtE,EAAS6D,EAAaC,EAAc3D,EAAa6D,EAAa/B,CAAM,EACpH,MAAO,CACL,SAAU2B,EAAS,SAAQ,EAC3B,UAAWU,EAAa,aACxB,eAAgBA,EAAa,eAC7B,KAAMA,EAAa,KACnB,IAAKrC,EAAO,QACZ,KAAM,SACN,QAAS,CAAC,CAAE,KAAMA,EAAO,QAAS,IAAK,IAAK,EAC5C,cAAeA,EAAO,QACtB,YAAaqC,EAAa,KAAK,OAAS,EAAI,YAAc,SAC1D,gBAAiB,IACvB,CACE,CAGA,MAAM,gBAAgBtE,EAAS6D,EAAaC,EAAc3D,EAAa6D,EAAa/B,EAAQ,CAC1F,MAAMD,EAAS,MAAMpC,EAAS,EACxBgD,EAAW,MAAM,KAAK,aAAa5C,CAAO,EAC1CuE,EAAS,IAAIvC,EAAO,SAASC,EAAO,OAAQvC,GAAYkD,CAAQ,EAEhE4B,EAAQ,CACZ,CAACX,EAAaC,CAAY,EAC1B,CAACD,EAAa5B,EAAO,QAAS6B,CAAY,CAChD,EAEI,UAAWW,KAAQD,EACjB,GAAI,CACF,MAAME,EAAU,MAAMH,EAAO,cAAcpE,EAAasE,CAAI,EACtDE,EAAYD,EAAQA,EAAQ,OAAS,CAAC,EACtCR,EAAelC,EAAO,YAAY2C,EAAWX,CAAW,EACxDY,EAAe,WAAWV,CAAY,EACtCC,EAAiBS,EAAe,WAAW5C,EAAO,YAAY7B,EAAa,EAAE,CAAC,EAEpF,MAAO,CAAE,aAAA+D,EAAc,eAAAC,EAAgB,aAAAS,EAAc,KAAAH,EAAM,IAAKxC,EAAO,OAAO,CAChF,MAAQ,CACN,QACF,CAEF,MAAM,IAAI,MAAM,yBAAyBA,EAAO,OAAO,EAAE,CAC3D,CAIA,MAAM,WAAWY,EAAY7C,EAAS6E,EAAO,SAC3C,MAAM7C,EAAS,MAAMpC,EAAS,EACxBqC,EAAS1C,EAAaS,CAAO,EACnC,GAAI,CAACiC,EAAQ,MAAM,IAAI,MAAM,sBAAsBjC,CAAO,EAAE,EAE5D,KAAM,CAAE,OAAAwD,EAAQ,KAAAsB,EAAM,SAAAC,EAAU,MAAAC,CAAK,EAAKH,EAG1C,IAAII,EAAWC,EACf,MAAMC,EAAY3B,EAAO,MAAM,iEAAiE,EAChG,GAAI2B,EACFF,EAAYE,EAAU,CAAC,EAAE,YAAW,EACpCD,EAAaC,EAAU,CAAC,EAAE,YAAW,EACjCD,IAAe,WAAUA,EAAa,YAE1C,OAAM,IAAI,MAAM,wBAAwB1B,CAAM,yBAAyB,EAIzE,MAAM4B,EAAW,KAAK,cAAcH,EAAWjF,CAAO,EAChDqF,EAAY,KAAK,cAAcH,EAAYlF,CAAO,EACxD,GAAI,CAACoF,EAAU,MAAM,IAAI,MAAM,SAASH,CAAS,uBAAuBjF,CAAO,EAAE,EACjF,GAAI,CAACqF,EAAW,MAAM,IAAI,MAAM,SAASH,CAAU,uBAAuBlF,CAAO,EAAE,EAEnF,MAAM+B,EAAS,MAAM,KAAK,WAAWc,EAAY7C,CAAO,EAGxD,IAAIC,EAASC,EAAUoF,EACnBR,EAAK,YAAW,IAAO,OACzB7E,EAAUoF,EACVnF,EAAWkF,EACXE,GAAe,WAAWP,CAAQ,EAAI,WAAWC,GAAS,CAAC,GAAG,SAAQ,IAEtE/E,EAAUmF,EACVlF,EAAWmF,EACXC,EAAcP,EAAS,SAAQ,GAIjC,MAAM7C,EAAajC,EAAQ,YAAW,IAAOgC,EAAO,QAAQ,YAAW,EACjEsD,EAAcrF,EAAS,YAAW,IAAO+B,EAAO,QAAQ,YAAW,EAEzE,IAAI8B,EAAa,GACZ7B,IAEH6B,EAAa,MADM,IAAI/B,EAAO,SAAS/B,EAASR,EAAWsC,EAAO,QAAQ,EAC5C,SAAQ,GAExC,IAAIiC,EAAc,GACbuB,IAEHvB,EAAc,MADM,IAAIhC,EAAO,SAAS9B,EAAUT,EAAWsC,EAAO,QAAQ,EAC5C,SAAQ,GAG1C,MAAM6B,EAAW5B,EAAO,WAAWsD,EAAavB,CAAU,EAG1D,GAAI,KAAK,gBAAkB,aACzB,GAAI,CACF,MAAME,EAAW,MAAM,KAAK,oBAAoBjE,EAASC,EAASC,EAAU0D,CAAQ,EACpF,GAAIK,EAAU,CACZA,EAAS,UAAY/D,EACrB,QAAQ,IAAI,yBAAyB+D,EAAS,YAAc,YAAY,MAAMA,EAAS,aAAa,EAAE,EACtG,MAAMuB,EAAS,MAAM,KAAK,uBAAuBzD,EAAQ/B,EAASC,EAAS2D,EAAUK,CAAQ,EACvFC,EAAelC,EAAO,YAAYiC,EAAS,UAAWD,CAAW,EAEvE,MAAO,CACL,QAAS,GACT,OAAQwB,EAAO,GAAG,KAClB,OAAAhC,EACA,KAAMsB,EAAK,YAAW,EACtB,SAAUQ,EACV,UAAWpB,EACX,eAAgBY,EAAK,gBAAkB,MAClC,WAAWQ,CAAW,EAAI,WAAWpB,CAAY,EACjD,WAAWA,CAAY,EAAI,WAAWoB,CAAW,EACtD,MAAOrD,EAAO,KACd,IAAK,kBACL,KAAM,aACN,WAAYuD,EAAO,YAAcvB,EAAS,YAAc,KACxD,QAASuB,EAAO,QAChB,cAAeA,EAAO,cACtB,SAAU,GAAGvD,EAAO,QAAQ,OAAOuD,EAAO,GAAG,IAAI,GACjD,SAASlE,EAAAkE,EAAO,QAAQ,UAAf,YAAAlE,EAAwB,WACjC,YAAakE,EAAO,QAAQ,WACxC,CACQ,CACF,OAASpG,EAAK,CACZ,QAAQ,KAAK,mEAAoEA,EAAI,OAAO,CAC9F,CAIF,QAAQ,IAAI,kCAAkC6C,EAAO,OAAO,EAAE,EAC9D,MAAMsC,EAAS,IAAIvC,EAAO,SAASC,EAAO,OAAQvC,GAAYqC,CAAM,EAGpE,IAAI0C,EACJ,GAAI,CACF,MAAMF,EAAO,cAAcX,EAAU,CAAC3D,EAASC,CAAQ,CAAC,EACxDuE,EAAO,CAACxE,EAASC,CAAQ,CAC3B,MAAQ,CACNuE,EAAO,CAACxE,EAASgC,EAAO,QAAS/B,CAAQ,EACzC,GAAI,CACF,MAAMqE,EAAO,cAAcX,EAAUa,CAAI,CAC3C,MAAQ,CACN,MAAM,IAAI,MAAM,oBAAoBQ,CAAS,IAAIC,CAAU,OAAOjD,EAAO,OAAO,EAAE,CACpF,CACF,CAGA,MAAMyC,EAAU,MAAMH,EAAO,cAAcX,EAAUa,CAAI,EACnDgB,EAAcf,EAAQA,EAAQ,OAAS,CAAC,EAExCgB,EAASD,EAAc,OAAO,KAAK,OAAO,EAD/B,GAC8C,KAAO,GAAK,CAAC,EAAI,OAC1EE,EAAW,KAAK,MAAM,KAAK,IAAG,EAAK,GAAI,EAAI,IAGjD,GAAI,CAACzD,EAAY,CACf,MAAMK,EAAgB,IAAIP,EAAO,SAAS/B,EAASR,EAAWsC,CAAM,EAClD,MAAMQ,EAAc,UAAUR,EAAO,QAASE,EAAO,MAAM,EAC7D2B,IACd,QAAQ,IAAI,sBAAsBqB,CAAS,QAAQhD,EAAO,OAAO,KAAK,EAEtE,MADkB,MAAMM,EAAc,QAAQN,EAAO,OAAQD,EAAO,UAAU,GAC9D,KAAI,EACpB,QAAQ,IAAI,6BAA6B,EAE7C,CAGA,IAAIS,EACJ,GAAIP,EACFO,EAAK,MAAM8B,EAAO,sBAAsBmB,EAAQjB,EAAM1C,EAAO,QAAS4D,EAAU,CAAE,MAAO/B,CAAQ,CAAE,UAC1F2B,EACT9C,EAAK,MAAM8B,EAAO,sBAAsBX,EAAU8B,EAAQjB,EAAM1C,EAAO,QAAS4D,CAAQ,MAExF,IAAI,CACFlD,EAAK,MAAM8B,EAAO,sDAChBX,EAAU8B,EAAQjB,EAAM1C,EAAO,QAAS4D,CAClD,CACM,MAAQ,CACNlD,EAAK,MAAM8B,EAAO,yBAAyBX,EAAU8B,EAAQjB,EAAM1C,EAAO,QAAS4D,CAAQ,CAC7F,CAGF,QAAQ,IAAI,qBAAqBlD,EAAG,IAAI,EAAE,EAC1C,MAAMC,EAAU,MAAMD,EAAG,KAAI,EAEvByB,EAAelC,EAAO,YAAYyD,EAAazB,CAAW,EAC1DG,EAAiB,WAAWD,CAAY,EAAI,WAAWoB,CAAW,EAExE,MAAO,CACL,QAAS,GACT,OAAQ7C,EAAG,KACX,OAAAe,EACA,KAAMsB,EAAK,YAAW,EACtB,SAAUQ,EACV,UAAWpB,EACX,eAAgBY,EAAK,YAAW,IAAO,MAClC,WAAWQ,CAAW,EAAI,WAAWpB,CAAY,EAClDC,EACJ,MAAOlC,EAAO,KACd,IAAKA,EAAO,QACZ,KAAM,SACN,QAAS,CAAC,CAAE,KAAMA,EAAO,QAAS,IAAK,IAAK,EAC5C,cAAeA,EAAO,QACtB,SAAU,GAAGA,EAAO,QAAQ,OAAOQ,EAAG,IAAI,GAC1C,SAASlB,EAAAmB,EAAQ,UAAR,YAAAnB,EAAiB,WAC1B,YAAamB,EAAQ,WAC3B,CACE,CAGA,MAAM,aAAc,CAClB,MAAO,CAAE,QAAS,GAAO,QAAS,+CAA+C,CACnF,CAGA,MAAM,qBAAqB1C,EAAS4F,EAAU,CAC5C,GAAI,CACF,KAAM,CAAE,gBAAAC,CAAe,EAAK,MAAKhG,EAAA,gCAAAgG,GAAA,KAAC,QAAO,iCAAqB,yBAAAA,CAAA,2BACxDC,EAAS,MAAMD,EAAgB7F,EAAS4F,CAAQ,EAChD3D,EAAS1C,EAAaS,CAAO,EACnC,MAAO,CACL,QAAS,GACT,OAAA8F,EACA,SAAU7D,EAAS,GAAGA,EAAO,QAAQ,OAAO6D,CAAM,GAAK,KACvD,OAAO7D,GAAA,YAAAA,EAAQ,OAAQ,SAASjC,CAAO,GACvC,OAAQ,eAChB,CACI,OAASZ,EAAK,CACZ,MAAO,CAAE,QAAS,GAAO,QAAS,kBAAkBA,EAAI,OAAO,EAAE,CACnE,CACF,CAGA,MAAM,eAAgB,CACpB,GAAI,CACF,KAAM,CAAE,YAAA2G,CAAW,EAAK,MAAKlG,EAAA,4BAAAkG,GAAA,KAAC,QAAO,iCAAqB,qBAAAA,CAAA,2BAC1D,OAAOA,EAAW,CACpB,MAAQ,CACN,MAAO,EACT,CACF,CAGA,MAAM,cAAe,CACnB,GAAI,CACF,KAAM,CAAE,oBAAAC,CAAmB,EAAK,MAAKnG,EAAA,oCAAAmG,GAAA,KAAC,QAAO,iCAAqB,6BAAAA,CAAA,2BAClE,OAAOA,EAAmB,CAC5B,MAAQ,CACN,OAAO,IACT,CACF,CAGA,qBAAsB,CACpB,MAAO,CACL,KAAM,KAAK,cACX,YAAa,OAAO,QAAQ/H,CAAa,EAAE,IAAI,CAAC,CAACgI,EAAM5H,CAAK,KAAO,CACjE,KAAA4H,EACA,OAAQ5H,EAAM,KAAO,OAAS,UAC9B,oBAAqBA,EAAM,SAC3B,YAAaA,EAAM,SAAW,IAAI,KAAKA,EAAM,QAAQ,EAAE,YAAW,EAAK,KACvE,YAAaA,EAAM,KAAO,IAAI,KAAKA,EAAM,SAAWL,EAAW,wBAAwB,EAAE,YAAW,EAAK,IACjH,EAAQ,EACF,OAAQ,CAAE,GAAGA,CAAU,CAC7B,CACE,CACF,CAEO,MAAMkI,GAAe,IAAIpG,GCljC1BqG,GAAa,uCAEnB,MAAMC,EAAc,CAClB,aAAc,CACZ,KAAK,YAAc,IAAI,GACzB,CAGA,MAAM,SAASC,EAAQ,OACrB,MAAMC,EAAa,mBAAiBhF,EAAAiF,EAAS,SAAQ,EAAG,OAApB,YAAAjF,EAA0B,QAAS,MAAM,GACvEkF,EAAe,MAAOC,GAAQ,CAClC,GAAKA,EAEL,IAAIA,EAAI,WAAW,KAAK,EAAG,CACzB,KAAM,CAAE,WAAA5D,CAAU,EAAK,MAAM6D,GAAWD,EAAKH,CAAU,EACvD,OAAOzD,CACT,CAEA,GAAI,CAAE,OAAO,KAAK4D,CAAG,CAAG,MAAQ,CAAE,OAAOA,CAAK,EAChD,EACA,MAAO,CACL,GAAGJ,EACH,OAAQ,MAAMG,EAAaH,EAAO,MAAM,EACxC,UAAW,MAAMG,EAAaH,EAAO,SAAS,EAC9C,WAAY,MAAMG,EAAaH,EAAO,UAAU,CACtD,CACE,CAGA,MAAM,aAAaM,EAAOC,EAAQnC,EAAM,CACtC,MAAMoC,EAAUF,EAAM,OAChBG,EAAgBH,EAAM,UAGtBI,EAAS,CAAE,IAAK,QAAS,IAAKF,EAAS,MAAO,OAAO,aAAc,IAAK,KAAK,EAG7EG,EAAM,KAAK,MAAM,KAAK,IAAG,EAAK,GAAI,EAClCC,EAAM,GAAGL,CAAM,oBAAoBnC,CAAI,GACvCyC,EAAU,CACd,IAAKL,EACL,IAAK,iBACL,IAAK,CAAC,aAAa,EACnB,IAAKG,EACL,IAAKA,EAAM,IACX,IAAAC,CACN,EAEUE,EAAYC,GAAQ,KAAKA,CAAG,EAAE,QAAQ,KAAM,EAAE,EAAE,QAAQ,MAAO,GAAG,EAAE,QAAQ,MAAO,GAAG,EACtFC,EAAeC,GAAQH,EAAS,KAAK,UAAUG,CAAG,CAAC,EACnDC,EAAeC,GAAQL,EAAS,OAAO,aAAa,GAAG,IAAI,WAAWK,CAAG,CAAC,CAAC,EAC3EC,EAAYJ,EAAYN,CAAM,EAC9BW,EAAaL,EAAYH,CAAO,EAChCS,EAAe,GAAGF,CAAS,IAAIC,CAAU,GAGzC5E,EAAM,MAAM,KAAK,aAAagE,CAAa,EAE3Cc,EAAM,MAAM,OAAO,OAAO,KAC9B,CAAE,KAAM,QAAS,KAAM,SAAS,EAChC9E,EACA,IAAI,YAAW,EAAG,OAAO6E,CAAY,CAC3C,EAEI,MAAO,GAAGA,CAAY,IAAIJ,EAAYK,CAAG,CAAC,EAC5C,CAGA,MAAM,aAAaC,EAAK,CAEtB,MAAMC,EAAWD,EACd,QAAQ,uCAAwC,EAAE,EAClD,QAAQ,qCAAsC,EAAE,EAChD,QAAQ,OAAQ,EAAE,EAClB,QAAQ,MAAO,EAAE,EACjB,QAAQ,MAAO,EAAE,EACjB,QAAQ,MAAO,EAAE,EAEdE,EAAM,WAAW,KAAK,KAAKD,CAAQ,EAAGE,GAAKA,EAAE,WAAW,CAAC,CAAC,EAGhE,GAAIH,EAAI,SAAS,mBAAmB,GAAK,CAACA,EAAI,SAAS,gBAAgB,EACrE,OAAO,OAAO,OAAO,UACnB,QAASE,EAAI,OACb,CAAE,KAAM,QAAS,WAAY,OAAO,EACpC,GAAO,CAAC,MAAM,CACtB,EAKI,MAAME,EAAI,KAAK,aAAaF,CAAG,EACzBG,EAAW,KAAK,eAAeH,CAAG,EAExC,GAAI,CAACE,GAAKA,EAAE,SAAW,GACrB,MAAM,IAAI,MAAM,oEAAmEA,GAAA,YAAAA,EAAG,SAAU,CAAC,EAAE,EAGrG,MAAME,EAAiBC,GACrB,KAAK,OAAO,aAAa,GAAGA,CAAK,CAAC,EAAE,QAAQ,KAAM,EAAE,EAAE,QAAQ,MAAO,GAAG,EAAE,QAAQ,MAAO,GAAG,EAExFC,EAAM,CACV,IAAK,KACL,IAAK,QACL,EAAGF,EAAcF,CAAC,CACxB,EAGI,GAAIC,GAAYA,EAAS,SAAW,IAAMA,EAAS,CAAC,IAAM,EACxDG,EAAI,EAAIF,EAAcD,EAAS,MAAM,EAAG,EAAE,CAAC,EAC3CG,EAAI,EAAIF,EAAcD,EAAS,MAAM,GAAI,EAAE,CAAC,MAI5C,QAAO,KAAK,sBAAsBH,CAAG,EAGvC,OAAO,OAAO,OAAO,UACnB,MAAOM,EACP,CAAE,KAAM,QAAS,WAAY,OAAO,EACpC,GAAO,CAAC,MAAM,CACpB,CACE,CAGA,aAAaN,EAAK,CAGhB,QAASO,EAAI,EAAGA,EAAIP,EAAI,OAAS,GAAIO,IACnC,GAAIP,EAAIO,CAAC,IAAM,GAAQP,EAAIO,EAAI,CAAC,IAAM,GAAQP,EAAIO,EAAI,CAAC,IAAM,GACzDP,EAAIO,EAAI,CAAC,IAAM,GAAQP,EAAIO,EAAI,CAAC,IAAM,GACxC,OAAOP,EAAI,MAAMO,EAAI,EAAGA,EAAI,EAAI,EAAE,EAGtC,OAAO,IACT,CAGA,eAAeP,EAAK,CAElB,QAASO,EAAI,EAAGA,EAAIP,EAAI,OAAS,GAAIO,IACnC,GAAIP,EAAIO,CAAC,IAAM,KAAQP,EAAIO,EAAI,CAAC,IAAM,GAAQP,EAAIO,EAAI,CAAC,IAAM,IAAQP,EAAIO,EAAI,CAAC,IAAM,EAClF,OAAOP,EAAI,MAAMO,EAAI,EAAGA,EAAI,EAAI,EAAE,EAGtC,OAAO,IACT,CAGA,MAAM,sBAAsBC,EAAS,CAEnC,MAAMC,EAAWD,EAAQ,OACnBE,EAAS,IAAI,WAAW,CAC5B,GAAM,GACN,EAAM,EAAM,GAAM,IAAM,GAAM,IAAM,GAAM,EAAM,EAChD,EAAM,EAAM,GAAM,IAAM,GAAM,IAAM,GAAM,EAAM,EAAM,CAC5D,CAAK,EACKC,EAAM,IAAI,WAAW,CAAC,EAAM,EAAM,CAAI,CAAC,EACvCC,EAAc,KAAK,SAAS,EAAMH,CAAQ,EAC1CI,EAAaF,EAAI,OAASD,EAAO,OAASE,EAAY,OAASH,EAC/DK,EAAY,KAAK,SAAS,GAAMD,CAAU,EAE1CE,EAAQ,IAAI,WAAWD,EAAU,OAASD,CAAU,EAC1D,IAAIG,EAAM,EACV,OAAAD,EAAM,IAAID,EAAWE,CAAG,EAAGA,GAAOF,EAAU,OAC5CC,EAAM,IAAIJ,EAAKK,CAAG,EAAGA,GAAOL,EAAI,OAChCI,EAAM,IAAIL,EAAQM,CAAG,EAAGA,GAAON,EAAO,OACtCK,EAAM,IAAIH,EAAaI,CAAG,EAAGA,GAAOJ,EAAY,OAChDG,EAAM,IAAIP,EAASQ,CAAG,EAEf,OAAO,OAAO,UACnB,QAASD,EAAM,OACf,CAAE,KAAM,QAAS,WAAY,OAAO,EACpC,GAAO,CAAC,MAAM,CACpB,CACE,CAGA,SAASE,EAAKC,EAAK,CACjB,OAAIA,EAAM,IAAY,IAAI,WAAW,CAACD,EAAKC,CAAG,CAAC,EAC3CA,EAAM,IAAY,IAAI,WAAW,CAACD,EAAK,IAAMC,CAAG,CAAC,EAC9C,IAAI,WAAW,CAACD,EAAK,IAAOC,GAAO,EAAK,IAAMA,EAAM,GAAI,CAAC,CAClE,CAGA,MAAM,iBAAiBtC,EAAOC,EAAQnC,EAAMyE,EAAO,KAAM,CACvD,MAAMC,EAAM,MAAM,KAAK,aAAaxC,EAAOC,EAAQnC,CAAI,EAGjD2E,EAAW,sBACjB,GAAI,CACF,MAAMC,EAAM,MAAM,MAAMD,EAAU,CAChC,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAkB,EAC7C,KAAM,KAAK,UAAU,CAAE,IAAAD,EAAK,OAAAvC,EAAQ,KAAAnC,EAAM,KAAAyE,EAAM,CACxD,CAAO,EAED,IAAI/H,EACJ,MAAMmI,EAAO,MAAMD,EAAI,KAAI,EAC3B,GAAI,CAAElI,EAAO,KAAK,MAAMmI,CAAI,CAAG,MAAQ,CAAEnI,EAAO,CAAE,MAAOmI,CAAI,CAAI,CAEjE,GAAI,CAACD,EAAI,GACP,MAAM,IAAI,MAAMlI,EAAK,OAASA,EAAK,SAAW,iBAAiBkI,EAAI,MAAM,EAAE,EAE7E,OAAOlI,CACT,OAAS/B,EAAK,CACZ,MAAIA,EAAI,UAAY,mBAAqBA,EAAI,OAAS,YAC9C,IAAI,MAAM,oEAAoE,EAEhFA,CACR,CACF,CAGA,MAAM,UAAUmK,EAAQC,EAAS,CAC/B,MAAMC,EAAU,IAAI,YACd3G,EAAM,MAAM,OAAO,OAAO,UAC9B,MAAO2G,EAAQ,OAAOF,CAAM,EAC5B,CAAE,KAAM,OAAQ,KAAM,SAAS,EAC/B,GAAO,CAAC,MAAM,CACpB,EACUG,EAAY,MAAM,OAAO,OAAO,KAAK,OAAQ5G,EAAK2G,EAAQ,OAAOD,CAAO,CAAC,EAC/E,OAAO,MAAM,KAAK,IAAI,WAAWE,CAAS,CAAC,EACxC,IAAIhJ,GAAKA,EAAE,SAAS,EAAE,EAAE,SAAS,EAAG,GAAG,CAAC,EACxC,KAAK,EAAE,CACZ,CAGA,MAAM,aAAa6I,EAAQC,EAASG,EAAc,GAAO,CACvD,MAAMF,EAAU,IAAI,YACpB,IAAIG,EACJ,GAAID,EAAa,CACf,MAAME,EAAM,KAAKN,CAAM,EACvBK,EAAU,IAAI,WAAWC,EAAI,MAAM,EACnC,QAAS,EAAI,EAAG,EAAIA,EAAI,OAAQ,IAAKD,EAAQ,CAAC,EAAIC,EAAI,WAAW,CAAC,CACpE,MACED,EAAUH,EAAQ,OAAOF,CAAM,EAEjC,MAAMzG,EAAM,MAAM,OAAO,OAAO,UAC9B,MAAO8G,EACP,CAAE,KAAM,OAAQ,KAAM,SAAS,EAC/B,GAAO,CAAC,MAAM,CACpB,EACUhC,EAAM,MAAM,OAAO,OAAO,KAAK,OAAQ9E,EAAK2G,EAAQ,OAAOD,CAAO,CAAC,EACzE,OAAO,KAAK,OAAO,aAAa,GAAG,IAAI,WAAW5B,CAAG,CAAC,CAAC,CACzD,CAGA,MAAM,mBAAmBkC,EAAWN,EAAS,CAC3C,MAAMK,EAAM,KAAKC,CAAS,EACpBF,EAAU,IAAI,WAAWC,EAAI,MAAM,EACzC,QAASvB,EAAI,EAAGA,EAAIuB,EAAI,OAAQvB,IAAKsB,EAAQtB,CAAC,EAAIuB,EAAI,WAAWvB,CAAC,EAClE,MAAMxF,EAAM,MAAM,OAAO,OAAO,UAC9B,MAAO8G,EACP,CAAE,KAAM,OAAQ,KAAM,SAAS,EAC/B,GAAO,CAAC,MAAM,CACpB,EAEUG,EAAU,OAAOP,GAAY,SAAW,IAAI,cAAc,OAAOA,CAAO,EAAIA,EAC5E5B,EAAM,MAAM,OAAO,OAAO,KAAK,OAAQ9E,EAAKiH,CAAO,EACzD,OAAO,KAAK,OAAO,aAAa,GAAG,IAAI,WAAWnC,CAAG,CAAC,CAAC,CACzD,CAGA,MAAM,QAAQ4B,EAAS,CACrB,MAAMrI,EAAO,IAAI,cAAc,OAAOqI,CAAO,EACvCQ,EAAO,MAAM,OAAO,OAAO,OAAO,UAAW7I,CAAI,EACvD,OAAO,IAAI,WAAW6I,CAAI,CAC5B,CAGA,MAAM,cAAcxL,EAAKoI,EAAQqD,EAAU,GAAIf,EAAO,KAAM,CAC1D,MAAMG,EAAM,MAAM,MAAM,oBAAqB,CAC3C,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAkB,EAC7C,KAAM,KAAK,UAAU,CAAE,IAAA7K,EAAK,OAAAoI,EAAQ,QAAAqD,EAAS,KAAAf,EAAM,CACzD,CAAK,EACKI,EAAO,MAAMD,EAAI,KAAI,EAC3B,IAAIlI,EACJ,GAAI,CAAEA,EAAO,KAAK,MAAMmI,CAAI,CAAG,MAAQ,CAAEnI,EAAO,CAAE,MAAOmI,CAAI,CAAI,CACjE,GAAI,CAACD,EAAI,GAAI,MAAM,IAAI,MAAMlI,EAAK,OAASA,EAAK,SAAWA,EAAK,KAAO,QAAQkI,EAAI,MAAM,EAAE,EAC3F,OAAOlI,CACT,CAKA,MAAM,cAAcwF,EAAOC,EAAQ7F,EAAUC,EAAS,GAAI,CACxD,MAAMkJ,EAAY,KAAK,IAAG,EAAG,SAAQ,EAC/BC,EAAa,OACnB,IAAIC,EAAc,GACdC,EAAU,GAEVzD,IAAW,MACbwD,EAAc,OAAO,QAAQpJ,CAAM,EAChC,OAAO,CAAC,EAAGsJ,CAAC,IAAyBA,GAAM,IAAI,EAC/C,IAAI,CAAC,CAACC,EAAGD,CAAC,IAAM,GAAGC,CAAC,IAAID,CAAC,EAAE,EAC3B,KAAK,GAAG,EAEXD,EAAU,KAAK,UAAUrJ,CAAM,EAGjC,MAAMwJ,EAAU,GAAGN,CAAS,GAAGvD,EAAM,MAAM,GAAGwD,CAAU,GAAGvD,IAAW,MAAQwD,EAAcC,CAAO,GAC7FX,EAAY,MAAM,KAAK,UAAU/C,EAAM,UAAW6D,CAAO,EAEzDhM,EAAM,GAAGiM,EAAQ,MAAM,OAAO,GAAG1J,CAAQ,GAAGqJ,EAAc,IAAMA,EAAc,EAAE,GAChFH,EAAU,CACd,iBAAkBtD,EAAM,OACxB,cAAe+C,EACf,mBAAoB,IACpB,mBAAoBQ,EACpB,qBAAsBC,EACtB,eAAgB,kBACtB,EAEUhJ,EAAO,MAAM,KAAK,cAAc3C,EAAKoI,EAAQqD,EAASrD,IAAW,MAAQ5F,EAAS,IAAI,EAC5F,GAAIG,EAAK,UAAY,GAAKA,EAAK,UAAY,OACzC,MAAM,IAAI,MAAM,UAAUA,EAAK,QAAU,eAAe,KAAKA,EAAK,OAAO,GAAG,EAE9E,OAAOA,EAAK,QAAUA,CACxB,CAKA,MAAM,eAAewF,EAAO5F,EAAUC,EAAS,GAAI,CACjD,MAAM0J,EAAQ,KAAK,IAAG,EAAG,SAAQ,EAC3BC,EAAW,IAAI,gBAAgB,CAAE,GAAG3J,EAAQ,MAAA0J,CAAK,CAAE,EAAE,SAAQ,EAG7DE,EAAa,MAAM,KAAK,QAAQF,EAAQC,CAAQ,EAChDE,EAAY,IAAI,cAAc,OAAO9J,CAAQ,EAC7C+J,EAAW,IAAI,WAAWD,EAAU,OAASD,EAAW,MAAM,EACpEE,EAAS,IAAID,EAAW,CAAC,EACzBC,EAAS,IAAIF,EAAYC,EAAU,MAAM,EACzC,MAAMnB,EAAY,MAAM,KAAK,mBAAmB/C,EAAM,UAAWmE,CAAQ,EAEnEtM,EAAM,GAAGiM,EAAQ,OAAO,OAAO,GAAG1J,CAAQ,GAC1CkJ,EAAU,CACd,UAAWtD,EAAM,OACjB,WAAY+C,EACZ,eAAgB,mCACtB,EAEUvI,EAAO,MAAM,KAAK,cAAc3C,EAAK,OAAQyL,EAASU,CAAQ,EACpE,GAAIxJ,EAAK,OAASA,EAAK,MAAM,OAAS,EACpC,MAAM,IAAI,MAAM,WAAWA,EAAK,MAAM,KAAK,IAAI,CAAC,EAAE,EAEpD,OAAOA,EAAK,QAAUA,CACxB,CAKA,MAAM,eAAewF,EAAOC,EAAQ7F,EAAUC,EAAS,GAAI,CACzD,MAAMkJ,EAAY,KAAK,IAAG,EAAG,SAAQ,EACrC,IAAIG,EAAU,GACVD,EAAc,GAEdxD,IAAW,OAASA,IAAW,UACjCwD,EAAc,OAAO,QAAQpJ,CAAM,EAChC,OAAO,CAAC,EAAGsJ,CAAC,IAAyBA,GAAM,IAAI,EAC/C,IAAI,CAAC,CAACC,EAAGD,CAAC,IAAM,GAAGC,CAAC,IAAID,CAAC,EAAE,EAC3B,KAAK,GAAG,EACPF,IAAarJ,EAAW,GAAGA,CAAQ,IAAIqJ,CAAW,KAEtDC,EAAU,KAAK,UAAUrJ,CAAM,EAGjC,MAAMwJ,EAAU,GAAGN,CAAS,GAAGtD,CAAM,GAAG7F,CAAQ,GAAGsJ,CAAO,GACpDX,EAAY,MAAM,KAAK,aAAa/C,EAAM,UAAW6D,CAAO,EAC5DO,EAAa,MAAM,KAAK,aAAapE,EAAM,UAAWA,EAAM,YAAc,EAAE,EAE5EnI,EAAM,GAAGiM,EAAQ,OAAO,OAAO,GAAG1J,CAAQ,GAC1CkJ,EAAU,CACd,aAActD,EAAM,OACpB,cAAe+C,EACf,mBAAoBQ,EACpB,oBAAqBa,EACrB,qBAAsB,IACtB,eAAgB,kBACtB,EAEU5J,EAAO,MAAM,KAAK,cAAc3C,EAAKoI,EAAQqD,EAASrD,IAAW,OAASA,IAAW,SAAW5F,EAAS,IAAI,EACnH,GAAIG,EAAK,MAAQA,EAAK,OAAS,SAC7B,MAAM,IAAI,MAAM,WAAWA,EAAK,KAAO,eAAe,KAAKA,EAAK,IAAI,GAAG,EAEzE,OAAOA,EAAK,MAAQA,CACtB,CAKA,MAAM,YAAYwF,EAAOC,EAAQ7F,EAAUC,EAAS,GAAI,CACtD,MAAMkJ,EAAY,IAAI,KAAI,EAAG,YAAW,EACxC,IAAIG,EAAU,GACVD,EAAc,GAEdxD,IAAW,OACbwD,EAAc,OAAO,QAAQpJ,CAAM,EAChC,OAAO,CAAC,EAAGsJ,CAAC,IAAyBA,GAAM,IAAI,EAC/C,IAAI,CAAC,CAACC,EAAGD,CAAC,IAAM,GAAGC,CAAC,IAAID,CAAC,EAAE,EAC3B,KAAK,GAAG,EACPF,IAAarJ,EAAW,GAAGA,CAAQ,IAAIqJ,CAAW,KAEtDC,EAAU,KAAK,UAAUrJ,CAAM,EAGjC,MAAMwJ,EAAU,GAAGN,CAAS,GAAGtD,CAAM,GAAG7F,CAAQ,GAAGsJ,CAAO,GACpDX,EAAY,MAAM,KAAK,aAAa/C,EAAM,UAAW6D,CAAO,EAE5DhM,EAAM,GAAGiM,EAAQ,IAAI,OAAO,GAAG1J,CAAQ,GACvCkJ,EAAU,CACd,gBAAiBtD,EAAM,OACvB,iBAAkB+C,EAClB,sBAAuBQ,EACvB,uBAAwBvD,EAAM,YAAc,GAC5C,eAAgB,kBACtB,EAEUxF,EAAO,MAAM,KAAK,cAAc3C,EAAKoI,EAAQqD,EAASrD,IAAW,MAAQ5F,EAAS,IAAI,EAC5F,GAAIG,EAAK,MAAQA,EAAK,OAAS,IAC7B,MAAM,IAAI,MAAM,QAAQA,EAAK,KAAO,eAAe,KAAKA,EAAK,IAAI,GAAG,EAEtE,OAAOA,EAAK,MAAQA,CACtB,CAKA,MAAM,cAAcwF,EAAOC,EAAQ7F,EAAUC,EAAS,GAAI,CACxD,MAAMkJ,EAAY,KAAK,IAAG,EAAG,SAAQ,EAC/Bc,EAAY,CAAE,GAAGhK,EAAQ,UAAAkJ,CAAS,EAClCE,EAAc,OAAO,QAAQY,CAAS,EACzC,KAAK,CAAC,CAAC1K,CAAC,EAAG,CAACI,CAAC,IAAMJ,EAAE,cAAcI,CAAC,CAAC,EACrC,OAAO,CAAC,EAAG4J,CAAC,IAAyBA,GAAM,IAAI,EAC/C,IAAI,CAAC,CAACC,EAAGD,CAAC,IAAM,GAAGC,CAAC,IAAI,mBAAmBD,CAAC,CAAC,EAAE,EAC/C,KAAK,GAAG,EAELZ,EAAY,MAAM,KAAK,UAAU/C,EAAM,UAAWyD,CAAW,EAC7Da,EAAc,GAAGb,CAAW,cAAcV,CAAS,GAEnDlL,EAAM,GAAGiM,EAAQ,MAAM,OAAO,GAAG1J,CAAQ,IAAIkK,CAAW,GACxDhB,EAAU,CACd,cAAetD,EAAM,OACrB,eAAgB,kBACtB,EAEUxF,EAAO,MAAM,KAAK,cAAc3C,EAAKoI,EAAQqD,EAASrD,IAAW,MAAQ5F,EAAS,IAAI,EAC5F,GAAIG,EAAK,MAAQA,EAAK,OAAS,EAC7B,MAAM,IAAI,MAAM,UAAUA,EAAK,KAAO,eAAe,KAAKA,EAAK,IAAI,GAAG,EAExE,OAAOA,EAAK,MAAQA,CACtB,CAKA,MAAM,eAAewF,EAAOC,EAAQ7F,EAAUC,EAAS,GAAI,CACzD,MAAMkJ,EAAY,KAAK,IAAG,EAAG,SAAQ,EACrC,IAAIG,EAAU,GACVD,EAAc,GAEdxD,IAAW,OACbwD,EAAc,OAAO,QAAQpJ,CAAM,EAChC,OAAO,CAAC,EAAGsJ,CAAC,IAAyBA,GAAM,IAAI,EAC/C,IAAI,CAAC,CAACC,EAAGD,CAAC,IAAM,GAAGC,CAAC,IAAID,CAAC,EAAE,EAC3B,KAAK,GAAG,EACPF,IAAarJ,EAAW,GAAGA,CAAQ,IAAIqJ,CAAW,KAEtDC,EAAU,KAAK,UAAUrJ,CAAM,EAGjC,MAAMwJ,EAAU,GAAGN,CAAS,GAAGtD,CAAM,GAAG7F,CAAQ,GAAGsJ,CAAO,GACpDX,EAAY,MAAM,KAAK,aAAa/C,EAAM,UAAW6D,CAAO,EAE5DhM,EAAM,GAAGiM,EAAQ,OAAO,OAAO,GAAG1J,CAAQ,GAC1CkJ,EAAU,CACd,aAActD,EAAM,OACpB,cAAe+C,EACf,mBAAoBQ,EACpB,oBAAqBvD,EAAM,YAAc,GACzC,eAAgB,mBAChB,OAAU,OAChB,EAEUxF,EAAO,MAAM,KAAK,cAAc3C,EAAKoI,EAAQqD,EAASrD,IAAW,MAAQ5F,EAAS,IAAI,EAC5F,GAAIG,EAAK,MAAQA,EAAK,OAAS,QAC7B,MAAM,IAAI,MAAM,WAAWA,EAAK,KAAO,eAAe,KAAKA,EAAK,IAAI,GAAG,EAEzE,OAAOA,EAAK,MAAQA,CACtB,CAKA,MAAM,aAAawF,EAAOC,EAAQ7F,EAAUC,EAAS,GAAI,CACvD,MAAMkJ,EAAY,KAAK,IAAG,EACpBc,EAAY,CAAE,GAAGhK,EAAQ,UAAAkJ,EAAW,WAAY,GAAI,EACpDE,EAAc,OAAO,QAAQY,CAAS,EACzC,OAAO,CAAC,EAAGV,CAAC,IAAyBA,GAAM,IAAI,EAC/C,IAAI,CAAC,CAACC,EAAGD,CAAC,IAAM,GAAGC,CAAC,IAAI,mBAAmBD,CAAC,CAAC,EAAE,EAC/C,KAAK,GAAG,EAELZ,EAAY,MAAM,KAAK,UAAU/C,EAAM,UAAWyD,CAAW,EAC7Da,EAAc,GAAGb,CAAW,cAAcV,CAAS,GAEnDlL,EAAMoI,IAAW,MACnB,GAAG6D,EAAQ,KAAK,OAAO,GAAG1J,CAAQ,IAAIkK,CAAW,GACjD,GAAGR,EAAQ,KAAK,OAAO,GAAG1J,CAAQ,GAEhCkJ,EAAU,CACd,gBAAiBtD,EAAM,OACvB,eAAgB,kBACtB,EAEUuC,EAAOtC,IAAW,MAAQqE,EAAc,KACxC9J,EAAO,MAAM,KAAK,cAAc3C,EAAKoI,EAAQqD,EAASf,CAAI,EAChE,GAAI/H,EAAK,MAAQA,EAAK,OAAS,GAAKA,EAAK,OAAS,IAChD,MAAM,IAAI,MAAM,SAASA,EAAK,KAAO,eAAe,KAAKA,EAAK,IAAI,GAAG,EAEvE,OAAOA,CACT,CAGA,MAAM,sBAAsBwF,EAAOC,EAAQ7F,EAAUC,EAAS,GAAI,CAChE,MAAMkJ,EAAY,KAAK,IAAG,EACpBc,EAAY,CAAE,GAAGhK,EAAQ,UAAAkJ,EAAW,WAAY,GAAI,EACpDE,EAAc,OAAO,QAAQY,CAAS,EACzC,OAAO,CAAC,EAAGV,CAAC,IAAyBA,GAAM,IAAI,EAC/C,IAAI,CAAC,CAACC,EAAGD,CAAC,IAAM,GAAGC,CAAC,IAAI,mBAAmBD,CAAC,CAAC,EAAE,EAC/C,KAAK,GAAG,EAELZ,EAAY,MAAM,KAAK,UAAU/C,EAAM,UAAWyD,CAAW,EAC7Da,EAAc,GAAGb,CAAW,cAAcV,CAAS,GAEnDlL,EAAMoI,IAAW,MACnB,GAAG6D,EAAQ,QAAQ,OAAO,GAAG1J,CAAQ,IAAIkK,CAAW,GACpD,GAAGR,EAAQ,QAAQ,OAAO,GAAG1J,CAAQ,GAEnCtC,EAAU,CACd,OAAAmI,EACA,QAAS,CACP,eAAgBD,EAAM,OACtB,eAAgB,mCACxB,CACA,GAEQC,IAAW,QAAUA,IAAW,YAClCnI,EAAQ,KAAOwM,GAGjB,MAAM5B,EAAM,MAAM,MAAM7K,EAAKC,CAAO,EAC9B0C,EAAO,MAAMkI,EAAI,KAAI,EAC3B,GAAI,CAACA,EAAI,GACP,MAAM,IAAI,MAAM,WAAWtI,CAAQ,KAAKI,EAAK,KAAOkI,EAAI,UAAU,KAAKlI,EAAK,MAAQkI,EAAI,MAAM,GAAG,EAEnG,OAAOlI,CACT,CAGA,MAAM,sBAAsBJ,EAAUC,EAAS,GAAI,CACjD,MAAMoJ,EAAc,OAAO,QAAQpJ,CAAM,EACtC,OAAO,CAAC,EAAGsJ,CAAC,IAAMA,IAAM,MAAS,EACjC,IAAI,CAAC,CAACC,EAAGD,CAAC,IAAM,GAAGC,CAAC,IAAI,mBAAmBD,CAAC,CAAC,EAAE,EAC/C,KAAK,GAAG,EACL9L,EAAM,GAAGiM,EAAQ,QAAQ,OAAO,GAAG1J,CAAQ,GAAGqJ,EAAc,IAAMA,EAAc,EAAE,GAClFf,EAAM,MAAM,MAAM7K,CAAG,EAC3B,GAAI,CAAC6K,EAAI,GAAI,MAAM,IAAI,MAAM,sBAAsBA,EAAI,MAAM,EAAE,EAC/D,OAAOA,EAAI,KAAI,CACjB,CAGA,MAAM,QAAQhD,EAAQ,aACpB,MAAMM,EAAQ,MAAM,KAAK,SAASN,CAAM,EAClCpE,EAASwI,EAAQpE,EAAO,QAAQ,EACtC,GAAI,CAACpE,EAAQ,MAAM,IAAI,MAAM,uBAAuBoE,EAAO,QAAQ,EAAE,EAErE,GAAI,CACF,OAAQA,EAAO,SAAQ,CACrB,IAAK,UAAW,CAEd,MAAM,KAAK,sBAAsB,cAAc,EAC/C,MAAM6E,EAAU,MAAM,KAAK,sBAAsBvE,EAAO,MAAO,iBAAiB,EAChF,YAAK,YAAY,IAAIN,EAAO,GAAI,CAC9B,MAAAM,EAAO,OAAA1E,EAAQ,UAAW,GAC1B,YAAaiJ,EAAQ,aAAe,GACpC,YAAaA,EAAQ,WACjC,CAAW,EACM,CACL,QAAS,GACT,QAAS,yBAAyBA,EAAQ,WAAW,IACrD,YAAaA,EAAQ,WACjC,CACQ,CACA,IAAK,WAAY,CACf,MAAMC,EAAW,MAAM,KAAK,iBAAiBxE,EAAO,MAAO,sCAAsC,EACjG,YAAK,YAAY,IAAIN,EAAO,GAAI,CAC9B,MAAAM,EAAO,OAAA1E,EAAQ,UAAW,GAC1B,YAAa,CAAC,OAAQ,OAAO,EAC7B,SAAUkJ,EAAS,UAAY,EAC3C,CAAW,EACM,CACL,QAAS,GACT,QAAS,2BAA2BA,EAAS,UAAY,IAAI,MAAM,aACnE,YAAa,CAAC,OAAQ,OAAO,CACzC,CACQ,CACA,IAAK,QAAS,CACZ,MAAMpJ,EAAS,MAAM,KAAK,cAAc4E,EAAO,MAAO,6BAA8B,CAAE,YAAa,UAAW,EACxGyE,IAAQ5J,GAAAD,GAAAD,EAAAS,GAAA,YAAAA,EAAQ,OAAR,YAAAT,EAAe,KAAf,YAAAC,EAAmB,OAAnB,YAAAC,EAAyB,SAAU,EACjD,YAAK,YAAY,IAAI6E,EAAO,GAAI,CAAE,MAAAM,EAAO,OAAA1E,EAAQ,UAAW,GAAM,YAAa,CAAC,OAAQ,OAAO,CAAC,CAAE,EAC3F,CAAE,QAAS,GAAM,QAAS,uBAAuBmJ,CAAK,WAAY,YAAa,CAAC,OAAQ,OAAO,CAAC,CACzG,CACA,IAAK,SAAU,CACb,MAAMhI,EAAU,MAAM,KAAK,eAAeuD,EAAO,oBAAoB,EAC/D0E,EAAS,OAAO,KAAKjI,GAAW,EAAE,EAAE,OAC1C,YAAK,YAAY,IAAIiD,EAAO,GAAI,CAAE,MAAAM,EAAO,OAAA1E,EAAQ,UAAW,GAAM,YAAa,CAAC,OAAQ,OAAO,CAAC,CAAE,EAC3F,CAAE,QAAS,GAAM,QAAS,wBAAwBoJ,CAAM,WAAY,YAAa,CAAC,OAAQ,OAAO,CAAC,CAC3G,CACA,IAAK,SAAU,CACb,MAAMF,EAAW,MAAM,KAAK,eAAexE,EAAO,MAAO,kBAAkB,EACrE2E,EAAQ,MAAM,QAAQH,CAAQ,EAAIA,EAAS,OAAS,EAC1D,YAAK,YAAY,IAAI9E,EAAO,GAAI,CAAE,MAAAM,EAAO,OAAA1E,EAAQ,UAAW,GAAM,YAAa,CAAC,OAAQ,OAAO,CAAC,CAAE,EAC3F,CAAE,QAAS,GAAM,QAAS,wBAAwBqJ,CAAK,aAAc,YAAa,CAAC,OAAQ,OAAO,CAAC,CAC5G,CACA,IAAK,MAAO,CACV,MAAMC,EAAM,MAAM,KAAK,YAAY5E,EAAO,MAAO,yBAAyB,EACpE0E,EAAS,MAAM,QAAQE,CAAG,KAAK9J,EAAA8J,EAAI,CAAC,IAAL,MAAA9J,EAAQ,SAAU8J,EAAI,CAAC,EAAE,QAAQ,OAAS,EAC/E,YAAK,YAAY,IAAIlF,EAAO,GAAI,CAAE,MAAAM,EAAO,OAAA1E,EAAQ,UAAW,GAAM,YAAa,CAAC,OAAQ,OAAO,CAAC,CAAE,EAC3F,CAAE,QAAS,GAAM,QAAS,qBAAqBoJ,CAAM,WAAY,YAAa,CAAC,OAAQ,OAAO,CAAC,CACxG,CACA,IAAK,QAAS,CACZ,MAAME,EAAM,MAAM,KAAK,cAAc5E,EAAO,MAAO,kCAAkC,EAC/E0E,EAAS,MAAM,QAAQE,GAAA,YAAAA,EAAK,QAAQ,EAAIA,EAAI,SAAS,OAAO7K,GAAK,WAAWA,EAAE,IAAI,EAAI,CAAC,EAAE,OAAS,EACxG,YAAK,YAAY,IAAI2F,EAAO,GAAI,CAAE,MAAAM,EAAO,OAAA1E,EAAQ,UAAW,GAAM,YAAa,CAAC,OAAQ,OAAO,CAAC,CAAE,EAC3F,CAAE,QAAS,GAAM,QAAS,uBAAuBoJ,CAAM,WAAY,YAAa,CAAC,OAAQ,OAAO,CAAC,CAC1G,CACA,IAAK,SAAU,CACb,MAAMG,EAAO,MAAM,KAAK,eAAe7E,EAAO,MAAO,6BAA6B,EAC5E0E,EAAS,MAAM,QAAQG,CAAI,EAAIA,EAAK,OAAOlL,GAAK,WAAWA,EAAE,SAAS,EAAI,CAAC,EAAE,OAAS,EAC5F,YAAK,YAAY,IAAI+F,EAAO,GAAI,CAAE,MAAAM,EAAO,OAAA1E,EAAQ,UAAW,GAAM,YAAa,CAAC,OAAQ,OAAO,CAAC,CAAE,EAC3F,CAAE,QAAS,GAAM,QAAS,wBAAwBoJ,CAAM,WAAY,YAAa,CAAC,OAAQ,OAAO,CAAC,CAC3G,CACA,IAAK,OAAQ,CACX,MAAMG,EAAO,MAAM,KAAK,aAAa7E,EAAO,MAAO,iBAAiB,EAC9D0E,EAAS,MAAM,QAAQG,GAAA,YAAAA,EAAM,QAAQ,EAAIA,EAAK,SAAS,OAAO9K,GAAK,WAAWA,EAAE,IAAI,EAAI,CAAC,EAAE,OAAS,EAC1G,YAAK,YAAY,IAAI2F,EAAO,GAAI,CAAE,MAAAM,EAAO,OAAA1E,EAAQ,UAAW,GAAM,YAAa,CAAC,OAAQ,OAAO,CAAC,CAAE,EAC3F,CAAE,QAAS,GAAM,QAAS,sBAAsBoJ,CAAM,WAAY,YAAa,CAAC,OAAQ,OAAO,CAAC,CACzG,CACA,QACE,aAAM,MAAMpJ,EAAO,OAAO,EAC1B,KAAK,YAAY,IAAIoE,EAAO,GAAI,CAAE,MAAAM,EAAO,OAAA1E,EAAQ,UAAW,GAAM,YAAa,EAAE,CAAE,EAC5E,CAAE,QAAS,GAAM,QAAS,gBAAgBA,EAAO,IAAI,EAAE,CAExE,CACI,OAAS7C,EAAK,CACZ,MAAO,CAAE,QAAS,GAAO,QAASA,EAAI,OAAO,CAC/C,CACF,CAGA,MAAM,YAAYqM,EAAU,WAC1B,MAAMC,EAAO,KAAK,YAAY,IAAID,CAAQ,EAC1C,GAAI,CAACC,EAAM,MAAM,IAAI,MAAM,sBAAsB,EAEjD,GAAIA,EAAK,OAAO,KAAO,UACrB,GAAI,CAEF,OADgB,MAAM,KAAK,sBAAsBA,EAAK,MAAO,MAAO,iBAAiB,GACtE,SACZ,OAAOhL,GAAK,WAAWA,EAAE,IAAI,EAAI,GAAK,WAAWA,EAAE,MAAM,EAAI,CAAC,EAC9D,IAAIA,IAAM,CACT,MAAOA,EAAE,MACT,KAAMA,EAAE,KACR,OAAQA,EAAE,OACV,OAAQ,WAAWA,EAAE,IAAI,EAAI,WAAWA,EAAE,MAAM,GAAG,SAAQ,CACvE,EAAY,CACN,OAAStB,EAAK,CACZ,cAAQ,MAAM,6BAA8BA,CAAG,EACzCA,CACR,CAGF,GAAIsM,EAAK,OAAO,KAAO,WACrB,GAAI,CAaF,QAZa,MAAM,KAAK,iBAAiBA,EAAK,MAAO,MAAO,sCAAsC,GAExE,UAAY,IAAI,IAAIpL,GAAC,aAAK,OAClD,MAAOA,EAAE,SACT,OAAMgB,EAAAhB,EAAE,oBAAF,YAAAgB,EAAqB,QAAS,IACpC,SAAQC,EAAAjB,EAAE,OAAF,YAAAiB,EAAQ,QAAS,IACzB,OAAQ,aAAWC,EAAAlB,EAAE,oBAAF,YAAAkB,EAAqB,QAAS,CAAC,EAAI,aAAWC,EAAAnB,EAAE,OAAF,YAAAmB,EAAQ,QAAS,CAAC,GAAG,SAAQ,EAC9F,KAAMnB,EAAE,IAClB,EAAU,EAE2B,OAAOA,GAAK,WAAWA,EAAE,IAAI,EAAI,GAAK,WAAWA,EAAE,MAAM,EAAI,CAAC,CAG7F,OAASlB,EAAK,CAAE,cAAQ,MAAM,wBAAyBA,CAAG,EAASA,CAAK,CAG1E,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,MAAM3J,EAAS,MAAM,KAAK,cAAc2J,EAAK,MAAO,MAAO,6BAA8B,CAAE,YAAa,SAAS,CAAE,EAEnH,SADcnK,GAAAD,EAAAS,GAAA,YAAAA,EAAQ,OAAR,YAAAT,EAAe,KAAf,YAAAC,EAAmB,OAAQ,IAEtC,OAAOyG,GAAK,WAAWA,EAAE,aAAa,EAAI,CAAC,EAC3C,IAAIA,IAAM,CACT,MAAOA,EAAE,KACT,KAAMA,EAAE,qBAAuBA,EAAE,eAAiB,IAClD,QAAS,WAAWA,EAAE,eAAiB,CAAC,EAAI,WAAWA,EAAE,qBAAuB,CAAC,GAAG,SAAQ,EAC5F,MAAOA,EAAE,eAAiB,GACtC,EAAY,CACN,OAAS5I,EAAK,CAAE,cAAQ,MAAM,qBAAsBA,CAAG,EAASA,CAAK,CAGvE,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAMtI,EAAU,MAAM,KAAK,eAAesI,EAAK,MAAO,oBAAoB,EAEpEC,EAAY,CAAE,KAAM,MAAO,KAAM,MAAO,KAAM,MAAO,KAAM,MAAO,KAAM,MAAO,KAAM,MAAO,MAAO,MAAM,EAC/G,OAAO,OAAO,QAAQvI,GAAW,EAAE,EAChC,OAAO,CAAC,EAAGkH,CAAC,IAAM,WAAWA,CAAC,EAAI,CAAC,EACnC,IAAI,CAAC,CAACC,EAAGD,CAAC,KAAO,CAChB,MAAOqB,EAAUpB,CAAC,GAAKA,EAAE,QAAQ,QAAS,EAAE,EAC5C,KAAMD,EACN,OAAQ,IACR,MAAOA,CACnB,EAAY,CACN,OAASlL,EAAK,CAAE,cAAQ,MAAM,sBAAuBA,CAAG,EAASA,CAAK,CAGxE,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAMP,EAAW,MAAM,KAAK,eAAeO,EAAK,MAAO,MAAO,mBAAoB,CAAE,KAAM,OAAO,CAAE,EACnG,OAAQ,MAAM,QAAQP,CAAQ,EAAIA,EAAW,IAC1C,OAAO7K,GAAK,WAAWA,EAAE,OAAO,EAAI,CAAC,EACrC,IAAIA,IAAM,CACT,MAAOA,EAAE,SACT,KAAMA,EAAE,WAAa,IACrB,OAAQA,EAAE,OAAS,IACnB,MAAOA,EAAE,SAAW,GAChC,EAAY,CACN,OAASlB,EAAK,CAAE,cAAQ,MAAM,sBAAuBA,CAAG,EAASA,CAAK,CAGxE,GAAIsM,EAAK,OAAO,KAAO,MACrB,GAAI,CACF,MAAMH,EAAM,MAAM,KAAK,YAAYG,EAAK,MAAO,MAAO,yBAAyB,EAE/E,OADgB,MAAM,QAAQH,CAAG,KAAK/J,EAAA+J,EAAI,CAAC,IAAL,MAAA/J,EAAQ,SAAU+J,EAAI,CAAC,EAAE,QAAU,IAEtE,OAAOtD,GAAK,WAAWA,EAAE,OAAO,EAAI,CAAC,EACrC,IAAIA,IAAM,CACT,MAAOA,EAAE,IACT,KAAMA,EAAE,UAAYA,EAAE,SAAW,IACjC,OAAQA,EAAE,WAAa,IACvB,MAAOA,EAAE,SAAW,GAChC,EAAY,CACN,OAAS7I,EAAK,CAAE,cAAQ,MAAM,mBAAoBA,CAAG,EAASA,CAAK,CAGrE,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,MAAMvK,EAAO,MAAM,KAAK,cAAcuK,EAAK,MAAO,MAAO,kCAAkC,EAE3F,QADiBvK,GAAA,YAAAA,EAAM,YAAa,MAAM,QAAQA,CAAI,EAAIA,EAAO,KAE9D,OAAOT,GAAK,WAAWA,EAAE,MAAQA,EAAE,WAAa,CAAC,EAAI,CAAC,EACtD,IAAIA,IAAM,CACT,MAAOA,EAAE,OAASA,EAAE,SACpB,KAAMA,EAAE,MAAQA,EAAE,WAAa,IAC/B,OAAQA,EAAE,QAAUA,EAAE,QAAU,IAChC,OAAQ,WAAWA,EAAE,MAAQA,EAAE,WAAa,CAAC,EAAI,WAAWA,EAAE,QAAUA,EAAE,QAAU,CAAC,GAAG,SAAQ,CAC5G,EAAY,CACN,OAAStB,EAAK,CAAE,cAAQ,MAAM,qBAAsBA,CAAG,EAASA,CAAK,CAGvE,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAMvK,EAAO,MAAM,KAAK,eAAeuK,EAAK,MAAO,MAAO,6BAA6B,EAEvF,OADe,MAAM,QAAQvK,CAAI,EAAIA,EAAO,IAEzC,OAAOb,GAAK,WAAWA,EAAE,WAAa,CAAC,EAAI,CAAC,EAC5C,IAAIA,IAAM,CACT,MAAOA,EAAE,MAAQA,EAAE,SACnB,KAAMA,EAAE,WAAa,IACrB,OAAQA,EAAE,QAAUA,EAAE,MAAQ,IAC9B,OAAQ,WAAWA,EAAE,WAAa,CAAC,EAAI,WAAWA,EAAE,QAAUA,EAAE,MAAQ,CAAC,GAAG,SAAQ,CAChG,EAAY,CACN,OAASlB,EAAK,CAAE,cAAQ,MAAM,sBAAuBA,CAAG,EAASA,CAAK,CAGxE,GAAIsM,EAAK,OAAO,KAAO,OACrB,GAAI,CACF,MAAMF,EAAO,MAAM,KAAK,aAAaE,EAAK,MAAO,MAAO,iBAAiB,EAEzE,OADiB,MAAM,QAAQF,GAAA,YAAAA,EAAM,QAAQ,EAAIA,EAAK,SAAW,IAE9D,OAAO9K,GAAK,WAAWA,EAAE,MAAQ,CAAC,EAAI,CAAC,EACvC,IAAIA,IAAM,CACT,MAAOA,EAAE,MACT,KAAMA,EAAE,MAAQ,IAChB,OAAQA,EAAE,QAAU,IACpB,OAAQ,WAAWA,EAAE,MAAQ,CAAC,EAAI,WAAWA,EAAE,QAAU,CAAC,GAAG,SAAQ,CACjF,EAAY,CACN,OAAStB,EAAK,CAAE,cAAQ,MAAM,oBAAqBA,CAAG,EAASA,CAAK,CAItE,MAAO,EACT,CAGA,MAAM,WAAWqM,EAAU5G,EAAO,uCAChC,MAAM6G,EAAO,KAAK,YAAY,IAAID,CAAQ,EAC1C,GAAI,CAACC,EAAM,MAAM,IAAI,MAAM,sBAAsB,EAEjD,KAAM,CAAE,OAAAlI,EAAQ,KAAAsB,EAAM,KAAA8G,EAAM,SAAA7G,EAAU,MAAAC,EAAO,SAAA6G,EAAU,WAAAC,CAAU,EAAKjH,EACtE,GAAI,CAACrB,GAAU,CAACsB,GAAQ,CAAC8G,GAAQ,CAAC7G,EAChC,MAAM,IAAI,MAAM,+BAA+B,EAGjD,GAAI2G,EAAK,OAAO,KAAO,UACrB,GAAI,CAEF,MAAMK,EAAc,CAClB,OAAQ,SACR,MAAO,QACP,UAAW,iBACrB,EAAUH,CAAI,GAAK,SAEL5K,EAAS,CACb,OAAQwC,EACR,KAAMsB,EAAK,YAAW,EACtB,KAAMiH,EACN,SAAUhH,EAAS,SAAQ,CACrC,GAEYgH,IAAgB,SAAWA,IAAgB,qBAC7C/K,EAAO,YAAc,MACrBA,EAAO,MAAQ,WAAWgE,CAAK,EAAE,QAAQ,CAAC,GAExC+G,IAAgB,oBAClB/K,EAAO,UAAY,WAAW6K,GAAY7G,CAAK,EAAE,QAAQ,CAAC,GAG5D,MAAMQ,EAAS,MAAM,KAAK,sBAAsBkG,EAAK,MAAO,OAAQ,gBAAiB1K,CAAM,EAE3F,MAAO,CACL,IAAIM,EAAAkE,EAAO,UAAP,YAAAlE,EAAgB,WACpB,cAAekE,EAAO,cACtB,OAAQA,EAAO,OACf,MAAMjE,EAAAiE,EAAO,OAAP,YAAAjE,EAAa,cACnB,MAAMC,EAAAgE,EAAO,OAAP,YAAAhE,EAAa,cACnB,SAAU,WAAWgE,EAAO,SAAWT,CAAQ,EAC/C,MAAO,WAAWS,EAAO,OAASR,GAAS,CAAC,EAC5C,YAAa,aAAWtD,GAAAD,EAAA+D,EAAO,QAAP,YAAA/D,EAAe,KAAf,YAAAC,EAAmB,QAAS8D,EAAO,OAAS,CAAC,EACrE,UAAW,WAAWA,EAAO,aAAe,CAAC,EAC7C,QAAQwG,EAAAxG,EAAO,SAAP,YAAAwG,EAAe,cACvB,UAAW,IAAI,KAAKxG,EAAO,cAAgB,KAAK,IAAG,CAAE,EAAE,YAAW,EAClE,OAAQ,UACR,KAAM,GACN,IAAKA,CACf,CACM,OAASpG,EAAK,CACZ,cAAQ,MAAM,4BAA6BA,CAAG,EACxCA,CACR,CAGF,GAAIsM,EAAK,OAAO,KAAO,WACrB,GAAI,CAIF,MAAMO,EAAYzI,EAAO,QAAQ,oCAAqC,OAAO,EAAE,YAAW,EAEpF0I,EAAc,GAChBN,IAAS,SACP9G,EAAK,YAAW,IAAO,MAEzBoH,EAAY,kBAAoB,CAC9B,YAAa,WAAWnH,CAAQ,EAAI,WAAWC,GAAS,CAAC,GAAG,QAAQ,CAAC,CACnF,EAGYkH,EAAY,kBAAoB,CAC9B,UAAW,WAAWnH,CAAQ,EAAE,SAAQ,CACtD,EAEmB6G,IAAS,UAClBM,EAAY,gBAAkB,CAC5B,UAAW,WAAWnH,CAAQ,EAAE,SAAQ,EACxC,YAAa,WAAWC,CAAK,EAAE,QAAQ,CAAC,CACpD,GAGQ,MAAMmH,EAAY,CAChB,gBAAiB,OAAO,WAAU,EAClC,WAAYF,EACZ,KAAMnH,EAAK,YAAW,EACtB,oBAAqBoH,CAC/B,EAGc1G,EAAS,MAAM,KAAK,iBAAiBkG,EAAK,MAAO,OAAQ,2BAA4BS,CAAS,EAIpG,GAAI,CAAC3G,EAAO,QAAS,CACnB,MAAM4G,IAASC,EAAA7G,EAAO,iBAAP,YAAA6G,EAAuB,UAASC,EAAA9G,EAAO,mBAAP,YAAA8G,EAAyB,UACnEC,EAAA/G,EAAO,iBAAP,YAAA+G,EAAuB,UAAW/G,EAAO,OAAS,gBACjDgH,IAAYC,EAAAjH,EAAO,iBAAP,YAAAiH,EAAuB,kBAAiBC,EAAAlH,EAAO,mBAAP,YAAAkH,EAAyB,UAAW,GAC9F,cAAQ,MAAM,2BAA4BN,EAAQI,CAAS,EACrD,IAAI,MAAM,0BAA0BJ,CAAM,GAAGI,EAAY,MAAQA,EAAY,EAAE,EAAE,CACzF,CAEA,MAAMG,EAAcnH,EAAO,kBAAoBA,EACzCoH,EAAUD,EAAY,UAAYA,EAAY,GACpD,GAAI,CAACC,EACH,cAAQ,MAAM,4CAA6CpH,CAAM,EAC3D,IAAI,MAAM,gCAAgC,EAKlD,IAAIqH,EAAc,EACdC,EAAY,EACZC,EAAc,UAGlB,QAAS5N,EAAU,EAAGA,EAAU,EAAGA,IACjC,GAAI,CACEA,EAAU,GAAG,MAAM,IAAI,QAAQE,IAAK,WAAWA,GAAG,GAAG,CAAC,EAC1D,MAAM2N,EAAU,MAAM,KAAK,iBAAiBtB,EAAK,MAAO,MAAO,uCAAuCkB,CAAO,EAAE,EAEzGK,EAAMD,EAAQ,OAASA,EAI7B,GAHAD,GAAeE,EAAI,QAAU,IAAI,YAAW,EAC5CJ,EAAc,WAAWI,EAAI,sBAAwB,CAAC,EACtDH,EAAY,WAAWG,EAAI,aAAe,CAAC,EACvCF,IAAgB,UAAYA,IAAgB,aAAeD,EAAY,EAAG,KAChF,OAASI,EAAW,CAClB,QAAQ,KAAK,yCAAyC/N,EAAU,CAAC,WAAY+N,EAAU,OAAO,CAChG,CAIF,OAAIJ,IAAc,GAAKD,IAAgB,IACrC,QAAQ,KAAK,8CAA+CD,EAAS,YAAaG,CAAW,EAE7FF,EAAc,WAAW7H,GAAS,CAAC,EACnC8H,EAAY,WAAW/H,CAAQ,EAC/BgI,EAAc,eAKT,CACL,GAAIH,EACJ,cAAeT,EAAU,gBACzB,OAAQF,EACR,KAAMnH,EAAK,YAAW,EACtB,KAAA8G,EACA,SAAUkB,EACV,MAAOD,EACP,YAAAA,EACA,UAAAC,EACA,OAAQC,EAAY,YAAW,EAC/B,UAAWA,IAAgB,cAC3B,UAAW,IAAI,KAAI,EAAG,YAAW,EACjC,OAAQ,WACR,KAAM,EAChB,CACM,OAAS3N,EAAK,CACZ,cAAQ,MAAM,qCAAsCA,EAAI,OAAO,EACzDA,CACR,CAIF,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,MAAMO,EAAYzI,EAAO,QAAQ,4BAA6B,MAAM,EAAE,YAAW,EAC3E2J,EAAc,CAClB,SAAU,OACV,OAAQlB,EACR,KAAMnH,EAAK,OAAO,CAAC,EAAE,cAAgBA,EAAK,MAAM,CAAC,EAAE,YAAW,EAC9D,UAAW8G,IAAS,SAAW,SAAW,QAC1C,IAAK7G,EAAS,SAAQ,CAChC,EACY6G,IAAS,UAAY9G,EAAK,YAAW,IAAO,QAE9CqI,EAAY,WAAa,YACzBA,EAAY,KAAO,WAAWpI,CAAQ,EAAI,WAAWC,GAAS,CAAC,GAAG,QAAQ,CAAC,GAEzE4G,IAAS,UACXuB,EAAY,MAAQ,WAAWnI,CAAK,EAAE,QAAQ,CAAC,EAC/CmI,EAAY,YAAc,OAG5B,MAAMP,GADS,MAAM,KAAK,cAAclB,EAAK,MAAO,OAAQ,mBAAoByB,CAAW,GACpE,SAAW,KAAK,IAAG,EAAG,SAAS,EAAE,EAExD,IAAIN,EAAc,WAAW7H,GAAS,CAAC,EACnC8H,EAAY,WAAW/H,CAAQ,EACnC,GAAI,CACF,MAAM,IAAI,QAAQ1F,GAAK,WAAWA,EAAG,GAAG,CAAC,EACzC,MAAM+N,EAAS,MAAM,KAAK,cAAc1B,EAAK,MAAO,MAAO,qBAAsB,CAAE,SAAU,OAAQ,QAAAkB,CAAO,CAAE,EACxGS,GAAIC,EAAAF,GAAA,YAAAA,EAAQ,OAAR,YAAAE,EAAe,GACrBD,IACFR,EAAc,WAAWQ,EAAE,UAAYA,EAAE,OAASrI,GAAS,CAAC,EAC5D8H,EAAY,WAAWO,EAAE,YAActI,CAAQ,EAEnD,MAAQ,CAAC,CACT,MAAO,CACL,GAAI6H,EAAS,OAAQX,EAAW,KAAMnH,EAAK,YAAW,EAAI,KAAA8G,EAC1D,SAAUkB,EAAW,MAAOD,EAAa,YAAAA,EAAa,UAAAC,EACtD,OAAQ,SAAU,UAAW,IAAI,KAAI,EAAG,YAAW,EAAI,OAAQ,QAAS,KAAM,EACxF,CACM,OAAS1N,EAAK,CAAE,cAAQ,MAAM,oBAAqBA,CAAG,EAASA,CAAK,CAItE,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CAEF,MAAM6B,EAAa/J,EAAO,QAAQ,MAAO,KAAK,EACxCxC,EAAS,CACb,KAAMuM,EACN,KAAMzI,EAAK,YAAW,EACtB,UAAW8G,IAAS,SAAW,SAAW,QAC1C,OAAQ7G,EAAS,SAAQ,CACnC,EACY6G,IAAS,UAAS5K,EAAO,MAAQ,WAAWgE,CAAK,EAAE,QAAQ,CAAC,GAChE,MAAMQ,EAAS,MAAM,KAAK,eAAekG,EAAK,MAAO,sBAAuB1K,CAAM,EAElF,MAAO,CACL,KAFWwM,EAAAhI,GAAA,YAAAA,EAAQ,OAAR,YAAAgI,EAAe,KAAM,KAAK,IAAG,EAAG,SAAS,EAAE,EAE5C,OAAQD,EAAY,KAAMzI,EAAK,YAAW,EAAI,KAAA8G,EACxD,SAAU,WAAW7G,CAAQ,EAAG,MAAO,WAAWC,GAAS,CAAC,EAC5D,YAAa,WAAWA,GAAS,CAAC,EAAG,UAAW,WAAWD,CAAQ,EACnE,OAAQ,SAAU,UAAW,IAAI,KAAI,EAAG,YAAW,EAAI,OAAQ,SAAU,KAAM,EACzF,CACM,OAAS3F,EAAK,CAAE,cAAQ,MAAM,qBAAsBA,CAAG,EAASA,CAAK,CAIvE,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CAEF,MAAMO,EAAYzI,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,EAC5ExC,EAAS,CACb,UAAW,OAAO,WAAU,EAC5B,OAAQiL,EACR,KAAMnH,EAAK,YAAW,EACtB,KAAM8G,IAAS,SAAW,SAAW,OAC/C,EACYA,IAAS,SACP9G,EAAK,YAAW,IAAO,MACzB9D,EAAO,OAAS,WAAW+D,CAAQ,EAAI,WAAWC,GAAS,CAAC,GAAG,QAAQ,CAAC,EAExEhE,EAAO,KAAO+D,EAAS,SAAQ,GAGjC/D,EAAO,MAAQ,WAAWgE,CAAK,EAAE,QAAQ,CAAC,EAC1ChE,EAAO,KAAO+D,EAAS,SAAQ,GAEjC,MAAMS,EAAS,MAAM,KAAK,eAAekG,EAAK,MAAO,OAAQ,iBAAkB1K,CAAM,EAErF,MAAO,CACL,IAFcwE,GAAA,YAAAA,EAAQ,UAAW,KAAK,IAAG,EAAG,SAAS,EAAE,EAE1C,OAAQyG,EAAW,KAAMnH,EAAK,YAAW,EAAI,KAAA8G,EAC1D,SAAU,WAAW7G,CAAQ,EAAG,MAAO,WAAWC,GAAS,CAAC,EAC5D,YAAa,WAAWA,GAAS,CAAC,EAAG,UAAW,WAAWD,CAAQ,EACnE,OAAQ,SAAU,UAAW,IAAI,KAAI,EAAG,YAAW,EAAI,OAAQ,SAAU,KAAM,EACzF,CACM,OAAS3F,EAAK,CAAE,cAAQ,MAAM,qBAAsBA,CAAG,EAASA,CAAK,CAIvE,GAAIsM,EAAK,OAAO,KAAO,MACrB,GAAI,CAEF,MAAMO,EAAYzI,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,EAC5ExC,EAAS,CACb,OAAQiL,EACR,OAAQ,OACR,KAAMnH,EAAK,YAAW,EACtB,QAAS8G,IAAS,SAAW,SAAW,QACxC,GAAI7G,EAAS,SAAQ,CAC/B,EACY6G,IAAS,UAAY9G,EAAK,YAAW,IAAO,QAC9C9D,EAAO,OAAS,YAChBA,EAAO,IAAM,WAAW+D,CAAQ,EAAI,WAAWC,GAAS,CAAC,GAAG,QAAQ,CAAC,GAEnE4G,IAAS,UAAS5K,EAAO,GAAK,WAAWgE,CAAK,EAAE,QAAQ,CAAC,GAC7D,MAAMQ,EAAS,MAAM,KAAK,YAAYkG,EAAK,MAAO,OAAQ,sBAAuB1K,CAAM,EACjF4L,EAAU,MAAM,QAAQpH,CAAM,GAAIiI,EAAAjI,EAAO,CAAC,IAAR,YAAAiI,EAAW,OAAQjI,GAAA,YAAAA,EAAQ,QAAS,KAAK,IAAG,EAAG,SAAS,EAAE,EAClG,GAAI,MAAM,QAAQA,CAAM,KAAKkI,EAAAlI,EAAO,CAAC,IAAR,YAAAkI,EAAW,SAAU,IAChD,MAAM,IAAI,MAAM,sBAAqBC,EAAAnI,EAAO,CAAC,IAAR,YAAAmI,EAAW,IAAI,EAAE,EAExD,MAAO,CACL,GAAIf,EAAS,OAAQX,EAAW,KAAMnH,EAAK,YAAW,EAAI,KAAA8G,EAC1D,SAAU,WAAW7G,CAAQ,EAAG,MAAO,WAAWC,GAAS,CAAC,EAC5D,YAAa,WAAWA,GAAS,CAAC,EAAG,UAAW,WAAWD,CAAQ,EACnE,OAAQ,SAAU,UAAW,IAAI,KAAI,EAAG,YAAW,EAAI,OAAQ,MAAO,KAAM,EACtF,CACM,OAAS3F,EAAK,CAAE,cAAQ,MAAM,kBAAmBA,CAAG,EAASA,CAAK,CAIpE,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CAEF,MAAMO,EAAYzI,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,EAC5ExC,EAAS,CACb,OAAQiL,EACR,KAAMnH,EAAK,YAAW,EACtB,KAAM8G,IAAS,SAAW,SAAW,OAC/C,EACYA,IAAS,SACP9G,EAAK,YAAW,IAAO,MACzB9D,EAAO,eAAiB,WAAW+D,CAAQ,EAAI,WAAWC,GAAS,CAAC,GAAG,QAAQ,CAAC,EAEhFhE,EAAO,SAAW,WAAW+D,CAAQ,EAAE,SAAQ,GAGjD/D,EAAO,MAAQ,WAAWgE,CAAK,EAAE,QAAQ,CAAC,EAC1ChE,EAAO,SAAW,WAAW+D,CAAQ,EAAE,SAAQ,GAEjD,MAAMS,EAAS,MAAM,KAAK,cAAckG,EAAK,MAAO,OAAQ,+BAAgC1K,CAAM,EAC5F4L,GAAUpH,GAAA,YAAAA,EAAQ,YAAWoI,EAAApI,GAAA,YAAAA,EAAQ,OAAR,YAAAoI,EAAc,UAAW,KAAK,MAAM,SAAS,EAAE,EAClF,MAAO,CACL,GAAIhB,GAAA,YAAAA,EAAS,WAAY,OAAQX,EAAW,KAAMnH,EAAK,YAAW,EAAI,KAAA8G,EACtE,SAAU,WAAW7G,CAAQ,EAAG,MAAO,WAAWC,GAAS,CAAC,EAC5D,YAAa,YAAWQ,GAAA,YAAAA,EAAQ,QAASR,GAAS,CAAC,EACnD,UAAW,YAAWQ,GAAA,YAAAA,EAAQ,cAAeT,CAAQ,EACrD,OAAQ,SAAU,UAAW,IAAI,KAAI,EAAG,YAAW,EAAI,OAAQ,QAAS,KAAM,EACxF,CACM,OAAS3F,EAAK,CAAE,cAAQ,MAAM,oBAAqBA,CAAG,EAASA,CAAK,CAItE,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAMO,EAAYzI,EAAO,QAAQ,4BAA6B,MAAM,EAAE,YAAW,EAC3ExC,EAAS,CACb,OAAQiL,EACR,KAAMnH,EAAK,YAAW,EACtB,UAAW8G,IAAS,SAAW,SAAW,QAC1C,MAAO,MACP,KAAM7G,EAAS,SAAQ,CACjC,EACY6G,IAAS,UAAY9G,EAAK,YAAW,IAAO,QAC9C9D,EAAO,MAAQ,WAAW+D,CAAQ,EAAI,WAAWC,GAAS,CAAC,GAAG,QAAQ,CAAC,GAErE4G,IAAS,UAAS5K,EAAO,MAAQ,WAAWgE,CAAK,EAAE,QAAQ,CAAC,GAChE,MAAMQ,EAAS,MAAM,KAAK,eAAekG,EAAK,MAAO,OAAQ,iCAAkC1K,CAAM,EAC/F4L,GAAUpH,GAAA,YAAAA,EAAQ,UAAW,KAAK,IAAG,EAAG,SAAS,EAAE,EACzD,MAAO,CACL,GAAIoH,GAAA,YAAAA,EAAS,WAAY,OAAQX,EAAW,KAAMnH,EAAK,YAAW,EAAI,KAAA8G,EACtE,SAAU,WAAW7G,CAAQ,EAAG,MAAO,WAAWC,GAAS,CAAC,EAC5D,YAAa,WAAWA,GAAS,CAAC,EAAG,UAAW,WAAWD,CAAQ,EACnE,OAAQ,SAAU,UAAW,IAAI,KAAI,EAAG,YAAW,EAAI,OAAQ,SAAU,KAAM,EACzF,CACM,OAAS3F,EAAK,CAAE,cAAQ,MAAM,qBAAsBA,CAAG,EAASA,CAAK,CAIvE,GAAIsM,EAAK,OAAO,KAAO,OACrB,GAAI,CAEF,MAAMO,EAAYzI,EAAO,QAAQ,4BAA6B,MAAM,EAAE,YAAW,EAC3ExC,EAAS,CACb,OAAQiL,EACR,KAAMnH,EAAK,YAAW,EACtB,KAAM8G,IAAS,SAAW,SAAW,OAC/C,EACYA,IAAS,SACP9G,EAAK,YAAW,IAAO,MACzB9D,EAAO,eAAiB,WAAW+D,CAAQ,EAAI,WAAWC,GAAS,CAAC,GAAG,QAAQ,CAAC,EAEhFhE,EAAO,SAAW,WAAW+D,CAAQ,EAAE,SAAQ,GAGjD/D,EAAO,MAAQ,WAAWgE,CAAK,EAAE,QAAQ,CAAC,EAC1ChE,EAAO,SAAW,WAAW+D,CAAQ,EAAE,SAAQ,EAC/C/D,EAAO,YAAc,OAEvB,MAAMwE,EAAS,MAAM,KAAK,aAAakG,EAAK,MAAO,OAAQ,gBAAiB1K,CAAM,EAC5E4L,GAAUpH,GAAA,YAAAA,EAAQ,UAAW,KAAK,IAAG,EAAG,SAAS,EAAE,EACzD,MAAO,CACL,GAAIoH,GAAA,YAAAA,EAAS,WAAY,OAAQX,EAAW,KAAMnH,EAAK,YAAW,EAAI,KAAA8G,EACtE,SAAU,WAAW7G,CAAQ,EAAG,MAAO,WAAWC,GAAS,CAAC,EAC5D,YAAa,YAAWQ,GAAA,YAAAA,EAAQ,QAASR,GAAS,CAAC,EACnD,UAAW,YAAWQ,GAAA,YAAAA,EAAQ,cAAeT,CAAQ,EACrD,OAAQ,SAAU,UAAW,IAAI,KAAI,EAAG,YAAW,EAAI,OAAQ,OAAQ,KAAM,EACvF,CACM,OAAS3F,EAAK,CAAE,cAAQ,MAAM,mBAAoBA,CAAG,EAASA,CAAK,CAIrE,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAM1L,EAAU0L,EAAK,SAAW,GAC1B7I,EAAa6I,EAAK,MAAM,UACxBlG,EAAS,MAAMU,GAAa,WAAWrD,EAAY7C,EAAS,CAChE,OAAAwD,EAAQ,KAAAsB,EAAM,KAAM,SAAU,SAAAC,EAAU,MAAAC,CAClD,CAAS,EACD,GAAI,CAACQ,EAAO,QAAS,MAAM,IAAI,MAAMA,EAAO,OAAS,iBAAiB,EACtE,MAAO,CACL,GAAIA,EAAO,QAAU,KAAK,IAAG,EAAG,SAAS,EAAE,EAC3C,OAAQA,EAAO,QAAUhC,EACzB,KAAMsB,EAAK,YAAW,EACtB,KAAM,SACN,SAAU,WAAWU,EAAO,UAAYT,CAAQ,EAChD,MAAO,WAAWS,EAAO,gBAAkBR,GAAS,CAAC,EACrD,YAAa,WAAWQ,EAAO,gBAAkBR,GAAS,CAAC,EAC3D,UAAW,WAAWQ,EAAO,WAAaT,CAAQ,EAClD,OAAQ,SACR,UAAW,IAAI,KAAI,EAAG,YAAW,EACjC,OAAQS,EAAO,OAAS,aAAe,kBAAoB,gBAC3D,KAAM,GACN,OAAQA,EAAO,OACf,MAAOA,EAAO,MACd,IAAKA,EAAO,IACZ,KAAMA,EAAO,KACb,QAASA,EAAO,QAChB,cAAeA,EAAO,aAChC,CACM,OAASpG,EAAK,CAAE,cAAQ,MAAM,yBAA0BA,CAAG,EAASA,CAAK,CAI3E,MAAO,CACL,GAAI,KAAK,MAAM,SAAS,EAAE,EAC1B,OAAAoE,EAAQ,KAAAsB,EAAM,KAAA8G,EACd,SAAU,WAAW7G,CAAQ,EAC7B,MAAOC,EAAQ,WAAWA,CAAK,EAAI,KACnC,OAAQ4G,IAAS,SAAW,SAAW,MACvC,YAAaA,IAAS,SAAW,WAAW5G,GAAS,CAAC,EAAI,KAC1D,UAAW,IAAI,KAAI,EAAG,YAAW,EACjC,OAAQ0G,EAAK,OAAO,KACpB,UAAW,EACjB,CACE,CAOA,MAAM,oBAAoBD,EAAU5G,EAAO,OAC5B,KAAK,YAAY,IAAI4G,CAAQ,EAC1C,KAAM,CAAE,OAAAjI,EAAQ,KAAAsB,EAAM,SAAAC,EAAU,MAAAC,EAAO,SAAA6I,EAAU,OAAAC,EAAQ,WAAAC,EAAY,SAAAlC,EAAU,WAAAC,EAAY,UAAAkC,CAAS,EAAKnJ,EAGnG1B,GAAgB7B,EAAAiF,EAAS,SAAQ,EAAG,OAApB,YAAAjF,EAA0B,cAChD,GAAI,CAAC6B,EAAe,MAAM,IAAI,MAAM,+CAA+C,EAGnF,MAAM8K,EAAUD,IAAc,MAAQ,GAAG7H,EAAU,aAAe,GAAGA,EAAU,cAG/E,GAAI2H,IAAW,SAAWC,EACxB,GAAI,CACF,MAAM1E,EAAM,MAAM,MAAM,GAAG4E,CAAO,SAAU,CAC1C,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAkB,EAC7C,KAAM,KAAK,UAAU,CAAE,OAAQ9K,EAAe,WAAA4K,EAAY,CACpE,CAAS,EACK5M,EAAO,MAAMkI,EAAI,KAAI,EAC3B,GAAI,CAACA,EAAI,IAAMlI,EAAK,MAAO,MAAM,IAAI,MAAMA,EAAK,OAAS,uBAAuB,EAEhF,MAAM+M,EAAW/M,EAAK,MAAQA,EAC9B,MAAO,CACL,GAAI4M,EACJ,OAAAvK,EACA,KAAMsB,EAAK,YAAW,EACtB,KAAM,SACN,SAAU,WAAWoJ,EAAS,YAAcnJ,CAAQ,EACpD,MAAO,WAAWmJ,EAAS,WAAalJ,GAAS,CAAC,EAClD,YAAa,WAAWkJ,EAAS,WAAalJ,GAAS,CAAC,EACxD,UAAW,WAAWkJ,EAAS,cAAgBnJ,CAAQ,EACvD,OAAQ,WAAWmJ,EAAS,aAAeA,EAAS,KAAO,CAAC,EAC5D,OAAQ,SACR,UAAW,IAAI,KAAI,EAAG,YAAW,EACjC,OAAQ,eACR,KAAM,GACN,UAAW,GACX,SAAAL,EACA,OAAQ,OAClB,CACM,OAASzO,EAAK,CACZ,cAAQ,MAAM,2BAA4BA,EAAI,OAAO,EAC/CA,CACR,CAIF,GAAI,CAEF,MAAM+O,EAAgBrJ,EAAK,YAAW,IAAO,MAAQ,OAAS,QAGxDsJ,EAAa,WAAWrJ,CAAQ,EAAI,WAAWC,GAAS,CAAC,EAG/D,IAAIqJ,EAAO7K,EACX,MAAM2B,EAAY3B,EAAO,MAAM,mCAAmC,EAC9D2B,IACFkJ,EAAO,GAAGlJ,EAAU,CAAC,CAAC,IAAIA,EAAU,CAAC,IAAM,SAAW,SAAW,KAAK,IAGxE,MAAMkE,EAAM,MAAM,MAAM,GAAG4E,CAAO,QAAS,CACzC,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAkB,EAC7C,KAAM,KAAK,UAAU,CACnB,OAAQ9K,EACR,KAAAkL,EACA,KAAMF,EACN,SAAU,SAASN,CAAQ,GAAK,EAChC,WAAAO,EACA,SAAUvC,GAAY,OACtB,WAAYC,GAAc,MACpC,CAAS,CACT,CAAO,EACK3K,EAAO,MAAMkI,EAAI,KAAI,EAC3B,GAAI,CAACA,EAAI,IAAMlI,EAAK,MAAO,MAAM,IAAI,MAAMA,EAAK,OAAS,sBAAsB,EAE/E,MAAM+M,EAAW/M,EAAK,MAAQA,EAC9B,MAAO,CACL,GAAI+M,EAAS,IAAMA,EAAS,YAAc,KAAK,IAAG,EAAG,SAAS,EAAE,EAChE,OAAA1K,EACA,KAAMsB,EAAK,YAAW,EACtB,KAAM,SACN,SAAU,WAAWoJ,EAAS,YAAcE,CAAU,EACtD,MAAO,WAAWF,EAAS,YAAclJ,GAAS,CAAC,EACnD,YAAa,WAAWkJ,EAAS,YAAclJ,GAAS,CAAC,EACzD,UAAW,WAAWkJ,EAAS,cAAgBE,EAAaP,CAAQ,EACpE,OAAQ,SACR,UAAW,IAAI,KAAI,EAAG,YAAW,EACjC,OAAQ,eACR,KAAM,GACN,UAAW,GACX,SAAU,SAASA,CAAQ,EAC3B,WAAYK,EAAS,IAAMA,EAAS,WACpC,iBAAkBA,EAAS,iBAC3B,YAAaA,EAAS,YACtB,OAAQ,MAChB,CACI,OAAS9O,EAAK,CACZ,cAAQ,MAAM,0BAA2BA,EAAI,OAAO,EAC9CA,CACR,CACF,CAMA,MAAM,uBAAuBqM,EAAU,CAAE,WAAAsC,EAAY,OAAAvK,EAAQ,KAAAsB,EAAM,MAAAE,EAAO,SAAA6I,GAAY,CACpF,OAAO,KAAK,oBAAoBpC,EAAU,CACxC,OAAAjI,EAAQ,KAAMsB,IAAS,MAAQ,OAAS,MACxC,SAAU,EAAG,MAAAE,EAAO,SAAA6I,EAAU,OAAQ,QAAS,WAAAE,CACrD,CAAK,CACH,CAGA,MAAM,YAAYtC,EAAUmB,EAASpJ,EAAQ,CAC3C,MAAMkI,EAAO,KAAK,YAAY,IAAID,CAAQ,EAC1C,GAAI,CAACC,EAAM,MAAM,IAAI,MAAM,sBAAsB,EAEjD,GAAIA,EAAK,OAAO,KAAO,UACrB,GAAI,CACF,MAAMlG,EAAS,MAAM,KAAK,sBAAsBkG,EAAK,MAAO,SAAU,gBAAiB,CAAE,OAAAlI,EAAQ,QAAAoJ,CAAO,CAAE,EAC1G,MAAO,CAAE,QAAS,GAAM,QAASpH,EAAO,QAAS,OAAQA,EAAO,MAAM,CACxE,OAASpG,EAAK,CAAE,MAAO,CAAE,QAAS,GAAO,QAASA,EAAI,OAAO,CAAI,CAEnE,GAAIsM,EAAK,OAAO,KAAO,WACrB,GAAI,CACF,aAAM,KAAK,iBAAiBA,EAAK,MAAO,OAAQ,wCAAyC,CAAE,UAAW,CAACkB,CAAO,EAAG,EAC1G,CAAE,QAAS,GAAM,QAAAA,CAAO,CACjC,OAASxN,EAAK,CAAE,MAAO,CAAE,QAAS,GAAO,QAASA,EAAI,OAAO,CAAI,CAEnE,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,aAAM,KAAK,cAAcA,EAAK,MAAO,OAAQ,mBAAoB,CAAE,SAAU,OAAQ,OAAAlI,EAAQ,QAAAoJ,CAAO,CAAE,EAC/F,CAAE,QAAS,GAAM,QAAAA,CAAO,CACjC,OAASxN,EAAK,CAAE,MAAO,CAAE,QAAS,GAAO,QAASA,EAAI,OAAO,CAAI,CAEnE,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,aAAM,KAAK,eAAeA,EAAK,MAAO,yBAA0B,CAAE,KAAMkB,EAAS,EAC1E,CAAE,QAAS,GAAM,QAAAA,CAAO,CACjC,OAASxN,EAAK,CAAE,MAAO,CAAE,QAAS,GAAO,QAASA,EAAI,OAAO,CAAI,CAEnE,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,aAAM,KAAK,eAAeA,EAAK,MAAO,SAAU,kBAAkBkB,CAAO,EAAE,EACpE,CAAE,QAAS,GAAM,QAAAA,CAAO,CACjC,OAASxN,EAAK,CAAE,MAAO,CAAE,QAAS,GAAO,QAASA,EAAI,OAAO,CAAI,CAEnE,GAAIsM,EAAK,OAAO,KAAO,MACrB,GAAI,CACF,aAAM,KAAK,YAAYA,EAAK,MAAO,OAAQ,6BAA8B,CAAE,OAAQlI,EAAQ,MAAOoJ,CAAO,CAAE,EACpG,CAAE,QAAS,GAAM,QAAAA,CAAO,CACjC,OAASxN,EAAK,CAAE,MAAO,CAAE,QAAS,GAAO,QAASA,EAAI,OAAO,CAAI,CAEnE,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,aAAM,KAAK,cAAcA,EAAK,MAAO,OAAQ,gCAAiC,CAAE,OAAAlI,EAAQ,QAAAoJ,EAAS,EAC1F,CAAE,QAAS,GAAM,QAAAA,CAAO,CACjC,OAASxN,EAAK,CAAE,MAAO,CAAE,QAAS,GAAO,QAASA,EAAI,OAAO,CAAI,CAEnE,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,aAAM,KAAK,eAAeA,EAAK,MAAO,OAAQ,kCAAmC,CAAE,OAAAlI,EAAQ,QAAAoJ,EAAS,EAC7F,CAAE,QAAS,GAAM,QAAAA,CAAO,CACjC,OAASxN,EAAK,CAAE,MAAO,CAAE,QAAS,GAAO,QAASA,EAAI,OAAO,CAAI,CAEnE,GAAIsM,EAAK,OAAO,KAAO,OACrB,GAAI,CACF,aAAM,KAAK,aAAaA,EAAK,MAAO,SAAU,gBAAiB,CAAE,OAAAlI,EAAQ,QAAAoJ,EAAS,EAC3E,CAAE,QAAS,GAAM,QAAAA,CAAO,CACjC,OAASxN,EAAK,CAAE,MAAO,CAAE,QAAS,GAAO,QAASA,EAAI,OAAO,CAAI,CAEnE,OAAIsM,EAAK,OAAO,KAAO,SACd,CAAE,QAAS,GAAO,QAAS,sDAAsD,EAGnF,CAAE,QAAS,GAAM,QAAAkB,EAAS,UAAW,EAAI,CAClD,CAGA,MAAM,cAAcnB,EAAUjI,EAAQ,CACpC,MAAMkI,EAAO,KAAK,YAAY,IAAID,CAAQ,EAC1C,GAAI,CAACC,EAAM,MAAM,IAAI,MAAM,sBAAsB,EAEjD,GAAIA,EAAK,OAAO,KAAO,UACrB,GAAI,CACF,MAAM1K,EAASwC,EAAS,CAAE,OAAAA,CAAM,EAAK,GAErC,OADe,MAAM,KAAK,sBAAsBkI,EAAK,MAAO,MAAO,qBAAsB1K,CAAM,GACjF,IAAIqM,GAAC,aAAK,OACtB,IAAI/L,EAAA+L,EAAE,UAAF,YAAA/L,EAAW,WACf,OAAQ+L,EAAE,OACV,MAAM9L,EAAA8L,EAAE,OAAF,YAAA9L,EAAQ,cACd,MAAMC,EAAA6L,EAAE,OAAF,YAAA7L,EAAQ,cACd,SAAU,WAAW6L,EAAE,OAAO,EAC9B,MAAO,WAAWA,EAAE,KAAK,EACzB,UAAW,WAAWA,EAAE,WAAW,EACnC,QAAQ5L,EAAA4L,EAAE,SAAF,YAAA5L,EAAU,cAClB,KAAM,IAAI,KAAK4L,EAAE,IAAI,EAAE,YAAW,CAC5C,EAAU,CACJ,MAAc,CACZ,MAAO,EACT,CAGF,GAAI3B,EAAK,OAAO,KAAO,WACrB,GAAI,CACF,MAAMO,EAAYzI,EACdA,EAAO,QAAQ,oCAAqC,OAAO,EAAE,YAAW,EACxE,OACJ,IAAIhF,EAAM,8DACV,OAAIyN,IAAWzN,GAAO,eAAeyN,CAAS,MACjC,MAAM,KAAK,iBAAiBP,EAAK,MAAO,MAAOlN,CAAG,GAClD,QAAU,IAAI,IAAI6O,GAAC,mBAAK,OACnC,GAAIA,EAAE,SACN,OAAQA,EAAE,WACV,MAAM/L,EAAA+L,EAAE,OAAF,YAAA/L,EAAQ,cACd,MAAMC,EAAA8L,EAAE,aAAF,YAAA9L,EAAc,cACpB,SAAU,aAAWE,GAAAD,EAAA6L,EAAE,sBAAF,YAAA7L,EAAuB,kBAAvB,YAAAC,EAAwC,YAAa,CAAC,EAC3E,MAAO,aAAWuK,GAAAtK,EAAA2L,EAAE,sBAAF,YAAA3L,EAAuB,kBAAvB,YAAAsK,EAAwC,cAAeqB,EAAE,sBAAwB,CAAC,EACpG,UAAW,WAAWA,EAAE,aAAe,CAAC,EACxC,QAAQhB,EAAAgB,EAAE,SAAF,YAAAhB,EAAU,cAClB,KAAMgB,EAAE,YAClB,EAAU,CACJ,OAASjO,EAAK,CACZ,eAAQ,MAAM,kCAAmCA,EAAI,OAAO,EACrD,EACT,CAIF,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,SAAU,MAAM,EAC7BwC,IAAQxC,EAAO,OAASwC,GAC5B,MAAMrC,EAAO,MAAM,KAAK,cAAcuK,EAAK,MAAO,MAAO,qBAAsB1K,CAAM,EACrF,QAAQG,GAAA,YAAAA,EAAM,OAAQ,IAAI,IAAIkM,GAAC,WAAK,OAClC,GAAIA,EAAE,QACN,OAAQA,EAAE,OACV,MAAM/L,EAAA+L,EAAE,OAAF,YAAA/L,EAAQ,cACd,MAAMC,EAAA8L,EAAE,YAAF,YAAA9L,EAAa,cACnB,SAAU,WAAW8L,EAAE,KAAO,CAAC,EAC/B,MAAO,WAAWA,EAAE,OAAS,CAAC,EAC9B,UAAW,WAAWA,EAAE,YAAc,CAAC,EACvC,QAAQ7L,EAAA6L,EAAE,cAAF,YAAA7L,EAAe,cACvB,KAAM6L,EAAE,YAAc,IAAI,KAAK,SAASA,EAAE,WAAW,CAAC,EAAE,YAAW,EAAK,IAClF,EAAU,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,uBAAwBA,EAAI,OAAO,EAAU,EAAI,CAIjF,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAMvK,EAAO,MAAM,KAAK,eAAeuK,EAAK,MAAO,uBAAuB,EACpE4C,GAASnN,GAAA,YAAAA,EAAM,OAAQ,GAC7B,OAAO,OAAO,QAAQmN,CAAM,EAAE,IAAI,CAAC,CAACC,EAAMlB,CAAC,IAAC,mBAAM,OAChD,GAAIkB,EACJ,SAAQjN,EAAA+L,EAAE,QAAF,YAAA/L,EAAS,OAAQ,GACzB,MAAME,GAAAD,EAAA8L,EAAE,QAAF,YAAA9L,EAAS,OAAT,YAAAC,EAAe,cACrB,MAAME,GAAAD,EAAA4L,EAAE,QAAF,YAAA5L,EAAS,YAAT,YAAAC,EAAoB,cAC1B,SAAU,WAAW2L,EAAE,KAAO,CAAC,EAC/B,MAAO,aAAWrB,EAAAqB,EAAE,QAAF,YAAArB,EAAS,QAAS,CAAC,EACrC,UAAW,WAAWqB,EAAE,UAAY,CAAC,EACrC,SAAQhB,EAAAgB,EAAE,SAAF,YAAAhB,EAAU,gBAAiB,OACnC,KAAMgB,EAAE,OAAS,IAAI,KAAKA,EAAE,OAAS,GAAI,EAAE,YAAW,EAAK,IACrE,EAAU,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,wBAAyBA,EAAI,OAAO,EAAU,EAAI,CAIlF,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,OAAQ,QAAQ,EAC7BwC,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,GAC5F,MAAMrC,EAAO,MAAM,KAAK,eAAeuK,EAAK,MAAO,MAAO,iBAAkB1K,CAAM,EAElF,OADc,MAAM,QAAQG,GAAA,YAAAA,EAAM,KAAK,EAAIA,EAAK,MAAS,MAAM,QAAQA,CAAI,EAAIA,EAAO,IACzE,IAAIkM,GAAC,SAAK,OACrB,GAAIA,EAAE,GACN,OAAQA,EAAE,OACV,MAAM/L,EAAA+L,EAAE,OAAF,YAAA/L,EAAQ,cACd,MAAMC,EAAA8L,EAAE,OAAF,YAAA9L,EAAQ,cACd,SAAU,WAAW8L,EAAE,MAAQ,CAAC,EAChC,MAAO,WAAWA,EAAE,OAAS,CAAC,EAC9B,UAAW,WAAWA,EAAE,UAAY,CAAC,EACrC,OAAQA,EAAE,SAAW,OAAS,OAC9B,KAAMA,EAAE,UAAY,IAAI,KAAK,SAASA,EAAE,SAAS,CAAC,EAAE,YAAW,EAAK,IAC9E,EAAU,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,wBAAyBA,EAAI,OAAO,EAAU,EAAI,CAIlF,GAAIsM,EAAK,OAAO,KAAO,MACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,SAAU,MAAM,EAC7BwC,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,GAC5F,MAAMrC,EAAO,MAAM,KAAK,YAAYuK,EAAK,MAAO,MAAO,+BAAgC1K,CAAM,EAE7F,OADc,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC9B,IAAIkM,GAAC,WAAK,OACrB,GAAIA,EAAE,MACN,OAAQA,EAAE,OACV,MAAM/L,EAAA+L,EAAE,OAAF,YAAA/L,EAAQ,cACd,MAAMC,EAAA8L,EAAE,UAAF,YAAA9L,EAAW,cACjB,SAAU,WAAW8L,EAAE,IAAM,CAAC,EAC9B,MAAO,WAAWA,EAAE,IAAM,CAAC,EAC3B,UAAW,WAAWA,EAAE,WAAa,CAAC,EACtC,SAAQ7L,EAAA6L,EAAE,QAAF,YAAA7L,EAAS,gBAAiB,OAClC,KAAM6L,EAAE,MAAQ,IAAI,KAAK,SAASA,EAAE,KAAK,CAAC,EAAE,YAAW,EAAK,IACtE,EAAU,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,qBAAsBA,EAAI,OAAO,EAAU,EAAI,CAI/E,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,MAAM1K,EAAS,GACXwC,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,GAC5F,MAAMrC,EAAO,MAAM,KAAK,cAAcuK,EAAK,MAAO,MAAO,oCAAqC1K,CAAM,EAEpG,QADeG,GAAA,YAAAA,EAAM,UAAW,MAAM,QAAQA,CAAI,EAAIA,EAAO,KAC/C,IAAIkM,GAAC,aAAK,OACtB,IAAI/L,EAAA+L,EAAE,UAAF,YAAA/L,EAAW,WACf,OAAQ+L,EAAE,OACV,MAAM9L,EAAA8L,EAAE,OAAF,YAAA9L,EAAQ,cACd,MAAMC,EAAA6L,EAAE,OAAF,YAAA7L,EAAQ,cACd,SAAU,WAAW6L,EAAE,SAAW,CAAC,EACnC,MAAO,WAAWA,EAAE,OAAS,CAAC,EAC9B,UAAW,WAAWA,EAAE,aAAe,CAAC,EACxC,SAAQ5L,EAAA4L,EAAE,SAAF,YAAA5L,EAAU,gBAAiB,OACnC,KAAM4L,EAAE,KAAO,IAAI,KAAK,SAASA,EAAE,IAAI,CAAC,EAAE,YAAW,EAAK,IACpE,EAAU,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,uBAAwBA,EAAI,OAAO,EAAU,EAAI,CAIjF,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAM1K,EAAS,GACXwC,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,MAAM,EAAE,YAAW,GAC3F,MAAMrC,EAAO,MAAM,KAAK,eAAeuK,EAAK,MAAO,MAAO,qCAAsC1K,CAAM,EAEtG,OADc,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC9B,IAAIkM,GAAC,WAAK,OACrB,GAAIA,EAAE,QACN,OAAQA,EAAE,OACV,MAAM/L,EAAA+L,EAAE,OAAF,YAAA/L,EAAQ,cACd,MAAMC,EAAA8L,EAAE,YAAF,YAAA9L,EAAa,cACnB,SAAU,WAAW8L,EAAE,MAAQ,CAAC,EAChC,MAAO,WAAWA,EAAE,OAAS,CAAC,EAC9B,UAAW,WAAWA,EAAE,YAAc,CAAC,EACvC,SAAQ7L,EAAA6L,EAAE,SAAF,YAAA7L,EAAU,gBAAiB,OACnC,KAAM6L,EAAE,MAAQ,IAAI,KAAK,SAASA,EAAE,KAAK,CAAC,EAAE,YAAW,EAAK,IACtE,EAAU,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,wBAAyBA,EAAI,OAAO,EAAU,EAAI,CAIlF,GAAIsM,EAAK,OAAO,KAAO,OACrB,GAAI,CACF,MAAM1K,EAAS,GACXwC,IAAQxC,EAAO,OAASwC,GAC5B,MAAMrC,EAAO,MAAM,KAAK,aAAauK,EAAK,MAAO,MAAO,qBAAsB1K,CAAM,EAEpF,OADe,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC9B,IAAIkM,GAAC,aAAK,OACtB,IAAI/L,EAAA+L,EAAE,UAAF,YAAA/L,EAAW,WACf,OAAQ+L,EAAE,OACV,MAAM9L,EAAA8L,EAAE,OAAF,YAAA9L,EAAQ,cACd,MAAMC,EAAA6L,EAAE,OAAF,YAAA7L,EAAQ,cACd,SAAU,WAAW6L,EAAE,SAAW,CAAC,EACnC,MAAO,WAAWA,EAAE,OAAS,CAAC,EAC9B,UAAW,WAAWA,EAAE,aAAe,CAAC,EACxC,SAAQ5L,EAAA4L,EAAE,SAAF,YAAA5L,EAAU,gBAAiB,OACnC,KAAM4L,EAAE,KAAO,IAAI,KAAKA,EAAE,IAAI,EAAE,YAAW,EAAK,IAC1D,EAAU,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,sBAAuBA,EAAI,OAAO,EAAU,EAAI,CAGhF,MAAO,EACT,CAGA,MAAM,gBAAgBqM,EAAUjI,EAAQgL,EAAQ,GAAI,CAClD,MAAM9C,EAAO,KAAK,YAAY,IAAID,CAAQ,EAC1C,GAAI,CAACC,EAAM,MAAM,IAAI,MAAM,sBAAsB,EAEjD,MAAM+C,EAAY,CAACpB,EAAGqB,IAAM,OAAM,OAChC,KAAIpN,EAAA+L,EAAEqB,EAAO,EAAE,IAAX,YAAApN,EAAc,aAAc,GAChC,OAAQ+L,EAAEqB,EAAO,MAAM,GAAK,GAC5B,MAAOrB,EAAEqB,EAAO,IAAI,GAAK,IAAI,YAAW,EACxC,MAAOrB,EAAEqB,EAAO,IAAI,GAAK,IAAI,YAAW,EACxC,SAAU,WAAWrB,EAAEqB,EAAO,GAAG,GAAK,CAAC,EACvC,MAAO,WAAWrB,EAAEqB,EAAO,KAAK,GAAK,CAAC,EACtC,UAAW,WAAWrB,EAAEqB,EAAO,SAAS,GAAK,CAAC,EAC9C,SAAU,WAAWrB,EAAEqB,EAAO,QAAQ,GAAKrB,EAAEqB,EAAO,KAAK,GAAK,CAAC,EAC/D,QAASrB,EAAEqB,EAAO,MAAM,GAAK,UAAU,YAAW,EAClD,KAAMA,EAAO,OAASA,EAAO,OAAOrB,CAAC,EAAI,IAC/C,GAGI,GAAI3B,EAAK,OAAO,KAAO,UACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,MAAAwN,CAAK,EAClBhL,IAAQxC,EAAO,OAASwC,GAC5B,MAAMrC,EAAO,MAAM,KAAK,sBAAsBuK,EAAK,MAAO,MAAO,oBAAqB1K,CAAM,EAE5F,OADe,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC9B,OAAOkM,GAAKA,EAAE,SAAW,OAASA,EAAE,SAAW,kBAAkB,EAAE,IAAIA,GAAKoB,EAAUpB,EAAG,CACrG,GAAI,UAAW,OAAQ,SAAU,KAAM,OAAQ,KAAM,OACrD,IAAK,UAAW,MAAO,QAAS,UAAW,cAAe,SAAU,QACpE,OAAQ,SAAU,OAASA,GAAMA,EAAE,KAAO,IAAI,KAAKA,EAAE,IAAI,EAAE,YAAW,EAAK,IACrF,CAAS,CAAC,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,2BAA4BA,EAAI,OAAO,EAAU,EAAI,CAIrF,GAAIsM,EAAK,OAAO,KAAO,WACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,aAAc,CAAC,SAAU,YAAa,SAAS,EAAG,MAAAwN,CAAK,EACpEhL,IAAQxC,EAAO,WAAawC,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,GAChG,MAAMrC,EAAO,MAAM,KAAK,iBAAiBuK,EAAK,MAAO,MAAO,4CAA6C1K,CAAM,EAC/G,QAAQG,GAAA,YAAAA,EAAM,SAAU,IAAI,IAAIkM,GAAKoB,EAAUpB,EAAG,CAChD,GAAI,WAAY,OAAQ,aAAc,KAAM,OAAQ,KAAM,aAC1D,IAAK,YAAa,MAAO,uBAAwB,UAAW,cAAe,SAAU,uBACrF,OAAQ,SAAU,OAASA,GAAMA,EAAE,cAAgB,IAC7D,CAAS,CAAC,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,4BAA6BA,EAAI,OAAO,EAAU,EAAI,CAItF,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,SAAU,OAAQ,MAAOwN,EAAM,UAAU,EACtDhL,IAAQxC,EAAO,OAASwC,GAC5B,MAAMrC,EAAO,MAAM,KAAK,cAAcuK,EAAK,MAAO,MAAO,oBAAqB1K,CAAM,EACpF,QAAQG,GAAA,YAAAA,EAAM,OAAQ,IAAI,IAAIkM,GAAKoB,EAAUpB,EAAG,CAC9C,GAAI,UAAW,OAAQ,SAAU,KAAM,OAAQ,KAAM,YACrD,IAAK,MAAO,MAAO,QAAS,UAAW,aAAc,SAAU,WAC/D,OAAQ,cAAe,OAASA,GAAMA,EAAE,YAAc,IAAI,KAAK,SAASA,EAAE,WAAW,CAAC,EAAE,YAAW,EAAK,IAClH,CAAS,CAAC,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,yBAA0BA,EAAI,OAAO,EAAU,EAAI,CAInF,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAMvK,EAAO,MAAM,KAAK,eAAeuK,EAAK,MAAO,yBAAyB,EACtE4C,GAASnN,GAAA,YAAAA,EAAM,SAAU,GAC/B,OAAO,OAAO,QAAQmN,CAAM,EAAE,MAAM,EAAGE,CAAK,EAAE,IAAI,CAAC,CAACD,EAAMlB,CAAC,IAAC,eAAM,OAChE,GAAIkB,EACJ,SAAQjN,EAAA+L,EAAE,QAAF,YAAA/L,EAAS,OAAQ,GACzB,QAAOC,EAAA8L,EAAE,QAAF,YAAA9L,EAAS,OAAQ,IAAI,YAAW,EACvC,QAAOC,EAAA6L,EAAE,QAAF,YAAA7L,EAAS,YAAa,IAAI,YAAW,EAC5C,SAAU,WAAW6L,EAAE,KAAO,CAAC,EAC/B,MAAO,aAAW5L,EAAA4L,EAAE,QAAF,YAAA5L,EAAS,QAAS,CAAC,EACrC,UAAW,WAAW4L,EAAE,UAAY,CAAC,EACrC,SAAU,WAAWA,EAAE,SAAS3L,EAAA2L,EAAE,QAAF,YAAA3L,EAAS,QAAS,CAAC,EACnD,QAAS2L,EAAE,QAAU,UAAU,YAAW,EAC1C,KAAMA,EAAE,QAAU,IAAI,KAAKA,EAAE,QAAU,GAAI,EAAE,YAAW,EAAK,IACvE,EAAU,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,0BAA2BA,EAAI,OAAO,EAAU,EAAI,CAIpF,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,OAAQ,MAAM,EAC3BwC,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,GAC5F,MAAMrC,EAAO,MAAM,KAAK,eAAeuK,EAAK,MAAO,MAAO,iBAAkB1K,CAAM,EAElF,OADc,MAAM,QAAQG,GAAA,YAAAA,EAAM,KAAK,EAAIA,EAAK,MAAS,MAAM,QAAQA,CAAI,EAAIA,EAAO,IACzE,MAAM,EAAGqN,CAAK,EAAE,IAAInB,GAAKoB,EAAUpB,EAAG,CACjD,GAAI,KAAM,OAAQ,SAAU,KAAM,OAAQ,KAAM,OAChD,IAAK,OAAQ,MAAO,QAAS,UAAW,WAAY,SAAU,YAC9D,OAAQ,SAAU,OAASA,GAAMA,EAAE,UAAY,IAAI,KAAK,SAASA,EAAE,SAAS,CAAC,EAAE,YAAW,EAAK,IACzG,CAAS,CAAC,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,0BAA2BA,EAAI,OAAO,EAAU,EAAI,CAIpF,GAAIsM,EAAK,OAAO,KAAO,MACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,SAAU,MAAM,EAC7BwC,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,GAC5F,MAAMrC,EAAO,MAAM,KAAK,YAAYuK,EAAK,MAAO,MAAO,uCAAwC1K,CAAM,EAErG,OADc,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC9B,MAAM,EAAGqN,CAAK,EAAE,IAAInB,GAAKoB,EAAUpB,EAAG,CACjD,GAAI,QAAS,OAAQ,SAAU,KAAM,OAAQ,KAAM,UACnD,IAAK,KAAM,MAAO,KAAM,UAAW,YAAa,SAAU,QAC1D,OAAQ,QAAS,OAASA,GAAMA,EAAE,MAAQ,IAAI,KAAK,SAASA,EAAE,KAAK,CAAC,EAAE,YAAW,EAAK,IAChG,CAAS,CAAC,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,uBAAwBA,EAAI,OAAO,EAAU,EAAI,CAIjF,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,MAAOwN,EAAM,SAAQ,CAAE,EACpChL,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,GAC5F,MAAMrC,EAAO,MAAM,KAAK,cAAcuK,EAAK,MAAO,MAAO,uCAAwC1K,CAAM,EAEvG,QADeG,GAAA,YAAAA,EAAM,UAAW,MAAM,QAAQA,CAAI,EAAIA,EAAO,KAC/C,IAAIkM,GAAKoB,EAAUpB,EAAG,CAClC,GAAI,UAAW,OAAQ,SAAU,KAAM,OAAQ,KAAM,OACrD,IAAK,UAAW,MAAO,QAAS,UAAW,cAAe,SAAU,WACpE,OAAQ,SAAU,OAASA,GAAMA,EAAE,KAAO,IAAI,KAAK,SAASA,EAAE,IAAI,CAAC,EAAE,YAAW,EAAK,IAC/F,CAAS,CAAC,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,yBAA0BA,EAAI,OAAO,EAAU,EAAI,CAInF,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,MAAOwN,EAAM,SAAQ,CAAE,EACpChL,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,MAAM,EAAE,YAAW,GAC3F,MAAMrC,EAAO,MAAM,KAAK,eAAeuK,EAAK,MAAO,MAAO,oCAAqC1K,CAAM,EAErG,OADc,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC9B,IAAIkM,GAAKoB,EAAUpB,EAAG,CACjC,GAAI,UAAW,OAAQ,SAAU,KAAM,OAAQ,KAAM,YACrD,IAAK,OAAQ,MAAO,QAAS,UAAW,aAAc,SAAU,WAChE,OAAQ,SAAU,OAASA,GAAMA,EAAE,MAAQ,IAAI,KAAK,SAASA,EAAE,KAAK,CAAC,EAAE,YAAW,EAAK,IACjG,CAAS,CAAC,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,0BAA2BA,EAAI,OAAO,EAAU,EAAI,CAIpF,GAAIsM,EAAK,OAAO,KAAO,OACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,MAAAwN,CAAK,EAClBhL,IAAQxC,EAAO,OAASwC,GAC5B,MAAMrC,EAAO,MAAM,KAAK,aAAauK,EAAK,MAAO,MAAO,oBAAqB1K,CAAM,EAEnF,OADe,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC9B,OAAOkM,GAAKA,EAAE,SAAW,KAAK,EAAE,IAAIA,GAAKoB,EAAUpB,EAAG,CAClE,GAAI,UAAW,OAAQ,SAAU,KAAM,OAAQ,KAAM,OACrD,IAAK,UAAW,MAAO,QAAS,UAAW,cAAe,SAAU,QACpE,OAAQ,SAAU,OAASA,GAAMA,EAAE,KAAO,IAAI,KAAKA,EAAE,IAAI,EAAE,YAAW,EAAK,IACrF,CAAS,CAAC,CACJ,OAASjO,EAAK,CAAE,eAAQ,MAAM,wBAAyBA,EAAI,OAAO,EAAU,EAAI,CAGlF,MAAO,EACT,CAGA,MAAM,gBAAgBqM,EAAUjI,EAAQgL,EAAQ,GAAI,CAClD,MAAM9C,EAAO,KAAK,YAAY,IAAID,CAAQ,EAC1C,GAAI,CAACC,EAAM,MAAM,IAAI,MAAM,sBAAsB,EAEjD,GAAIA,EAAK,OAAO,KAAO,UACrB,GAAI,CAEF,OADe,MAAM,KAAK,sBAAsBA,EAAK,MAAO,MAAO,mBAAoB,CAAE,OAAAlI,EAAQ,MAAAgL,CAAK,CAAE,GAC1F,IAAIG,GAAC,SAAK,OACtB,IAAIrN,EAAAqN,EAAE,KAAF,YAAArN,EAAM,WACV,SAASC,EAAAoN,EAAE,UAAF,YAAApN,EAAW,WACpB,OAAQoN,EAAE,OACV,KAAMA,EAAE,QAAU,MAAQ,OAC1B,MAAO,WAAWA,EAAE,KAAK,EACzB,SAAU,WAAWA,EAAE,GAAG,EAC1B,WAAY,WAAWA,EAAE,UAAU,EACnC,gBAAiBA,EAAE,gBACnB,KAAM,IAAI,KAAKA,EAAE,IAAI,EAAE,YAAW,EAClC,QAASA,EAAE,OACrB,EAAU,CACJ,MAAc,CACZ,MAAO,EACT,CAGF,GAAIjD,EAAK,OAAO,KAAO,WACrB,GAAI,CACF,MAAMO,EAAYzI,EACdA,EAAO,QAAQ,oCAAqC,OAAO,EAAE,YAAW,EACxE,OACJ,IAAIhF,EAAM,mDAAmDgQ,CAAK,GAClE,OAAIvC,IAAWzN,GAAO,eAAeyN,CAAS,MACjC,MAAM,KAAK,iBAAiBP,EAAK,MAAO,MAAOlN,CAAG,GAElD,OAAS,IAAI,IAAIoQ,GAAC,WAAK,OAClC,GAAIA,EAAE,UAAYA,EAAE,SACpB,QAASA,EAAE,SACX,OAAQA,EAAE,WACV,MAAMtN,EAAAsN,EAAE,OAAF,YAAAtN,EAAQ,cACd,MAAO,WAAWsN,EAAE,OAAS,CAAC,EAC9B,SAAU,WAAWA,EAAE,MAAQA,EAAE,eAAiB,CAAC,EACnD,WAAY,WAAWA,EAAE,YAAc,CAAC,EACxC,kBAAiBpN,GAAAD,EAAAqN,EAAE,aAAF,YAAArN,EAAc,MAAM,OAApB,YAAAC,EAA2B,KAAM,MAClD,KAAMoN,EAAE,WACR,QAAS,EACnB,EAAU,CACJ,OAASxP,EAAK,CACZ,eAAQ,MAAM,oCAAqCA,EAAI,OAAO,EACvD,EACT,CAIF,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,SAAU,OAAQ,MAAOwN,EAAM,UAAU,EACtDhL,IAAQxC,EAAO,OAASwC,GAC5B,MAAMrC,EAAO,MAAM,KAAK,cAAcuK,EAAK,MAAO,MAAO,qBAAsB1K,CAAM,EACrF,QAAQG,GAAA,YAAAA,EAAM,OAAQ,IAAI,IAAI,GAAC,OAAK,OAClC,GAAI,EAAE,OACN,QAAS,EAAE,QACX,OAAQ,EAAE,OACV,MAAMG,EAAA,EAAE,OAAF,YAAAA,EAAQ,cACd,MAAO,WAAW,EAAE,WAAa,CAAC,EAClC,SAAU,WAAW,EAAE,SAAW,CAAC,EACnC,WAAY,WAAW,EAAE,SAAW,CAAC,EACrC,gBAAiB,EAAE,aAAe,GAClC,KAAM,EAAE,SAAW,IAAI,KAAK,SAAS,EAAE,QAAQ,CAAC,EAAE,YAAW,EAAK,KAClE,QAAS,EAAE,UAAY,QAAU,EAAE,UAAY,EACzD,EAAU,CACJ,OAASlC,EAAK,CAAE,eAAQ,MAAM,yBAA0BA,EAAI,OAAO,EAAU,EAAI,CAInF,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAMvK,EAAO,MAAM,KAAK,eAAeuK,EAAK,MAAO,0BAA0B,EACvEmD,GAAS1N,GAAA,YAAAA,EAAM,SAAU,GAC/B,OAAO,OAAO,QAAQ0N,CAAM,EAAE,MAAM,EAAGL,CAAK,EAAE,IAAI,CAAC,CAACD,EAAMI,CAAC,IAAC,OAAM,OAChE,GAAIJ,EACJ,QAASI,EAAE,UACX,OAAQA,EAAE,KACV,MAAMrN,EAAAqN,EAAE,OAAF,YAAArN,EAAQ,cACd,MAAO,WAAWqN,EAAE,OAAS,CAAC,EAC9B,SAAU,WAAWA,EAAE,KAAO,CAAC,EAC/B,WAAY,WAAWA,EAAE,KAAO,CAAC,EACjC,gBAAiB,GACjB,KAAMA,EAAE,KAAO,IAAI,KAAKA,EAAE,KAAO,GAAI,EAAE,YAAW,EAAK,KACvD,QAASA,EAAE,QAAU,EAC/B,EAAU,CACJ,OAASvP,EAAK,CAAE,eAAQ,MAAM,0BAA2BA,EAAI,OAAO,EAAU,EAAI,CAIpF,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAM1K,EAAS,GACXwC,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,GAC5F,MAAMrC,EAAO,MAAM,KAAK,eAAeuK,EAAK,MAAO,MAAO,gBAAiB1K,CAAM,EAEjF,OADc,MAAM,QAAQG,GAAA,YAAAA,EAAM,KAAK,EAAIA,EAAK,MAAS,MAAM,QAAQA,CAAI,EAAIA,EAAO,IACzE,MAAM,EAAGqN,CAAK,EAAE,IAAIG,GAAC,OAAK,OACrC,GAAIA,EAAE,SAAWA,EAAE,GACnB,QAASA,EAAE,QACX,OAAQA,EAAE,OACV,MAAMrN,EAAAqN,EAAE,OAAF,YAAArN,EAAQ,cACd,MAAO,WAAWqN,EAAE,OAAS,CAAC,EAC9B,SAAU,WAAWA,EAAE,MAAQ,CAAC,EAChC,WAAY,WAAWA,EAAE,KAAO,CAAC,EACjC,gBAAiBA,EAAE,aAAe,GAClC,KAAMA,EAAE,UAAY,IAAI,KAAK,SAASA,EAAE,SAAS,CAAC,EAAE,YAAW,EAAK,KACpE,QAASA,EAAE,YAAc,OACnC,EAAU,CACJ,OAASvP,EAAK,CAAE,eAAQ,MAAM,0BAA2BA,EAAI,OAAO,EAAU,EAAI,CAIpF,GAAIsM,EAAK,OAAO,KAAO,MACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,SAAU,MAAM,EAC7BwC,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,GAC5F,MAAMrC,EAAO,MAAM,KAAK,YAAYuK,EAAK,MAAO,MAAO,8BAA+B1K,CAAM,EAE5F,OADc,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC9B,MAAM,EAAGqN,CAAK,EAAE,IAAIG,GAAC,OAAK,OACrC,GAAIA,EAAE,SAAWA,EAAE,OACnB,QAASA,EAAE,MACX,OAAQA,EAAE,OACV,MAAMrN,EAAAqN,EAAE,OAAF,YAAArN,EAAQ,cACd,MAAO,WAAWqN,EAAE,QAAU,CAAC,EAC/B,SAAU,WAAWA,EAAE,QAAU,CAAC,EAClC,WAAY,KAAK,IAAI,WAAWA,EAAE,KAAO,CAAC,CAAC,EAC3C,gBAAiBA,EAAE,QAAU,GAC7B,KAAMA,EAAE,GAAK,IAAI,KAAK,SAASA,EAAE,EAAE,CAAC,EAAE,YAAW,EAAK,KACtD,QAASA,EAAE,WAAa,GAClC,EAAU,CACJ,OAASvP,EAAK,CAAE,eAAQ,MAAM,uBAAwBA,EAAI,OAAO,EAAU,EAAI,CAIjF,GAAIsM,EAAK,OAAO,KAAO,QACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,MAAOwN,EAAM,SAAQ,CAAE,EACpChL,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,OAAO,EAAE,YAAW,GAC5F,MAAMrC,EAAO,MAAM,KAAK,cAAcuK,EAAK,MAAO,MAAO,uCAAwC1K,CAAM,EAEvG,QADeG,GAAA,YAAAA,EAAM,UAAW,MAAM,QAAQA,CAAI,EAAIA,EAAO,KAC/C,IAAIwN,GAAC,WAAK,OACtB,IAAIrN,EAAAqN,EAAE,UAAF,YAAArN,EAAW,WACf,SAASC,EAAAoN,EAAE,UAAF,YAAApN,EAAW,WACpB,OAAQoN,EAAE,OACV,MAAMnN,EAAAmN,EAAE,OAAF,YAAAnN,EAAQ,cACd,MAAO,WAAWmN,EAAE,OAASA,EAAE,UAAY,CAAC,EAC5C,SAAU,WAAWA,EAAE,aAAeA,EAAE,SAAW,CAAC,EACpD,WAAY,WAAWA,EAAE,YAAc,CAAC,EACxC,gBAAiBA,EAAE,iBAAmB,GACtC,KAAMA,EAAE,KAAO,IAAI,KAAK,SAASA,EAAE,IAAI,CAAC,EAAE,YAAW,EAAK,KAC1D,QAAS,EACnB,EAAU,CACJ,OAASvP,EAAK,CAAE,eAAQ,MAAM,yBAA0BA,EAAI,OAAO,EAAU,EAAI,CAInF,GAAIsM,EAAK,OAAO,KAAO,SACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,MAAOwN,EAAM,SAAQ,CAAE,EACpChL,IAAQxC,EAAO,OAASwC,EAAO,QAAQ,4BAA6B,MAAM,EAAE,YAAW,GAC3F,MAAMrC,EAAO,MAAM,KAAK,eAAeuK,EAAK,MAAO,MAAO,2BAA4B1K,CAAM,EAE5F,OADc,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC9B,IAAIwN,GAAC,OAAK,OACrB,GAAIA,EAAE,SAAWA,EAAE,OACnB,QAASA,EAAE,QACX,OAAQA,EAAE,OACV,MAAMrN,EAAAqN,EAAE,OAAF,YAAArN,EAAQ,cACd,MAAO,WAAWqN,EAAE,UAAYA,EAAE,OAAS,CAAC,EAC5C,SAAU,WAAWA,EAAE,MAAQ,CAAC,EAChC,WAAY,WAAWA,EAAE,MAAQA,EAAE,KAAO,CAAC,EAC3C,gBAAiBA,EAAE,QAAU,GAC7B,KAAMA,EAAE,MAAQ,IAAI,KAAK,SAASA,EAAE,KAAK,CAAC,EAAE,YAAW,EAAK,KAC5D,QAASA,EAAE,aAAe,OACpC,EAAU,CACJ,OAASvP,EAAK,CAAE,eAAQ,MAAM,0BAA2BA,EAAI,OAAO,EAAU,EAAI,CAIpF,GAAIsM,EAAK,OAAO,KAAO,OACrB,GAAI,CACF,MAAM1K,EAAS,CAAE,MAAAwN,CAAK,EAClBhL,IAAQxC,EAAO,OAASwC,GAC5B,MAAMrC,EAAO,MAAM,KAAK,aAAauK,EAAK,MAAO,MAAO,mBAAoB1K,CAAM,EAElF,OADe,MAAM,QAAQG,CAAI,EAAIA,EAAO,IAC9B,IAAIwN,GAAC,SAAK,OACtB,IAAIrN,EAAAqN,EAAE,KAAF,YAAArN,EAAM,WACV,SAASC,EAAAoN,EAAE,UAAF,YAAApN,EAAW,WACpB,OAAQoN,EAAE,OACV,KAAMA,EAAE,QAAU,MAAQ,OAC1B,MAAO,WAAWA,EAAE,OAAS,CAAC,EAC9B,SAAU,WAAWA,EAAE,KAAO,CAAC,EAC/B,WAAY,WAAWA,EAAE,YAAc,CAAC,EACxC,gBAAiBA,EAAE,iBAAmB,GACtC,KAAMA,EAAE,KAAO,IAAI,KAAKA,EAAE,IAAI,EAAE,YAAW,EAAK,KAChD,QAASA,EAAE,UAAY,EACjC,EAAU,CACJ,OAASvP,EAAK,CAAE,eAAQ,MAAM,wBAAyBA,EAAI,OAAO,EAAU,EAAI,CAGlF,MAAO,EACT,CAGA,MAAM,gBAAgBoE,EAAQ,aAC5B,GAAI,CAEF,MAAMsL,GAAaxN,GADN,MAAM,KAAK,sBAAsB,uBAAwB,CAAE,OAAAkC,EAAQ,GACxD,UAAL,YAAAlC,EAAe,GAClC,GAAI,CAACwN,EAAY,OAAO,KAExB,MAAMC,GAAUxN,EAAAuN,EAAW,UAAX,YAAAvN,EAAoB,KAAKqN,GAAKA,EAAE,aAAe,YACzDI,GAAcxN,EAAAsN,EAAW,UAAX,YAAAtN,EAAoB,KAAKoN,GAAKA,EAAE,aAAe,gBAC7DK,GAAcxN,EAAAqN,EAAW,UAAX,YAAArN,EAAoB,KAAKmN,GAAKA,EAAE,aAAe,YAAcA,EAAE,aAAe,gBAElG,MAAO,CACL,OAAQE,EAAW,OACnB,OAAQA,EAAW,OACnB,UAAWA,EAAW,UACtB,WAAYA,EAAW,WACvB,OAAQC,EAAU,WAAWA,EAAQ,MAAM,EAAI,EAC/C,OAAQA,EAAU,WAAWA,EAAQ,MAAM,EAAI,IAC/C,SAAUA,EAAU,WAAWA,EAAQ,QAAQ,EAAI,EACnD,SAAUC,EAAc,WAAWA,EAAY,QAAQ,EAAI,EAC3D,SAAUA,EAAc,WAAWA,EAAY,QAAQ,EAAI,EAC3D,YAAaC,EAAc,WAAWA,EAAY,aAAeA,EAAY,QAAQ,EAAI,CACjG,CACI,MAAQ,CACN,OAAO,IACT,CACF,CAGA,YAAYxD,EAAU,CACpB,OAAO,KAAK,YAAY,IAAIA,CAAQ,CACtC,CAGA,cAAcA,EAAU,CACtB,OAAO,KAAK,YAAY,IAAIA,CAAQ,CACtC,CAGA,WAAWA,EAAU,CACnB,KAAK,YAAY,OAAOA,CAAQ,CAClC,CACF,CAEY,MAACyD,GAAgB,IAAI9I","names":["AGGREGATOR_0X","AGGREGATOR_1INCH","AGGREGATOR_PARASWAP","KAIROS_FEE_RECIPIENT","KAIROS_FEE_BPS","RESILIENCE","_circuitState","_recordSuccess","aggName","_recordFailure","state","_isCircuitOpen","_fetchWithTimeout","url","options","timeoutMs","_","reject","_withRetry","fn","maxRetries","delayMs","label","lastError","attempt","err","r","EXECUTION_MODE","CHAIN_CONFIG","TOKEN_ADDRESSES","ERC20_ABI","ROUTER_ABI","ethersLib","getEthers","__vitePreload","WalletBrokerService","mode","chainId","tokenIn","tokenOut","amountInWei","aggregators","available","a","validQuotes","agg","quote","b","aBuy","bBuy","best","q","endpoint","params","response","error","data","sources","s","_a","_b","_c","_d","_e","priceParams","priceResp","bestRoute","e","wallet","ethers","config","isNativeIn","activeQuote","freshQuote","txResp","txData","tokenContract","gasLimit","tx","receipt","rpc","provider","privateKey","key","symbolOrAddress","tokens","upper","cleaned","walletAddress","balance","nativeBalance","balances","formatted","symbol","address","contract","decimals","amountIn","tokenInAddr","tokenOutAddr","decimalsIn","decimalsOut","aggQuote","formattedOut","effectivePrice","directQuote","savings","directResult","router","paths","path","amounts","amountOut","amountOutNum","order","side","quantity","price","baseToken","quoteToken","pairMatch","baseAddr","quoteAddr","amountInRaw","isNativeOut","result","expectedOut","minOut","deadline","txParams","sendTransaction","txHash","isConnected","getConnectedAccount","name","walletBroker","KAIROS_API","BrokerService","broker","derivedPwd","useStore","decryptField","val","decryptKey","creds","method","keyName","privateKeyPem","header","now","uri","payload","toB64url","str","objToB64url","obj","bufToB64url","buf","headerB64","payloadB64","signingInput","sig","pem","pemClean","der","c","d","pubPoint","bytesToB64url","bytes","jwk","i","sec1Der","octetLen","algoId","ver","octetHeader","totalInner","seqHeader","pkcs8","off","tag","len","body","jwt","proxyUrl","res","text","secret","message","encoder","signature","isB64Secret","keyData","bin","secretB64","msgData","hash","headers","timestamp","recvWindow","queryString","bodyStr","v","k","preSign","BROKERS","nonce","postData","sha256Hash","pathBytes","sigInput","passphrase","allParams","signedQuery","account","accounts","coins","assets","count","bal","acct","brokerId","conn","krakenMap","type","stopLoss","takeProfit","binanceType","_f","productId","orderConfig","orderBody","errMsg","_g","_h","_i","errDetail","_j","_k","orderResult","orderId","filledPrice","filledQty","orderStatus","details","ord","detailErr","orderParams","detail","o","_l","krakenPair","_m","_n","_o","_p","_q","leverage","action","positionId","execRoute","apiBase","position","leveragedSide","collateral","pair","orders","txid","limit","normalize","fields","t","f","trades","symbolInfo","lotSize","priceFilter","minNotional","brokerService"],"ignoreList":[],"sources":["../../src/services/walletBroker.js","../../src/services/broker.js"],"sourcesContent":["// Kairos Trade  Wallet/DEX Broker Service (Resilient v2.0)\n// Ultra-reliable DEX execution: Multi-aggregator + Retry + Circuit Breaker + Timeout\n// Zero-downtime design: if ALL aggregators fail  direct DEX router fallback\n// Uses ethers.js for blockchain interaction\n\n// \n//  MULTI-AGGREGATOR CONFIG  Redundant price sources\n// \n\n// Primary: 0x Protocol (100+ DEXes per chain)\nconst AGGREGATOR_0X = {\n  name: '0x',\n  endpoints: {\n    56:    'https://bsc.api.0x.org',\n    1:     'https://api.0x.org',\n    137:   'https://polygon.api.0x.org',\n    42161: 'https://arbitrum.api.0x.org',\n    8453:  'https://base.api.0x.org',\n  },\n};\n\n// Secondary: 1inch API (fallback aggregator)\nconst AGGREGATOR_1INCH = {\n  name: '1inch',\n  endpoints: {\n    56:    'https://api.1inch.dev/swap/v6.0/56',\n    1:     'https://api.1inch.dev/swap/v6.0/1',\n    137:   'https://api.1inch.dev/swap/v6.0/137',\n    42161: 'https://api.1inch.dev/swap/v6.0/42161',\n    8453:  'https://api.1inch.dev/swap/v6.0/8453',\n  },\n};\n\n// Tertiary: Paraswap (second fallback)\nconst AGGREGATOR_PARASWAP = {\n  name: 'Paraswap',\n  endpoints: {\n    56:    'https://apiv5.paraswap.io',\n    1:     'https://apiv5.paraswap.io',\n    137:   'https://apiv5.paraswap.io',\n    42161: 'https://apiv5.paraswap.io',\n    8453:  'https://apiv5.paraswap.io',\n  },\n};\n\n// Legacy flat map (backwards compatibility)\nconst AGGREGATOR_ENDPOINTS = AGGREGATOR_0X.endpoints;\n\n// Kairos fee recipient (treasury)\nconst KAIROS_FEE_RECIPIENT = '0xCee44904A6aA94dEa28754373887E07D4B6f4968';\nconst KAIROS_FEE_BPS = 15; // 0.15%\n\n// \n//  RESILIENCE CONFIG\n// \nconst RESILIENCE = {\n  QUOTE_TIMEOUT_MS: 8000,       // Max 8s per aggregator quote\n  EXECUTE_TIMEOUT_MS: 60000,    // Max 60s for TX confirmation\n  MAX_RETRIES: 2,               // Retry failed quotes up to 2x\n  RETRY_DELAY_MS: 500,          // Wait 500ms between retries\n  QUOTE_MAX_AGE_MS: 15000,      // Re-quote if older than 15s\n  CIRCUIT_BREAKER_THRESHOLD: 3, // Mark aggregator \"down\" after 3 consecutive fails\n  CIRCUIT_BREAKER_RESET_MS: 120000, // Reset circuit after 2 min\n  GAS_MULTIPLIER: 1.5,          // 50% gas buffer (up from 30%)\n  PARALLEL_QUOTES: true,        // Query multiple aggregators simultaneously\n};\n\n// Circuit breaker state per aggregator\nconst _circuitState = {\n  '0x':       { failures: 0, lastFail: 0, open: false },\n  '1inch':    { failures: 0, lastFail: 0, open: false },\n  'Paraswap': { failures: 0, lastFail: 0, open: false },\n};\n\nfunction _recordSuccess(aggName) {\n  if (_circuitState[aggName]) {\n    _circuitState[aggName].failures = 0;\n    _circuitState[aggName].open = false;\n  }\n}\n\nfunction _recordFailure(aggName) {\n  const state = _circuitState[aggName];\n  if (!state) return;\n  state.failures++;\n  state.lastFail = Date.now();\n  if (state.failures >= RESILIENCE.CIRCUIT_BREAKER_THRESHOLD) {\n    state.open = true;\n    console.warn(`[CIRCUIT-BREAKER] ${aggName} marked DOWN (${state.failures} consecutive failures)`);\n  }\n}\n\nfunction _isCircuitOpen(aggName) {\n  const state = _circuitState[aggName];\n  if (!state || !state.open) return false;\n  // Auto-reset after cooldown\n  if (Date.now() - state.lastFail > RESILIENCE.CIRCUIT_BREAKER_RESET_MS) {\n    state.open = false;\n    state.failures = 0;\n    console.log(`[CIRCUIT-BREAKER] ${aggName} circuit RESET (cooldown elapsed)`);\n    return false;\n  }\n  return true;\n}\n\n// Timeout helper\nfunction _fetchWithTimeout(url, options, timeoutMs) {\n  return Promise.race([\n    fetch(url, options),\n    new Promise((_, reject) =>\n      setTimeout(() => reject(new Error(`Timeout after ${timeoutMs}ms`)), timeoutMs)\n    ),\n  ]);\n}\n\n// Retry helper\nasync function _withRetry(fn, maxRetries, delayMs, label) {\n  let lastError;\n  for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (err) {\n      lastError = err;\n      if (attempt < maxRetries) {\n        console.warn(`[RETRY] ${label} attempt ${attempt + 1}/${maxRetries} failed: ${err.message}. Retrying in ${delayMs}ms...`);\n        await new Promise(r => setTimeout(r, delayMs));\n      }\n    }\n  }\n  throw lastError;\n}\n\n// Execution mode: 'aggregator' (best price) or 'direct' (single DEX fallback)\nlet EXECUTION_MODE = 'aggregator';\n\nconst CHAIN_CONFIG = {\n  56: {\n    name: 'BSC',\n    rpc: ['https://bsc-dataseed1.binance.org', 'https://bsc-dataseed2.binance.org', 'https://bsc-dataseed3.binance.org'],\n    router: '0x10ED43C718714eb63d5aA57B78B54704E256024E', // PancakeSwap V2\n    factory: '0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73',\n    wrapped: '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c', // WBNB\n    dexName: 'PancakeSwap',\n    explorer: 'https://bscscan.com',\n    nativeSymbol: 'BNB',\n  },\n  1: {\n    name: 'Ethereum',\n    rpc: ['https://eth.llamarpc.com', 'https://rpc.ankr.com/eth'],\n    router: '0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D', // Uniswap V2\n    factory: '0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f',\n    wrapped: '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2', // WETH\n    dexName: 'Uniswap',\n    explorer: 'https://etherscan.io',\n    nativeSymbol: 'ETH',\n  },\n  137: {\n    name: 'Polygon',\n    rpc: ['https://polygon-rpc.com', 'https://rpc.ankr.com/polygon'],\n    router: '0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff', // QuickSwap\n    factory: '0x5757371414417b8C6CAad45bAeF941aBc7d3Ab32',\n    wrapped: '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270', // WMATIC\n    dexName: 'QuickSwap',\n    explorer: 'https://polygonscan.com',\n    nativeSymbol: 'MATIC',\n  },\n  42161: {\n    name: 'Arbitrum',\n    rpc: ['https://arb1.arbitrum.io/rpc', 'https://rpc.ankr.com/arbitrum'],\n    router: '0x1b02dA8Cb0d097eB8D57A175b88c7D8b47997506', // SushiSwap\n    factory: '0xc35DADB65012eC5796536bD9864eD8773aBc74C4',\n    wrapped: '0x82aF49447D8a07e3bd95BD0d56f35241523fBab1', // WETH\n    dexName: 'SushiSwap',\n    explorer: 'https://arbiscan.io',\n    nativeSymbol: 'ETH',\n  },\n  43114: {\n    name: 'Avalanche',\n    rpc: ['https://api.avax.network/ext/bc/C/rpc', 'https://rpc.ankr.com/avalanche'],\n    router: '0x60aE616a2155Ee3d9A68541Ba4544862310933d4', // Trader Joe\n    factory: '0x9Ad6C38BE94206cA50bb0d90783181834C6AbB96',\n    wrapped: '0xB31f66AA3C1e785363F0875A1B74E27b85FD66c7', // WAVAX\n    dexName: 'Trader Joe',\n    explorer: 'https://snowtrace.io',\n    nativeSymbol: 'AVAX',\n  },\n  8453: {\n    name: 'Base',\n    rpc: ['https://mainnet.base.org', 'https://rpc.ankr.com/base'],\n    router: '0x327Df1E6de05895d2ab08513aaDD9313fE505d86', // BaseSwap\n    factory: '0xFDa619b6d20975be80A10332cD39b9a4b0FAa8BB',\n    wrapped: '0x4200000000000000000000000000000000000006', // WETH\n    dexName: 'BaseSwap',\n    explorer: 'https://basescan.org',\n    nativeSymbol: 'ETH',\n  },\n};\n\n// Common token addresses by chain\nconst TOKEN_ADDRESSES = {\n  56: {\n    USDT: '0x55d398326f99059fF775485246999027B3197955',\n    USDC: '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d',\n    BUSD: '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56',\n    BTC: '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c',  // BTCB\n    ETH: '0x2170Ed0880ac9A755fd29B2688956BD959F933F8',\n    KAIROS: '0x14D41707269c7D8b8DFa5095b38824a46dA05da3',\n    BNB: '0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c',  // WBNB\n  },\n  1: {\n    USDT: '0xdAC17F958D2ee523a2206206994597C13D831ec7',\n    USDC: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',\n    WETH: '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2',\n  },\n  137: {\n    USDT: '0xc2132D05D31c914a87C6611C10748AEb04B58e8F',\n    USDC: '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174',\n    KAIROS: '0x9151B8C90B2F8a8DF82426E7E65d00563A75a6C9',\n    WMATIC: '0x0d500B1d8E8eF31E21C99d1Db9A6444d3ADf1270',\n  },\n  42161: {\n    USDT: '0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9',\n    USDC: '0xFF970A61A04b1cA14834A43f5dE4533eBDDB5CC8',\n    KAIROS: '0x14D41707269c7D8b8DFa5095b38824a46dA05da3',\n    WETH: '0x82aF49447D8a07e3bd95BD0d56f35241523fBab1',\n  },\n  43114: {\n    USDT: '0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7',\n    USDC: '0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E',\n    WAVAX: '0xB31f66AA3C1e785363F0875A1B74E27b85FD66c7',\n  },\n  8453: {\n    USDC: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913',\n    WETH: '0x4200000000000000000000000000000000000006',\n    KAIROS: '0x14D41707269c7D8b8DFa5095b38824a46dA05da3',\n  },\n};\n\n// ABIs\nconst ERC20_ABI = [\n  'function balanceOf(address) view returns (uint256)',\n  'function decimals() view returns (uint8)',\n  'function symbol() view returns (string)',\n  'function name() view returns (string)',\n  'function allowance(address owner, address spender) view returns (uint256)',\n  'function approve(address spender, uint256 amount) returns (bool)',\n];\n\nconst ROUTER_ABI = [\n  'function getAmountsOut(uint amountIn, address[] path) view returns (uint[] amounts)',\n  'function swapExactTokensForTokens(uint amountIn, uint amountOutMin, address[] path, address to, uint deadline) returns (uint[] amounts)',\n  'function swapExactETHForTokens(uint amountOutMin, address[] path, address to, uint deadline) payable returns (uint[] amounts)',\n  'function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] path, address to, uint deadline) returns (uint[] amounts)',\n  'function swapExactTokensForTokensSupportingFeeOnTransferTokens(uint amountIn, uint amountOutMin, address[] path, address to, uint deadline)',\n  'function WETH() view returns (address)',\n];\n\n// Dynamic ethers import\nlet ethersLib = null;\nasync function getEthers() {\n  if (ethersLib) return ethersLib;\n  try {\n    ethersLib = await import('ethers');\n    return ethersLib;\n  } catch {\n    // Fallback: Load from CDN\n    if (window.ethers) {\n      ethersLib = window.ethers;\n      return ethersLib;\n    }\n    throw new Error('ethers.js not available. Install with: npm install ethers');\n  }\n}\n\nclass WalletBrokerService {\n  constructor() {\n    this.providers = {};\n    this.wallets = {};\n    this.executionMode = EXECUTION_MODE;\n  }\n\n  // \n  //  EXECUTION MODE CONTROL\n  // \n\n  setExecutionMode(mode) {\n    if (!['aggregator', 'direct'].includes(mode)) throw new Error('Invalid mode. Use \"aggregator\" or \"direct\"');\n    this.executionMode = mode;\n    EXECUTION_MODE = mode;\n    console.log(`[BROKER] Execution mode  ${mode === 'aggregator' ? ' Aggregator (100+ DEXes)' : ' Direct (single DEX)'}`);\n  }\n\n  getExecutionMode() {\n    return this.executionMode;\n  }\n\n  // \n  //  MULTI-AGGREGATOR: Get best quote from ALL available sources\n  // \n\n  async _getAggregatorQuote(chainId, tokenIn, tokenOut, amountInWei) {\n    // Try aggregators in priority order, skip circuit-broken ones\n    const aggregators = [\n      { ...AGGREGATOR_0X, method: '_quote0x' },\n      { ...AGGREGATOR_1INCH, method: '_quote1inch' },\n      { ...AGGREGATOR_PARASWAP, method: '_quoteParaswap' },\n    ];\n\n    if (RESILIENCE.PARALLEL_QUOTES) {\n      // Race all available aggregators in parallel  fastest wins\n      const available = aggregators.filter(a => !_isCircuitOpen(a.name) && a.endpoints[chainId]);\n      if (available.length === 0) {\n        console.warn('[AGGREGATOR] All aggregators circuit-broken, will try direct DEX');\n        return null;\n      }\n\n      const results = await Promise.allSettled(\n        available.map(agg =>\n          _withRetry(\n            () => this[agg.method](chainId, tokenIn, tokenOut, amountInWei),\n            RESILIENCE.MAX_RETRIES,\n            RESILIENCE.RETRY_DELAY_MS,\n            agg.name\n          ).then(quote => {\n            if (quote) {\n              _recordSuccess(agg.name);\n              return { ...quote, aggregator: agg.name };\n            }\n            throw new Error('Empty quote');\n          }).catch(err => {\n            _recordFailure(agg.name);\n            throw err;\n          })\n        )\n      );\n\n      // Pick the best quote (highest buyAmount = best price for the user)\n      const validQuotes = results\n        .filter(r => r.status === 'fulfilled')\n        .map(r => r.value)\n        .sort((a, b) => {\n          const aBuy = BigInt(a.buyAmount || '0');\n          const bBuy = BigInt(b.buyAmount || '0');\n          return bBuy > aBuy ? 1 : bBuy < aBuy ? -1 : 0;\n        });\n\n      if (validQuotes.length > 0) {\n        const best = validQuotes[0];\n        console.log(`[AGGREGATOR] Best quote from ${best.aggregator} (${validQuotes.length} sources responded)`);\n        if (validQuotes.length > 1) {\n          console.log(`[AGGREGATOR] Compared: ${validQuotes.map(q => `${q.aggregator}=${q.buyAmount}`).join(' vs ')}`);\n        }\n        return best;\n      }\n\n      console.warn('[AGGREGATOR] All parallel quotes failed');\n      return null;\n    }\n\n    // Sequential mode (fallback)  try each aggregator one by one\n    for (const agg of aggregators) {\n      if (_isCircuitOpen(agg.name)) continue;\n      if (!agg.endpoints[chainId]) continue;\n\n      try {\n        const quote = await _withRetry(\n          () => this[agg.method](chainId, tokenIn, tokenOut, amountInWei),\n          RESILIENCE.MAX_RETRIES,\n          RESILIENCE.RETRY_DELAY_MS,\n          agg.name\n        );\n        if (quote) {\n          _recordSuccess(agg.name);\n          return { ...quote, aggregator: agg.name };\n        }\n      } catch (err) {\n        _recordFailure(agg.name);\n        console.warn(`[AGGREGATOR] ${agg.name} failed: ${err.message}`);\n      }\n    }\n\n    return null;\n  }\n\n  //  0x Protocol Quote \n  async _quote0x(chainId, tokenIn, tokenOut, amountInWei) {\n    const endpoint = AGGREGATOR_0X.endpoints[chainId];\n    if (!endpoint) return null;\n\n    const params = new URLSearchParams({\n      sellToken: tokenIn,\n      buyToken: tokenOut,\n      sellAmount: amountInWei.toString(),\n      slippagePercentage: '0.005',\n      feeRecipient: KAIROS_FEE_RECIPIENT,\n      buyTokenPercentageFee: (KAIROS_FEE_BPS / 10000).toString(),\n      enableSlippageProtection: 'true',\n    });\n\n    const response = await _fetchWithTimeout(\n      `${endpoint}/swap/v1/quote?${params}`,\n      { headers: { '0x-api-key': '' } },\n      RESILIENCE.QUOTE_TIMEOUT_MS\n    );\n\n    if (!response.ok) {\n      const error = await response.json().catch(() => ({}));\n      throw new Error(`0x quote failed (${response.status}): ${error?.reason || 'Unknown'}`);\n    }\n\n    const data = await response.json();\n    const sources = (data.sources || [])\n      .filter(s => parseFloat(s.proportion) > 0)\n      .map(s => ({ name: s.name, pct: Math.round(parseFloat(s.proportion) * 100) }))\n      .sort((a, b) => b.pct - a.pct);\n\n    return {\n      buyAmount: data.buyAmount,\n      to: data.to,\n      data: data.data,\n      value: data.value || '0',\n      gasEstimate: data.estimatedGas,\n      allowanceTarget: data.allowanceTarget,\n      sources,\n      sourceSummary: sources.map(s => `${s.name} ${s.pct}%`).join(' + ') || 'Direct',\n      price: data.price,\n      guaranteedPrice: data.guaranteedPrice,\n      quotedAt: Date.now(),\n    };\n  }\n\n  //  1inch Quote (fallback aggregator) \n  async _quote1inch(chainId, tokenIn, tokenOut, amountInWei) {\n    const endpoint = AGGREGATOR_1INCH.endpoints[chainId];\n    if (!endpoint) return null;\n\n    const params = new URLSearchParams({\n      src: tokenIn,\n      dst: tokenOut,\n      amount: amountInWei.toString(),\n      from: KAIROS_FEE_RECIPIENT, // placeholder  will be overridden on execution\n      slippage: '0.5',\n      fee: (KAIROS_FEE_BPS / 100).toString(), // 1inch uses % not bps\n      referrerAddress: KAIROS_FEE_RECIPIENT,\n      disableEstimate: 'true',\n    });\n\n    const response = await _fetchWithTimeout(\n      `${endpoint}/swap?${params}`,\n      { headers: { 'accept': 'application/json' } },\n      RESILIENCE.QUOTE_TIMEOUT_MS\n    );\n\n    if (!response.ok) {\n      throw new Error(`1inch quote failed (${response.status})`);\n    }\n\n    const data = await response.json();\n\n    return {\n      buyAmount: data.dstAmount || data.toAmount || '0',\n      to: data.tx?.to || data.to,\n      data: data.tx?.data || data.data,\n      value: data.tx?.value || '0',\n      gasEstimate: data.tx?.gas || data.estimatedGas || '300000',\n      allowanceTarget: data.tx?.to || data.to,\n      sources: [{ name: '1inch Router', pct: 100 }],\n      sourceSummary: '1inch Aggregation',\n      price: null,\n      guaranteedPrice: null,\n      quotedAt: Date.now(),\n    };\n  }\n\n  //  Paraswap Quote (second fallback) \n  async _quoteParaswap(chainId, tokenIn, tokenOut, amountInWei) {\n    const endpoint = AGGREGATOR_PARASWAP.endpoints[chainId];\n    if (!endpoint) return null;\n\n    // Step 1: Get price route\n    const priceParams = new URLSearchParams({\n      srcToken: tokenIn,\n      destToken: tokenOut,\n      amount: amountInWei.toString(),\n      srcDecimals: '18',\n      destDecimals: '18',\n      side: 'SELL',\n      network: chainId.toString(),\n      partner: 'kairos',\n      version: '6.2',\n    });\n\n    const priceResp = await _fetchWithTimeout(\n      `${endpoint}/prices?${priceParams}`,\n      { headers: { 'accept': 'application/json' } },\n      RESILIENCE.QUOTE_TIMEOUT_MS\n    );\n\n    if (!priceResp.ok) {\n      throw new Error(`Paraswap price failed (${priceResp.status})`);\n    }\n\n    const priceData = await priceResp.json();\n    const bestRoute = priceData.priceRoute;\n    if (!bestRoute) throw new Error('Paraswap: no route found');\n\n    return {\n      buyAmount: bestRoute.destAmount || '0',\n      to: null, // Paraswap requires a separate /transactions call to get calldata\n      data: null,\n      value: '0',\n      gasEstimate: bestRoute.gasCost || '300000',\n      allowanceTarget: bestRoute.tokenTransferProxy,\n      sources: [{ name: 'Paraswap', pct: 100 }],\n      sourceSummary: `Paraswap (${bestRoute.bestRoute?.[0]?.swaps?.[0]?.swapExchanges?.map(e => e.exchange).join('+') || 'multi'})`,\n      price: null,\n      guaranteedPrice: null,\n      priceRoute: bestRoute, // Needed for building TX later\n      quotedAt: Date.now(),\n      needsTxBuild: true,\n    };\n  }\n\n  // \n  //  RESILIENT EXECUTION: Execute Swap with re-quote protection\n  // \n\n  async _executeAggregatorSwap(wallet, chainId, tokenIn, amountInWei, quote) {\n    const ethers = await getEthers();\n    const config = CHAIN_CONFIG[chainId];\n    const isNativeIn = tokenIn.toLowerCase() === config.wrapped.toLowerCase();\n\n    // Re-quote if quote is stale (>15s old)\n    let activeQuote = quote;\n    if (Date.now() - (quote.quotedAt || 0) > RESILIENCE.QUOTE_MAX_AGE_MS) {\n      console.log('[AGGREGATOR] Quote is stale, refreshing...');\n      const freshQuote = await this._getAggregatorQuote(chainId, tokenIn, quote._tokenOut || tokenIn, amountInWei);\n      if (freshQuote && freshQuote.data) {\n        activeQuote = freshQuote;\n        console.log('[AGGREGATOR] Using fresh quote');\n      } else {\n        console.warn('[AGGREGATOR] Re-quote failed, proceeding with original');\n      }\n    }\n\n    // Paraswap needs a separate TX-build step\n    if (activeQuote.needsTxBuild && activeQuote.priceRoute) {\n      try {\n        const txResp = await _fetchWithTimeout(\n          `${AGGREGATOR_PARASWAP.endpoints[chainId]}/transactions/${chainId}`,\n          {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              srcToken: tokenIn,\n              destToken: activeQuote._tokenOut,\n              srcAmount: amountInWei.toString(),\n              destAmount: activeQuote.buyAmount,\n              priceRoute: activeQuote.priceRoute,\n              userAddress: wallet.address,\n              partner: 'kairos',\n            }),\n          },\n          RESILIENCE.QUOTE_TIMEOUT_MS\n        );\n        if (txResp.ok) {\n          const txData = await txResp.json();\n          activeQuote.to = txData.to;\n          activeQuote.data = txData.data;\n          activeQuote.value = txData.value || '0';\n          activeQuote.gasEstimate = txData.gas || activeQuote.gasEstimate;\n        } else {\n          throw new Error('Paraswap TX build failed');\n        }\n      } catch (err) {\n        console.warn('[PARASWAP] TX build failed:', err.message);\n        throw err; // Will trigger fallback to direct DEX\n      }\n    }\n\n    if (!activeQuote.to || !activeQuote.data) {\n      throw new Error('Quote has no execution data');\n    }\n\n    // Approve if ERC20\n    if (!isNativeIn && activeQuote.allowanceTarget) {\n      const tokenContract = new ethers.Contract(tokenIn, ERC20_ABI, wallet);\n      const allowance = await tokenContract.allowance(wallet.address, activeQuote.allowanceTarget);\n      if (allowance < BigInt(amountInWei)) {\n        console.log(`[AGGREGATOR] Approving token for ${activeQuote.sourceSummary}...`);\n        const approveTx = await tokenContract.approve(activeQuote.allowanceTarget, ethers.MaxUint256);\n        await approveTx.wait();\n        console.log('[AGGREGATOR] Approval confirmed');\n      }\n    }\n\n    // Execute aggregated swap with enhanced gas buffer\n    const gasLimit = Math.ceil(Number(activeQuote.gasEstimate || 300000) * RESILIENCE.GAS_MULTIPLIER);\n    const tx = await wallet.sendTransaction({\n      to: activeQuote.to,\n      data: activeQuote.data,\n      value: activeQuote.value,\n      gasLimit,\n    });\n\n    console.log(`[AGGREGATOR] Swap tx: ${tx.hash} via ${activeQuote.sourceSummary} (gas limit: ${gasLimit})`);\n    const receipt = await tx.wait();\n\n    if (receipt.status === 0) {\n      throw new Error(`TX reverted on-chain: ${tx.hash}`);\n    }\n\n    return { tx, receipt, sources: activeQuote.sources, sourceSummary: activeQuote.sourceSummary, aggregator: activeQuote.aggregator };\n  }\n\n  // Get or create provider for chain\n  async _getProvider(chainId) {\n    if (this.providers[chainId]) return this.providers[chainId];\n    const ethers = await getEthers();\n    const config = CHAIN_CONFIG[chainId];\n    if (!config) throw new Error(`Unsupported chain: ${chainId}`);\n\n    // Try each RPC until one works\n    for (const rpc of config.rpc) {\n      try {\n        const provider = new ethers.JsonRpcProvider(rpc, chainId);\n        await provider.getBlockNumber(); // Test connection\n        this.providers[chainId] = provider;\n        return provider;\n      } catch {\n        continue;\n      }\n    }\n    throw new Error(`Could not connect to ${config.name} RPC`);\n  }\n\n  // Get wallet signer\n  async _getWallet(privateKey, chainId) {\n    const key = `${chainId}-${privateKey.slice(-6)}`;\n    if (this.wallets[key]) return this.wallets[key];\n    const ethers = await getEthers();\n    const provider = await this._getProvider(chainId);\n    const wallet = new ethers.Wallet(privateKey, provider);\n    this.wallets[key] = wallet;\n    return wallet;\n  }\n\n  // Resolve token symbol to address\n  _resolveToken(symbolOrAddress, chainId) {\n    if (symbolOrAddress?.startsWith('0x') && symbolOrAddress.length === 42) return symbolOrAddress;\n    const tokens = TOKEN_ADDRESSES[chainId] || {};\n    const upper = (symbolOrAddress || '').toUpperCase();\n    // Handle KAIROS pairs like BTCKAIROS  map to BTC\n    const cleaned = upper.replace('KAIROS', '').replace('USDT', '').replace('USDC', '');\n    return tokens[upper] || tokens[cleaned] || null;\n  }\n\n  //  CONNECT \n  async connect(walletAddress, privateKey, chainId = 56) {\n    try {\n      const ethers = await getEthers();\n      const config = CHAIN_CONFIG[chainId];\n      if (!config) return { success: false, message: `Red no soportada: ${chainId}` };\n\n      // Validate address\n      if (!ethers.isAddress(walletAddress)) {\n        return { success: false, message: 'Direccin de wallet invlida' };\n      }\n\n      // Validate private key by deriving address\n      try {\n        const wallet = new ethers.Wallet(privateKey);\n        if (wallet.address.toLowerCase() !== walletAddress.toLowerCase()) {\n          return { success: false, message: 'La clave privada no corresponde a la direccin' };\n        }\n      } catch {\n        return { success: false, message: 'Clave privada invlida' };\n      }\n\n      // Test RPC connection + get balance\n      const provider = await this._getProvider(chainId);\n      const balance = await provider.getBalance(walletAddress);\n      const nativeBalance = ethers.formatEther(balance);\n\n      return {\n        success: true,\n        message: `Conectado a ${config.name} via ${this.executionMode === 'aggregator' ? 'Kairos Exchange (100+ DEXes)' : config.dexName} (${parseFloat(nativeBalance).toFixed(4)} ${config.nativeSymbol})`,\n        chain: config.name,\n        dex: this.executionMode === 'aggregator' ? 'Kairos Exchange' : config.dexName,\n        executionMode: this.executionMode,\n        nativeBalance,\n      };\n    } catch (err) {\n      return { success: false, message: `Error: ${err.message}` };\n    }\n  }\n\n  //  GET BALANCES \n  async getBalances(walletAddress, chainId = 56) {\n    const ethers = await getEthers();\n    const provider = await this._getProvider(chainId);\n    const config = CHAIN_CONFIG[chainId];\n    const tokens = TOKEN_ADDRESSES[chainId] || {};\n    const balances = [];\n\n    // Native balance\n    try {\n      const balance = await provider.getBalance(walletAddress);\n      const formatted = ethers.formatEther(balance);\n      if (parseFloat(formatted) > 0) {\n        balances.push({\n          asset: config.nativeSymbol,\n          free: formatted,\n          locked: '0',\n          total: formatted,\n          native: true,\n        });\n      }\n    } catch (err) {\n      console.warn('Native balance error:', err.message);\n    }\n\n    // ERC20 token balances\n    for (const [symbol, address] of Object.entries(tokens)) {\n      if (address.toLowerCase() === config.wrapped.toLowerCase()) continue; // Skip wrapped native (already shown)\n      try {\n        const contract = new ethers.Contract(address, ERC20_ABI, provider);\n        const [balance, decimals] = await Promise.all([\n          contract.balanceOf(walletAddress),\n          contract.decimals(),\n        ]);\n        const formatted = ethers.formatUnits(balance, decimals);\n        if (parseFloat(formatted) > 0.000001) {\n          balances.push({\n            asset: symbol,\n            free: formatted,\n            locked: '0',\n            total: formatted,\n          });\n        }\n      } catch (err) {\n        console.warn(`Token ${symbol} balance error:`, err.message);\n      }\n    }\n\n    return balances;\n  }\n\n  //  GET QUOTE \n  // Aggregator-first: gets best price across 100+ DEXes, falls back to single DEX\n  async getQuote(chainId, tokenIn, tokenOut, amountIn) {\n    const ethers = await getEthers();\n    const provider = await this._getProvider(chainId);\n    const config = CHAIN_CONFIG[chainId];\n\n    const tokenInAddr = this._resolveToken(tokenIn, chainId);\n    const tokenOutAddr = this._resolveToken(tokenOut, chainId);\n    if (!tokenInAddr || !tokenOutAddr) throw new Error(`Token not found: ${tokenIn} or ${tokenOut}`);\n\n    // Get token decimals\n    let decimalsIn = 18;\n    if (tokenInAddr.toLowerCase() !== config.wrapped.toLowerCase()) {\n      const tokenContract = new ethers.Contract(tokenInAddr, ERC20_ABI, provider);\n      decimalsIn = await tokenContract.decimals();\n    }\n    let decimalsOut = 18;\n    if (tokenOutAddr.toLowerCase() !== config.wrapped.toLowerCase()) {\n      const outContract = new ethers.Contract(tokenOutAddr, ERC20_ABI, provider);\n      decimalsOut = await outContract.decimals();\n    }\n    const amountInWei = ethers.parseUnits(amountIn.toString(), decimalsIn);\n\n    //  STRATEGY 1: Aggregator (100+ DEXes via 0x) \n    if (this.executionMode === 'aggregator') {\n      try {\n        const aggQuote = await this._getAggregatorQuote(chainId, tokenInAddr, tokenOutAddr, amountInWei);\n        if (aggQuote) {\n          aggQuote._tokenOut = tokenOutAddr; // Store for potential re-quote\n          const formattedOut = ethers.formatUnits(aggQuote.buyAmount, decimalsOut);\n          const effectivePrice = parseFloat(formattedOut) / parseFloat(amountIn);\n          console.log(`[QUOTE] Aggregator  ${formattedOut} via ${aggQuote.sourceSummary}`);\n\n          // Also get direct DEX quote for comparison (non-blocking)\n          let directQuote = null;\n          try { directQuote = await this._getDirectQuote(chainId, tokenInAddr, tokenOutAddr, amountInWei, decimalsOut, config); } catch {}\n          const savings = directQuote\n            ? ((parseFloat(formattedOut) - directQuote.amountOutNum) / directQuote.amountOutNum * 100).toFixed(2)\n            : null;\n\n          return {\n            amountIn: amountIn.toString(),\n            amountOut: formattedOut,\n            effectivePrice,\n            dex: 'Kairos Exchange',\n            mode: 'aggregator',\n            sources: aggQuote.sources,\n            sourceSummary: aggQuote.sourceSummary,\n            priceImpact: 'optimized',\n            savingsVsDirect: savings ? `${savings > 0 ? '+' : ''}${savings}%` : null,\n            directDex: directQuote?.dex || null,\n            _aggQuoteData: aggQuote, // Internal: used by placeOrder\n          };\n        }\n      } catch (err) {\n        console.warn('[QUOTE] Aggregator failed, falling back to direct DEX:', err.message);\n      }\n    }\n\n    //  STRATEGY 2: Direct DEX (single router, fallback) \n    const directResult = await this._getDirectQuote(chainId, tokenInAddr, tokenOutAddr, amountInWei, decimalsOut, config);\n    return {\n      amountIn: amountIn.toString(),\n      amountOut: directResult.formattedOut,\n      effectivePrice: directResult.effectivePrice,\n      path: directResult.path,\n      dex: config.dexName,\n      mode: 'direct',\n      sources: [{ name: config.dexName, pct: 100 }],\n      sourceSummary: config.dexName,\n      priceImpact: directResult.path.length > 2 ? 'multi-hop' : 'direct',\n      savingsVsDirect: null,\n    };\n  }\n\n  //  Internal: Direct DEX quote via single router \n  async _getDirectQuote(chainId, tokenInAddr, tokenOutAddr, amountInWei, decimalsOut, config) {\n    const ethers = await getEthers();\n    const provider = await this._getProvider(chainId);\n    const router = new ethers.Contract(config.router, ROUTER_ABI, provider);\n\n    const paths = [\n      [tokenInAddr, tokenOutAddr],\n      [tokenInAddr, config.wrapped, tokenOutAddr],\n    ];\n\n    for (const path of paths) {\n      try {\n        const amounts = await router.getAmountsOut(amountInWei, path);\n        const amountOut = amounts[amounts.length - 1];\n        const formattedOut = ethers.formatUnits(amountOut, decimalsOut);\n        const amountOutNum = parseFloat(formattedOut);\n        const effectivePrice = amountOutNum / parseFloat(ethers.formatUnits(amountInWei, 18));\n\n        return { formattedOut, effectivePrice, amountOutNum, path, dex: config.dexName };\n      } catch {\n        continue;\n      }\n    }\n    throw new Error(`No liquidity found on ${config.dexName}`);\n  }\n\n  //  PLACE ORDER (DEX SWAP) \n  // Aggregator-first: routes through best DEXes, falls back to single router\n  async placeOrder(privateKey, chainId, order) {\n    const ethers = await getEthers();\n    const config = CHAIN_CONFIG[chainId];\n    if (!config) throw new Error(`Unsupported chain: ${chainId}`);\n\n    const { symbol, side, quantity, price } = order;\n\n    // Parse trading pair: BTCUSDT  buy BTC with USDT (buy side) or sell BTC for USDT (sell side)\n    let baseToken, quoteToken;\n    const pairMatch = symbol.match(/^([A-Z]+)(USDT|USDC|BUSD|KAIROS|BNB|ETH|WETH|WBNB|MATIC|AVAX)$/i);\n    if (pairMatch) {\n      baseToken = pairMatch[1].toUpperCase();\n      quoteToken = pairMatch[2].toUpperCase();\n      if (quoteToken === 'KAIROS') quoteToken = 'USDT';\n    } else {\n      throw new Error(`Invalid pair format: ${symbol}. Expected e.g. BTCUSDT`);\n    }\n\n    // Resolve addresses\n    const baseAddr = this._resolveToken(baseToken, chainId);\n    const quoteAddr = this._resolveToken(quoteToken, chainId);\n    if (!baseAddr) throw new Error(`Token ${baseToken} not found on chain ${chainId}`);\n    if (!quoteAddr) throw new Error(`Token ${quoteToken} not found on chain ${chainId}`);\n\n    const wallet = await this._getWallet(privateKey, chainId);\n\n    // Determine swap direction\n    let tokenIn, tokenOut, amountInRaw;\n    if (side.toLowerCase() === 'buy') {\n      tokenIn = quoteAddr;\n      tokenOut = baseAddr;\n      amountInRaw = (parseFloat(quantity) * parseFloat(price || 1)).toString();\n    } else {\n      tokenIn = baseAddr;\n      tokenOut = quoteAddr;\n      amountInRaw = quantity.toString();\n    }\n\n    // Get decimals\n    const isNativeIn = tokenIn.toLowerCase() === config.wrapped.toLowerCase();\n    const isNativeOut = tokenOut.toLowerCase() === config.wrapped.toLowerCase();\n\n    let decimalsIn = 18;\n    if (!isNativeIn) {\n      const inContract = new ethers.Contract(tokenIn, ERC20_ABI, wallet.provider);\n      decimalsIn = await inContract.decimals();\n    }\n    let decimalsOut = 18;\n    if (!isNativeOut) {\n      const outContract = new ethers.Contract(tokenOut, ERC20_ABI, wallet.provider);\n      decimalsOut = await outContract.decimals();\n    }\n\n    const amountIn = ethers.parseUnits(amountInRaw, decimalsIn);\n\n    //  STRATEGY 1: Aggregator (100+ DEXes) \n    if (this.executionMode === 'aggregator') {\n      try {\n        const aggQuote = await this._getAggregatorQuote(chainId, tokenIn, tokenOut, amountIn);\n        if (aggQuote) {\n          aggQuote._tokenOut = tokenOut; // Store for potential re-quote\n          console.log(`[ORDER] Executing via ${aggQuote.aggregator || 'Aggregator'}  ${aggQuote.sourceSummary}`);\n          const result = await this._executeAggregatorSwap(wallet, chainId, tokenIn, amountIn, aggQuote);\n          const formattedOut = ethers.formatUnits(aggQuote.buyAmount, decimalsOut);\n\n          return {\n            success: true,\n            txHash: result.tx.hash,\n            symbol,\n            side: side.toLowerCase(),\n            amountIn: amountInRaw,\n            amountOut: formattedOut,\n            effectivePrice: side.toLowerCase() === 'buy'\n              ? (parseFloat(amountInRaw) / parseFloat(formattedOut))\n              : (parseFloat(formattedOut) / parseFloat(amountInRaw)),\n            chain: config.name,\n            dex: 'Kairos Exchange',\n            mode: 'aggregator',\n            aggregator: result.aggregator || aggQuote.aggregator || '0x',\n            sources: result.sources,\n            sourceSummary: result.sourceSummary,\n            explorer: `${config.explorer}/tx/${result.tx.hash}`,\n            gasUsed: result.receipt.gasUsed?.toString(),\n            blockNumber: result.receipt.blockNumber,\n          };\n        }\n      } catch (err) {\n        console.warn('[ORDER] Aggregator execution failed, falling back to direct DEX:', err.message);\n      }\n    }\n\n    //  STRATEGY 2: Direct DEX (single router, fallback) \n    console.log(`[ORDER] Executing via Direct  ${config.dexName}`);\n    const router = new ethers.Contract(config.router, ROUTER_ABI, wallet);\n\n    // Build path\n    let path;\n    try {\n      await router.getAmountsOut(amountIn, [tokenIn, tokenOut]);\n      path = [tokenIn, tokenOut];\n    } catch {\n      path = [tokenIn, config.wrapped, tokenOut];\n      try {\n        await router.getAmountsOut(amountIn, path);\n      } catch {\n        throw new Error(`No liquidity for ${baseToken}/${quoteToken} on ${config.dexName}`);\n      }\n    }\n\n    // Get expected output\n    const amounts = await router.getAmountsOut(amountIn, path);\n    const expectedOut = amounts[amounts.length - 1];\n    const slippage = 0.5;\n    const minOut = expectedOut * BigInt(Math.floor((1 - slippage / 100) * 10000)) / 10000n;\n    const deadline = Math.floor(Date.now() / 1000) + 300;\n\n    // Approve token if needed\n    if (!isNativeIn) {\n      const tokenContract = new ethers.Contract(tokenIn, ERC20_ABI, wallet);\n      const allowance = await tokenContract.allowance(wallet.address, config.router);\n      if (allowance < amountIn) {\n        console.log(`[WALLET] Approving ${baseToken} for ${config.dexName}...`);\n        const approveTx = await tokenContract.approve(config.router, ethers.MaxUint256);\n        await approveTx.wait();\n        console.log('[WALLET] Approval confirmed');\n      }\n    }\n\n    // Execute swap\n    let tx;\n    if (isNativeIn) {\n      tx = await router.swapExactETHForTokens(minOut, path, wallet.address, deadline, { value: amountIn });\n    } else if (isNativeOut) {\n      tx = await router.swapExactTokensForETH(amountIn, minOut, path, wallet.address, deadline);\n    } else {\n      try {\n        tx = await router.swapExactTokensForTokensSupportingFeeOnTransferTokens(\n          amountIn, minOut, path, wallet.address, deadline\n        );\n      } catch {\n        tx = await router.swapExactTokensForTokens(amountIn, minOut, path, wallet.address, deadline);\n      }\n    }\n\n    console.log(`[WALLET] Swap tx: ${tx.hash}`);\n    const receipt = await tx.wait();\n\n    const formattedOut = ethers.formatUnits(expectedOut, decimalsOut);\n    const effectivePrice = parseFloat(formattedOut) / parseFloat(amountInRaw);\n\n    return {\n      success: true,\n      txHash: tx.hash,\n      symbol,\n      side: side.toLowerCase(),\n      amountIn: amountInRaw,\n      amountOut: formattedOut,\n      effectivePrice: side.toLowerCase() === 'buy' \n        ? (parseFloat(amountInRaw) / parseFloat(formattedOut))\n        : effectivePrice,\n      chain: config.name,\n      dex: config.dexName,\n      mode: 'direct',\n      sources: [{ name: config.dexName, pct: 100 }],\n      sourceSummary: config.dexName,\n      explorer: `${config.explorer}/tx/${tx.hash}`,\n      gasUsed: receipt.gasUsed?.toString(),\n      blockNumber: receipt.blockNumber,\n    };\n  }\n\n  //  CANCEL ORDER \n  async cancelOrder() {\n    return { success: false, message: 'DEX swaps are instant and cannot be cancelled' };\n  }\n\n  //  WALLETCONNECT: Send transaction via external wallet \n  async sendViaWalletConnect(chainId, txParams) {\n    try {\n      const { sendTransaction } = await import('./walletConnectDApp');\n      const txHash = await sendTransaction(chainId, txParams);\n      const config = CHAIN_CONFIG[chainId];\n      return {\n        success: true,\n        txHash,\n        explorer: config ? `${config.explorer}/tx/${txHash}` : null,\n        chain: config?.name || `Chain ${chainId}`,\n        method: 'WalletConnect',\n      };\n    } catch (err) {\n      return { success: false, message: `WalletConnect: ${err.message}` };\n    }\n  }\n\n  //  WALLETCONNECT: Check if WC is available for signing \n  async isWCAvailable() {\n    try {\n      const { isConnected } = await import('./walletConnectDApp');\n      return isConnected();\n    } catch {\n      return false;\n    }\n  }\n\n  //  WALLETCONNECT: Get connected account \n  async getWCAccount() {\n    try {\n      const { getConnectedAccount } = await import('./walletConnectDApp');\n      return getConnectedAccount();\n    } catch {\n      return null;\n    }\n  }\n\n  //  DIAGNOSTICS: Get aggregator health status \n  getAggregatorStatus() {\n    return {\n      mode: this.executionMode,\n      aggregators: Object.entries(_circuitState).map(([name, state]) => ({\n        name,\n        status: state.open ? 'DOWN' : 'HEALTHY',\n        consecutiveFailures: state.failures,\n        lastFailure: state.lastFail ? new Date(state.lastFail).toISOString() : null,\n        willResetAt: state.open ? new Date(state.lastFail + RESILIENCE.CIRCUIT_BREAKER_RESET_MS).toISOString() : null,\n      })),\n      config: { ...RESILIENCE },\n    };\n  }\n}\n\nexport const walletBroker = new WalletBrokerService();\n","// Kairos Trade  Broker Service (Elite v4)\n// Real execution on Binance (HMAC-SHA256) + Coinbase CDP (JWT/EC)\n// Uses Web Crypto API (no external dependencies)\nimport { BROKERS } from '../constants';\nimport { decryptKey } from '../utils/keyVault';\nimport useStore from '../store/useStore';\nimport { walletBroker } from './walletBroker';\n\n// Kairos API for leveraged (margin/perps) execution\nconst KAIROS_API = 'https://kairos-api-u6k5.onrender.com';\n\nclass BrokerService {\n  constructor() {\n    this.connections = new Map();\n  }\n\n  // Decrypt stored credentials (AES-256-GCM or legacy base64)\n  async _decrypt(broker) {\n    const derivedPwd = `kairos:broker:${useStore.getState().user?.email || 'anon'}`;\n    const decryptField = async (val) => {\n      if (!val) return undefined;\n      // New AES format starts with 'v1:'\n      if (val.startsWith('v1:')) {\n        const { privateKey } = await decryptKey(val, derivedPwd);\n        return privateKey;\n      }\n      // Legacy base64 fallback\n      try { return atob(val); } catch { return val; }\n    };\n    return {\n      ...broker,\n      apiKey: await decryptField(broker.apiKey),\n      apiSecret: await decryptField(broker.apiSecret),\n      passphrase: await decryptField(broker.passphrase),\n    };\n  }\n\n  //  Coinbase CDP: Build JWT from EC Private Key \n  async _coinbaseJWT(creds, method, path) {\n    const keyName = creds.apiKey;\n    const privateKeyPem = creds.apiSecret;\n\n    // JWT Header\n    const header = { alg: 'ES256', kid: keyName, nonce: crypto.randomUUID(), typ: 'JWT' };\n\n    // JWT Payload  Coinbase CDP requires 'uri' field: \"METHOD host/path\"\n    const now = Math.floor(Date.now() / 1000);\n    const uri = `${method} api.coinbase.com${path}`;\n    const payload = {\n      sub: keyName,\n      iss: 'coinbase-cloud',\n      aud: ['cdp_service'],\n      nbf: now,\n      exp: now + 120,\n      uri,\n    };\n\n    const toB64url = (str) => btoa(str).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\n    const objToB64url = (obj) => toB64url(JSON.stringify(obj));\n    const bufToB64url = (buf) => toB64url(String.fromCharCode(...new Uint8Array(buf)));\n    const headerB64 = objToB64url(header);\n    const payloadB64 = objToB64url(payload);\n    const signingInput = `${headerB64}.${payloadB64}`;\n\n    // Import EC key and sign\n    const key = await this._importECKey(privateKeyPem);\n\n    const sig = await crypto.subtle.sign(\n      { name: 'ECDSA', hash: 'SHA-256' },\n      key,\n      new TextEncoder().encode(signingInput)\n    );\n\n    return `${signingInput}.${bufToB64url(sig)}`;\n  }\n\n  // Parse SEC1 PEM (BEGIN EC PRIVATE KEY)  extract d, x, y  import as JWK\n  async _importECKey(pem) {\n    // Clean PEM: remove headers and all literal \\n\n    const pemClean = pem\n      .replace(/-----BEGIN (?:EC )?PRIVATE KEY-----/g, '')\n      .replace(/-----END (?:EC )?PRIVATE KEY-----/g, '')\n      .replace(/\\\\n/g, '')\n      .replace(/\\n/g, '')\n      .replace(/\\r/g, '')\n      .replace(/\\s/g, '');\n\n    const der = Uint8Array.from(atob(pemClean), c => c.charCodeAt(0));\n\n    // If it's PKCS8 format (BEGIN PRIVATE KEY), import directly\n    if (pem.includes('BEGIN PRIVATE KEY') && !pem.includes('EC PRIVATE KEY')) {\n      return crypto.subtle.importKey(\n        'pkcs8', der.buffer,\n        { name: 'ECDSA', namedCurve: 'P-256' },\n        false, ['sign']\n      );\n    }\n\n    // SEC1 EC format: parse ASN.1 to extract raw key material\n    // Structure: SEQUENCE { version(1), d(32 bytes), [0]curveOid, [1]publicKey(65 bytes) }\n    const d = this._extractEC_d(der);\n    const pubPoint = this._extractEC_pub(der);\n\n    if (!d || d.length !== 32) {\n      throw new Error(`Clave EC invlida: se esperaban 32 bytes para d, se encontraron ${d?.length || 0}`);\n    }\n\n    const bytesToB64url = (bytes) =>\n      btoa(String.fromCharCode(...bytes)).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\n\n    const jwk = {\n      kty: 'EC',\n      crv: 'P-256',\n      d: bytesToB64url(d),\n    };\n\n    // If public key present (65 bytes: 04 || x(32) || y(32))\n    if (pubPoint && pubPoint.length === 65 && pubPoint[0] === 0x04) {\n      jwk.x = bytesToB64url(pubPoint.slice(1, 33));\n      jwk.y = bytesToB64url(pubPoint.slice(33, 65));\n    } else {\n      // Without public key, Web Crypto can't import. Derive it.\n      // Try PKCS8 wrapping as fallback\n      return this._importECKeyPkcs8Wrap(der);\n    }\n\n    return crypto.subtle.importKey(\n      'jwk', jwk,\n      { name: 'ECDSA', namedCurve: 'P-256' },\n      false, ['sign']\n    );\n  }\n\n  // Extract 32-byte private key 'd' from SEC1 DER\n  _extractEC_d(der) {\n    // Find OCTET STRING (tag 0x04) after version INTEGER (02 01 01)\n    // Typical: 30 77 02 01 01 04 20 <32 bytes d>\n    for (let i = 0; i < der.length - 34; i++) {\n      if (der[i] === 0x02 && der[i + 1] === 0x01 && der[i + 2] === 0x01 &&\n          der[i + 3] === 0x04 && der[i + 4] === 0x20) {\n        return der.slice(i + 5, i + 5 + 32);\n      }\n    }\n    return null;\n  }\n\n  // Extract public key point from SEC1 DER\n  _extractEC_pub(der) {\n    // Look for context tag [1] (0xA1) followed by BIT STRING (0x03)\n    for (let i = 0; i < der.length - 67; i++) {\n      if (der[i] === 0xA1 && der[i + 2] === 0x03 && der[i + 3] === 0x42 && der[i + 4] === 0x00) {\n        return der.slice(i + 5, i + 5 + 65);\n      }\n    }\n    return null;\n  }\n\n  // Fallback: wrap SEC1 DER in PKCS8 envelope\n  async _importECKeyPkcs8Wrap(sec1Der) {\n    // PKCS8 = SEQUENCE { version(0), AlgorithmIdentifier(EC P-256), OCTET STRING(SEC1) }\n    const octetLen = sec1Der.length;\n    const algoId = new Uint8Array([\n      0x30, 0x13,\n      0x06, 0x07, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x02, 0x01,\n      0x06, 0x08, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x03, 0x01, 0x07,\n    ]);\n    const ver = new Uint8Array([0x02, 0x01, 0x00]);\n    const octetHeader = this._asn1Len(0x04, octetLen);\n    const totalInner = ver.length + algoId.length + octetHeader.length + octetLen;\n    const seqHeader = this._asn1Len(0x30, totalInner);\n\n    const pkcs8 = new Uint8Array(seqHeader.length + totalInner);\n    let off = 0;\n    pkcs8.set(seqHeader, off); off += seqHeader.length;\n    pkcs8.set(ver, off); off += ver.length;\n    pkcs8.set(algoId, off); off += algoId.length;\n    pkcs8.set(octetHeader, off); off += octetHeader.length;\n    pkcs8.set(sec1Der, off);\n\n    return crypto.subtle.importKey(\n      'pkcs8', pkcs8.buffer,\n      { name: 'ECDSA', namedCurve: 'P-256' },\n      false, ['sign']\n    );\n  }\n\n  // ASN.1 tag + length header\n  _asn1Len(tag, len) {\n    if (len < 128) return new Uint8Array([tag, len]);\n    if (len < 256) return new Uint8Array([tag, 0x81, len]);\n    return new Uint8Array([tag, 0x82, (len >> 8) & 0xff, len & 0xff]);\n  }\n\n  //  Coinbase CDP Signed Request (via Netlify proxy to bypass CORS) \n  async _coinbaseRequest(creds, method, path, body = null) {\n    const jwt = await this._coinbaseJWT(creds, method, path);\n\n    // Use serverless proxy to bypass CORS  JWT signed client-side, keys never leave browser\n    const proxyUrl = '/api/coinbase-proxy';\n    try {\n      const res = await fetch(proxyUrl, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ jwt, method, path, body }),\n      });\n\n      let data;\n      const text = await res.text();\n      try { data = JSON.parse(text); } catch { data = { error: text }; }\n\n      if (!res.ok) {\n        throw new Error(data.error || data.message || `Coinbase HTTP ${res.status}`);\n      }\n      return data;\n    } catch (err) {\n      if (err.message === 'Failed to fetch' || err.name === 'TypeError') {\n        throw new Error('Error de red al conectar con el proxy. Reintenta en unos segundos.');\n      }\n      throw err;\n    }\n  }\n\n  //  HMAC-SHA256 Signing (Web Crypto API) \n  async _hmacSign(secret, message) {\n    const encoder = new TextEncoder();\n    const key = await crypto.subtle.importKey(\n      'raw', encoder.encode(secret),\n      { name: 'HMAC', hash: 'SHA-256' },\n      false, ['sign']\n    );\n    const signature = await crypto.subtle.sign('HMAC', key, encoder.encode(message));\n    return Array.from(new Uint8Array(signature))\n      .map(b => b.toString(16).padStart(2, '0'))\n      .join('');\n  }\n\n  //  HMAC-SHA256  Base64 (for Kraken, OKX, KuCoin) \n  async _hmacSignB64(secret, message, isB64Secret = false) {\n    const encoder = new TextEncoder();\n    let keyData;\n    if (isB64Secret) {\n      const bin = atob(secret);\n      keyData = new Uint8Array(bin.length);\n      for (let i = 0; i < bin.length; i++) keyData[i] = bin.charCodeAt(i);\n    } else {\n      keyData = encoder.encode(secret);\n    }\n    const key = await crypto.subtle.importKey(\n      'raw', keyData,\n      { name: 'HMAC', hash: 'SHA-256' },\n      false, ['sign']\n    );\n    const sig = await crypto.subtle.sign('HMAC', key, encoder.encode(message));\n    return btoa(String.fromCharCode(...new Uint8Array(sig)));\n  }\n\n  //  HMAC-SHA512  Base64 (for Kraken) \n  async _hmacSignSHA512B64(secretB64, message) {\n    const bin = atob(secretB64);\n    const keyData = new Uint8Array(bin.length);\n    for (let i = 0; i < bin.length; i++) keyData[i] = bin.charCodeAt(i);\n    const key = await crypto.subtle.importKey(\n      'raw', keyData,\n      { name: 'HMAC', hash: 'SHA-512' },\n      false, ['sign']\n    );\n    // Kraken expects: HMAC-SHA512( base64decode(secret), path + SHA256(nonce + postData) )\n    const msgData = typeof message === 'string' ? new TextEncoder().encode(message) : message;\n    const sig = await crypto.subtle.sign('HMAC', key, msgData);\n    return btoa(String.fromCharCode(...new Uint8Array(sig)));\n  }\n\n  //  SHA-256 digest (for Kraken nonce signing) \n  async _sha256(message) {\n    const data = new TextEncoder().encode(message);\n    const hash = await crypto.subtle.digest('SHA-256', data);\n    return new Uint8Array(hash);\n  }\n\n  //  Universal Proxy Request (for non-Binance/Coinbase brokers) \n  async _proxyRequest(url, method, headers = {}, body = null) {\n    const res = await fetch('/api/broker-proxy', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ url, method, headers, body }),\n    });\n    const text = await res.text();\n    let data;\n    try { data = JSON.parse(text); } catch { data = { error: text }; }\n    if (!res.ok) throw new Error(data.error || data.message || data.msg || `HTTP ${res.status}`);\n    return data;\n  }\n\n  // \n  //  BYBIT v5 (HMAC-SHA256) \n  // \n  async _bybitRequest(creds, method, endpoint, params = {}) {\n    const timestamp = Date.now().toString();\n    const recvWindow = '5000';\n    let queryString = '';\n    let bodyStr = '';\n\n    if (method === 'GET') {\n      queryString = Object.entries(params)\n        .filter(([, v]) => v !== undefined && v !== null)\n        .map(([k, v]) => `${k}=${v}`)\n        .join('&');\n    } else {\n      bodyStr = JSON.stringify(params);\n    }\n\n    const preSign = `${timestamp}${creds.apiKey}${recvWindow}${method === 'GET' ? queryString : bodyStr}`;\n    const signature = await this._hmacSign(creds.apiSecret, preSign);\n\n    const url = `${BROKERS.bybit.baseUrl}${endpoint}${queryString ? '?' + queryString : ''}`;\n    const headers = {\n      'X-BAPI-API-KEY': creds.apiKey,\n      'X-BAPI-SIGN': signature,\n      'X-BAPI-SIGN-TYPE': '2',\n      'X-BAPI-TIMESTAMP': timestamp,\n      'X-BAPI-RECV-WINDOW': recvWindow,\n      'Content-Type': 'application/json',\n    };\n\n    const data = await this._proxyRequest(url, method, headers, method !== 'GET' ? params : null);\n    if (data.retCode !== 0 && data.retCode !== undefined) {\n      throw new Error(`Bybit: ${data.retMsg || 'Unknown error'} (${data.retCode})`);\n    }\n    return data.result || data;\n  }\n\n  // \n  //  KRAKEN (HMAC-SHA512 with nonce) \n  // \n  async _krakenRequest(creds, endpoint, params = {}) {\n    const nonce = Date.now().toString();\n    const postData = new URLSearchParams({ ...params, nonce }).toString();\n\n    // Kraken signature: HMAC-SHA512( base64decode(secret), path + SHA256(nonce + postData) )\n    const sha256Hash = await this._sha256(nonce + postData);\n    const pathBytes = new TextEncoder().encode(endpoint);\n    const sigInput = new Uint8Array(pathBytes.length + sha256Hash.length);\n    sigInput.set(pathBytes, 0);\n    sigInput.set(sha256Hash, pathBytes.length);\n    const signature = await this._hmacSignSHA512B64(creds.apiSecret, sigInput);\n\n    const url = `${BROKERS.kraken.baseUrl}${endpoint}`;\n    const headers = {\n      'API-Key': creds.apiKey,\n      'API-Sign': signature,\n      'Content-Type': 'application/x-www-form-urlencoded',\n    };\n\n    const data = await this._proxyRequest(url, 'POST', headers, postData);\n    if (data.error && data.error.length > 0) {\n      throw new Error(`Kraken: ${data.error.join(', ')}`);\n    }\n    return data.result || data;\n  }\n\n  // \n  //  KUCOIN (HMAC-SHA256 + passphrase) \n  // \n  async _kucoinRequest(creds, method, endpoint, params = {}) {\n    const timestamp = Date.now().toString();\n    let bodyStr = '';\n    let queryString = '';\n\n    if (method === 'GET' || method === 'DELETE') {\n      queryString = Object.entries(params)\n        .filter(([, v]) => v !== undefined && v !== null)\n        .map(([k, v]) => `${k}=${v}`)\n        .join('&');\n      if (queryString) endpoint = `${endpoint}?${queryString}`;\n    } else {\n      bodyStr = JSON.stringify(params);\n    }\n\n    const preSign = `${timestamp}${method}${endpoint}${bodyStr}`;\n    const signature = await this._hmacSignB64(creds.apiSecret, preSign);\n    const passphrase = await this._hmacSignB64(creds.apiSecret, creds.passphrase || '');\n\n    const url = `${BROKERS.kucoin.baseUrl}${endpoint}`;\n    const headers = {\n      'KC-API-KEY': creds.apiKey,\n      'KC-API-SIGN': signature,\n      'KC-API-TIMESTAMP': timestamp,\n      'KC-API-PASSPHRASE': passphrase,\n      'KC-API-KEY-VERSION': '2',\n      'Content-Type': 'application/json',\n    };\n\n    const data = await this._proxyRequest(url, method, headers, method !== 'GET' && method !== 'DELETE' ? params : null);\n    if (data.code && data.code !== '200000') {\n      throw new Error(`KuCoin: ${data.msg || 'Unknown error'} (${data.code})`);\n    }\n    return data.data || data;\n  }\n\n  // \n  //  OKX (HMAC-SHA256 + passphrase, ISO timestamp) \n  // \n  async _okxRequest(creds, method, endpoint, params = {}) {\n    const timestamp = new Date().toISOString();\n    let bodyStr = '';\n    let queryString = '';\n\n    if (method === 'GET') {\n      queryString = Object.entries(params)\n        .filter(([, v]) => v !== undefined && v !== null)\n        .map(([k, v]) => `${k}=${v}`)\n        .join('&');\n      if (queryString) endpoint = `${endpoint}?${queryString}`;\n    } else {\n      bodyStr = JSON.stringify(params);\n    }\n\n    const preSign = `${timestamp}${method}${endpoint}${bodyStr}`;\n    const signature = await this._hmacSignB64(creds.apiSecret, preSign);\n\n    const url = `${BROKERS.okx.baseUrl}${endpoint}`;\n    const headers = {\n      'OK-ACCESS-KEY': creds.apiKey,\n      'OK-ACCESS-SIGN': signature,\n      'OK-ACCESS-TIMESTAMP': timestamp,\n      'OK-ACCESS-PASSPHRASE': creds.passphrase || '',\n      'Content-Type': 'application/json',\n    };\n\n    const data = await this._proxyRequest(url, method, headers, method !== 'GET' ? params : null);\n    if (data.code && data.code !== '0') {\n      throw new Error(`OKX: ${data.msg || 'Unknown error'} (${data.code})`);\n    }\n    return data.data || data;\n  }\n\n  // \n  //  BINGX (HMAC-SHA256, query string signing) \n  // \n  async _bingxRequest(creds, method, endpoint, params = {}) {\n    const timestamp = Date.now().toString();\n    const allParams = { ...params, timestamp };\n    const queryString = Object.entries(allParams)\n      .sort(([a], [b]) => a.localeCompare(b))\n      .filter(([, v]) => v !== undefined && v !== null)\n      .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)\n      .join('&');\n\n    const signature = await this._hmacSign(creds.apiSecret, queryString);\n    const signedQuery = `${queryString}&signature=${signature}`;\n\n    const url = `${BROKERS.bingx.baseUrl}${endpoint}?${signedQuery}`;\n    const headers = {\n      'X-BX-APIKEY': creds.apiKey,\n      'Content-Type': 'application/json',\n    };\n\n    const data = await this._proxyRequest(url, method, headers, method !== 'GET' ? params : null);\n    if (data.code && data.code !== 0) {\n      throw new Error(`BingX: ${data.msg || 'Unknown error'} (${data.code})`);\n    }\n    return data.data || data;\n  }\n\n  // \n  //  BITGET (HMAC-SHA256 + passphrase, like OKX) \n  // \n  async _bitgetRequest(creds, method, endpoint, params = {}) {\n    const timestamp = Date.now().toString();\n    let bodyStr = '';\n    let queryString = '';\n\n    if (method === 'GET') {\n      queryString = Object.entries(params)\n        .filter(([, v]) => v !== undefined && v !== null)\n        .map(([k, v]) => `${k}=${v}`)\n        .join('&');\n      if (queryString) endpoint = `${endpoint}?${queryString}`;\n    } else {\n      bodyStr = JSON.stringify(params);\n    }\n\n    const preSign = `${timestamp}${method}${endpoint}${bodyStr}`;\n    const signature = await this._hmacSignB64(creds.apiSecret, preSign);\n\n    const url = `${BROKERS.bitget.baseUrl}${endpoint}`;\n    const headers = {\n      'ACCESS-KEY': creds.apiKey,\n      'ACCESS-SIGN': signature,\n      'ACCESS-TIMESTAMP': timestamp,\n      'ACCESS-PASSPHRASE': creds.passphrase || '',\n      'Content-Type': 'application/json',\n      'locale': 'en-US',\n    };\n\n    const data = await this._proxyRequest(url, method, headers, method !== 'GET' ? params : null);\n    if (data.code && data.code !== '00000') {\n      throw new Error(`Bitget: ${data.msg || 'Unknown error'} (${data.code})`);\n    }\n    return data.data || data;\n  }\n\n  // \n  //  MEXC (HMAC-SHA256, Binance-style query signing) \n  // \n  async _mexcRequest(creds, method, endpoint, params = {}) {\n    const timestamp = Date.now();\n    const allParams = { ...params, timestamp, recvWindow: 5000 };\n    const queryString = Object.entries(allParams)\n      .filter(([, v]) => v !== undefined && v !== null)\n      .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)\n      .join('&');\n\n    const signature = await this._hmacSign(creds.apiSecret, queryString);\n    const signedQuery = `${queryString}&signature=${signature}`;\n\n    const url = method === 'GET'\n      ? `${BROKERS.mexc.baseUrl}${endpoint}?${signedQuery}`\n      : `${BROKERS.mexc.baseUrl}${endpoint}`;\n\n    const headers = {\n      'X-MEXC-APIKEY': creds.apiKey,\n      'Content-Type': 'application/json',\n    };\n\n    const body = method !== 'GET' ? signedQuery : null;\n    const data = await this._proxyRequest(url, method, headers, body);\n    if (data.code && data.code !== 0 && data.code !== 200) {\n      throw new Error(`MEXC: ${data.msg || 'Unknown error'} (${data.code})`);\n    }\n    return data;\n  }\n\n  //  Binance Signed Request \n  async _binanceSignedRequest(creds, method, endpoint, params = {}) {\n    const timestamp = Date.now();\n    const allParams = { ...params, timestamp, recvWindow: 5000 };\n    const queryString = Object.entries(allParams)\n      .filter(([, v]) => v !== undefined && v !== null)\n      .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)\n      .join('&');\n\n    const signature = await this._hmacSign(creds.apiSecret, queryString);\n    const signedQuery = `${queryString}&signature=${signature}`;\n\n    const url = method === 'GET'\n      ? `${BROKERS.binance.baseUrl}${endpoint}?${signedQuery}`\n      : `${BROKERS.binance.baseUrl}${endpoint}`;\n\n    const options = {\n      method,\n      headers: {\n        'X-MBX-APIKEY': creds.apiKey,\n        'Content-Type': 'application/x-www-form-urlencoded',\n      },\n    };\n\n    if (method === 'POST' || method === 'DELETE') {\n      options.body = signedQuery;\n    }\n\n    const res = await fetch(url, options);\n    const data = await res.json();\n    if (!res.ok) {\n      throw new Error(`Binance ${endpoint}: ${data.msg || res.statusText} (${data.code || res.status})`);\n    }\n    return data;\n  }\n\n  //  Binance Public Request \n  async _binancePublicRequest(endpoint, params = {}) {\n    const queryString = Object.entries(params)\n      .filter(([, v]) => v !== undefined)\n      .map(([k, v]) => `${k}=${encodeURIComponent(v)}`)\n      .join('&');\n    const url = `${BROKERS.binance.baseUrl}${endpoint}${queryString ? '?' + queryString : ''}`;\n    const res = await fetch(url);\n    if (!res.ok) throw new Error(`Binance API error: ${res.status}`);\n    return res.json();\n  }\n\n  //  Connect to broker \n  async connect(broker) {\n    const creds = await this._decrypt(broker);\n    const config = BROKERS[broker.brokerId];\n    if (!config) throw new Error(`Unsupported broker: ${broker.brokerId}`);\n\n    try {\n      switch (broker.brokerId) {\n        case 'binance': {\n          // Real test: Ping + account info to verify API key\n          await this._binancePublicRequest('/api/v3/ping');\n          const account = await this._binanceSignedRequest(creds, 'GET', '/api/v3/account');\n          this.connections.set(broker.id, {\n            creds, config, connected: true,\n            permissions: account.permissions || [],\n            accountType: account.accountType,\n          });\n          return {\n            success: true,\n            message: `Connected to Binance (${account.accountType})`,\n            permissions: account.permissions,\n          };\n        }\n        case 'coinbase': {\n          const accounts = await this._coinbaseRequest(creds, 'GET', '/api/v3/brokerage/accounts?limit=250');\n          this.connections.set(broker.id, {\n            creds, config, connected: true,\n            permissions: ['read', 'trade'],\n            accounts: accounts.accounts || [],\n          });\n          return {\n            success: true,\n            message: `Connected to Coinbase (${(accounts.accounts || []).length} accounts)`,\n            permissions: ['read', 'trade'],\n          };\n        }\n        case 'bybit': {\n          const wallet = await this._bybitRequest(creds, 'GET', '/v5/account/wallet-balance', { accountType: 'UNIFIED' });\n          const coins = wallet?.list?.[0]?.coin?.length || 0;\n          this.connections.set(broker.id, { creds, config, connected: true, permissions: ['read', 'trade'] });\n          return { success: true, message: `Connected to Bybit (${coins} assets)`, permissions: ['read', 'trade'] };\n        }\n        case 'kraken': {\n          const balance = await this._krakenRequest(creds, '/0/private/Balance');\n          const assets = Object.keys(balance || {}).length;\n          this.connections.set(broker.id, { creds, config, connected: true, permissions: ['read', 'trade'] });\n          return { success: true, message: `Connected to Kraken (${assets} assets)`, permissions: ['read', 'trade'] };\n        }\n        case 'kucoin': {\n          const accounts = await this._kucoinRequest(creds, 'GET', '/api/v1/accounts');\n          const count = Array.isArray(accounts) ? accounts.length : 0;\n          this.connections.set(broker.id, { creds, config, connected: true, permissions: ['read', 'trade'] });\n          return { success: true, message: `Connected to KuCoin (${count} accounts)`, permissions: ['read', 'trade'] };\n        }\n        case 'okx': {\n          const bal = await this._okxRequest(creds, 'GET', '/api/v5/account/balance');\n          const assets = Array.isArray(bal) && bal[0]?.details ? bal[0].details.length : 0;\n          this.connections.set(broker.id, { creds, config, connected: true, permissions: ['read', 'trade'] });\n          return { success: true, message: `Connected to OKX (${assets} assets)`, permissions: ['read', 'trade'] };\n        }\n        case 'bingx': {\n          const bal = await this._bingxRequest(creds, 'GET', '/openApi/spot/v1/account/balance');\n          const assets = Array.isArray(bal?.balances) ? bal.balances.filter(b => parseFloat(b.free) > 0).length : 0;\n          this.connections.set(broker.id, { creds, config, connected: true, permissions: ['read', 'trade'] });\n          return { success: true, message: `Connected to BingX (${assets} assets)`, permissions: ['read', 'trade'] };\n        }\n        case 'bitget': {\n          const acct = await this._bitgetRequest(creds, 'GET', '/api/v2/spot/account/assets');\n          const assets = Array.isArray(acct) ? acct.filter(a => parseFloat(a.available) > 0).length : 0;\n          this.connections.set(broker.id, { creds, config, connected: true, permissions: ['read', 'trade'] });\n          return { success: true, message: `Connected to Bitget (${assets} assets)`, permissions: ['read', 'trade'] };\n        }\n        case 'mexc': {\n          const acct = await this._mexcRequest(creds, 'GET', '/api/v3/account');\n          const assets = Array.isArray(acct?.balances) ? acct.balances.filter(b => parseFloat(b.free) > 0).length : 0;\n          this.connections.set(broker.id, { creds, config, connected: true, permissions: ['read', 'trade'] });\n          return { success: true, message: `Connected to MEXC (${assets} assets)`, permissions: ['read', 'trade'] };\n        }\n        default: {\n          await fetch(config.baseUrl);\n          this.connections.set(broker.id, { creds, config, connected: true, permissions: [] });\n          return { success: true, message: `Connected to ${config.name}` };\n        }\n      }\n    } catch (err) {\n      return { success: false, message: err.message };\n    }\n  }\n\n  //  Get REAL balances from Binance \n  async getBalances(brokerId) {\n    const conn = this.connections.get(brokerId);\n    if (!conn) throw new Error('Broker not connected');\n\n    if (conn.config.id === 'binance') {\n      try {\n        const account = await this._binanceSignedRequest(conn.creds, 'GET', '/api/v3/account');\n        return account.balances\n          .filter(b => parseFloat(b.free) > 0 || parseFloat(b.locked) > 0)\n          .map(b => ({\n            asset: b.asset,\n            free: b.free,\n            locked: b.locked,\n            total: (parseFloat(b.free) + parseFloat(b.locked)).toString(),\n          }));\n      } catch (err) {\n        console.error('Binance getBalances error:', err);\n        throw err;\n      }\n    }\n\n    if (conn.config.id === 'coinbase') {\n      try {\n        const data = await this._coinbaseRequest(conn.creds, 'GET', '/api/v3/brokerage/accounts?limit=250');\n        // Debug removed for production\n        const allAccounts = (data.accounts || []).map(a => ({\n          asset: a.currency,\n          free: a.available_balance?.value || '0',\n          locked: a.hold?.value || '0',\n          total: (parseFloat(a.available_balance?.value || 0) + parseFloat(a.hold?.value || 0)).toString(),\n          name: a.name,\n        }));\n\n        const filtered = allAccounts.filter(a => parseFloat(a.free) > 0 || parseFloat(a.locked) > 0);\n\n        return filtered;\n      } catch (err) { console.error('Coinbase getBalances:', err); throw err; }\n    }\n\n    if (conn.config.id === 'bybit') {\n      try {\n        const wallet = await this._bybitRequest(conn.creds, 'GET', '/v5/account/wallet-balance', { accountType: 'UNIFIED' });\n        const coins = wallet?.list?.[0]?.coin || [];\n        return coins\n          .filter(c => parseFloat(c.walletBalance) > 0)\n          .map(c => ({\n            asset: c.coin,\n            free: c.availableToWithdraw || c.walletBalance || '0',\n            locked: (parseFloat(c.walletBalance || 0) - parseFloat(c.availableToWithdraw || 0)).toString(),\n            total: c.walletBalance || '0',\n          }));\n      } catch (err) { console.error('Bybit getBalances:', err); throw err; }\n    }\n\n    if (conn.config.id === 'kraken') {\n      try {\n        const balance = await this._krakenRequest(conn.creds, '/0/private/Balance');\n        // Kraken uses prefixes: XXBT for BTC, ZUSD for USD, etc.\n        const krakenMap = { XXBT: 'BTC', XETH: 'ETH', ZUSD: 'USD', XXRP: 'XRP', XLTC: 'LTC', XXLM: 'XLM', XDOGE: 'DOGE' };\n        return Object.entries(balance || {})\n          .filter(([, v]) => parseFloat(v) > 0)\n          .map(([k, v]) => ({\n            asset: krakenMap[k] || k.replace(/^[XZ]/, ''),\n            free: v,\n            locked: '0',\n            total: v,\n          }));\n      } catch (err) { console.error('Kraken getBalances:', err); throw err; }\n    }\n\n    if (conn.config.id === 'kucoin') {\n      try {\n        const accounts = await this._kucoinRequest(conn.creds, 'GET', '/api/v1/accounts', { type: 'trade' });\n        return (Array.isArray(accounts) ? accounts : [])\n          .filter(a => parseFloat(a.balance) > 0)\n          .map(a => ({\n            asset: a.currency,\n            free: a.available || '0',\n            locked: a.holds || '0',\n            total: a.balance || '0',\n          }));\n      } catch (err) { console.error('KuCoin getBalances:', err); throw err; }\n    }\n\n    if (conn.config.id === 'okx') {\n      try {\n        const bal = await this._okxRequest(conn.creds, 'GET', '/api/v5/account/balance');\n        const details = Array.isArray(bal) && bal[0]?.details ? bal[0].details : [];\n        return details\n          .filter(d => parseFloat(d.cashBal) > 0)\n          .map(d => ({\n            asset: d.ccy,\n            free: d.availBal || d.cashBal || '0',\n            locked: d.frozenBal || '0',\n            total: d.cashBal || '0',\n          }));\n      } catch (err) { console.error('OKX getBalances:', err); throw err; }\n    }\n\n    if (conn.config.id === 'bingx') {\n      try {\n        const data = await this._bingxRequest(conn.creds, 'GET', '/openApi/spot/v1/account/balance');\n        const balances = data?.balances || (Array.isArray(data) ? data : []);\n        return balances\n          .filter(b => parseFloat(b.free || b.available || 0) > 0)\n          .map(b => ({\n            asset: b.asset || b.currency,\n            free: b.free || b.available || '0',\n            locked: b.locked || b.freeze || '0',\n            total: (parseFloat(b.free || b.available || 0) + parseFloat(b.locked || b.freeze || 0)).toString(),\n          }));\n      } catch (err) { console.error('BingX getBalances:', err); throw err; }\n    }\n\n    if (conn.config.id === 'bitget') {\n      try {\n        const data = await this._bitgetRequest(conn.creds, 'GET', '/api/v2/spot/account/assets');\n        const assets = Array.isArray(data) ? data : [];\n        return assets\n          .filter(a => parseFloat(a.available || 0) > 0)\n          .map(a => ({\n            asset: a.coin || a.coinName,\n            free: a.available || '0',\n            locked: a.frozen || a.lock || '0',\n            total: (parseFloat(a.available || 0) + parseFloat(a.frozen || a.lock || 0)).toString(),\n          }));\n      } catch (err) { console.error('Bitget getBalances:', err); throw err; }\n    }\n\n    if (conn.config.id === 'mexc') {\n      try {\n        const acct = await this._mexcRequest(conn.creds, 'GET', '/api/v3/account');\n        const balances = Array.isArray(acct?.balances) ? acct.balances : [];\n        return balances\n          .filter(b => parseFloat(b.free || 0) > 0)\n          .map(b => ({\n            asset: b.asset,\n            free: b.free || '0',\n            locked: b.locked || '0',\n            total: (parseFloat(b.free || 0) + parseFloat(b.locked || 0)).toString(),\n          }));\n      } catch (err) { console.error('MEXC getBalances:', err); throw err; }\n    }\n\n    // Fallback for unsupported brokers\n    return [];\n  }\n\n  //  Place REAL order on Binance \n  async placeOrder(brokerId, order) {\n    const conn = this.connections.get(brokerId);\n    if (!conn) throw new Error('Broker not connected');\n\n    const { symbol, side, type, quantity, price, stopLoss, takeProfit } = order;\n    if (!symbol || !side || !type || !quantity) {\n      throw new Error('Missing required order fields');\n    }\n\n    if (conn.config.id === 'binance') {\n      try {\n        // Map order type to Binance format\n        const binanceType = {\n          market: 'MARKET',\n          limit: 'LIMIT',\n          stop_loss: 'STOP_LOSS_LIMIT',\n        }[type] || 'MARKET';\n\n        const params = {\n          symbol: symbol,\n          side: side.toUpperCase(),\n          type: binanceType,\n          quantity: quantity.toString(),\n        };\n\n        if (binanceType === 'LIMIT' || binanceType === 'STOP_LOSS_LIMIT') {\n          params.timeInForce = 'GTC';\n          params.price = parseFloat(price).toFixed(2);\n        }\n        if (binanceType === 'STOP_LOSS_LIMIT') {\n          params.stopPrice = parseFloat(stopLoss || price).toFixed(2);\n        }\n\n        const result = await this._binanceSignedRequest(conn.creds, 'POST', '/api/v3/order', params);\n\n        return {\n          id: result.orderId?.toString(),\n          clientOrderId: result.clientOrderId,\n          symbol: result.symbol,\n          side: result.side?.toLowerCase(),\n          type: result.type?.toLowerCase(),\n          quantity: parseFloat(result.origQty || quantity),\n          price: parseFloat(result.price || price || 0),\n          filledPrice: parseFloat(result.fills?.[0]?.price || result.price || 0),\n          filledQty: parseFloat(result.executedQty || 0),\n          status: result.status?.toLowerCase(),\n          timestamp: new Date(result.transactTime || Date.now()).toISOString(),\n          broker: 'Binance',\n          real: true,\n          raw: result,\n        };\n      } catch (err) {\n        console.error('Binance placeOrder error:', err);\n        throw err;\n      }\n    }\n\n    if (conn.config.id === 'coinbase') {\n      try {\n        // Coinbase Advanced Trade API  Create Order\n        // https://docs.cdp.coinbase.com/advanced-trade/reference/retailbrokerageapi_postorder\n        // Convert symbol: BTCUSDT  BTC-USDT (Coinbase format)\n        const productId = symbol.replace(/([A-Z]+)(USDT|USDC|USD|BTC|ETH)$/i, '$1-$2').toUpperCase();\n\n        const orderConfig = {};\n        if (type === 'market') {\n          if (side.toLowerCase() === 'buy') {\n            // Market buy: specify quote_size (USD amount)\n            orderConfig.market_market_ioc = {\n              quote_size: (parseFloat(quantity) * parseFloat(price || 0)).toFixed(2),\n            };\n          } else {\n            // Market sell: specify base_size (crypto amount)\n            orderConfig.market_market_ioc = {\n              base_size: parseFloat(quantity).toString(),\n            };\n          }\n        } else if (type === 'limit') {\n          orderConfig.limit_limit_gtc = {\n            base_size: parseFloat(quantity).toString(),\n            limit_price: parseFloat(price).toFixed(2),\n          };\n        }\n\n        const orderBody = {\n          client_order_id: crypto.randomUUID(),\n          product_id: productId,\n          side: side.toUpperCase(),\n          order_configuration: orderConfig,\n        };\n\n\n        const result = await this._coinbaseRequest(conn.creds, 'POST', '/api/v3/brokerage/orders', orderBody);\n\n\n        // Coinbase returns { success: true/false, success_response: {...}, error_response: {...} }\n        if (!result.success) {\n          const errMsg = result.error_response?.error || result.failure_response?.error \n            || result.error_response?.message || result.error || 'Unknown error';\n          const errDetail = result.error_response?.error_details || result.failure_response?.message || '';\n          console.error('[COINBASE ORDER] FAILED:', errMsg, errDetail);\n          throw new Error(`Coinbase order failed: ${errMsg}${errDetail ? '  ' + errDetail : ''}`);\n        }\n\n        const orderResult = result.success_response || result;\n        const orderId = orderResult.order_id || orderResult.id;\n        if (!orderId) {\n          console.error('[COINBASE ORDER] No order_id in response:', result);\n          throw new Error('Coinbase: no order_id returned');\n        }\n\n\n        // Wait briefly for market order to fill, then fetch details\n        let filledPrice = 0;\n        let filledQty = 0;\n        let orderStatus = 'unknown';\n\n        // Retry up to 3 times to get fill details (market orders fill within ms)\n        for (let attempt = 0; attempt < 3; attempt++) {\n          try {\n            if (attempt > 0) await new Promise(r => setTimeout(r, 500));\n            const details = await this._coinbaseRequest(conn.creds, 'GET', `/api/v3/brokerage/orders/historical/${orderId}`);\n\n            const ord = details.order || details;\n            orderStatus = (ord.status || '').toUpperCase();\n            filledPrice = parseFloat(ord.average_filled_price || 0);\n            filledQty = parseFloat(ord.filled_size || 0);\n            if (orderStatus === 'FILLED' || orderStatus === 'CANCELLED' || filledQty > 0) break;\n          } catch (detailErr) {\n            console.warn(`[COINBASE ORDER] Detail fetch attempt ${attempt + 1} failed:`, detailErr.message);\n          }\n        }\n\n        // If we still couldn't confirm fill, mark as unconfirmed\n        if (filledQty === 0 && filledPrice === 0) {\n          console.warn('[COINBASE ORDER] Could not confirm fill for', orderId, '- status:', orderStatus);\n          // Use local price as estimate but flag it\n          filledPrice = parseFloat(price || 0);\n          filledQty = parseFloat(quantity);\n          orderStatus = 'UNCONFIRMED';\n        }\n\n\n\n        return {\n          id: orderId,\n          clientOrderId: orderBody.client_order_id,\n          symbol: productId,\n          side: side.toLowerCase(),\n          type,\n          quantity: filledQty,\n          price: filledPrice,\n          filledPrice,\n          filledQty,\n          status: orderStatus.toLowerCase(),\n          confirmed: orderStatus !== 'UNCONFIRMED',\n          timestamp: new Date().toISOString(),\n          broker: 'Coinbase',\n          real: true,\n        };\n      } catch (err) {\n        console.error('[COINBASE ORDER] placeOrder error:', err.message);\n        throw err;\n      }\n    }\n\n    //  BYBIT v5 \n    if (conn.config.id === 'bybit') {\n      try {\n        const productId = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1$2').toUpperCase();\n        const orderParams = {\n          category: 'spot',\n          symbol: productId,\n          side: side.charAt(0).toUpperCase() + side.slice(1).toLowerCase(),\n          orderType: type === 'market' ? 'Market' : 'Limit',\n          qty: quantity.toString(),\n        };\n        if (type === 'market' && side.toLowerCase() === 'buy') {\n          // Bybit spot market buy: use quote qty\n          orderParams.marketUnit = 'quoteCoin';\n          orderParams.qty = (parseFloat(quantity) * parseFloat(price || 0)).toFixed(2);\n        }\n        if (type === 'limit') {\n          orderParams.price = parseFloat(price).toFixed(2);\n          orderParams.timeInForce = 'GTC';\n        }\n        const result = await this._bybitRequest(conn.creds, 'POST', '/v5/order/create', orderParams);\n        const orderId = result.orderId || Date.now().toString(36);\n        // Get fill details\n        let filledPrice = parseFloat(price || 0);\n        let filledQty = parseFloat(quantity);\n        try {\n          await new Promise(r => setTimeout(r, 500)); // Wait for fill\n          const detail = await this._bybitRequest(conn.creds, 'GET', '/v5/order/realtime', { category: 'spot', orderId });\n          const o = detail?.list?.[0];\n          if (o) {\n            filledPrice = parseFloat(o.avgPrice || o.price || price || 0);\n            filledQty = parseFloat(o.cumExecQty || quantity);\n          }\n        } catch {}\n        return {\n          id: orderId, symbol: productId, side: side.toLowerCase(), type,\n          quantity: filledQty, price: filledPrice, filledPrice, filledQty,\n          status: 'filled', timestamp: new Date().toISOString(), broker: 'Bybit', real: true,\n        };\n      } catch (err) { console.error('Bybit placeOrder:', err); throw err; }\n    }\n\n    //  KRAKEN \n    if (conn.config.id === 'kraken') {\n      try {\n        // Kraken pair format: XBTUSDT, ETHUSDT\n        const krakenPair = symbol.replace('BTC', 'XBT');\n        const params = {\n          pair: krakenPair,\n          type: side.toLowerCase(),\n          ordertype: type === 'market' ? 'market' : 'limit',\n          volume: quantity.toString(),\n        };\n        if (type === 'limit') params.price = parseFloat(price).toFixed(2);\n        const result = await this._krakenRequest(conn.creds, '/0/private/AddOrder', params);\n        const txid = result?.txid?.[0] || Date.now().toString(36);\n        return {\n          id: txid, symbol: krakenPair, side: side.toLowerCase(), type,\n          quantity: parseFloat(quantity), price: parseFloat(price || 0),\n          filledPrice: parseFloat(price || 0), filledQty: parseFloat(quantity),\n          status: 'filled', timestamp: new Date().toISOString(), broker: 'Kraken', real: true,\n        };\n      } catch (err) { console.error('Kraken placeOrder:', err); throw err; }\n    }\n\n    //  KUCOIN \n    if (conn.config.id === 'kucoin') {\n      try {\n        // KuCoin pair: BTC-USDT\n        const productId = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const params = {\n          clientOid: crypto.randomUUID(),\n          symbol: productId,\n          side: side.toLowerCase(),\n          type: type === 'market' ? 'market' : 'limit',\n        };\n        if (type === 'market') {\n          if (side.toLowerCase() === 'buy') {\n            params.funds = (parseFloat(quantity) * parseFloat(price || 0)).toFixed(2);\n          } else {\n            params.size = quantity.toString();\n          }\n        } else {\n          params.price = parseFloat(price).toFixed(2);\n          params.size = quantity.toString();\n        }\n        const result = await this._kucoinRequest(conn.creds, 'POST', '/api/v1/orders', params);\n        const orderId = result?.orderId || Date.now().toString(36);\n        return {\n          id: orderId, symbol: productId, side: side.toLowerCase(), type,\n          quantity: parseFloat(quantity), price: parseFloat(price || 0),\n          filledPrice: parseFloat(price || 0), filledQty: parseFloat(quantity),\n          status: 'filled', timestamp: new Date().toISOString(), broker: 'KuCoin', real: true,\n        };\n      } catch (err) { console.error('KuCoin placeOrder:', err); throw err; }\n    }\n\n    //  OKX \n    if (conn.config.id === 'okx') {\n      try {\n        // OKX pair: BTC-USDT\n        const productId = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const params = {\n          instId: productId,\n          tdMode: 'cash', // spot\n          side: side.toLowerCase(),\n          ordType: type === 'market' ? 'market' : 'limit',\n          sz: quantity.toString(),\n        };\n        if (type === 'market' && side.toLowerCase() === 'buy') {\n          params.tgtCcy = 'quote_ccy';\n          params.sz = (parseFloat(quantity) * parseFloat(price || 0)).toFixed(2);\n        }\n        if (type === 'limit') params.px = parseFloat(price).toFixed(2);\n        const result = await this._okxRequest(conn.creds, 'POST', '/api/v5/trade/order', params);\n        const orderId = Array.isArray(result) ? result[0]?.ordId : result?.ordId || Date.now().toString(36);\n        if (Array.isArray(result) && result[0]?.sCode !== '0') {\n          throw new Error(`OKX order failed: ${result[0]?.sMsg}`);\n        }\n        return {\n          id: orderId, symbol: productId, side: side.toLowerCase(), type,\n          quantity: parseFloat(quantity), price: parseFloat(price || 0),\n          filledPrice: parseFloat(price || 0), filledQty: parseFloat(quantity),\n          status: 'filled', timestamp: new Date().toISOString(), broker: 'OKX', real: true,\n        };\n      } catch (err) { console.error('OKX placeOrder:', err); throw err; }\n    }\n\n    //  BINGX \n    if (conn.config.id === 'bingx') {\n      try {\n        // BingX pair: BTC-USDT\n        const productId = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const params = {\n          symbol: productId,\n          side: side.toUpperCase(),\n          type: type === 'market' ? 'MARKET' : 'LIMIT',\n        };\n        if (type === 'market') {\n          if (side.toLowerCase() === 'buy') {\n            params.quoteOrderQty = (parseFloat(quantity) * parseFloat(price || 0)).toFixed(2);\n          } else {\n            params.quantity = parseFloat(quantity).toString();\n          }\n        } else {\n          params.price = parseFloat(price).toFixed(2);\n          params.quantity = parseFloat(quantity).toString();\n        }\n        const result = await this._bingxRequest(conn.creds, 'POST', '/openApi/spot/v1/trade/order', params);\n        const orderId = result?.orderId || result?.data?.orderId || Date.now().toString(36);\n        return {\n          id: orderId?.toString(), symbol: productId, side: side.toLowerCase(), type,\n          quantity: parseFloat(quantity), price: parseFloat(price || 0),\n          filledPrice: parseFloat(result?.price || price || 0),\n          filledQty: parseFloat(result?.executedQty || quantity),\n          status: 'filled', timestamp: new Date().toISOString(), broker: 'BingX', real: true,\n        };\n      } catch (err) { console.error('BingX placeOrder:', err); throw err; }\n    }\n\n    //  BITGET \n    if (conn.config.id === 'bitget') {\n      try {\n        const productId = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1$2').toUpperCase();\n        const params = {\n          symbol: productId,\n          side: side.toLowerCase(),\n          orderType: type === 'market' ? 'market' : 'limit',\n          force: 'gtc',\n          size: quantity.toString(),\n        };\n        if (type === 'market' && side.toLowerCase() === 'buy') {\n          params.size = (parseFloat(quantity) * parseFloat(price || 0)).toFixed(2);\n        }\n        if (type === 'limit') params.price = parseFloat(price).toFixed(2);\n        const result = await this._bitgetRequest(conn.creds, 'POST', '/api/v2/spot/trade/place-order', params);\n        const orderId = result?.orderId || Date.now().toString(36);\n        return {\n          id: orderId?.toString(), symbol: productId, side: side.toLowerCase(), type,\n          quantity: parseFloat(quantity), price: parseFloat(price || 0),\n          filledPrice: parseFloat(price || 0), filledQty: parseFloat(quantity),\n          status: 'filled', timestamp: new Date().toISOString(), broker: 'Bitget', real: true,\n        };\n      } catch (err) { console.error('Bitget placeOrder:', err); throw err; }\n    }\n\n    //  MEXC \n    if (conn.config.id === 'mexc') {\n      try {\n        // MEXC uses Binance-style symbols: BTCUSDT\n        const productId = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1$2').toUpperCase();\n        const params = {\n          symbol: productId,\n          side: side.toUpperCase(),\n          type: type === 'market' ? 'MARKET' : 'LIMIT',\n        };\n        if (type === 'market') {\n          if (side.toLowerCase() === 'buy') {\n            params.quoteOrderQty = (parseFloat(quantity) * parseFloat(price || 0)).toFixed(2);\n          } else {\n            params.quantity = parseFloat(quantity).toString();\n          }\n        } else {\n          params.price = parseFloat(price).toFixed(2);\n          params.quantity = parseFloat(quantity).toString();\n          params.timeInForce = 'GTC';\n        }\n        const result = await this._mexcRequest(conn.creds, 'POST', '/api/v3/order', params);\n        const orderId = result?.orderId || Date.now().toString(36);\n        return {\n          id: orderId?.toString(), symbol: productId, side: side.toLowerCase(), type,\n          quantity: parseFloat(quantity), price: parseFloat(price || 0),\n          filledPrice: parseFloat(result?.price || price || 0),\n          filledQty: parseFloat(result?.executedQty || quantity),\n          status: 'filled', timestamp: new Date().toISOString(), broker: 'MEXC', real: true,\n        };\n      } catch (err) { console.error('MEXC placeOrder:', err); throw err; }\n    }\n\n    //  WALLET / DEX \n    if (conn.config.id === 'wallet') {\n      try {\n        const chainId = conn.chainId || 56;\n        const privateKey = conn.creds.apiSecret;\n        const result = await walletBroker.placeOrder(privateKey, chainId, {\n          symbol, side, type: 'market', quantity, price\n        });\n        if (!result.success) throw new Error(result.error || 'DEX swap failed');\n        return {\n          id: result.txHash || Date.now().toString(36),\n          symbol: result.symbol || symbol,\n          side: side.toLowerCase(),\n          type: 'market',\n          quantity: parseFloat(result.amountIn || quantity),\n          price: parseFloat(result.effectivePrice || price || 0),\n          filledPrice: parseFloat(result.effectivePrice || price || 0),\n          filledQty: parseFloat(result.amountOut || quantity),\n          status: 'filled',\n          timestamp: new Date().toISOString(),\n          broker: result.mode === 'aggregator' ? 'Kairos Exchange' : 'Kairos Wallet',\n          real: true,\n          txHash: result.txHash,\n          chain: result.chain,\n          dex: result.dex,\n          mode: result.mode,\n          sources: result.sources,\n          sourceSummary: result.sourceSummary,\n        };\n      } catch (err) { console.error('Wallet DEX placeOrder:', err); throw err; }\n    }\n\n    // Simulated execution for any remaining unsupported brokers\n    return {\n      id: Date.now().toString(36),\n      symbol, side, type,\n      quantity: parseFloat(quantity),\n      price: price ? parseFloat(price) : null,\n      status: type === 'market' ? 'filled' : 'new',\n      filledPrice: type === 'market' ? parseFloat(price || 0) : null,\n      timestamp: new Date().toISOString(),\n      broker: conn.config.name,\n      simulated: true,\n    };\n  }\n\n  // \n  //  LEVERAGED ORDER  Open/Close positions via Kairos Margin/Perps API\n  //  Routes bot signals to the backend margin engine or DEX perps (GMX V2)\n  // \n\n  async placeLeveragedOrder(brokerId, order) {\n    const conn = this.connections.get(brokerId);\n    const { symbol, side, quantity, price, leverage, action, positionId, stopLoss, takeProfit, execRoute } = order;\n\n    // Get wallet address from Kairos account\n    const walletAddress = useStore.getState().user?.walletAddress;\n    if (!walletAddress) throw new Error('Wallet address required for leveraged trading');\n\n    // Choose API route: 'dex'  GMX V2 on Arbitrum, 'internal'  Kairos margin engine\n    const apiBase = execRoute === 'dex' ? `${KAIROS_API}/api/perps` : `${KAIROS_API}/api/margin`;\n\n    //  CLOSE position \n    if (action === 'close' && positionId) {\n      try {\n        const res = await fetch(`${apiBase}/close`, {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ wallet: walletAddress, positionId }),\n        });\n        const data = await res.json();\n        if (!res.ok || data.error) throw new Error(data.error || 'Close position failed');\n\n        const position = data.data || data;\n        return {\n          id: positionId,\n          symbol,\n          side: side.toLowerCase(),\n          type: 'market',\n          quantity: parseFloat(position.collateral || quantity),\n          price: parseFloat(position.exitPrice || price || 0),\n          filledPrice: parseFloat(position.exitPrice || price || 0),\n          filledQty: parseFloat(position.positionSize || quantity),\n          profit: parseFloat(position.realizedPnl || position.pnl || 0),\n          status: 'filled',\n          timestamp: new Date().toISOString(),\n          broker: 'Kairos Perps',\n          real: true,\n          leveraged: true,\n          leverage,\n          action: 'close',\n        };\n      } catch (err) {\n        console.error('[LEVERAGED] Close error:', err.message);\n        throw err;\n      }\n    }\n\n    //  OPEN position \n    try {\n      // Map signal side to leveraged side\n      const leveragedSide = side.toLowerCase() === 'buy' ? 'LONG' : 'SHORT';\n\n      // Calculate collateral from quantity * price / leverage\n      const collateral = parseFloat(quantity) * parseFloat(price || 1);\n\n      // Parse pair: BTCKAIROS  BTC/KAIROS, BTCUSDT  BTC/USD\n      let pair = symbol;\n      const pairMatch = symbol.match(/^([A-Z]+)(KAIROS|USDT|USDC|USD)$/i);\n      if (pairMatch) {\n        pair = `${pairMatch[1]}/${pairMatch[2] === 'KAIROS' ? 'KAIROS' : 'USD'}`;\n      }\n\n      const res = await fetch(`${apiBase}/open`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          wallet: walletAddress,\n          pair,\n          side: leveragedSide,\n          leverage: parseInt(leverage) || 3,\n          collateral,\n          stopLoss: stopLoss || undefined,\n          takeProfit: takeProfit || undefined,\n        }),\n      });\n      const data = await res.json();\n      if (!res.ok || data.error) throw new Error(data.error || 'Open position failed');\n\n      const position = data.data || data;\n      return {\n        id: position.id || position.positionId || Date.now().toString(36),\n        symbol,\n        side: side.toLowerCase(),\n        type: 'market',\n        quantity: parseFloat(position.collateral || collateral),\n        price: parseFloat(position.entryPrice || price || 0),\n        filledPrice: parseFloat(position.entryPrice || price || 0),\n        filledQty: parseFloat(position.positionSize || collateral * leverage),\n        status: 'filled',\n        timestamp: new Date().toISOString(),\n        broker: 'Kairos Perps',\n        real: true,\n        leveraged: true,\n        leverage: parseInt(leverage),\n        positionId: position.id || position.positionId,\n        liquidationPrice: position.liquidationPrice,\n        marginRatio: position.marginRatio,\n        action: 'open',\n      };\n    } catch (err) {\n      console.error('[LEVERAGED] Open error:', err.message);\n      throw err;\n    }\n  }\n\n  // \n  //  CLOSE LEVERAGED  convenience for closing a leveraged position\n  // \n\n  async closeLeveragedPosition(brokerId, { positionId, symbol, side, price, leverage }) {\n    return this.placeLeveragedOrder(brokerId, {\n      symbol, side: side === 'buy' ? 'sell' : 'buy', // Opposite side to close\n      quantity: 0, price, leverage, action: 'close', positionId,\n    });\n  }\n\n  //  Cancel order \n  async cancelOrder(brokerId, orderId, symbol) {\n    const conn = this.connections.get(brokerId);\n    if (!conn) throw new Error('Broker not connected');\n\n    if (conn.config.id === 'binance') {\n      try {\n        const result = await this._binanceSignedRequest(conn.creds, 'DELETE', '/api/v3/order', { symbol, orderId });\n        return { success: true, orderId: result.orderId, status: result.status };\n      } catch (err) { return { success: false, message: err.message }; }\n    }\n    if (conn.config.id === 'coinbase') {\n      try {\n        await this._coinbaseRequest(conn.creds, 'POST', '/api/v3/brokerage/orders/batch_cancel', { order_ids: [orderId] });\n        return { success: true, orderId };\n      } catch (err) { return { success: false, message: err.message }; }\n    }\n    if (conn.config.id === 'bybit') {\n      try {\n        await this._bybitRequest(conn.creds, 'POST', '/v5/order/cancel', { category: 'spot', symbol, orderId });\n        return { success: true, orderId };\n      } catch (err) { return { success: false, message: err.message }; }\n    }\n    if (conn.config.id === 'kraken') {\n      try {\n        await this._krakenRequest(conn.creds, '/0/private/CancelOrder', { txid: orderId });\n        return { success: true, orderId };\n      } catch (err) { return { success: false, message: err.message }; }\n    }\n    if (conn.config.id === 'kucoin') {\n      try {\n        await this._kucoinRequest(conn.creds, 'DELETE', `/api/v1/orders/${orderId}`);\n        return { success: true, orderId };\n      } catch (err) { return { success: false, message: err.message }; }\n    }\n    if (conn.config.id === 'okx') {\n      try {\n        await this._okxRequest(conn.creds, 'POST', '/api/v5/trade/cancel-order', { instId: symbol, ordId: orderId });\n        return { success: true, orderId };\n      } catch (err) { return { success: false, message: err.message }; }\n    }\n    if (conn.config.id === 'bingx') {\n      try {\n        await this._bingxRequest(conn.creds, 'POST', '/openApi/spot/v1/trade/cancel', { symbol, orderId });\n        return { success: true, orderId };\n      } catch (err) { return { success: false, message: err.message }; }\n    }\n    if (conn.config.id === 'bitget') {\n      try {\n        await this._bitgetRequest(conn.creds, 'POST', '/api/v2/spot/trade/cancel-order', { symbol, orderId });\n        return { success: true, orderId };\n      } catch (err) { return { success: false, message: err.message }; }\n    }\n    if (conn.config.id === 'mexc') {\n      try {\n        await this._mexcRequest(conn.creds, 'DELETE', '/api/v3/order', { symbol, orderId });\n        return { success: true, orderId };\n      } catch (err) { return { success: false, message: err.message }; }\n    }\n    if (conn.config.id === 'wallet') {\n      return { success: false, message: 'DEX orders are instant swaps and cannot be cancelled' };\n    }\n\n    return { success: true, orderId, simulated: true };\n  }\n\n  //  Get open orders (real) \n  async getOpenOrders(brokerId, symbol) {\n    const conn = this.connections.get(brokerId);\n    if (!conn) throw new Error('Broker not connected');\n\n    if (conn.config.id === 'binance') {\n      try {\n        const params = symbol ? { symbol } : {};\n        const orders = await this._binanceSignedRequest(conn.creds, 'GET', '/api/v3/openOrders', params);\n        return orders.map(o => ({\n          id: o.orderId?.toString(),\n          symbol: o.symbol,\n          side: o.side?.toLowerCase(),\n          type: o.type?.toLowerCase(),\n          quantity: parseFloat(o.origQty),\n          price: parseFloat(o.price),\n          filledQty: parseFloat(o.executedQty),\n          status: o.status?.toLowerCase(),\n          time: new Date(o.time).toISOString(),\n        }));\n      } catch (err) {\n        return [];\n      }\n    }\n\n    if (conn.config.id === 'coinbase') {\n      try {\n        const productId = symbol\n          ? symbol.replace(/([A-Z]+)(USDT|USDC|USD|BTC|ETH)$/i, '$1-$2').toUpperCase()\n          : undefined;\n        let url = '/api/v3/brokerage/orders/historical/batch?order_status=OPEN';\n        if (productId) url += `&product_id=${productId}`;\n        const data = await this._coinbaseRequest(conn.creds, 'GET', url);\n        return (data.orders || []).map(o => ({\n          id: o.order_id,\n          symbol: o.product_id,\n          side: o.side?.toLowerCase(),\n          type: o.order_type?.toLowerCase(),\n          quantity: parseFloat(o.order_configuration?.limit_limit_gtc?.base_size || 0),\n          price: parseFloat(o.order_configuration?.limit_limit_gtc?.limit_price || o.average_filled_price || 0),\n          filledQty: parseFloat(o.filled_size || 0),\n          status: o.status?.toLowerCase(),\n          time: o.created_time,\n        }));\n      } catch (err) {\n        console.error('[COINBASE] getOpenOrders error:', err.message);\n        return [];\n      }\n    }\n\n    //  BYBIT v5 \n    if (conn.config.id === 'bybit') {\n      try {\n        const params = { category: 'spot' };\n        if (symbol) params.symbol = symbol;\n        const data = await this._bybitRequest(conn.creds, 'GET', '/v5/order/realtime', params);\n        return (data?.list || []).map(o => ({\n          id: o.orderId,\n          symbol: o.symbol,\n          side: o.side?.toLowerCase(),\n          type: o.orderType?.toLowerCase(),\n          quantity: parseFloat(o.qty || 0),\n          price: parseFloat(o.price || 0),\n          filledQty: parseFloat(o.cumExecQty || 0),\n          status: o.orderStatus?.toLowerCase(),\n          time: o.createdTime ? new Date(parseInt(o.createdTime)).toISOString() : null,\n        }));\n      } catch (err) { console.error('Bybit getOpenOrders:', err.message); return []; }\n    }\n\n    //  KRAKEN \n    if (conn.config.id === 'kraken') {\n      try {\n        const data = await this._krakenRequest(conn.creds, '/0/private/OpenOrders');\n        const orders = data?.open || {};\n        return Object.entries(orders).map(([txid, o]) => ({\n          id: txid,\n          symbol: o.descr?.pair || '',\n          side: o.descr?.type?.toLowerCase(),\n          type: o.descr?.ordertype?.toLowerCase(),\n          quantity: parseFloat(o.vol || 0),\n          price: parseFloat(o.descr?.price || 0),\n          filledQty: parseFloat(o.vol_exec || 0),\n          status: o.status?.toLowerCase() || 'open',\n          time: o.opentm ? new Date(o.opentm * 1000).toISOString() : null,\n        }));\n      } catch (err) { console.error('Kraken getOpenOrders:', err.message); return []; }\n    }\n\n    //  KUCOIN \n    if (conn.config.id === 'kucoin') {\n      try {\n        const params = { status: 'active' };\n        if (symbol) params.symbol = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const data = await this._kucoinRequest(conn.creds, 'GET', '/api/v1/orders', params);\n        const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);\n        return items.map(o => ({\n          id: o.id,\n          symbol: o.symbol,\n          side: o.side?.toLowerCase(),\n          type: o.type?.toLowerCase(),\n          quantity: parseFloat(o.size || 0),\n          price: parseFloat(o.price || 0),\n          filledQty: parseFloat(o.dealSize || 0),\n          status: o.isActive ? 'open' : 'done',\n          time: o.createdAt ? new Date(parseInt(o.createdAt)).toISOString() : null,\n        }));\n      } catch (err) { console.error('KuCoin getOpenOrders:', err.message); return []; }\n    }\n\n    //  OKX \n    if (conn.config.id === 'okx') {\n      try {\n        const params = { instType: 'SPOT' };\n        if (symbol) params.instId = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const data = await this._okxRequest(conn.creds, 'GET', '/api/v5/trade/orders-pending', params);\n        const items = Array.isArray(data) ? data : [];\n        return items.map(o => ({\n          id: o.ordId,\n          symbol: o.instId,\n          side: o.side?.toLowerCase(),\n          type: o.ordType?.toLowerCase(),\n          quantity: parseFloat(o.sz || 0),\n          price: parseFloat(o.px || 0),\n          filledQty: parseFloat(o.accFillSz || 0),\n          status: o.state?.toLowerCase() || 'open',\n          time: o.cTime ? new Date(parseInt(o.cTime)).toISOString() : null,\n        }));\n      } catch (err) { console.error('OKX getOpenOrders:', err.message); return []; }\n    }\n\n    //  BINGX \n    if (conn.config.id === 'bingx') {\n      try {\n        const params = {};\n        if (symbol) params.symbol = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const data = await this._bingxRequest(conn.creds, 'GET', '/openApi/spot/v1/trade/openOrders', params);\n        const orders = data?.orders || (Array.isArray(data) ? data : []);\n        return orders.map(o => ({\n          id: o.orderId?.toString(),\n          symbol: o.symbol,\n          side: o.side?.toLowerCase(),\n          type: o.type?.toLowerCase(),\n          quantity: parseFloat(o.origQty || 0),\n          price: parseFloat(o.price || 0),\n          filledQty: parseFloat(o.executedQty || 0),\n          status: o.status?.toLowerCase() || 'open',\n          time: o.time ? new Date(parseInt(o.time)).toISOString() : null,\n        }));\n      } catch (err) { console.error('BingX getOpenOrders:', err.message); return []; }\n    }\n\n    //  BITGET \n    if (conn.config.id === 'bitget') {\n      try {\n        const params = {};\n        if (symbol) params.symbol = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1$2').toUpperCase();\n        const data = await this._bitgetRequest(conn.creds, 'GET', '/api/v2/spot/trade/unfilled-orders', params);\n        const items = Array.isArray(data) ? data : [];\n        return items.map(o => ({\n          id: o.orderId,\n          symbol: o.symbol,\n          side: o.side?.toLowerCase(),\n          type: o.orderType?.toLowerCase(),\n          quantity: parseFloat(o.size || 0),\n          price: parseFloat(o.price || 0),\n          filledQty: parseFloat(o.baseVolume || 0),\n          status: o.status?.toLowerCase() || 'open',\n          time: o.cTime ? new Date(parseInt(o.cTime)).toISOString() : null,\n        }));\n      } catch (err) { console.error('Bitget getOpenOrders:', err.message); return []; }\n    }\n\n    //  MEXC \n    if (conn.config.id === 'mexc') {\n      try {\n        const params = {};\n        if (symbol) params.symbol = symbol;\n        const data = await this._mexcRequest(conn.creds, 'GET', '/api/v3/openOrders', params);\n        const orders = Array.isArray(data) ? data : [];\n        return orders.map(o => ({\n          id: o.orderId?.toString(),\n          symbol: o.symbol,\n          side: o.side?.toLowerCase(),\n          type: o.type?.toLowerCase(),\n          quantity: parseFloat(o.origQty || 0),\n          price: parseFloat(o.price || 0),\n          filledQty: parseFloat(o.executedQty || 0),\n          status: o.status?.toLowerCase() || 'open',\n          time: o.time ? new Date(o.time).toISOString() : null,\n        }));\n      } catch (err) { console.error('MEXC getOpenOrders:', err.message); return []; }\n    }\n\n    return [];\n  }\n\n  //  Get closed/completed orders (filled, cancelled, expired) \n  async getClosedOrders(brokerId, symbol, limit = 50) {\n    const conn = this.connections.get(brokerId);\n    if (!conn) throw new Error('Broker not connected');\n\n    const normalize = (o, fields) => ({\n      id: o[fields.id]?.toString() || '',\n      symbol: o[fields.symbol] || '',\n      side: (o[fields.side] || '').toLowerCase(),\n      type: (o[fields.type] || '').toLowerCase(),\n      quantity: parseFloat(o[fields.qty] || 0),\n      price: parseFloat(o[fields.price] || 0),\n      filledQty: parseFloat(o[fields.filledQty] || 0),\n      avgPrice: parseFloat(o[fields.avgPrice] || o[fields.price] || 0),\n      status: (o[fields.status] || 'closed').toLowerCase(),\n      time: fields.timeFn ? fields.timeFn(o) : null,\n    });\n\n    //  BINANCE \n    if (conn.config.id === 'binance') {\n      try {\n        const params = { limit };\n        if (symbol) params.symbol = symbol;\n        const data = await this._binanceSignedRequest(conn.creds, 'GET', '/api/v3/allOrders', params);\n        const orders = Array.isArray(data) ? data : [];\n        return orders.filter(o => o.status !== 'NEW' && o.status !== 'PARTIALLY_FILLED').map(o => normalize(o, {\n          id: 'orderId', symbol: 'symbol', side: 'side', type: 'type',\n          qty: 'origQty', price: 'price', filledQty: 'executedQty', avgPrice: 'price',\n          status: 'status', timeFn: (o) => o.time ? new Date(o.time).toISOString() : null,\n        }));\n      } catch (err) { console.error('Binance getClosedOrders:', err.message); return []; }\n    }\n\n    //  COINBASE \n    if (conn.config.id === 'coinbase') {\n      try {\n        const params = { order_status: ['FILLED', 'CANCELLED', 'EXPIRED'], limit };\n        if (symbol) params.product_id = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const data = await this._coinbaseRequest(conn.creds, 'GET', '/api/v3/brokerage/orders/historical/batch', params);\n        return (data?.orders || []).map(o => normalize(o, {\n          id: 'order_id', symbol: 'product_id', side: 'side', type: 'order_type',\n          qty: 'base_size', price: 'average_filled_price', filledQty: 'filled_size', avgPrice: 'average_filled_price',\n          status: 'status', timeFn: (o) => o.created_time || null,\n        }));\n      } catch (err) { console.error('Coinbase getClosedOrders:', err.message); return []; }\n    }\n\n    //  BYBIT v5 \n    if (conn.config.id === 'bybit') {\n      try {\n        const params = { category: 'spot', limit: limit.toString() };\n        if (symbol) params.symbol = symbol;\n        const data = await this._bybitRequest(conn.creds, 'GET', '/v5/order/history', params);\n        return (data?.list || []).map(o => normalize(o, {\n          id: 'orderId', symbol: 'symbol', side: 'side', type: 'orderType',\n          qty: 'qty', price: 'price', filledQty: 'cumExecQty', avgPrice: 'avgPrice',\n          status: 'orderStatus', timeFn: (o) => o.createdTime ? new Date(parseInt(o.createdTime)).toISOString() : null,\n        }));\n      } catch (err) { console.error('Bybit getClosedOrders:', err.message); return []; }\n    }\n\n    //  KRAKEN \n    if (conn.config.id === 'kraken') {\n      try {\n        const data = await this._krakenRequest(conn.creds, '/0/private/ClosedOrders');\n        const orders = data?.closed || {};\n        return Object.entries(orders).slice(0, limit).map(([txid, o]) => ({\n          id: txid,\n          symbol: o.descr?.pair || '',\n          side: (o.descr?.type || '').toLowerCase(),\n          type: (o.descr?.ordertype || '').toLowerCase(),\n          quantity: parseFloat(o.vol || 0),\n          price: parseFloat(o.descr?.price || 0),\n          filledQty: parseFloat(o.vol_exec || 0),\n          avgPrice: parseFloat(o.price || o.descr?.price || 0),\n          status: (o.status || 'closed').toLowerCase(),\n          time: o.closetm ? new Date(o.closetm * 1000).toISOString() : null,\n        }));\n      } catch (err) { console.error('Kraken getClosedOrders:', err.message); return []; }\n    }\n\n    //  KUCOIN \n    if (conn.config.id === 'kucoin') {\n      try {\n        const params = { status: 'done' };\n        if (symbol) params.symbol = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const data = await this._kucoinRequest(conn.creds, 'GET', '/api/v1/orders', params);\n        const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);\n        return items.slice(0, limit).map(o => normalize(o, {\n          id: 'id', symbol: 'symbol', side: 'side', type: 'type',\n          qty: 'size', price: 'price', filledQty: 'dealSize', avgPrice: 'dealFunds',\n          status: 'status', timeFn: (o) => o.createdAt ? new Date(parseInt(o.createdAt)).toISOString() : null,\n        }));\n      } catch (err) { console.error('KuCoin getClosedOrders:', err.message); return []; }\n    }\n\n    //  OKX \n    if (conn.config.id === 'okx') {\n      try {\n        const params = { instType: 'SPOT' };\n        if (symbol) params.instId = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const data = await this._okxRequest(conn.creds, 'GET', '/api/v5/trade/orders-history-archive', params);\n        const items = Array.isArray(data) ? data : [];\n        return items.slice(0, limit).map(o => normalize(o, {\n          id: 'ordId', symbol: 'instId', side: 'side', type: 'ordType',\n          qty: 'sz', price: 'px', filledQty: 'accFillSz', avgPrice: 'avgPx',\n          status: 'state', timeFn: (o) => o.cTime ? new Date(parseInt(o.cTime)).toISOString() : null,\n        }));\n      } catch (err) { console.error('OKX getClosedOrders:', err.message); return []; }\n    }\n\n    //  BINGX \n    if (conn.config.id === 'bingx') {\n      try {\n        const params = { limit: limit.toString() };\n        if (symbol) params.symbol = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const data = await this._bingxRequest(conn.creds, 'GET', '/openApi/spot/v1/trade/historyOrders', params);\n        const orders = data?.orders || (Array.isArray(data) ? data : []);\n        return orders.map(o => normalize(o, {\n          id: 'orderId', symbol: 'symbol', side: 'side', type: 'type',\n          qty: 'origQty', price: 'price', filledQty: 'executedQty', avgPrice: 'avgPrice',\n          status: 'status', timeFn: (o) => o.time ? new Date(parseInt(o.time)).toISOString() : null,\n        }));\n      } catch (err) { console.error('BingX getClosedOrders:', err.message); return []; }\n    }\n\n    //  BITGET \n    if (conn.config.id === 'bitget') {\n      try {\n        const params = { limit: limit.toString() };\n        if (symbol) params.symbol = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1$2').toUpperCase();\n        const data = await this._bitgetRequest(conn.creds, 'GET', '/api/v2/spot/trade/history-orders', params);\n        const items = Array.isArray(data) ? data : [];\n        return items.map(o => normalize(o, {\n          id: 'orderId', symbol: 'symbol', side: 'side', type: 'orderType',\n          qty: 'size', price: 'price', filledQty: 'baseVolume', avgPrice: 'priceAvg',\n          status: 'status', timeFn: (o) => o.cTime ? new Date(parseInt(o.cTime)).toISOString() : null,\n        }));\n      } catch (err) { console.error('Bitget getClosedOrders:', err.message); return []; }\n    }\n\n    //  MEXC \n    if (conn.config.id === 'mexc') {\n      try {\n        const params = { limit };\n        if (symbol) params.symbol = symbol;\n        const data = await this._mexcRequest(conn.creds, 'GET', '/api/v3/allOrders', params);\n        const orders = Array.isArray(data) ? data : [];\n        return orders.filter(o => o.status !== 'NEW').map(o => normalize(o, {\n          id: 'orderId', symbol: 'symbol', side: 'side', type: 'type',\n          qty: 'origQty', price: 'price', filledQty: 'executedQty', avgPrice: 'price',\n          status: 'status', timeFn: (o) => o.time ? new Date(o.time).toISOString() : null,\n        }));\n      } catch (err) { console.error('MEXC getClosedOrders:', err.message); return []; }\n    }\n\n    return [];\n  }\n\n  //  Get trade history (real) \n  async getTradeHistory(brokerId, symbol, limit = 50) {\n    const conn = this.connections.get(brokerId);\n    if (!conn) throw new Error('Broker not connected');\n\n    if (conn.config.id === 'binance') {\n      try {\n        const trades = await this._binanceSignedRequest(conn.creds, 'GET', '/api/v3/myTrades', { symbol, limit });\n        return trades.map(t => ({\n          id: t.id?.toString(),\n          orderId: t.orderId?.toString(),\n          symbol: t.symbol,\n          side: t.isBuyer ? 'buy' : 'sell',\n          price: parseFloat(t.price),\n          quantity: parseFloat(t.qty),\n          commission: parseFloat(t.commission),\n          commissionAsset: t.commissionAsset,\n          time: new Date(t.time).toISOString(),\n          isMaker: t.isMaker,\n        }));\n      } catch (err) {\n        return [];\n      }\n    }\n\n    if (conn.config.id === 'coinbase') {\n      try {\n        const productId = symbol\n          ? symbol.replace(/([A-Z]+)(USDT|USDC|USD|BTC|ETH)$/i, '$1-$2').toUpperCase()\n          : undefined;\n        let url = `/api/v3/brokerage/orders/historical/fills?limit=${limit}`;\n        if (productId) url += `&product_id=${productId}`;\n        const data = await this._coinbaseRequest(conn.creds, 'GET', url);\n\n        return (data.fills || []).map(f => ({\n          id: f.trade_id || f.entry_id,\n          orderId: f.order_id,\n          symbol: f.product_id,\n          side: f.side?.toLowerCase(),\n          price: parseFloat(f.price || 0),\n          quantity: parseFloat(f.size || f.size_in_quote || 0),\n          commission: parseFloat(f.commission || 0),\n          commissionAsset: f.product_id?.split('-')?.[1] || 'USD',\n          time: f.trade_time,\n          isMaker: false,\n        }));\n      } catch (err) {\n        console.error('[COINBASE] getTradeHistory error:', err.message);\n        return [];\n      }\n    }\n\n    //  BYBIT v5 \n    if (conn.config.id === 'bybit') {\n      try {\n        const params = { category: 'spot', limit: limit.toString() };\n        if (symbol) params.symbol = symbol;\n        const data = await this._bybitRequest(conn.creds, 'GET', '/v5/execution/list', params);\n        return (data?.list || []).map(t => ({\n          id: t.execId,\n          orderId: t.orderId,\n          symbol: t.symbol,\n          side: t.side?.toLowerCase(),\n          price: parseFloat(t.execPrice || 0),\n          quantity: parseFloat(t.execQty || 0),\n          commission: parseFloat(t.execFee || 0),\n          commissionAsset: t.feeCurrency || '',\n          time: t.execTime ? new Date(parseInt(t.execTime)).toISOString() : null,\n          isMaker: t.isMaker === 'true' || t.isMaker === true,\n        }));\n      } catch (err) { console.error('Bybit getTradeHistory:', err.message); return []; }\n    }\n\n    //  KRAKEN \n    if (conn.config.id === 'kraken') {\n      try {\n        const data = await this._krakenRequest(conn.creds, '/0/private/TradesHistory');\n        const trades = data?.trades || {};\n        return Object.entries(trades).slice(0, limit).map(([txid, t]) => ({\n          id: txid,\n          orderId: t.ordertxid,\n          symbol: t.pair,\n          side: t.type?.toLowerCase(),\n          price: parseFloat(t.price || 0),\n          quantity: parseFloat(t.vol || 0),\n          commission: parseFloat(t.fee || 0),\n          commissionAsset: '',\n          time: t.time ? new Date(t.time * 1000).toISOString() : null,\n          isMaker: t.maker === true,\n        }));\n      } catch (err) { console.error('Kraken getTradeHistory:', err.message); return []; }\n    }\n\n    //  KUCOIN \n    if (conn.config.id === 'kucoin') {\n      try {\n        const params = {};\n        if (symbol) params.symbol = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const data = await this._kucoinRequest(conn.creds, 'GET', '/api/v1/fills', params);\n        const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data) ? data : []);\n        return items.slice(0, limit).map(t => ({\n          id: t.tradeId || t.id,\n          orderId: t.orderId,\n          symbol: t.symbol,\n          side: t.side?.toLowerCase(),\n          price: parseFloat(t.price || 0),\n          quantity: parseFloat(t.size || 0),\n          commission: parseFloat(t.fee || 0),\n          commissionAsset: t.feeCurrency || '',\n          time: t.createdAt ? new Date(parseInt(t.createdAt)).toISOString() : null,\n          isMaker: t.liquidity === 'maker',\n        }));\n      } catch (err) { console.error('KuCoin getTradeHistory:', err.message); return []; }\n    }\n\n    //  OKX \n    if (conn.config.id === 'okx') {\n      try {\n        const params = { instType: 'SPOT' };\n        if (symbol) params.instId = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const data = await this._okxRequest(conn.creds, 'GET', '/api/v5/trade/fills-history', params);\n        const items = Array.isArray(data) ? data : [];\n        return items.slice(0, limit).map(t => ({\n          id: t.tradeId || t.billId,\n          orderId: t.ordId,\n          symbol: t.instId,\n          side: t.side?.toLowerCase(),\n          price: parseFloat(t.fillPx || 0),\n          quantity: parseFloat(t.fillSz || 0),\n          commission: Math.abs(parseFloat(t.fee || 0)),\n          commissionAsset: t.feeCcy || '',\n          time: t.ts ? new Date(parseInt(t.ts)).toISOString() : null,\n          isMaker: t.execType === 'M',\n        }));\n      } catch (err) { console.error('OKX getTradeHistory:', err.message); return []; }\n    }\n\n    //  BINGX \n    if (conn.config.id === 'bingx') {\n      try {\n        const params = { limit: limit.toString() };\n        if (symbol) params.symbol = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1-$2').toUpperCase();\n        const data = await this._bingxRequest(conn.creds, 'GET', '/openApi/spot/v1/trade/historyOrders', params);\n        const orders = data?.orders || (Array.isArray(data) ? data : []);\n        return orders.map(t => ({\n          id: t.orderId?.toString(),\n          orderId: t.orderId?.toString(),\n          symbol: t.symbol,\n          side: t.side?.toLowerCase(),\n          price: parseFloat(t.price || t.avgPrice || 0),\n          quantity: parseFloat(t.executedQty || t.origQty || 0),\n          commission: parseFloat(t.commission || 0),\n          commissionAsset: t.commissionAsset || '',\n          time: t.time ? new Date(parseInt(t.time)).toISOString() : null,\n          isMaker: false,\n        }));\n      } catch (err) { console.error('BingX getTradeHistory:', err.message); return []; }\n    }\n\n    //  BITGET \n    if (conn.config.id === 'bitget') {\n      try {\n        const params = { limit: limit.toString() };\n        if (symbol) params.symbol = symbol.replace(/([A-Z]+)(USDT|USDC|USD)$/i, '$1$2').toUpperCase();\n        const data = await this._bitgetRequest(conn.creds, 'GET', '/api/v2/spot/trade/fills', params);\n        const items = Array.isArray(data) ? data : [];\n        return items.map(t => ({\n          id: t.tradeId || t.fillId,\n          orderId: t.orderId,\n          symbol: t.symbol,\n          side: t.side?.toLowerCase(),\n          price: parseFloat(t.priceAvg || t.price || 0),\n          quantity: parseFloat(t.size || 0),\n          commission: parseFloat(t.fees || t.fee || 0),\n          commissionAsset: t.feeCcy || '',\n          time: t.cTime ? new Date(parseInt(t.cTime)).toISOString() : null,\n          isMaker: t.tradeScope === 'maker',\n        }));\n      } catch (err) { console.error('Bitget getTradeHistory:', err.message); return []; }\n    }\n\n    //  MEXC \n    if (conn.config.id === 'mexc') {\n      try {\n        const params = { limit };\n        if (symbol) params.symbol = symbol;\n        const data = await this._mexcRequest(conn.creds, 'GET', '/api/v3/myTrades', params);\n        const trades = Array.isArray(data) ? data : [];\n        return trades.map(t => ({\n          id: t.id?.toString(),\n          orderId: t.orderId?.toString(),\n          symbol: t.symbol,\n          side: t.isBuyer ? 'buy' : 'sell',\n          price: parseFloat(t.price || 0),\n          quantity: parseFloat(t.qty || 0),\n          commission: parseFloat(t.commission || 0),\n          commissionAsset: t.commissionAsset || '',\n          time: t.time ? new Date(t.time).toISOString() : null,\n          isMaker: t.isMaker === true,\n        }));\n      } catch (err) { console.error('MEXC getTradeHistory:', err.message); return []; }\n    }\n\n    return [];\n  }\n\n  //  Get exchange info (filters, min qty, etc.) \n  async getExchangeInfo(symbol) {\n    try {\n      const info = await this._binancePublicRequest('/api/v3/exchangeInfo', { symbol });\n      const symbolInfo = info.symbols?.[0];\n      if (!symbolInfo) return null;\n\n      const lotSize = symbolInfo.filters?.find(f => f.filterType === 'LOT_SIZE');\n      const priceFilter = symbolInfo.filters?.find(f => f.filterType === 'PRICE_FILTER');\n      const minNotional = symbolInfo.filters?.find(f => f.filterType === 'NOTIONAL' || f.filterType === 'MIN_NOTIONAL');\n\n      return {\n        symbol: symbolInfo.symbol,\n        status: symbolInfo.status,\n        baseAsset: symbolInfo.baseAsset,\n        quoteAsset: symbolInfo.quoteAsset,\n        minQty: lotSize ? parseFloat(lotSize.minQty) : 0,\n        maxQty: lotSize ? parseFloat(lotSize.maxQty) : Infinity,\n        stepSize: lotSize ? parseFloat(lotSize.stepSize) : 0,\n        minPrice: priceFilter ? parseFloat(priceFilter.minPrice) : 0,\n        tickSize: priceFilter ? parseFloat(priceFilter.tickSize) : 0,\n        minNotional: minNotional ? parseFloat(minNotional.minNotional || minNotional.notional) : 0,\n      };\n    } catch {\n      return null;\n    }\n  }\n\n  //  Is connected? \n  isConnected(brokerId) {\n    return this.connections.has(brokerId);\n  }\n\n  //  Get connection info \n  getConnection(brokerId) {\n    return this.connections.get(brokerId);\n  }\n\n  //  Disconnect \n  disconnect(brokerId) {\n    this.connections.delete(brokerId);\n  }\n}\n\nexport const brokerService = new BrokerService();\nexport default brokerService;\n"],"file":"assets/broker-BUr9uyY7.js"}