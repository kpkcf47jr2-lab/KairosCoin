import{a as b,j as e,P as R,ap as _,o as I,m as C,a0 as M,B as H,T as L,s as O,a2 as B,a1 as D,S as V}from"./ui-8HTTZoBK.js";import{f as E,u as W,c as z,g as U}from"./index-B3zs21wG.js";import{m as k}from"./marketData-K1zKCjjj.js";import"./vendor-C1W0orB6.js";const A="kairos_trade_simulator";class J{constructor(){this.state=this._load()}_load(){try{const i=JSON.parse(localStorage.getItem(A));if(i)return i}catch{}return this._defaultState()}_defaultState(){return{balance:1e4,initialBalance:1e4,positions:[],closedTrades:[],orders:[],equity:1e4,stats:{totalTrades:0,wins:0,losses:0,totalPnl:0,bestTrade:0,worstTrade:0,avgWin:0,avgLoss:0,maxDrawdown:0,sharpeRatio:0},equityHistory:[{time:Date.now(),value:1e4}],createdAt:new Date().toISOString()}}_save(){localStorage.setItem(A,JSON.stringify(this.state))}reset(i=1e4){return this.state=this._defaultState(),this.state.balance=i,this.state.initialBalance=i,this.state.equity=i,this.state.equityHistory=[{time:Date.now(),value:i}],this._save(),this.state}async openPosition(i,t,r,s={}){const l=await k.getPrice(i),n=l*r;if(n>this.state.balance)throw new Error(`Fondos insuficientes. Necesitas $${n.toFixed(2)}, tienes $${this.state.balance.toFixed(2)}`);const o={id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),symbol:i,side:t,quantity:r,entryPrice:l,currentPrice:l,cost:n,pnl:0,pnlPercent:0,stopLoss:s.stopLoss||null,takeProfit:s.takeProfit||null,leverage:s.leverage||1,openedAt:new Date().toISOString()},c=E.applyVolumeFee(l,r);return this.state.balance-=n+c,this.state.positions.push(o),this._save(),{success:!0,position:o,message:`${t.toUpperCase()} ${r} ${i} @ $${l.toFixed(2)}`}}async closePosition(i){const t=this.state.positions.findIndex(y=>y.id===i);if(t===-1)throw new Error("Posición no encontrada");const r=this.state.positions[t],s=await k.getPrice(r.symbol),l=r.side==="buy"?(s-r.entryPrice)*r.quantity*r.leverage:(r.entryPrice-s)*r.quantity*r.leverage,{adjustedPnl:n,fee:o}=E.applyFee(s,r.quantity,l),c=n/r.cost*100,g={...r,exitPrice:s,pnl:n,pnlPercent:c,closedAt:new Date().toISOString(),duration:Date.now()-new Date(r.openedAt).getTime()};return this.state.balance+=r.cost+n,this.state.positions.splice(t,1),this.state.closedTrades.push(g),this._updateStats(n),this._save(),{success:!0,trade:g,message:`Cerrada: ${n>=0?"+":""}$${n.toFixed(2)} (${c.toFixed(1)}%)`}}async placeLimitOrder(i,t,r,s,l={}){const n=await k.getPrice(i),o={id:Date.now().toString(36),symbol:i,side:t,quantity:r,targetPrice:s,currentPrice:n,type:"limit",stopLoss:l.stopLoss||null,takeProfit:l.takeProfit||null,status:"pending",createdAt:new Date().toISOString()};return this.state.orders.push(o),this._save(),{success:!0,order:o}}cancelOrder(i){return this.state.orders=this.state.orders.filter(t=>t.id!==i),this._save(),{success:!0}}async updatePositions(){let i=this.state.balance;for(const t of this.state.positions)try{const r=await k.getPrice(t.symbol);if(t.currentPrice=r,t.pnl=t.side==="buy"?(r-t.entryPrice)*t.quantity*(t.leverage||1):(t.entryPrice-r)*t.quantity*(t.leverage||1),t.pnlPercent=t.pnl/t.cost*100,i+=t.cost+t.pnl,t.stopLoss&&(t.side==="buy"?r<=t.stopLoss:r>=t.stopLoss)){await this.closePosition(t.id);continue}if(t.takeProfit&&(t.side==="buy"?r>=t.takeProfit:r<=t.takeProfit)){await this.closePosition(t.id);continue}}catch{}for(const t of this.state.orders.filter(r=>r.status==="pending"))try{const r=await k.getPrice(t.symbol);(t.side==="buy"?r<=t.targetPrice:r>=t.targetPrice)&&(t.status="filled",await this.openPosition(t.symbol,t.side,t.quantity,{stopLoss:t.stopLoss,takeProfit:t.takeProfit}))}catch{}return this.state.orders=this.state.orders.filter(t=>t.status==="pending"),this.state.equity=i,this.state.equityHistory.push({time:Date.now(),value:i}),this.state.equityHistory.length>500&&(this.state.equityHistory=this.state.equityHistory.slice(-500)),this._save(),this.state}_updateStats(i){const t=this.state.stats;t.totalTrades++,t.totalPnl+=i,i>0?(t.wins++,t.bestTrade=Math.max(t.bestTrade,i)):(t.losses++,t.worstTrade=Math.min(t.worstTrade,i)),t.avgWin=t.wins>0?t.totalPnl/t.wins:0,t.avgLoss=t.losses>0?(t.totalPnl-t.avgWin*t.wins)/t.losses:0;const r=Math.max(...this.state.equityHistory.map(n=>n.value));t.maxDrawdown=(r-this.state.equity)/r*100,t.winRate=t.totalTrades>0?t.wins/t.totalTrades*100:0;const s=this.state.closedTrades.filter(n=>n.pnl>0).reduce((n,o)=>n+o.pnl,0),l=Math.abs(this.state.closedTrades.filter(n=>n.pnl<0).reduce((n,o)=>n+o.pnl,0));t.profitFactor=l>0?s/l:s>0?1/0:0}getState(){return this.state}getPerformance(){const i=this.state,t=(i.equity-i.initialBalance)/i.initialBalance*100;return{balance:i.balance,equity:i.equity,initialBalance:i.initialBalance,returnPct:t,openPositions:i.positions.length,pendingOrders:i.orders.length,...i.stats}}}const u=new J;function Y({data:m,height:i=140}){const t=b.useRef(null);return b.useEffect(()=>{const r=t.current;if(!r||!m||m.length<2)return;const s=r.getContext("2d"),l=window.devicePixelRatio||1,n=r.clientWidth,o=r.clientHeight;r.width=n*l,r.height=o*l,s.scale(l,l),s.clearRect(0,0,n,o);const c=m.map(d=>d.value),g=Math.min(...c)*.998,y=Math.max(...c)*1.002,w=y-g||1,x={top:8,bottom:20,left:0,right:0},S=n-x.left-x.right,F=o-x.top-x.bottom,v=d=>x.left+d/(m.length-1)*S,f=d=>x.top+F-(d-g)/w*F,j=c[0],$=c[c.length-1],T=$>=j,P=T?"#00DC82":"#FF3B30";s.beginPath(),s.moveTo(v(0),f(c[0]));for(let d=1;d<c.length;d++)s.lineTo(v(d),f(c[d]));s.lineTo(v(c.length-1),o-x.bottom),s.lineTo(v(0),o-x.bottom),s.closePath();const N=s.createLinearGradient(0,0,0,o);N.addColorStop(0,T?"rgba(0,220,130,0.2)":"rgba(255,59,48,0.2)"),N.addColorStop(1,"rgba(0,0,0,0)"),s.fillStyle=N,s.fill(),s.beginPath(),s.moveTo(v(0),f(c[0]));for(let d=1;d<c.length;d++)s.lineTo(v(d),f(c[d]));s.strokeStyle=P,s.lineWidth=2,s.lineJoin="round",s.stroke(),s.beginPath(),s.setLineDash([3,3]);const a=f(j);s.moveTo(0,a),s.lineTo(n,a),s.strokeStyle="#3B82F640",s.lineWidth=1,s.stroke(),s.setLineDash([]),s.fillStyle="#666",s.font="9px Inter, sans-serif",s.textAlign="left",s.fillText(`$${g.toFixed(0)}`,4,o-x.bottom+12),s.textAlign="right",s.fillText(`$${y.toFixed(0)}`,n-4,o-x.bottom+12);const h=v(c.length-1),p=f($);s.beginPath(),s.arc(h,p,3,0,Math.PI*2),s.fillStyle=P,s.fill(),s.beginPath(),s.arc(h,p,6,0,Math.PI*2),s.strokeStyle=P,s.lineWidth=1,s.globalAlpha=.4,s.stroke(),s.globalAlpha=1},[m,i]),!m||m.length<2?e.jsx("div",{className:"flex items-center justify-center text-xs text-[var(--text-dim)]",style:{height:i},children:"Ejecuta trades para ver la curva de equity"}):e.jsx("canvas",{ref:t,style:{width:"100%",height:i}})}function Z(){var $,T,P,N;const{selectedPair:m,currentPrice:i,setPage:t}=W(),[r,s]=b.useState(u.getState()),[l,n]=b.useState(u.getPerformance()),[o,c]=b.useState({quantity:"",stopLoss:"",takeProfit:"",side:"buy"}),[g,y]=b.useState(!1),[w,x]=b.useState(null);b.useEffect(()=>{const a=setInterval(async()=>{const h=await u.updatePositions();s({...h}),n(u.getPerformance())},1e4);return()=>clearInterval(a)},[]);const S=b.useCallback(async()=>{const a=await u.updatePositions();s({...a}),n(u.getPerformance())},[]),F=async()=>{if(!(!o.quantity||!i)){y(!0);try{const a=await u.openPosition(m,o.side,parseFloat(o.quantity),{stopLoss:o.stopLoss?parseFloat(o.stopLoss):null,takeProfit:o.takeProfit?parseFloat(o.takeProfit):null});x({type:"success",text:a.message}),c({...o,quantity:"",stopLoss:"",takeProfit:""}),await S()}catch(a){x({type:"error",text:a.message})}y(!1),setTimeout(()=>x(null),3e3)}},v=async a=>{try{const h=await u.closePosition(a);x({type:h.trade.pnl>=0?"success":"error",text:h.message}),await S()}catch(h){x({type:"error",text:h.message})}setTimeout(()=>x(null),3e3)},f=()=>{u.reset(1e4),s(u.getState()),n(u.getPerformance()),x({type:"success",text:"Simulador reiniciado con $10,000"}),setTimeout(()=>x(null),2e3)},j=l.returnPct||0;return e.jsxs("div",{className:"flex-1 overflow-y-auto px-5 py-5 space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("h1",{className:"text-lg font-bold flex items-center gap-2",children:[e.jsx(R,{size:18,className:"text-[var(--gold)] shrink-0"}),"Paper Trading"]}),e.jsx("p",{className:"text-xs text-[var(--text-dim)]",children:"Practica con datos reales, sin arriesgar dinero"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:S,className:"px-3 py-1.5 bg-[var(--dark-3)] text-[var(--text-dim)] rounded-lg text-xs hover:text-[var(--text)] transition-colors",children:"Actualizar"}),e.jsxs("button",{onClick:f,className:"flex items-center gap-1 px-3 py-1.5 bg-[var(--red)]/20 text-[var(--red)] rounded-lg text-xs font-bold hover:bg-[var(--red)]/30 transition-colors",children:[e.jsx(_,{size:12})," Reiniciar"]})]})]}),e.jsx(I,{children:w&&e.jsx(C.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:`p-3 rounded-xl text-sm font-bold text-center ${w.type==="success"?"bg-[var(--green)]/20 text-[var(--green)]":"bg-[var(--red)]/20 text-[var(--red)]"}`,children:w.text})}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-5 gap-2",children:[{label:"Balance",value:`$${($=l.balance)==null?void 0:$.toFixed(2)}`,icon:M,color:"var(--gold)"},{label:"Equity",value:`$${(T=l.equity)==null?void 0:T.toFixed(2)}`,icon:H,color:"var(--blue)"},{label:"Retorno",value:`${j>=0?"+":""}${j.toFixed(2)}%`,icon:j>=0?L:O,color:j>=0?"var(--green)":"var(--red)"},{label:"Win Rate",value:`${(l.winRate||0).toFixed(0)}%`,icon:B,color:"var(--gold)"},{label:"Trades",value:l.totalTrades||0,icon:D,color:"var(--text)"}].map((a,h)=>{const p=a.icon;return e.jsxs(C.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:h*.05},className:"bg-[var(--dark-2)] border border-[var(--border)] rounded-xl p-3 text-center",children:[e.jsx(p,{size:16,style:{color:a.color},className:"mx-auto mb-1"}),e.jsx("p",{className:"text-lg font-bold font-mono",style:{color:a.color},children:a.value}),e.jsx("p",{className:"text-[10px] text-[var(--text-dim)]",children:a.label})]},a.label)})}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:[{label:"P&L Total",value:`${l.totalPnl>=0?"+":""}$${(l.totalPnl||0).toFixed(2)}`,color:(l.totalPnl||0)>=0?"var(--green)":"var(--red)"},{label:"Mejor Trade",value:`+$${(l.bestTrade||0).toFixed(2)}`,color:"var(--green)"},{label:"Peor Trade",value:`$${(l.worstTrade||0).toFixed(2)}`,color:"var(--red)"},{label:"Max Drawdown",value:`${(l.maxDrawdown||0).toFixed(1)}%`,color:"var(--red)"}].map(a=>e.jsxs("div",{className:"bg-[var(--dark-2)] border border-[var(--border)] rounded-xl p-3",children:[e.jsx("p",{className:"text-xs text-[var(--text-dim)]",children:a.label}),e.jsx("p",{className:"text-sm font-bold font-mono",style:{color:a.color},children:a.value})]},a.label))}),e.jsxs("div",{className:"rounded-xl overflow-hidden",style:{background:"var(--surface)",border:"1px solid var(--border)"},children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2.5",style:{borderBottom:"1px solid var(--border)"},children:[e.jsxs("h3",{className:"text-xs font-bold flex items-center gap-2 text-[var(--text-secondary)]",children:[e.jsx(L,{size:14,className:"text-[var(--gold)]"})," Curva de Equity"]}),e.jsxs("span",{className:"text-[10px] text-[var(--text-dim)]",children:[((P=r.equityHistory)==null?void 0:P.length)||0," puntos"]})]}),e.jsx("div",{className:"p-2",children:e.jsx(Y,{data:r.equityHistory,height:160})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-[var(--dark-2)] border border-[var(--border)] rounded-xl p-4 space-y-3",children:[e.jsx("h3",{className:"text-sm font-bold",children:"Abrir Posición (Demo)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-bold text-[var(--gold)]",children:z(m)}),e.jsxs("span",{className:"text-sm font-mono",children:["$",(i==null?void 0:i.toLocaleString(void 0,{maximumFractionDigits:2}))||"---"]}),e.jsx("button",{onClick:()=>t("chart"),className:"text-xs text-[var(--gold)] hover:underline ml-auto",children:"Ver gráfico →"})]}),e.jsxs("div",{className:"flex gap-1 bg-[var(--dark-3)] rounded-lg p-1",children:[e.jsx("button",{onClick:()=>c({...o,side:"buy"}),className:`flex-1 py-2 text-sm font-bold rounded-md transition-all ${o.side==="buy"?"bg-[var(--green)] text-white":"text-[var(--text-dim)]"}`,children:"COMPRAR"}),e.jsx("button",{onClick:()=>c({...o,side:"sell"}),className:`flex-1 py-2 text-sm font-bold rounded-md transition-all ${o.side==="sell"?"bg-[var(--red)] text-white":"text-[var(--text-dim)]"}`,children:"VENDER"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-[var(--text-dim)] mb-1 block",children:"Cantidad"}),e.jsx("input",{type:"number",value:o.quantity,onChange:a=>c({...o,quantity:a.target.value}),placeholder:"Ej: 0.01",className:"w-full text-sm"}),o.quantity&&i&&e.jsxs("p",{className:"text-[10px] text-[var(--text-dim)] mt-1",children:["Costo: $",(parseFloat(o.quantity)*i).toFixed(2)," de $",(N=l.balance)==null?void 0:N.toFixed(2)," disponible"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs text-[var(--text-dim)] mb-1 flex items-center gap-1",children:[e.jsx(V,{size:10})," Stop Loss"]}),e.jsx("input",{type:"number",value:o.stopLoss,onChange:a=>c({...o,stopLoss:a.target.value}),placeholder:"Precio",className:"w-full text-xs"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs text-[var(--text-dim)] mb-1 flex items-center gap-1",children:[e.jsx(D,{size:10})," Take Profit"]}),e.jsx("input",{type:"number",value:o.takeProfit,onChange:a=>c({...o,takeProfit:a.target.value}),placeholder:"Precio",className:"w-full text-xs"})]})]}),e.jsx("button",{onClick:F,disabled:!o.quantity||!i||g,className:`w-full py-3 font-bold rounded-xl text-sm transition-colors disabled:opacity-50 ${o.side==="buy"?"bg-[var(--green)] text-white":"bg-[var(--red)] text-white"}`,children:g?"Ejecutando...":`${o.side==="buy"?"Comprar":"Vender"} ${U(m)} (Demo)`})]}),e.jsxs("div",{className:"bg-[var(--dark-2)] border border-[var(--border)] rounded-xl p-4",children:[e.jsxs("h3",{className:"text-sm font-bold mb-3",children:["Posiciones Abiertas (",r.positions.length,")"]}),r.positions.length===0?e.jsx("p",{className:"text-sm text-[var(--text-dim)] text-center py-8",children:"Sin posiciones abiertas"}):e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:r.positions.map(a=>{var h,p,d,q;return e.jsxs("div",{className:"bg-[var(--dark-3)] rounded-xl p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-xs font-bold px-1.5 py-0.5 rounded ${a.side==="buy"?"bg-[var(--green)]/20 text-[var(--green)]":"bg-[var(--red)]/20 text-[var(--red)]"}`,children:a.side.toUpperCase()}),e.jsx("span",{className:"text-sm font-bold",children:a.symbol})]}),e.jsx("button",{onClick:()=>v(a.id),className:"px-2 py-0.5 bg-[var(--dark-4)] text-[var(--text-dim)] rounded text-[10px] hover:bg-[var(--red)]/20 hover:text-[var(--red)] transition-colors",children:"Cerrar"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-[10px]",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--text-dim)]",children:"Entrada"}),e.jsxs("p",{className:"font-mono",children:["$",(h=a.entryPrice)==null?void 0:h.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--text-dim)]",children:"Actual"}),e.jsxs("p",{className:"font-mono",children:["$",(p=a.currentPrice)==null?void 0:p.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-[var(--text-dim)]",children:"P&L"}),e.jsxs("p",{className:`font-mono font-bold ${a.pnl>=0?"text-[var(--green)]":"text-[var(--red)]"}`,children:[a.pnl>=0?"+":"","$",(d=a.pnl)==null?void 0:d.toFixed(2)," (",(q=a.pnlPercent)==null?void 0:q.toFixed(1),"%)"]})]})]})]},a.id)})})]})]}),r.closedTrades.length>0&&e.jsxs("div",{className:"bg-[var(--dark-2)] border border-[var(--border)] rounded-xl overflow-hidden",children:[e.jsx("div",{className:"p-3 border-b border-[var(--border)]",children:e.jsx("h3",{className:"text-sm font-bold",children:"Historial de Trades (Demo)"})}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-[var(--text-dim)] border-b border-[var(--border)]",children:[e.jsx("th",{className:"text-left p-2",children:"Par"}),e.jsx("th",{className:"text-left p-2",children:"Lado"}),e.jsx("th",{className:"text-right p-2",children:"Entrada"}),e.jsx("th",{className:"text-right p-2",children:"Salida"}),e.jsx("th",{className:"text-right p-2",children:"P&L"})]})}),e.jsx("tbody",{children:r.closedTrades.slice().reverse().map(a=>{var h,p,d;return e.jsxs("tr",{className:"border-b border-[var(--border)]/50 hover:bg-[var(--dark-3)]",children:[e.jsx("td",{className:"p-2 font-bold",children:a.symbol}),e.jsx("td",{className:"p-2",children:e.jsx("span",{className:a.side==="buy"?"text-[var(--green)]":"text-[var(--red)]",children:a.side.toUpperCase()})}),e.jsxs("td",{className:"p-2 text-right font-mono",children:["$",(h=a.entryPrice)==null?void 0:h.toFixed(2)]}),e.jsxs("td",{className:"p-2 text-right font-mono",children:["$",(p=a.exitPrice)==null?void 0:p.toFixed(2)]}),e.jsxs("td",{className:`p-2 text-right font-mono font-bold ${a.pnl>=0?"text-[var(--green)]":"text-[var(--red)]"}`,children:[a.pnl>=0?"+":"","$",(d=a.pnl)==null?void 0:d.toFixed(2)]})]},a.id)})})]})})]}),e.jsxs("div",{className:"text-center text-xs text-[var(--text-dim)] pb-4",children:[e.jsx("p",{children:"⚠️ Esto es un simulador con datos reales del mercado. No se usa dinero real."}),e.jsx("p",{className:"text-[var(--gold)] mt-1",children:"Practica tus estrategias sin riesgo."})]})]})}export{Z as default};
//# sourceMappingURL=SimulatorScreen-B_1wmk7u.js.map
