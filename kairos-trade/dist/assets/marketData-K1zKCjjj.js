const d=["https://api.binance.us/api/v3","https://api.binance.com/api/v3"],l=["wss://stream.binance.us:9443/ws","wss://stream.binance.com:9443/ws"],m="https://api.coingecko.com/api/v3",f={BTC:"bitcoin",ETH:"ethereum",BNB:"binancecoin",SOL:"solana",XRP:"ripple",ADA:"cardano",DOGE:"dogecoin",DOT:"polkadot",AVAX:"avalanche-2",MATIC:"matic-network",LINK:"chainlink",UNI:"uniswap",SHIB:"shiba-inu",LTC:"litecoin",ATOM:"cosmos",ARB:"arbitrum",OP:"optimism",APT:"aptos",SUI:"sui",NEAR:"near",FIL:"filecoin",ICP:"internet-computer",TRX:"tron",PEPE:"pepe",WIF:"dogwifcoin",RENDER:"render-token",FET:"fetch-ai",INJ:"injective-protocol",TIA:"celestia",SEI:"sei-network",BONK:"bonk",JUP:"jupiter-exchange-solana",AAVE:"aave",MKR:"maker",CRV:"curve-dao-token",LDO:"lido-dao",SAND:"the-sandbox",MANA:"decentraland",AXS:"axie-infinity",GALA:"gala",ENS:"ethereum-name-service",FTM:"fantom",ALGO:"algorand",HBAR:"hedera-hashgraph",VET:"vechain",EGLD:"elrond-erd-2",EOS:"eos",XLM:"stellar",XMR:"monero",BCH:"bitcoin-cash",ETC:"ethereum-classic",RUNE:"thorchain"};function C(p){const s=["USDT","BUSD","USDC","USD","BTC","ETH","BNB"];for(const e of s)if(p.endsWith(e)&&p.length>e.length)return p.slice(0,-e.length);return p}function u(p){const s=C(p);return f[s]||s.toLowerCase()}class T{constructor(){this.ws=null,this.subscribers=new Map,this.reconnectAttempts=0,this.maxReconnect=5,this.candleCache=new Map,this._apiBase=null,this._wsBase=null,this._useCoinGecko=!1,this._geckoRateLimit=0}async _getAPI(){if(this._useCoinGecko)return"coingecko";if(this._apiBase)return this._apiBase;for(const s of d)try{const e=new AbortController,n=setTimeout(()=>e.abort(),5e3),t=await fetch(`${s}/ping`,{signal:e.signal});if(clearTimeout(n),t.ok)return this._apiBase=s,this._wsBase=s.includes("binance.us")?l[0]:l[1],s}catch{}try{const s=new AbortController,e=setTimeout(()=>s.abort(),5e3),n=await fetch(`${m}/ping`,{signal:s.signal});if(clearTimeout(e),n.ok)return this._useCoinGecko=!0,console.log("Kairos MarketData: using CoinGecko fallback"),"coingecko"}catch{}return this._apiBase=d[0],this._wsBase=l[0],this._apiBase}async _geckoFetch(s){const e=Date.now(),n=Math.max(0,this._geckoRateLimit+2200-e);n>0&&await new Promise(r=>setTimeout(r,n)),this._geckoRateLimit=Date.now();const t=new AbortController,i=setTimeout(()=>t.abort(),1e4),o=await fetch(`${m}${s}`,{signal:t.signal});if(clearTimeout(i),!o.ok)throw new Error(`CoinGecko HTTP ${o.status}`);return o.json()}connectStream(s,e={}){const n=s.toLowerCase(),t=this._wsBase||l[0],i=`${t}/${n}@ticker/${n}@kline_1m`;return this.ws&&this.ws.close(),this.ws=new WebSocket(i),this.ws.onopen=()=>{var o;this.reconnectAttempts=0,(o=e.onConnect)==null||o.call(e)},this.ws.onmessage=o=>{var r,c;try{const a=JSON.parse(o.data);if(a.e==="24hrTicker"&&((r=e.onTicker)==null||r.call(e,{symbol:a.s,price:parseFloat(a.c),change:parseFloat(a.p),changePercent:parseFloat(a.P),high:parseFloat(a.h),low:parseFloat(a.l),volume:parseFloat(a.v),quoteVolume:parseFloat(a.q)})),a.e==="kline"){const h=a.k;(c=e.onCandle)==null||c.call(e,{time:Math.floor(h.t/1e3),open:parseFloat(h.o),high:parseFloat(h.h),low:parseFloat(h.l),close:parseFloat(h.c),volume:parseFloat(h.v),closed:h.x})}}catch(a){console.error("WS parse error:",a)}},this.ws.onerror=o=>{var r;if(console.error("WS error:",o),t===l[1]&&this.reconnectAttempts===0){this._wsBase=l[0],this.connectStream(s,e);return}(r=e.onError)==null||r.call(e,o)},this.ws.onclose=()=>{var o;this.reconnectAttempts<this.maxReconnect&&(this.reconnectAttempts++,setTimeout(()=>this.connectStream(s,e),2e3*this.reconnectAttempts)),(o=e.onDisconnect)==null||o.call(e)},()=>this.disconnect()}disconnect(){this.ws&&(this.ws.close(),this.ws=null)}async getCandles(s,e="1h",n=500){const t=`${s}_${e}`,i=await this._getAPI();if(i==="coingecko")return this._getCandlesCoinGecko(s,e,t);try{const o=await this._getCandlesBinance(i,s,e,n);return this.candleCache.set(t,{data:o,ts:Date.now()}),o}catch(o){if(this._apiBase){this._apiBase=null;try{const c=await this._getAPI();if(c!=="coingecko"){const a=await this._getCandlesBinance(c,s,e,n);return this.candleCache.set(t,{data:a,ts:Date.now()}),a}}catch{}}try{return await this._getCandlesCoinGecko(s,e,t)}catch{}const r=this.candleCache.get(t);if(r)return r.data;throw o}}async _getCandlesBinance(s,e,n,t){const i=new AbortController,o=setTimeout(()=>i.abort(),1e4),r=await fetch(`${s}/klines?symbol=${e}&interval=${n}&limit=${t}`,{signal:i.signal});if(clearTimeout(o),!r.ok)throw new Error(`HTTP ${r.status}`);return(await r.json()).map(a=>({time:Math.floor(a[0]/1e3),open:parseFloat(a[1]),high:parseFloat(a[2]),low:parseFloat(a[3]),close:parseFloat(a[4]),volume:parseFloat(a[5])}))}async _getCandlesCoinGecko(s,e,n){const t=u(s),o={"1m":1,"5m":1,"15m":1,"30m":1,"1h":7,"4h":30,"1d":365}[e]||30,c=(await this._geckoFetch(`/coins/${t}/ohlc?vs_currency=usd&days=${o}`)).map(([a,h,w,g,_])=>({time:Math.floor(a/1e3),open:h,high:w,low:g,close:_,volume:0}));return this.candleCache.set(n,{data:c,ts:Date.now()}),c}async getPrice(s){var n,t;const e=await this._getAPI();if(e==="coingecko"){const i=u(s);return((n=(await this._geckoFetch(`/simple/price?ids=${i}&vs_currencies=usd`))[i])==null?void 0:n.usd)||0}try{const o=await(await fetch(`${e}/ticker/price?symbol=${s}`)).json();if(o.price)return parseFloat(o.price);throw new Error("No price")}catch{const i=u(s);return((t=(await this._geckoFetch(`/simple/price?ids=${i}&vs_currencies=usd`))[i])==null?void 0:t.usd)||0}}async get24hrTicker(s){const e=await this._getAPI();if(e==="coingecko")return this._get24hrTickerCoinGecko(s);try{const t=await(await fetch(`${e}/ticker/24hr?symbol=${s}`)).json();if(!t.lastPrice)throw new Error("No data");return{symbol:t.symbol,price:parseFloat(t.lastPrice),change:parseFloat(t.priceChange),changePercent:parseFloat(t.priceChangePercent),high:parseFloat(t.highPrice),low:parseFloat(t.lowPrice),volume:parseFloat(t.volume),quoteVolume:parseFloat(t.quoteVolume)}}catch{return this._get24hrTickerCoinGecko(s)}}async _get24hrTickerCoinGecko(s){var i,o,r,c,a;const e=u(s),t=(await this._geckoFetch(`/coins/${e}?localization=false&tickers=false&community_data=false&developer_data=false`)).market_data;return{symbol:s,price:((i=t.current_price)==null?void 0:i.usd)||0,change:t.price_change_24h||0,changePercent:t.price_change_percentage_24h||0,high:((o=t.high_24h)==null?void 0:o.usd)||0,low:((r=t.low_24h)==null?void 0:r.usd)||0,volume:((c=t.total_volume)==null?void 0:c.usd)||0,quoteVolume:((a=t.total_volume)==null?void 0:a.usd)||0}}async getOrderBook(s,e=20){const n=await this._getAPI();if(n==="coingecko")return{bids:[],asks:[]};try{const i=await(await fetch(`${n}/depth?symbol=${s}&limit=${e}`)).json();return{bids:i.bids.map(([o,r])=>({price:parseFloat(o),quantity:parseFloat(r)})),asks:i.asks.map(([o,r])=>({price:parseFloat(o),quantity:parseFloat(r)}))}}catch{return{bids:[],asks:[]}}}async searchSymbols(s){const e=await this._getAPI();if(e==="coingecko")return((await this._geckoFetch(`/search?query=${encodeURIComponent(s)}`)).coins||[]).slice(0,20).map(t=>({symbol:`${t.symbol.toUpperCase()}USDT`,base:t.symbol.toUpperCase(),quote:"USDT"}));try{const t=await(await fetch(`${e}/exchangeInfo`)).json(),i=s.toUpperCase();return t.symbols.filter(o=>o.status==="TRADING"&&(o.symbol.includes(i)||o.baseAsset.includes(i))).slice(0,20).map(o=>({symbol:o.symbol,base:o.baseAsset,quote:o.quoteAsset}))}catch{return((await this._geckoFetch(`/search?query=${encodeURIComponent(s)}`)).coins||[]).slice(0,20).map(t=>({symbol:`${t.symbol.toUpperCase()}USDT`,base:t.symbol.toUpperCase(),quote:"USDT"}))}}}const A=new T;export{A as m};
