{"version":3,"mappings":";oQAaA,MAAMA,EAAe,CACnB,kCACA,kCACF,EAEA,MAAMC,CAAc,CAClB,aAAc,CACZ,KAAK,WAAa,IAAI,IACtB,KAAK,QAAU,IAAI,IACnB,KAAK,UAAY,IAAI,IACrB,KAAK,QAAU,IAAI,IACnB,KAAK,cAAgB,IAAI,IACzB,KAAK,KAAO,IAAI,IAChB,KAAK,UAAY,IAAI,IACrB,KAAK,SAAW,IAAI,GACtB,CAGA,KAAKC,EAAOC,EAAK,WACf,MAAMC,EAAO,KAAK,KAAK,IAAIF,CAAK,GAAK,GAC/BG,EAAU,KAAK,WAAW,IAAIH,CAAK,EACzCE,EAAK,KAAK,CAAE,QAASD,EAAK,KAAM,KAAK,IAAG,EAAI,UAASG,EAAAD,GAAA,YAAAA,EAAS,MAAT,YAAAC,EAAc,OAAQ,KAAK,CAAE,EAC9EF,EAAK,OAAS,KAAKA,EAAK,OAAO,EAAG,EAAE,EACxC,KAAK,KAAK,IAAIF,EAAOE,CAAI,EACzB,GAAI,EAAEG,GAAAC,EAAA,KAAK,UAAU,IAAIN,CAAK,IAAxB,YAAAM,EAA2B,QAA3B,MAAAD,EAAA,KAAAC,EAAmCL,EAAM,MAAY,CAAuB,CACpF,CAGA,SAASD,EAAOO,EAAO,SACrB,GAAI,EAAED,GAAAF,EAAA,KAAK,UAAU,IAAIJ,CAAK,IAAxB,YAAAI,EAA2B,UAA3B,MAAAE,EAAA,KAAAF,EAAqCG,EAAQ,MAAY,CAAuB,CACxF,CAGA,MAAM,qBAAqBC,EAAKC,EAAYC,EAAMC,EAAUC,EAAO,CACjE,GAAI,CACF,MAAMC,GAAS,MAAKC,EAAA,wBAAAC,CAAA,OAAC,QAAO,qBAAmB,OAAAC,KAAA,mBAAAD,CAAA,gCAAG,QAC5CE,EAAQJ,EAAM,SAAQ,EAGXI,EAAM,UAAU,OAAOC,GAAKA,EAAE,QAAUV,EAAI,EAAE,EACtD,QAAQU,GAAKD,EAAM,cAAcC,EAAE,EAAE,CAAC,EAE/CL,EAAM,SAAQ,EAAG,YAAY,CAC3B,KAAML,EAAI,KACV,KAAAE,EACA,SAAAC,EACA,WAAAF,EACA,aAAcA,EACd,SAAUG,EAAM,SAAW,WAAWA,EAAM,SAAS,QAAQ,CAAC,CAAC,EAAI,KACnE,WAAYA,EAAM,WAAa,WAAWA,EAAM,WAAW,QAAQ,CAAC,CAAC,EAAI,KACzE,MAAOJ,EAAI,GACX,QAASA,EAAI,KACb,KAAM,KAAK,IAAG,CACtB,CAAO,CACH,MAAQ,CAAC,CACX,CAGA,MAAM,yBAAyBR,EAAO,CACpC,GAAI,CAEF,MAAMiB,GADS,MAAKH,EAAA,wBAAAC,CAAA,OAAC,QAAO,qBAAmB,OAAAC,KAAA,mBAAAD,CAAA,gCAAG,QAC9B,SAAQ,EAEPE,EAAM,UAAU,OAAOC,GAAKA,EAAE,QAAUlB,CAAK,EACrD,QAAQkB,GAAKD,EAAM,cAAcC,EAAE,EAAE,CAAC,CACrD,MAAQ,CAAC,CACX,CAGA,aAAalB,EAAOmB,EAASC,EAAO,CAClC,KAAK,UAAU,IAAIpB,EAAO,CAAE,QAAAmB,EAAS,MAAAC,EAAO,CAC9C,CAGA,QAAQpB,EAAO,CACb,OAAO,KAAK,KAAK,IAAIA,CAAK,GAAK,EACjC,CAGA,YAAa,CACX,MAAMqB,EAAM,GACZ,SAAW,CAACrB,EAAOE,CAAI,IAAK,KAAK,KAC/BmB,EAAI,KAAK,GAAGnB,EAAK,IAAIoB,IAAM,CAAE,GAAGA,EAAG,MAAAtB,CAAK,EAAG,CAAC,EAE9C,OAAOqB,EAAI,KAAK,CAACE,EAAGC,IAAMD,EAAE,KAAOC,EAAE,IAAI,EAAE,MAAM,IAAI,CACvD,CAGA,MAAM,uBAAuBhB,EAAK,CAChC,GAAI,CAACA,EAAI,SAAU,MAAO,GAC1B,GAAIiB,EAAc,YAAY,IAAIjB,EAAI,QAAQ,EAAG,MAAO,GAExD,GAAI,CAEF,MAAMkB,GADY,MAAKZ,EAAA,wBAAAC,CAAA,OAAC,QAAO,qBAAmB,+BAAAA,CAAA,gCAAG,QAC7B,SAAQ,EAAG,QAAQ,KAAKS,GAAKA,EAAE,KAAOhB,EAAI,QAAQ,EAC1E,GAAIkB,GAAUA,EAAO,UACnB,aAAMD,EAAc,QAAQC,CAAM,EAC3B,EAEX,OAASC,EAAK,CACZ,QAAQ,KAAK,yBAA0BA,EAAI,OAAO,CACpD,CACA,MAAO,EACT,CAGA,MAAM,SAASnB,EAAKW,EAASC,EAAO,OAClC,GAAI,KAAK,WAAW,IAAIZ,EAAI,EAAE,EAAG,OAGjC,KAAK,UAAU,IAAIA,EAAI,GAAI,CAAE,QAAAW,EAAS,MAAAC,EAAO,EAC7C,KAAK,WAAW,IAAIZ,EAAI,GAAI,CAAE,IAAAA,EAAK,QAAS,GAAM,EAElD,KAAK,KAAKA,EAAI,GAAI,WAAWA,EAAI,IAAI,iBAAiBA,EAAI,IAAI,EAAE,EAGhE,MAAMoB,EAAc,MAAM,KAAK,uBAAuBpB,CAAG,EACrDA,EAAI,SACN,KAAK,KAAKA,EAAI,GAAIoB,EACd,2CACA,qCAAqC,EAEzC,KAAK,KAAKpB,EAAI,GAAI,sDAAsD,EAI1E,MAAMqB,EAAUC,EAAUtB,EAAI,IAAI,EAClC,IAAIuB,EACJ,GAAI,CACFA,EAAiB,MAAMC,EAAW,WAAWH,EAASrB,EAAI,UAAW,GAAG,EACxE,KAAK,QAAQ,IAAIA,EAAI,GAAIuB,CAAc,EACvC,MAAME,GAAY7B,EAAA2B,EAAeA,EAAe,OAAS,CAAC,IAAxC,YAAA3B,EAA2C,MAC7D,KAAK,KAAKI,EAAI,GAAI,MAAMuB,EAAe,MAAM,8BAA8BE,GAAA,YAAAA,EAAW,QAAQ,EAAE,UAAUzB,EAAI,SAAS,EAAE,CAC3H,OAASmB,EAAK,CACZ,KAAK,KAAKnB,EAAI,GAAI,2BAA2BmB,EAAI,OAAO,EAAE,EAC1D,KAAK,KAAKnB,EAAI,GAAI,gCAAgC,EAClD,KAAK,sBAAsBA,EAAKqB,CAAO,EACvC,MACF,CAGA,MAAMK,EAASH,EAAe,IAAII,GAAKA,EAAE,KAAK,EACxCC,EAAeF,EAAOA,EAAO,OAAS,CAAC,EACvCG,EAAS,KAAK,kBAAkB7B,EAAI,SAAUuB,EAAgBG,EAAQ1B,EAAI,EAAE,EAC9E6B,GACF,KAAK,KAAK7B,EAAI,GAAI,qBAAqB6B,EAAO,KAAK,YAAW,CAAE,OAAOD,EAAa,QAAQ,CAAC,CAAC,EAAE,EAChG,MAAM,KAAK,cAAc5B,EAAK6B,EAAQD,CAAY,GAGlD,KAAK,oBAAoB5B,EAAK0B,CAAM,EAItC,KAAK,kBAAkB1B,EAAKqB,CAAO,CACrC,CAGA,oBAAoBrB,EAAK0B,EAAQ,yCAC/B,MAAMI,EAAMJ,EAAO,OACbK,GAAMjC,GAAAF,EAAAI,EAAI,WAAJ,YAAAJ,EAAc,QAAd,YAAAE,EAAqB,UACjC,GAAI,CACF,GAAIiC,IAAQ,aAAeA,IAAQ,gBAAiB,CAClD,MAAMC,IAAOnC,EAAAG,EAAI,SAAS,MAAM,SAAnB,YAAAH,EAA2B,YAAWoC,EAAAjC,EAAI,SAAS,MAAM,SAAnB,YAAAiC,EAA2B,OAAQ,GAChFC,IAAOC,EAAAnC,EAAI,SAAS,MAAM,SAAnB,YAAAmC,EAA2B,YAAWC,EAAApC,EAAI,SAAS,MAAM,SAAnB,YAAAoC,EAA2B,OAAQ,GAChFC,EAAUC,EAAaZ,EAAQM,CAAI,EACnCO,EAAUD,EAAaZ,EAAQQ,CAAI,EACnCM,IAASH,EAAQP,EAAM,CAAC,EAAIS,EAAQT,EAAM,CAAC,GAAKS,EAAQT,EAAM,CAAC,EAAI,KAAK,QAAQ,CAAC,EACvF,IAAIW,EAAO,SAAST,CAAI,OAAMU,EAAAL,EAAQP,EAAM,CAAC,IAAf,YAAAY,EAAkB,QAAQ,EAAE,SAASR,CAAI,OAAMS,EAAAJ,EAAQT,EAAM,CAAC,IAAf,YAAAa,EAAkB,QAAQ,EAAE,YAAYH,CAAI,IACzH,GAAIT,IAAQ,gBAAiB,CAC3B,MAAMa,EAAMC,EAAanB,IAAQoB,EAAA9C,EAAI,SAAS,MAAM,SAAnB,YAAA8C,EAA2B,YAAa,EAAE,EAC3EL,GAAQ,YAAWM,EAAAH,EAAId,EAAM,CAAC,IAAX,YAAAiB,EAAc,QAAQ,EAAE,EAC7C,CACA,KAAK,KAAK/C,EAAI,GAAI,GAAGyC,CAAI,+BAA+B,CAC1D,SAAWV,IAAQ,MAAO,CACxB,MAAMa,EAAMC,EAAanB,IAAQsB,EAAAhD,EAAI,SAAS,MAAM,SAAnB,YAAAgD,EAA2B,SAAU,EAAE,EACxE,KAAK,KAAKhD,EAAI,GAAI,YAAWiD,EAAAL,EAAId,EAAM,CAAC,IAAX,YAAAmB,EAAc,QAAQ,EAAE,+BAA+B,CACtF,SAAWlB,IAAQ,aAAc,CAC/B,KAAM,CAAE,KAAAmB,EAAM,OAAArB,GAAWsB,EAAczB,CAAM,EAC7C,KAAK,KAAK1B,EAAI,GAAI,aAAYoD,EAAAF,EAAKpB,EAAM,CAAC,IAAZ,YAAAsB,EAAe,QAAQ,EAAE,eAAcC,EAAAxB,EAAOC,EAAM,CAAC,IAAd,YAAAuB,EAAiB,QAAQ,EAAE,+BAA+B,CACjI,WAAWC,EAAAtD,EAAI,WAAJ,YAAAsD,EAAc,QAAS,gBAAiB,CAEjD,MAAMjB,EAAUC,EAAaZ,EAAQ,CAAC,EAChCa,EAAUD,EAAaZ,EAAQ,EAAE,EACjC6B,EAASV,EAAanB,EAAQ,EAAE,EAChChB,EAAIgB,EAAOI,EAAM,CAAC,EAClBU,IAASH,EAAQP,EAAM,CAAC,EAAIS,EAAQT,EAAM,CAAC,GAAKS,EAAQT,EAAM,CAAC,EAAI,KAAK,QAAQ,CAAC,EACvF,KAAK,KAAK9B,EAAI,GAAI,OAAOU,GAAA,YAAAA,EAAG,QAAQ,EAAE,cAAa8C,EAAAnB,EAAQP,EAAM,CAAC,IAAf,YAAA0B,EAAkB,QAAQ,EAAE,eAAcC,EAAAlB,EAAQT,EAAM,CAAC,IAAf,YAAA2B,EAAkB,QAAQ,EAAE,KAAKjB,CAAI,cAAakB,EAAAH,EAAOzB,EAAM,CAAC,IAAd,YAAA4B,EAAiB,QAAQ,EAAE,cAAc,CAC1L,MACE,KAAK,KAAK1D,EAAI,GAAI,+CAA+C,CAErE,MAAQ,CACN,KAAK,KAAKA,EAAI,GAAI,+CAA+C,CACnE,CACF,CAGA,kBAAkBA,EAAKqB,EAASsC,EAAU,EAAG,OAC3C,GAAI,GAAC/D,EAAA,KAAK,WAAW,IAAII,EAAI,EAAE,IAA1B,MAAAJ,EAA6B,SAAS,OAE3C,MAAMgE,EAAOvC,EAAQ,YAAW,EAC1BwC,EAAK7D,EAAI,WAAa,KAGtB8D,EAAStC,EAAW,SAAWlC,EAAa,CAAC,EAC7CyE,EAAM,GAAGD,CAAM,IAAIF,CAAI,WAAWA,CAAI,UAAUC,CAAE,GAExD,KAAK,KAAK7D,EAAI,GAAI,yBAAyBqB,CAAO,MAAMwC,CAAE,GAAGF,EAAU,EAAI,aAAaA,EAAU,CAAC,IAAM,EAAE,KAAK,EAEhH,IAAIK,EACJ,GAAI,CACFA,EAAK,IAAI,UAAUD,CAAG,CACxB,OAAS5C,EAAK,CACZ,KAAK,KAAKnB,EAAI,GAAI,sBAAsBmB,EAAI,OAAO,wBAAwB,EAC3E,KAAK,sBAAsBnB,EAAKqB,CAAO,EACvC,MACF,CAEA,IAAI4C,EAAmB,KAEvBD,EAAG,OAAS,IAAM,CAChB,KAAK,KAAKhE,EAAI,GAAI,yDAAyD,EAC3E2D,EAAU,CACZ,EAEAK,EAAG,UAAaE,GAAU,OACxB,IAAKtE,EAAA,KAAK,WAAW,IAAII,EAAI,EAAE,IAA1B,MAAAJ,EAA6B,QAElC,GAAI,CACF,MAAMuE,EAAO,KAAK,MAAMD,EAAM,IAAI,EAGlC,GAAIC,EAAK,IAAM,aAAc,CAC3B,MAAMvC,EAAe,WAAWuC,EAAK,CAAC,EACtC,KAAK,YAAYnE,EAAK4B,CAAY,CACpC,CAGA,GAAIuC,EAAK,IAAM,QAAS,CACtB,MAAMC,EAAID,EAAK,EACTE,EAAS,CACb,KAAM,KAAK,MAAMD,EAAE,EAAI,GAAI,EAC3B,KAAM,WAAWA,EAAE,CAAC,EACpB,KAAM,WAAWA,EAAE,CAAC,EACpB,IAAK,WAAWA,EAAE,CAAC,EACnB,MAAO,WAAWA,EAAE,CAAC,EACrB,OAAQ,WAAWA,EAAE,CAAC,CAClC,EAEcA,EAAE,GAEJ,KAAK,mBAAmBpE,EAAKqE,CAAM,CAEvC,CACF,OAASC,EAAG,CACV,QAAQ,MAAM,QAAQtE,EAAI,EAAE,cAAesE,CAAC,CAC9C,CACF,EAEAN,EAAG,QAAW7C,GAAQ,CAGpB,GAFA,QAAQ,MAAM,QAAQnB,EAAI,EAAE,aAAcmB,CAAG,EAEzCwC,IAAY,EAAG,CACjB,MAAMY,EAAUT,IAAWxE,EAAa,CAAC,EAAIA,EAAa,CAAC,EAAIA,EAAa,CAAC,EAC7EkC,EAAW,QAAU+C,EACrB,KAAK,KAAKvE,EAAI,GAAI,qCAAqC,EACvD,GAAI,CAAEgE,EAAG,MAAK,CAAI,MAAQ,CAAC,CAC3B,KAAK,kBAAkBhE,EAAKqB,EAAS,CAAC,EACtC,MACF,CACF,EAEA2C,EAAG,QAAU,IAAM,OACjB,IAAKpE,EAAA,KAAK,WAAW,IAAII,EAAI,EAAE,IAA1B,MAAAJ,EAA6B,QAElC,GAAI+D,EAAU,EAAG,CACf,MAAMa,EAAQ,KAAK,IAAI,KAAQb,EAAU,GAAI,GAAK,EAClD,KAAK,KAAK3D,EAAI,GAAI,sBAAsBwE,EAAQ,GAAI,MAAM,EAC1DP,EAAmB,WAAW,IAAM,CAClC,KAAK,kBAAkBjE,EAAKqB,EAASsC,EAAU,CAAC,CAClD,EAAGa,CAAK,CACV,MACE,KAAK,KAAKxE,EAAI,GAAI,oDAAoD,EACtE,KAAK,sBAAsBA,EAAKqB,CAAO,CAE3C,EAGA,KAAK,QAAQ,IAAIrB,EAAI,GAAI,CAAE,GAAAgE,EAAI,iBAAAC,EAAkB,CACnD,CAGA,YAAYzE,EAAO,CACjB,OAAO,KAAK,SAAS,IAAIA,CAAK,GAAK,IACrC,CAGA,YAAYQ,EAAK4B,EAAc,CAE7B,MAAM6C,EAAM,KAAK,UAAU,IAAIzE,EAAI,EAAE,EACrC,GAAIyE,EAAK,CACP,MAAMC,EAAgBD,EAAI,OAAS,OAC9B7C,EAAe6C,EAAI,YAAcA,EAAI,UACrCA,EAAI,WAAa7C,GAAgB6C,EAAI,SACpCE,EAAaF,EAAI,OAAS,OAC1B7C,EAAe6C,EAAI,YAAcA,EAAI,WAAc,KACnDA,EAAI,WAAa7C,GAAgB6C,EAAI,WAAc,IACzD,KAAK,SAAS,IAAIzE,EAAI,GAAI,CACxB,MAAO4B,EACP,cAAA8C,EACA,WAAAC,EACA,SAAU,CAAE,KAAMF,EAAI,KAAM,WAAYA,EAAI,WAAY,SAAUA,EAAI,QAAQ,EAC9E,KAAM,KAAK,IAAG,CACtB,CAAO,CACH,MACE,KAAK,SAAS,IAAIzE,EAAI,GAAI,CAAE,MAAO4B,EAAc,cAAe,EAAG,WAAY,EAAG,SAAU,KAAM,KAAM,KAAK,IAAG,EAAI,EAItH,MAAMgD,EAAM,KAAK,IAAG,EACdC,EAAS,KAAK,cAAc,IAAI7E,EAAI,EAAE,GAAK,EACjD,GAAI4E,EAAMC,EAAS,IAEjB,GADA,KAAK,cAAc,IAAI7E,EAAI,GAAI4E,CAAG,EAC9BH,EAAK,CACP,MAAMC,EAAgBD,EAAI,OAAS,OAC9B7C,EAAe6C,EAAI,YAAcA,EAAI,UACrCA,EAAI,WAAa7C,GAAgB6C,EAAI,SAC1C,KAAK,KAAKzE,EAAI,GAAI,OAAO4B,EAAa,QAAQ,CAAC,CAAC,MAAM6C,EAAI,KAAK,YAAW,CAAE,OAAOA,EAAI,WAAW,QAAQ,CAAC,CAAC,WAAWC,GAAiB,EAAI,IAAM,EAAE,IAAIA,EAAc,QAAQ,CAAC,CAAC,EAAE,CACpL,MACE,KAAK,KAAK1E,EAAI,GAAI,OAAO4B,EAAa,QAAQ,CAAC,CAAC,uBAAuB,EAK3E,KAAK,yBAAyB5B,EAAK4B,CAAY,CACjD,CAGA,MAAM,mBAAmB5B,EAAKqE,EAAQ,CACpC,MAAMS,EAAa,KAAK,QAAQ,IAAI9E,EAAI,EAAE,GAAK,GAG3C8E,EAAW,OAAS,GAAKA,EAAWA,EAAW,OAAS,CAAC,EAAE,OAAST,EAAO,KAC7ES,EAAWA,EAAW,OAAS,CAAC,EAAIT,GAEpCS,EAAW,KAAKT,CAAM,EAClBS,EAAW,OAAS,KAAKA,EAAW,MAAK,GAE/C,KAAK,QAAQ,IAAI9E,EAAI,GAAI8E,CAAU,EAEnC,MAAMpD,EAASoD,EAAW,IAAInD,GAAKA,EAAE,KAAK,EACpCC,EAAeyC,EAAO,MAE5B,KAAK,KAAKrE,EAAI,GAAI,uBAAuBqE,EAAO,KAAK,QAAQ,CAAC,CAAC,MAAMA,EAAO,KAAK,QAAQ,CAAC,CAAC,MAAMA,EAAO,IAAI,QAAQ,CAAC,CAAC,MAAMA,EAAO,MAAM,QAAQ,CAAC,CAAC,EAAE,EAGrJ,MAAMxC,EAAS,KAAK,kBAAkB7B,EAAI,SAAU8E,EAAYpD,EAAQ1B,EAAI,EAAE,EAC1E6B,EACF,MAAM,KAAK,cAAc7B,EAAK6B,EAAQD,CAAY,EAGlD,KAAK,oBAAoB5B,EAAK0B,CAAM,CAExC,CAGA,MAAM,cAAc1B,EAAK6B,EAAQD,EAAc,CAC7C,MAAMmD,EAAe,KAAK,UAAU,IAAI/E,EAAI,EAAE,EAG1C+E,GAAgBA,EAAa,OAASlD,EAAO,MAC/C,MAAM,KAAK,eAAe7B,EAAK+E,EAAcnD,EAAcC,EAAO,IAAI,EAInE,KAAK,UAAU,IAAI7B,EAAI,EAAE,GAC5B,MAAM,KAAK,cAAcA,EAAK6B,EAAQD,CAAY,CAEtD,CAGA,MAAM,eAAe5B,EAAKgF,EAAUpD,EAAcqD,EAAUC,EAAQ,CAClE,MAAMjF,EAAa+E,EAAS,WACtBG,EAAMH,EAAS,SACfI,EAAYJ,EAAS,OAAS,OAC/BpD,EAAe3B,GAAckF,GAC7BlF,EAAa2B,GAAgBuD,EAG5BE,EAAWC,EAAW,eAAe1D,EAAcuD,CAAG,EACtDI,EAASH,EAAYC,EAE3B,KAAK,KAAKrF,EAAI,GAAI,gBAAgBgF,EAAS,KAAK,YAAW,CAAE,MAAMC,EAAS,YAAW,CAAE,OAAOhF,EAAW,QAAQ,CAAC,CAAC,OAAO2B,EAAa,QAAQ,CAAC,CAAC,WAAW2D,GAAU,EAAI,IAAM,EAAE,IAAIA,EAAO,QAAQ,CAAC,CAAC,EAAE,EAE3M,MAAMC,EAAa,CACjB,OAAQlE,EAAUtB,EAAI,IAAI,EAC1B,KAAMiF,EACN,KAAM,SACN,SAAUE,EACV,MAAOvD,CACb,EAEI,GAAI5B,EAAI,UAAYiB,EAAc,YAAY,IAAIjB,EAAI,QAAQ,EAC5D,GAAI,CACF,KAAK,KAAKA,EAAI,GAAI,wCAAwC,EAC1D,MAAMyF,EAAS,MAAMxE,EAAc,WAAWjB,EAAI,SAAUwF,CAAU,EAChEE,EAAYD,EAAO,YAAc,GACjCE,EAAiBF,EAAO,aAAeA,EAAO,YAAc,EAC9DA,EAAO,YAAc7D,EAInBgE,GAHgBZ,EAAS,OAAS,OACnCW,EAAgB1F,GAAckF,GAC9BlF,EAAa0F,GAAiBR,GACAE,EAC7BQ,EAAaH,EAAY,IAAM,KACrC,KAAK,KAAK1F,EAAI,GAAI,GAAG6F,CAAU,iBAAiBD,GAAc,EAAI,IAAM,EAAE,IAAIA,EAAW,QAAQ,CAAC,CAAC,KAAKH,EAAO,MAAM,QAAQA,EAAO,IAAM,KAAK,EAAE,EACjJ,KAAK,SAASzF,EAAI,GAAI,CAAE,GAAGwF,EAAY,GAAGC,EAAQ,OAAQG,EAAY,KAAM,GAAM,UAAAF,EAAW,OAAQ,QAAS,OAAAR,EAAQ,EAGtHY,EAAgB,iBAAiB9F,EAAI,KAAMgF,EAAS,KAAMhF,EAAI,KAAMC,EAAY0F,EAAeC,EAAYV,CAAM,EAGjH,KAAK,mBAAmBlF,CAAG,CAC7B,OAASmB,EAAK,CACZ,KAAK,KAAKnB,EAAI,GAAI,qBAAqBmB,EAAI,OAAO,EAAE,EACpD,KAAK,SAASnB,EAAI,GAAI,CAAE,GAAGwF,EAAY,OAAAD,EAAQ,OAAQ,QAAS,MAAOpE,EAAI,QAAS,OAAQ,OAAO,CAAE,CACvG,MAEA,KAAK,KAAKnB,EAAI,GAAI,0BAA0BuF,GAAU,EAAI,IAAM,EAAE,IAAIA,EAAO,QAAQ,CAAC,CAAC,EAAE,EACzF,KAAK,SAASvF,EAAI,GAAI,CAAE,GAAGwF,EAAY,OAAAD,EAAQ,OAAQ,SAAU,UAAW,GAAM,OAAQ,QAAS,OAAAL,CAAM,CAAE,EAG7G,KAAK,UAAU,OAAOlF,EAAI,EAAE,EAC5B,KAAK,yBAAyBA,EAAI,EAAE,CACtC,CAGA,MAAM,cAAcA,EAAK6B,EAAQD,EAAc,qBAE7C,MAAMmE,IAAWnG,EAAA,KAAK,iBAAL,YAAAA,EAAqB,IAAII,EAAI,MAAO,EAC/CgG,GAAWlG,EAAA,KAAK,qBAAL,MAAAA,EAAyB,IAAIE,EAAI,IAAM,IAAQ,IAChE,GAAI,KAAK,MAAQ+F,EAAWC,EAC1B,OAGF,KAAK,KAAKhG,EAAI,GAAI,aAAa6B,EAAO,KAAK,YAAW,CAAE,OAAOD,EAAa,QAAQ,CAAC,CAAC,EAAE,EAExF,MAAMqE,EAAe,KAAK,uBAAuBjG,EAAK4B,CAAY,EAGlE,GAAIqE,EAAerE,EAAe,GAAM,CACtC,KAAK,KAAK5B,EAAI,GAAI,sFAAsF,EACxG,KAAK,eAAiB,KAAK,gBAAkB,IAAI,IACjD,KAAK,mBAAqB,KAAK,oBAAsB,IAAI,IACzD,KAAK,eAAe,IAAIA,EAAI,GAAI,KAAK,KAAK,EAC1C,KAAK,mBAAmB,IAAIA,EAAI,GAAI,EAAI,EACxC,MACF,CAGA,MAAMkG,GAAYrG,EAAA,KAAK,iBAAL,YAAAA,EAAqB,IAAIG,EAAI,IACzCmG,EAAQ,YAAWD,GAAA,YAAAA,EAAW,aAAYjE,EAAAjC,EAAI,WAAJ,YAAAiC,EAAc,WAAY,CAAC,EAAI,IACzEmE,EAAQ,YAAWF,GAAA,YAAAA,EAAW,eAAc/D,EAAAnC,EAAI,WAAJ,YAAAmC,EAAc,aAAc,CAAC,EAAI,IAE7E/B,EAAQ,CACZ,OAAQkB,EAAUtB,EAAI,IAAI,EAC1B,KAAM6B,EAAO,KACb,KAAM,SACN,SAAUoE,EACV,MAAOrE,EACP,SAAUC,EAAO,OAAS,MACtBD,GAAgB,EAAIuE,GACpBvE,GAAgB,EAAIuE,GACxB,WAAYtE,EAAO,OAAS,MACxBD,GAAgB,EAAIwE,GACpBxE,GAAgB,EAAIwE,EAC9B,EAEI,GAAIpG,EAAI,UAAYiB,EAAc,YAAY,IAAIjB,EAAI,QAAQ,EAC5D,GAAI,CACF,KAAK,KAAKA,EAAI,GAAI,uCAAuC,EACzD,MAAMyF,EAAS,MAAMxE,EAAc,WAAWjB,EAAI,SAAUI,CAAK,EAC3DiG,EAAYZ,EAAO,aAAe7D,EAClC8D,EAAYD,EAAO,YAAc,GACjCI,EAAaH,EAAY,IAAM,KAErCJ,EAAW,eAAee,EAAWZ,EAAO,WAAaQ,CAAY,EAErE,KAAK,KAAKjG,EAAI,GAAI,GAAG6F,CAAU,WAAUzD,EAAAqD,EAAO,OAAP,YAAArD,EAAa,aAAa,IAAIqD,EAAO,WAAaQ,CAAY,OAAOI,EAAU,QAAQ,CAAC,CAAC,KAAKZ,EAAO,MAAM,QAAQA,EAAO,IAAM,KAAK,EAAE,EAC3KC,GACH,KAAK,KAAK1F,EAAI,GAAI,mEAAmE,GAGvF0C,EAAA,KAAK,iBAAL,MAAAA,EAAqB,OAAO1C,EAAI,KAChC2C,EAAA,KAAK,qBAAL,MAAAA,EAAyB,OAAO3C,EAAI,IAEpC,KAAK,UAAU,IAAIA,EAAI,GAAI,CACzB,KAAM6B,EAAO,KACb,WAAYwE,EACZ,SAAUZ,EAAO,WAAaQ,EAC9B,UAAW,KAAK,IAAG,EACnB,QAASR,EAAO,EAC1B,CAAS,EACD,KAAK,qBAAqBzF,EAAKqG,EAAWxE,EAAO,KAAM4D,EAAO,WAAaQ,EAAc7F,CAAK,EAC9F,KAAK,SAASJ,EAAI,GAAI,CAAE,GAAGI,EAAO,GAAGqF,EAAQ,KAAM,GAAM,OAAQ,MAAM,CAAE,EAGzEK,EAAgB,gBAAgB9F,EAAI,KAAM6B,EAAO,KAAM7B,EAAI,KAAMqG,EAAWZ,EAAO,WAAaQ,EAAcjG,EAAI,YAAcA,EAAI,QAAQ,EAG5I,KAAK,mBAAmBA,CAAG,CAC7B,OAASmB,EAAK,CACZ,KAAK,KAAKnB,EAAI,GAAI,kBAAkBmB,EAAI,OAAO,EAAE,EAEjD,KAAK,eAAiB,KAAK,gBAAkB,IAAI,IACjD,KAAK,eAAe,IAAInB,EAAI,GAAI,KAAK,KAAK,EAE1C,KAAK,mBAAqB,KAAK,oBAAsB,IAAI,IACzD,MAAMP,EAAM0B,EAAI,QAAQ,YAAW,EAC7BmF,EAAc7G,EAAI,SAAS,cAAc,GAAKA,EAAI,SAAS,MAAM,GAAKA,EAAI,SAAS,SAAS,GAAKA,EAAI,SAAS,WAAW,GAAKA,EAAI,SAAS,SAAS,EAC1J,KAAK,mBAAmB,IAAIO,EAAI,GAAIsG,CAAW,CAEjD,MAGAhB,EAAW,eAAe1D,EAAcqE,CAAY,EAEpD,KAAK,KAAKjG,EAAI,GAAI,aAAa6B,EAAO,KAAK,YAAW,CAAE,IAAIoE,CAAY,OAAOrE,EAAa,QAAQ,CAAC,CAAC,EAAE,EACxG,KAAK,UAAU,IAAI5B,EAAI,GAAI,CACzB,KAAM6B,EAAO,KACb,WAAYD,EACZ,SAAUqE,EACV,UAAW,KAAK,IAAG,EACnB,UAAW,EACnB,CAAO,EACD,KAAK,qBAAqBjG,EAAK4B,EAAcC,EAAO,KAAMoE,EAAc7F,CAAK,EAC7E,KAAK,SAASJ,EAAI,GAAI,CAAE,GAAGI,EAAO,OAAQ,SAAU,UAAW,GAAM,OAAQ,MAAM,CAAE,CAEzF,CAGA,MAAM,yBAAyBJ,EAAK4B,EAAc,mBAChD,MAAM6C,EAAM,KAAK,UAAU,IAAIzE,EAAI,EAAE,EACrC,GAAI,CAACyE,EAAK,OAEV,MAAMyB,GAAYtG,EAAA,KAAK,iBAAL,YAAAA,EAAqB,IAAII,EAAI,IACzCmG,EAAQ,YAAWD,GAAA,YAAAA,EAAW,aAAYpG,EAAAE,EAAI,WAAJ,YAAAF,EAAc,WAAY,CAAC,EAAI,IACzEsG,EAAQ,YAAWF,GAAA,YAAAA,EAAW,eAAcrG,EAAAG,EAAI,WAAJ,YAAAH,EAAc,aAAc,CAAC,EAAI,IAI7E0G,EAAkBvG,EAAI,gBAAgBiC,EAAAjC,EAAI,WAAJ,YAAAiC,EAAc,gBAAgBiE,GAAA,YAAAA,EAAW,cAC/EM,EAAc,WAAWxG,EAAI,mBAAmBmC,EAAAnC,EAAI,WAAJ,YAAAmC,EAAc,mBAAmB+D,GAAA,YAAAA,EAAW,kBAAmBC,EAAQ,GAAG,EAAI,IAC9HM,EAAqB,WAAWzG,EAAI,sBAAsBoC,EAAApC,EAAI,WAAJ,YAAAoC,EAAc,sBAAsB8D,GAAA,YAAAA,EAAW,qBAAsB,EAAG,EAAI,IAE5I,IAAIQ,EAAIC,EAAoB,GACxBJ,GAEG9B,EAAI,YAAWA,EAAI,UAAYA,EAAI,YACpCA,EAAI,OAAS,OACfA,EAAI,UAAY,KAAK,IAAIA,EAAI,UAAW7C,CAAY,GAEjCA,EAAe6C,EAAI,YAAcA,EAAI,YACvCgC,GACfC,EAAKjC,EAAI,WAAa,EAAI+B,GAC1BG,EAAoB,IAEpBD,EAAKjC,EAAI,YAAc,EAAI0B,KAG7B1B,EAAI,UAAY,KAAK,IAAIA,EAAI,UAAW7C,CAAY,GACjC6C,EAAI,WAAa7C,GAAgB6C,EAAI,YACvCgC,GACfC,EAAKjC,EAAI,WAAa,EAAI+B,GAC1BG,EAAoB,IAEpBD,EAAKjC,EAAI,YAAc,EAAI0B,IAI/B,KAAK,UAAU,IAAInG,EAAI,GAAIyE,CAAG,GAE9BiC,EAAKjC,EAAI,OAAS,MACdA,EAAI,YAAc,EAAI0B,GACtB1B,EAAI,YAAc,EAAI0B,GAG5B,MAAMS,EAAKnC,EAAI,OAAS,MACpBA,EAAI,YAAc,EAAI2B,GACtB3B,EAAI,YAAc,EAAI2B,GAEpBS,EAAQpC,EAAI,OAAS,MAAQ7C,GAAgB8E,EAAK9E,GAAgB8E,EAClEI,EAAQrC,EAAI,OAAS,MAAQ7C,GAAgBgF,EAAKhF,GAAgBgF,EAGxE,GAAID,EAAmB,CACrB,MAAMI,EAAK,KAAK,SAAS,IAAI/G,EAAI,EAAE,EAC/B+G,IACFA,EAAG,aAAeL,EAClBK,EAAG,UAAYtC,EAAI,UACnB,KAAK,SAAS,IAAIzE,EAAI,GAAI+G,CAAE,EAEhC,CAEA,GAAIF,GAASC,EAAO,CAClB,MAAM7B,EAAWR,EAAI,OAAS,MAAQ,OAAS,MACzCS,EAAS2B,EAASF,EAAoB,gBAAkB,YAAe,cACvEK,EAAOH,EAASF,EAAoB,mBAAqB,eAAkB,iBAEjF,KAAK,KAAK3G,EAAI,GAAI,GAAGgH,CAAI,OAAOpF,EAAa,QAAQ,CAAC,CAAC,GAAG+E,EAAoB,aAAYjE,EAAA+B,EAAI,YAAJ,YAAA/B,EAAe,QAAQ,EAAE,IAAM,EAAE,EAAE,EAC7H,MAAM,KAAK,eAAe1C,EAAKyE,EAAK7C,EAAcqD,EAAUC,CAAM,CACpE,CACF,CAGA,sBAAsBlF,EAAKqB,EAAS,CAClC,MAAM4F,EAAgB,KAAK,kBAAkBjH,EAAI,SAAS,EAC1D,KAAK,KAAKA,EAAI,GAAI,mBAAmBiH,EAAgB,GAAI,GAAG,EAE5D,MAAMC,EAAU,SAAY,OAC1B,IAAKtH,EAAA,KAAK,WAAW,IAAII,EAAI,EAAE,IAA1B,MAAAJ,EAA6B,QAElC,GAAI,CACF,MAAMuH,EAAU,MAAM3F,EAAW,WAAWH,EAASrB,EAAI,UAAW,GAAG,EACvE,KAAK,QAAQ,IAAIA,EAAI,GAAImH,CAAO,EAChC,MAAMzF,EAASyF,EAAQ,IAAI,GAAK,EAAE,KAAK,EACjCvF,EAAeF,EAAOA,EAAO,OAAS,CAAC,EAGvC+C,EAAM,KAAK,UAAU,IAAIzE,EAAI,EAAE,EACrC,GAAIyE,EAAK,CACP,MAAM2C,EAAM3C,EAAI,OAAS,OACpB7C,EAAe6C,EAAI,YAAcA,EAAI,UACrCA,EAAI,WAAa7C,GAAgB6C,EAAI,SAC1C,KAAK,KAAKzE,EAAI,GAAI,OAAO4B,EAAa,QAAQ,CAAC,CAAC,MAAM6C,EAAI,KAAK,YAAW,CAAE,OAAOA,EAAI,WAAW,QAAQ,CAAC,CAAC,WAAW2C,GAAO,EAAI,IAAM,EAAE,IAAIA,EAAI,QAAQ,CAAC,CAAC,EAAE,CAChK,MACE,KAAK,KAAKpH,EAAI,GAAI,OAAO4B,EAAa,QAAQ,CAAC,CAAC,uBAAuB,EAIzE,MAAMC,EAAS,KAAK,kBAAkB7B,EAAI,SAAUmH,EAASzF,EAAQ1B,EAAI,EAAE,EACvE6B,EACF,MAAM,KAAK,cAAc7B,EAAK6B,EAAQD,CAAY,EAElD,KAAK,oBAAoB5B,EAAK0B,CAAM,EAItC,MAAM,KAAK,yBAAyB1B,EAAK4B,CAAY,CACvD,OAAST,EAAK,CACZ,KAAK,KAAKnB,EAAI,GAAI,YAAYmB,EAAI,OAAO,EAAE,CAC7C,CACF,EAEA+F,EAAO,EACP,MAAMG,EAAW,YAAYH,EAASD,CAAa,EACnD,KAAK,QAAQ,IAAIjH,EAAI,GAAI,CAAE,SAAAqH,EAAU,CACvC,CAGA,QAAQ7H,EAAO,CACb,MAAM8H,EAAS,KAAK,WAAW,IAAI9H,CAAK,EACpC8H,IACFA,EAAO,QAAU,GACjB,KAAK,WAAW,OAAO9H,CAAK,GAI9B,MAAM+H,EAAS,KAAK,QAAQ,IAAI/H,CAAK,EACrC,GAAI+H,EAAQ,CACV,GAAIA,EAAO,GACT,GAAI,CAAEA,EAAO,GAAG,MAAK,CAAI,MAAQ,CAAC,CAEhCA,EAAO,kBAAkB,aAAaA,EAAO,gBAAgB,EAC7DA,EAAO,UAAU,cAAcA,EAAO,QAAQ,EAClD,KAAK,QAAQ,OAAO/H,CAAK,CAC3B,CAGA,KAAK,UAAU,OAAOA,CAAK,EAC3B,KAAK,QAAQ,OAAOA,CAAK,EACzB,KAAK,cAAc,OAAOA,CAAK,EAC/B,KAAK,UAAU,OAAOA,CAAK,EAC3B,KAAK,SAAS,OAAOA,CAAK,CAC5B,CAGA,kBAAkBgI,EAAUL,EAASzF,EAAQlC,EAAO,+BAElD,IAAIgI,GAAA,YAAAA,EAAU,QAAS,kBAAmBA,GAAA,MAAAA,EAAU,MAAM,CACxD,MAAM/B,EAASgC,EAAcD,EAAS,KAAML,CAAO,EAOnD,QAJIvH,EAAA6F,EAAO,OAAP,YAAA7F,EAAa,QAAS,GACxB6F,EAAO,KAAK,QAAQ3E,GAAK,KAAK,KAAKtB,EAAO,MAAMsB,CAAC,EAAE,CAAC,EAGlD2E,EAAO,OACT,KAAK,KAAKjG,EAAO,mBAAmBiG,EAAO,KAAK,EAAE,EAC3C,OAILA,EAAO,QAAUjG,IACnB,KAAK,eAAiB,KAAK,gBAAkB,IAAI,IACjD,KAAK,eAAe,IAAIA,EAAOiG,EAAO,MAAM,GAG1CA,EAAO,QACT,KAAK,KAAKjG,EAAO,oBAAoBiG,EAAO,OAAO,KAAK,YAAW,CAAE,EAAE,EAElEA,EAAO,OAChB,CAEA,GAAI,GAAC3F,EAAA0H,GAAA,YAAAA,EAAU,QAAV,MAAA1H,EAAiB,WAAW,OAAO,KAExC,MAAMgC,EAAMJ,EAAO,OACnB,GAAII,EAAM,GAAI,OAAO,KACrB,MAAM4F,EAAYF,EAAS,MAAM,UAEjC,OAAQE,EAAS,CACf,IAAK,YACL,IAAK,gBAAiB,CACpB,MAAM1F,IAAOnC,EAAA2H,EAAS,MAAM,SAAf,YAAA3H,EAAuB,YAAWoC,EAAAuF,EAAS,MAAM,SAAf,YAAAvF,EAAuB,OAAQ,EACxEC,IAAOC,EAAAqF,EAAS,MAAM,SAAf,YAAArF,EAAuB,YAAWC,EAAAoF,EAAS,MAAM,SAAf,YAAApF,EAAuB,OAAQ,GACxEC,EAAUC,EAAaZ,EAAQM,CAAI,EACnCO,EAAUD,EAAaZ,EAAQQ,CAAI,EACnCyF,EAAQC,EAAgBvF,EAASE,EAAST,EAAM,CAAC,EAEvD,GAAI4F,IAAc,gBAAiB,CACjC,MAAMG,IAAYnF,EAAA8E,EAAS,MAAM,SAAf,YAAA9E,EAAuB,YAAa,GAEhDoF,EADMjF,EAAanB,EAAQmG,CAAS,EACnB/F,EAAM,CAAC,EACxBiG,IAAWpF,EAAA6E,EAAS,MAAM,SAAf,YAAA7E,EAAuB,cAAe,GACjDqF,IAAajF,GAAAD,EAAA0E,EAAS,OAAT,YAAA1E,EAAe,SAAf,YAAAC,EAAuB,gBAAiB,GAE3D,GAAI4E,IAAU,iBAAmBG,EAAaC,EAAU,MAAO,CAAE,KAAM,KAAK,EAC5E,GAAIJ,IAAU,iBAAmBG,EAAaE,EAAY,MAAO,CAAE,KAAM,MAAM,EAC/E,GAAIF,EAAaE,EAAY,MAAO,CAAE,KAAM,MAAM,EAClD,GAAIF,EAAaC,EAAU,MAAO,CAAE,KAAM,KAAK,CACjD,KAAO,CACL,GAAIJ,IAAU,gBAAiB,MAAO,CAAE,KAAM,KAAK,EACnD,GAAIA,IAAU,gBAAiB,MAAO,CAAE,KAAM,MAAM,CACtD,CACA,KACF,CAEA,IAAK,MAAO,CACV,MAAMM,IAASjF,EAAAwE,EAAS,MAAM,SAAf,YAAAxE,EAAuB,SAAU,GAE1CkF,EADMrF,EAAanB,EAAQuG,CAAM,EACnBnG,EAAM,CAAC,EAC3B,GAAIoG,KAAWjF,EAAAuE,EAAS,MAAM,SAAf,YAAAvE,EAAuB,WAAY,IAAK,MAAO,CAAE,KAAM,KAAK,EAC3E,GAAIiF,KAAW9E,EAAAoE,EAAS,MAAM,SAAf,YAAApE,EAAuB,aAAc,IAAK,MAAO,CAAE,KAAM,MAAM,EAC9E,KACF,CAEA,IAAK,aAAc,CACjB,KAAM,CAAE,KAAAF,EAAM,OAAArB,GAAWsB,EAAczB,CAAM,EACvCiG,EAAQC,EAAgB1E,EAAMrB,EAAQC,EAAM,CAAC,EACnD,GAAI6F,IAAU,gBAAiB,MAAO,CAAE,KAAM,KAAK,EACnD,GAAIA,IAAU,gBAAiB,MAAO,CAAE,KAAM,MAAM,EACpD,KACF,CAEA,QACE,OAAO,IACf,CAEI,OAAO,IACT,CAGA,MAAM,mBAAmB3H,EAAK,OAC5B,GAAI,GAACA,EAAI,UAAY,CAACiB,EAAc,YAAY,IAAIjB,EAAI,QAAQ,GAChE,GAAI,CACF,MAAMmI,EAAW,MAAMlH,EAAc,YAAYjB,EAAI,QAAQ,EAEvDoI,EAAc,CAAC,OAAQ,MAAO,OAAQ,OAAQ,OAAO,EACrDC,EAAYF,EAAS,KAAKnH,GAAC,OAAI,OAAAoH,EAAY,UAASxI,EAAAoB,EAAE,QAAF,YAAApB,EAAS,aAAa,EAAC,EACjF,GAAIyI,EAAW,CACb,MAAMC,EAAa,WAAWD,EAAU,MAAQA,EAAU,OAAS,CAAC,EACpE,GAAIC,EAAa,GAAKA,IAAetI,EAAI,QAAS,CAChD,KAAK,KAAKA,EAAI,GAAI,6BAA4BJ,EAAAI,EAAI,UAAJ,YAAAJ,EAAa,QAAQ,EAAE,OAAO0I,EAAW,QAAQ,CAAC,CAAC,EAAE,EACnGtI,EAAI,QAAUsI,EAEd,GAAI,CACF,KAAM,CAAE,QAASC,GAAa,wCAAM,QAAO,qBAAmB,OAAA/H,KAAA,mBAAA+H,CAAA,+BAGxDC,GAFQD,EAAS,SAAQ,EACZ,MAAQ,IACN,IAAIvH,GAAKA,EAAE,KAAOhB,EAAI,GAAK,CAAE,GAAGgB,EAAG,QAASsH,CAAU,EAAKtH,CAAC,EACjFuH,EAAS,SAAS,CAAE,KAAMC,CAAO,CAAE,CACrC,MAAQ,CAAC,CACX,CACF,CACF,OAASrH,EAAK,CAEZ,QAAQ,KAAK,0CAA2CA,EAAI,OAAO,CACrE,CACF,CAGA,uBAAuBnB,EAAKyI,EAAO,CACjC,MAAMC,EAAU1I,EAAI,SAAW,IACzB2I,EAAc,WAAW3I,EAAI,aAAe,CAAC,EAAI,IACvD,IAAI4I,EAAYF,EAAUC,EAG1B,MAAME,EAAgB,IAClBD,EAAYC,IACdD,EAAY,KAAK,IAAIC,EAAeH,EAAU,GAAI,EAClD,KAAK,KAAK1I,EAAI,GAAI,kCAAkC0I,EAAUC,GAAa,QAAQ,CAAC,CAAC,kBAAkBC,EAAU,QAAQ,CAAC,CAAC,EAAE,GAI3HA,EAAYF,EAAU,MACxBE,EAAYF,EAAU,KAIxB,KAAK,KAAK1I,EAAI,GAAI,qBAAqB4I,EAAU,QAAQ,CAAC,CAAC,SAASD,EAAc,GAAG,SAASD,CAAO,GAAG,EAExG,MAAMI,EAASF,EAAYH,EAC3B,OAAO,KAAK,MAAMK,EAAS,GAAG,EAAI,GACpC,CAGA,kBAAkBC,EAAW,CAS3B,MARkB,CAChB,KAAM,KACN,KAAM,IACN,MAAO,IACP,KAAM,IACN,KAAM,KACN,KAAM,GACZ,EACqBA,CAAS,GAAK,GACjC,CAGA,mBAAoB,CAClB,OAAO,KAAK,WAAW,IACzB,CACF,CAEY,MAACC,EAAgB,IAAIzJ","names":["WS_ENDPOINTS","TradingEngine","botId","msg","logs","botData","_a","_c","_b","trade","bot","entryPrice","side","quantity","order","store","__vitePreload","__vite_default__","n","state","p","onTrade","onLog","all","l","a","b","brokerService","broker","err","brokerReady","apiPair","toApiPair","initialCandles","marketData","lastPrice","closes","c","currentPrice","signal","len","ind","fast","_d","slow","_e","_f","emaFast","calculateEMA","emaSlow","diff","info","_g","_h","rsi","calculateRSI","_i","_j","_k","_l","macd","calculateMACD","_m","_n","_o","rsiArr","_p","_q","_r","retries","pair","tf","wsBase","url","ws","reconnectTimeout","event","data","k","candle","e","altBase","delay","pos","unrealizedPnl","pnlPercent","now","lastHB","botCandles","openPosition","position","exitSide","reason","qty","rawProfit","closeFee","feeService","profit","closeOrder","result","confirmed","realExitPrice","realProfit","statusIcon","telegramService","lastFail","cooldown","positionSize","scriptCfg","slPct","tpPct","fillPrice","isPermanent","trailingEnabled","trailingPct","trailingActivation","sl","effectiveTrailing","tp","hitSL","hitTP","ld","icon","checkInterval","monitor","candles","pnl","interval","active","stream","strategy","executeScript","indicator","cross","detectCrossover","rsiPeriod","currentRSI","oversold","overbought","period","current","balances","stableNames","stableBal","newBalance","useStore","updated","price","balance","riskPercent","usdAmount","MIN_ORDER_USD","amount","timeframe","tradingEngine"],"ignoreList":[],"sources":["../../src/services/tradingEngine.js"],"sourcesContent":["// Kairos Trade â€” Trading Engine (Bot Execution Core)\n// Real-time WebSocket monitoring + REAL trade execution via connected broker\n// Each bot gets a dedicated WebSocket for instant price updates\n// Callbacks are stored in a registry so they survive component remounts\n\nimport { calculateEMA, calculateRSI, calculateMACD, detectCrossover } from './indicators';\nimport { marketData } from './marketData';\nimport { brokerService } from './broker';\nimport { executeScript } from './kairosScript';\nimport { toApiPair } from '../utils/pairUtils';\nimport { telegramService } from './telegram';\nimport { feeService } from './feeService';\n\nconst WS_ENDPOINTS = [\n  'wss://stream.binance.us:9443/ws',\n  'wss://stream.binance.com:9443/ws',\n];\n\nclass TradingEngine {\n  constructor() {\n    this.activeBots = new Map();\n    this.streams = new Map();       // WebSocket or interval per bot\n    this.positions = new Map();     // Open positions: botId -> { side, entryPrice, quantity, entryTime }\n    this.candles = new Map();       // Candle arrays per bot for indicator calculation\n    this.lastHeartbeat = new Map(); // Throttle heartbeat logs\n    this.logs = new Map();          // Internal log buffer per bot (survives navigation)\n    this.callbacks = new Map();     // Callback registry per bot { onTrade, onLog }\n    this.liveData = new Map();      // Real-time data per bot: { price, unrealizedPnl, position }\n  }\n\n  // â”€â”€â”€ Internal log: stores + forwards to UI â”€â”€â”€\n  _log(botId, msg) {\n    const logs = this.logs.get(botId) || [];\n    const botData = this.activeBots.get(botId);\n    logs.push({ message: msg, time: Date.now(), botName: botData?.bot?.name || 'Bot' });\n    if (logs.length > 150) logs.splice(0, 50);\n    this.logs.set(botId, logs);\n    try { this.callbacks.get(botId)?.onLog?.(msg); } catch (e) { /* stale callback */ }\n  }\n\n  // â”€â”€â”€ Internal trade forward â”€â”€â”€\n  _onTrade(botId, trade) {\n    try { this.callbacks.get(botId)?.onTrade?.(trade); } catch (e) { /* stale callback */ }\n  }\n\n  // â”€â”€â”€ Sync bot position to Zustand store (for OrdersPanel visibility) â”€â”€â”€\n  async _syncPositionToStore(bot, entryPrice, side, quantity, order) {\n    try {\n      const store = (await import('../store/useStore')).default;\n      const state = store.getState();\n\n      // Remove any existing position for this bot first (prevent duplicates)\n      const existing = state.positions.filter(p => p.botId === bot.id);\n      existing.forEach(p => state.closePosition(p.id));\n\n      store.getState().addPosition({\n        pair: bot.pair,\n        side,\n        quantity,\n        entryPrice,\n        currentPrice: entryPrice,\n        stopLoss: order.stopLoss ? parseFloat(order.stopLoss.toFixed(2)) : null,\n        takeProfit: order.takeProfit ? parseFloat(order.takeProfit.toFixed(2)) : null,\n        botId: bot.id,\n        botName: bot.name,\n        time: Date.now(),\n      });\n    } catch {}\n  }\n\n  // â”€â”€â”€ Remove bot position from store â”€â”€â”€\n  async _removePositionFromStore(botId) {\n    try {\n      const store = (await import('../store/useStore')).default;\n      const state = store.getState();\n      // Remove ALL positions for this bot (in case of duplicates)\n      const botPositions = state.positions.filter(p => p.botId === botId);\n      botPositions.forEach(p => state.closePosition(p.id));\n    } catch {}\n  }\n\n  // â”€â”€â”€ Update callbacks (call when component remounts) â”€â”€â”€\n  setCallbacks(botId, onTrade, onLog) {\n    this.callbacks.set(botId, { onTrade, onLog });\n  }\n\n  // â”€â”€â”€ Get stored logs for a bot â”€â”€â”€\n  getLogs(botId) {\n    return this.logs.get(botId) || [];\n  }\n\n  // â”€â”€â”€ Get all logs across all bots â”€â”€â”€\n  getAllLogs() {\n    const all = [];\n    for (const [botId, logs] of this.logs) {\n      all.push(...logs.map(l => ({ ...l, botId })));\n    }\n    return all.sort((a, b) => a.time - b.time).slice(-100);\n  }\n\n  // â”€â”€â”€ Auto-reconnect broker if needed â”€â”€â”€\n  async _ensureBrokerConnected(bot) {\n    if (!bot.brokerId) return false;\n    if (brokerService.connections.has(bot.brokerId)) return true;\n\n    try {\n      const useStore = (await import('../store/useStore')).default;\n      const broker = useStore.getState().brokers.find(b => b.id === bot.brokerId);\n      if (broker && broker.connected) {\n        await brokerService.connect(broker);\n        return true;\n      }\n    } catch (err) {\n      console.warn('Auto-reconnect failed:', err.message);\n    }\n    return false;\n  }\n\n  // â”€â”€â”€ Start a bot with real-time WebSocket â”€â”€â”€\n  async startBot(bot, onTrade, onLog) {\n    if (this.activeBots.has(bot.id)) return;\n\n    // Register callbacks in registry (looked up dynamically, never stale)\n    this.callbacks.set(bot.id, { onTrade, onLog });\n    this.activeBots.set(bot.id, { bot, running: true });\n\n    this._log(bot.id, `ðŸ¤– Bot \"${bot.name}\" iniciado en ${bot.pair}`);\n\n    // Auto-reconnect broker\n    const brokerReady = await this._ensureBrokerConnected(bot);\n    if (bot.brokerId) {\n      this._log(bot.id, brokerReady\n        ? `ðŸ”— Broker conectado â€” modo REAL activado`\n        : `âš ï¸ Broker no disponible â€” modo DEMO`);\n    } else {\n      this._log(bot.id, `ðŸ“‹ Modo DEMO â€” Conecta un broker para operar en real`);\n    }\n\n    // Fetch initial candles for indicator calculation\n    const apiPair = toApiPair(bot.pair);\n    let initialCandles;\n    try {\n      initialCandles = await marketData.getCandles(apiPair, bot.timeframe, 100);\n      this.candles.set(bot.id, initialCandles);\n      const lastPrice = initialCandles[initialCandles.length - 1]?.close;\n      this._log(bot.id, `ðŸ“Š ${initialCandles.length} velas cargadas | Precio: $${lastPrice?.toFixed(2)} | TF: ${bot.timeframe}`);\n    } catch (err) {\n      this._log(bot.id, `âŒ Error cargando datos: ${err.message}`);\n      this._log(bot.id, `â±ï¸ Cambiando a modo polling...`);\n      this._startPollingFallback(bot, apiPair);\n      return;\n    }\n\n    // Run initial strategy evaluation\n    const closes = initialCandles.map(c => c.close);\n    const currentPrice = closes[closes.length - 1];\n    const signal = this._evaluateStrategy(bot.strategy, initialCandles, closes, bot.id);\n    if (signal) {\n      this._log(bot.id, `ðŸ“Š SeÃ±al inicial: ${signal.type.toUpperCase()} a $${currentPrice.toFixed(2)}`);\n      await this._handleSignal(bot, signal, currentPrice);\n    } else {\n      // Log current indicator values so user sees the bot is analyzing\n      this._logIndicatorStatus(bot, closes);\n    }\n\n    // Connect real-time WebSocket\n    this._connectBotStream(bot, apiPair);\n  }\n\n  // â”€â”€â”€ Log indicator status (no signal, but show what the bot sees) â”€â”€â”€\n  _logIndicatorStatus(bot, closes) {\n    const len = closes.length;\n    const ind = bot.strategy?.entry?.indicator;\n    try {\n      if (ind === 'ema_cross' || ind === 'ema_cross_rsi') {\n        const fast = bot.strategy.entry.params?.fastEma || bot.strategy.entry.params?.fast || 20;\n        const slow = bot.strategy.entry.params?.slowEma || bot.strategy.entry.params?.slow || 50;\n        const emaFast = calculateEMA(closes, fast);\n        const emaSlow = calculateEMA(closes, slow);\n        const diff = ((emaFast[len - 1] - emaSlow[len - 1]) / emaSlow[len - 1] * 100).toFixed(3);\n        let info = `ðŸ“ˆ EMA${fast}: $${emaFast[len - 1]?.toFixed(2)} | EMA${slow}: $${emaSlow[len - 1]?.toFixed(2)} | Diff: ${diff}%`;\n        if (ind === 'ema_cross_rsi') {\n          const rsi = calculateRSI(closes, bot.strategy.entry.params?.rsiPeriod || 14);\n          info += ` | RSI: ${rsi[len - 1]?.toFixed(1)}`;\n        }\n        this._log(bot.id, `${info} â€” Sin seÃ±al, monitoreando...`);\n      } else if (ind === 'rsi') {\n        const rsi = calculateRSI(closes, bot.strategy.entry.params?.period || 14);\n        this._log(bot.id, `ðŸ“ˆ RSI: ${rsi[len - 1]?.toFixed(1)} â€” Sin seÃ±al, monitoreando...`);\n      } else if (ind === 'macd_cross') {\n        const { macd, signal } = calculateMACD(closes);\n        this._log(bot.id, `ðŸ“ˆ MACD: ${macd[len - 1]?.toFixed(2)} | Signal: ${signal[len - 1]?.toFixed(2)} â€” Sin seÃ±al, monitoreando...`);\n      } else if (bot.strategy?.type === 'custom_script') {\n        // Custom script â€” show key indicator values automatically\n        const emaFast = calculateEMA(closes, 9);\n        const emaSlow = calculateEMA(closes, 21);\n        const rsiArr = calculateRSI(closes, 14);\n        const p = closes[len - 1];\n        const diff = ((emaFast[len - 1] - emaSlow[len - 1]) / emaSlow[len - 1] * 100).toFixed(3);\n        this._log(bot.id, `ðŸ“ˆ $${p?.toFixed(2)} | EMA9: $${emaFast[len - 1]?.toFixed(2)} | EMA21: $${emaSlow[len - 1]?.toFixed(2)} (${diff}%) | RSI: ${rsiArr[len - 1]?.toFixed(1)} â€” Sin seÃ±al`);\n      } else {\n        this._log(bot.id, `ðŸ‘€ Sin seÃ±al â€” Monitoreando en tiempo real...`);\n      }\n    } catch {\n      this._log(bot.id, `ðŸ‘€ Sin seÃ±al â€” Monitoreando en tiempo real...`);\n    }\n  }\n\n  // â”€â”€â”€ Create dedicated WebSocket per bot â”€â”€â”€\n  _connectBotStream(bot, apiPair, retries = 0) {\n    if (!this.activeBots.get(bot.id)?.running) return;\n\n    const pair = apiPair.toLowerCase();\n    const tf = bot.timeframe || '1m';\n\n    // Use detected endpoint or try US first\n    const wsBase = marketData._wsBase || WS_ENDPOINTS[0];\n    const url = `${wsBase}/${pair}@ticker/${pair}@kline_${tf}`;\n\n    this._log(bot.id, `ðŸ”Œ Conectando stream: ${apiPair} @ ${tf}${retries > 0 ? ` (intento ${retries + 1})` : ''}...`);\n\n    let ws;\n    try {\n      ws = new WebSocket(url);\n    } catch (err) {\n      this._log(bot.id, `âŒ Error WebSocket: ${err.message} â€” Cambiando a polling`);\n      this._startPollingFallback(bot, apiPair);\n      return;\n    }\n\n    let reconnectTimeout = null;\n\n    ws.onopen = () => {\n      this._log(bot.id, `âš¡ Stream EN VIVO conectado â€” Datos instantÃ¡neos activos`);\n      retries = 0;\n    };\n\n    ws.onmessage = (event) => {\n      if (!this.activeBots.get(bot.id)?.running) return;\n\n      try {\n        const data = JSON.parse(event.data);\n\n        // Real-time ticker â€” check SL/TP and heartbeat\n        if (data.e === '24hrTicker') {\n          const currentPrice = parseFloat(data.c);\n          this._handleTick(bot, currentPrice);\n        }\n\n        // Kline â€” evaluate strategy on candle close\n        if (data.e === 'kline') {\n          const k = data.k;\n          const candle = {\n            time: Math.floor(k.t / 1000),\n            open: parseFloat(k.o),\n            high: parseFloat(k.h),\n            low: parseFloat(k.l),\n            close: parseFloat(k.c),\n            volume: parseFloat(k.v),\n          };\n\n          if (k.x) {\n            // Candle CLOSED â€” update array and evaluate strategy\n            this._handleCandleClose(bot, candle);\n          }\n        }\n      } catch (e) {\n        console.error(`[Bot ${bot.id}] WS parse:`, e);\n      }\n    };\n\n    ws.onerror = (err) => {\n      console.error(`[Bot ${bot.id}] WS error`, err);\n      // Try alternate endpoint on first error\n      if (retries === 0) {\n        const altBase = wsBase === WS_ENDPOINTS[0] ? WS_ENDPOINTS[1] : WS_ENDPOINTS[0];\n        marketData._wsBase = altBase;\n        this._log(bot.id, `ðŸ”„ Probando endpoint alternativo...`);\n        try { ws.close(); } catch {}\n        this._connectBotStream(bot, apiPair, 1);\n        return;\n      }\n    };\n\n    ws.onclose = () => {\n      if (!this.activeBots.get(bot.id)?.running) return;\n\n      if (retries < 5) {\n        const delay = Math.min(2000 * (retries + 1), 10000);\n        this._log(bot.id, `ðŸ”„ Reconectando en ${delay / 1000}s...`);\n        reconnectTimeout = setTimeout(() => {\n          this._connectBotStream(bot, apiPair, retries + 1);\n        }, delay);\n      } else {\n        this._log(bot.id, `âš ï¸ WebSocket no disponible â€” Modo polling activado`);\n        this._startPollingFallback(bot, apiPair);\n      }\n    };\n\n    // Store WS reference for cleanup\n    this.streams.set(bot.id, { ws, reconnectTimeout });\n  }\n\n  // â”€â”€â”€ Get live data for a bot (called by UI) â”€â”€â”€\n  getLiveData(botId) {\n    return this.liveData.get(botId) || null;\n  }\n\n  // â”€â”€â”€ Handle real-time price tick â”€â”€â”€\n  _handleTick(bot, currentPrice) {\n    // Update live data on EVERY tick (for real-time UI)\n    const pos = this.positions.get(bot.id);\n    if (pos) {\n      const unrealizedPnl = pos.side === 'buy'\n        ? (currentPrice - pos.entryPrice) * pos.quantity\n        : (pos.entryPrice - currentPrice) * pos.quantity;\n      const pnlPercent = pos.side === 'buy'\n        ? ((currentPrice - pos.entryPrice) / pos.entryPrice) * 100\n        : ((pos.entryPrice - currentPrice) / pos.entryPrice) * 100;\n      this.liveData.set(bot.id, {\n        price: currentPrice,\n        unrealizedPnl,\n        pnlPercent,\n        position: { side: pos.side, entryPrice: pos.entryPrice, quantity: pos.quantity },\n        time: Date.now(),\n      });\n    } else {\n      this.liveData.set(bot.id, { price: currentPrice, unrealizedPnl: 0, pnlPercent: 0, position: null, time: Date.now() });\n    }\n\n    // Heartbeat log every 10 seconds\n    const now = Date.now();\n    const lastHB = this.lastHeartbeat.get(bot.id) || 0;\n    if (now - lastHB > 10000) {\n      this.lastHeartbeat.set(bot.id, now);\n      if (pos) {\n        const unrealizedPnl = pos.side === 'buy'\n          ? (currentPrice - pos.entryPrice) * pos.quantity\n          : (pos.entryPrice - currentPrice) * pos.quantity;\n        this._log(bot.id, `ðŸ’“ $${currentPrice.toFixed(2)} | ${pos.side.toUpperCase()} @ $${pos.entryPrice.toFixed(2)} | P&L: ${unrealizedPnl >= 0 ? '+' : ''}$${unrealizedPnl.toFixed(2)}`);\n      } else {\n        this._log(bot.id, `ðŸ’“ $${currentPrice.toFixed(2)} â€” Esperando seÃ±al...`);\n      }\n    }\n\n    // Check SL/TP on EVERY tick (instant reaction)\n    this._checkStopLossTakeProfit(bot, currentPrice);\n  }\n\n  // â”€â”€â”€ Handle closed candle â€” evaluate strategy â”€â”€â”€\n  async _handleCandleClose(bot, candle) {\n    const botCandles = this.candles.get(bot.id) || [];\n\n    // Append or update last candle\n    if (botCandles.length > 0 && botCandles[botCandles.length - 1].time === candle.time) {\n      botCandles[botCandles.length - 1] = candle;\n    } else {\n      botCandles.push(candle);\n      if (botCandles.length > 200) botCandles.shift();\n    }\n    this.candles.set(bot.id, botCandles);\n\n    const closes = botCandles.map(c => c.close);\n    const currentPrice = candle.close;\n\n    this._log(bot.id, `ðŸ•¯ï¸ Vela cerrada: O:${candle.open.toFixed(2)} H:${candle.high.toFixed(2)} L:${candle.low.toFixed(2)} C:${candle.close.toFixed(2)}`);\n\n    // Evaluate strategy\n    const signal = this._evaluateStrategy(bot.strategy, botCandles, closes, bot.id);\n    if (signal) {\n      await this._handleSignal(bot, signal, currentPrice);\n    } else {\n      // Show indicator values so user knows bot is analyzing\n      this._logIndicatorStatus(bot, closes);\n    }\n  }\n\n  // â”€â”€â”€ Handle trade signal (open/close positions) â”€â”€â”€\n  async _handleSignal(bot, signal, currentPrice) {\n    const openPosition = this.positions.get(bot.id);\n\n    // Close existing position if signal is opposite\n    if (openPosition && openPosition.side !== signal.type) {\n      await this._closePosition(bot, openPosition, currentPrice, signal.type);\n    }\n\n    // Open NEW position\n    if (!this.positions.has(bot.id)) {\n      await this._openPosition(bot, signal, currentPrice);\n    }\n  }\n\n  // â”€â”€â”€ Close position â”€â”€â”€\n  async _closePosition(bot, position, currentPrice, exitSide, reason) {\n    const entryPrice = position.entryPrice;\n    const qty = position.quantity;\n    const rawProfit = position.side === 'buy'\n      ? (currentPrice - entryPrice) * qty\n      : (entryPrice - currentPrice) * qty;\n\n    // Platform fee (0.05% of volume on close)\n    const closeFee = feeService.applyVolumeFee(currentPrice, qty);\n    const profit = rawProfit - closeFee;\n\n    this._log(bot.id, `ðŸ“Š Cerrando: ${position.side.toUpperCase()} â†’ ${exitSide.toUpperCase()} | $${entryPrice.toFixed(2)} â†’ $${currentPrice.toFixed(2)} | P&L: ${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}`);\n\n    const closeOrder = {\n      symbol: toApiPair(bot.pair),\n      side: exitSide,\n      type: 'market',\n      quantity: qty,\n      price: currentPrice,\n    };\n\n    if (bot.brokerId && brokerService.connections.has(bot.brokerId)) {\n      try {\n        this._log(bot.id, `ðŸ”„ Cerrando posiciÃ³n REAL en broker...`);\n        const result = await brokerService.placeOrder(bot.brokerId, closeOrder);\n        const confirmed = result.confirmed !== false;\n        const realExitPrice = (result.filledPrice && result.filledPrice > 0)\n          ? result.filledPrice : currentPrice;\n        const rawRealProfit = position.side === 'buy'\n          ? (realExitPrice - entryPrice) * qty\n          : (entryPrice - realExitPrice) * qty;\n        const realProfit = rawRealProfit - closeFee;\n        const statusIcon = confirmed ? 'âœ…' : 'âš ï¸';\n        this._log(bot.id, `${statusIcon} Cerrada: P&L ${realProfit >= 0 ? '+' : ''}$${realProfit.toFixed(4)} [${result.status}] ID:${result.id || 'N/A'}`);\n        this._onTrade(bot.id, { ...closeOrder, ...result, profit: realProfit, real: true, confirmed, action: 'close', reason });\n\n        // Telegram notification\n        telegramService.notifyTradeClose(bot.name, position.side, bot.pair, entryPrice, realExitPrice, realProfit, reason);\n\n        // Auto-refresh balance from broker after closing\n        this._refreshBotBalance(bot);\n      } catch (err) {\n        this._log(bot.id, `âŒ Error cerrando: ${err.message}`);\n        this._onTrade(bot.id, { ...closeOrder, profit, status: 'error', error: err.message, action: 'close' });\n      }\n    } else {\n      this._log(bot.id, `ðŸ“ [DEMO] Cerrada: P&L ${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}`);\n      this._onTrade(bot.id, { ...closeOrder, profit, status: 'filled', simulated: true, action: 'close', reason });\n    }\n\n    this.positions.delete(bot.id);\n    this._removePositionFromStore(bot.id);\n  }\n\n  // â”€â”€â”€ Open position â”€â”€â”€\n  async _openPosition(bot, signal, currentPrice) {\n    // Short cooldown (5s): prevents double-fire on same candle, lets next candle evaluate fresh\n    const lastFail = this._lastOrderFail?.get(bot.id) || 0;\n    const cooldown = this._lastFailPermanent?.get(bot.id) ? 60000 : 5000; // 1min for balance issues, 5s for transient\n    if (Date.now() - lastFail < cooldown) {\n      return;\n    }\n\n    this._log(bot.id, `ðŸ“Š SeÃ±al: ${signal.type.toUpperCase()} a $${currentPrice.toFixed(2)}`);\n\n    const positionSize = this._calculatePositionSize(bot, currentPrice);\n\n    // Sanity check: if position too small even after minimum, skip\n    if (positionSize * currentPrice < 0.50) {\n      this._log(bot.id, `âš ï¸ Balance insuficiente para operar (mÃ­nimo ~$1). Necesitas al menos $1.10 de saldo.`);\n      this._lastOrderFail = this._lastOrderFail || new Map();\n      this._lastFailPermanent = this._lastFailPermanent || new Map();\n      this._lastOrderFail.set(bot.id, Date.now());\n      this._lastFailPermanent.set(bot.id, true);\n      return;\n    }\n\n    // Use script config SL/TP if available, otherwise bot strategy defaults\n    const scriptCfg = this._scriptConfigs?.get(bot.id);\n    const slPct = parseFloat(scriptCfg?.stopLoss || bot.strategy?.stopLoss || 2) / 100;\n    const tpPct = parseFloat(scriptCfg?.takeProfit || bot.strategy?.takeProfit || 4) / 100;\n\n    const order = {\n      symbol: toApiPair(bot.pair),\n      side: signal.type,\n      type: 'market',\n      quantity: positionSize,\n      price: currentPrice,\n      stopLoss: signal.type === 'buy'\n        ? currentPrice * (1 - slPct)\n        : currentPrice * (1 + slPct),\n      takeProfit: signal.type === 'buy'\n        ? currentPrice * (1 + tpPct)\n        : currentPrice * (1 - tpPct),\n    };\n\n    if (bot.brokerId && brokerService.connections.has(bot.brokerId)) {\n      try {\n        this._log(bot.id, `ðŸ”„ Ejecutando orden REAL en broker...`);\n        const result = await brokerService.placeOrder(bot.brokerId, order);\n        const fillPrice = result.filledPrice || currentPrice;\n        const confirmed = result.confirmed !== false;\n        const statusIcon = confirmed ? 'âœ…' : 'âš ï¸';\n        // Platform fee (0.05% of volume on open)\n        feeService.applyVolumeFee(fillPrice, result.filledQty || positionSize);\n\n        this._log(bot.id, `${statusIcon} REAL: ${result.side?.toUpperCase()} ${result.filledQty || positionSize} @ $${fillPrice.toFixed(2)} [${result.status}] ID:${result.id || 'N/A'}`);\n        if (!confirmed) {\n          this._log(bot.id, `âš ï¸ Orden no confirmada por el broker â€” el fill real puede diferir`);\n        }\n        // Clear cooldown on success\n        this._lastOrderFail?.delete(bot.id);\n        this._lastFailPermanent?.delete(bot.id);\n\n        this.positions.set(bot.id, {\n          side: signal.type,\n          entryPrice: fillPrice,\n          quantity: result.filledQty || positionSize,\n          entryTime: Date.now(),\n          orderId: result.id,\n        });\n        this._syncPositionToStore(bot, fillPrice, signal.type, result.filledQty || positionSize, order);\n        this._onTrade(bot.id, { ...order, ...result, real: true, action: 'open' });\n\n        // Telegram notification\n        telegramService.notifyTradeOpen(bot.name, signal.type, bot.pair, fillPrice, result.filledQty || positionSize, bot.brokerName || bot.brokerId);\n\n        // Auto-refresh balance from broker after trade\n        this._refreshBotBalance(bot);\n      } catch (err) {\n        this._log(bot.id, `âŒ Error orden: ${err.message}`);\n        // Short cooldown (5s) â€” next candle re-evaluarÃ¡ la seÃ±al fresca\n        this._lastOrderFail = this._lastOrderFail || new Map();\n        this._lastOrderFail.set(bot.id, Date.now());\n        // Detect permanent errors (balance/size) vs transient (network/rate-limit)\n        this._lastFailPermanent = this._lastFailPermanent || new Map();\n        const msg = err.message.toLowerCase();\n        const isPermanent = msg.includes('insufficient') || msg.includes('size') || msg.includes('balance') || msg.includes('too small') || msg.includes('minimum');\n        this._lastFailPermanent.set(bot.id, isPermanent);\n        // Don't fire _onTrade for errors (don't count as trade)\n      }\n    } else {\n      // Platform fee (0.05% of volume on open â€” demo)\n      feeService.applyVolumeFee(currentPrice, positionSize);\n\n      this._log(bot.id, `ðŸ“ [DEMO] ${signal.type.toUpperCase()} ${positionSize} @ $${currentPrice.toFixed(2)}`);\n      this.positions.set(bot.id, {\n        side: signal.type,\n        entryPrice: currentPrice,\n        quantity: positionSize,\n        entryTime: Date.now(),\n        simulated: true,\n      });\n      this._syncPositionToStore(bot, currentPrice, signal.type, positionSize, order);\n      this._onTrade(bot.id, { ...order, status: 'filled', simulated: true, action: 'open' });\n    }\n  }\n\n  // â”€â”€â”€ Check SL/TP + Trailing Stop on every tick (real-time) â”€â”€â”€\n  async _checkStopLossTakeProfit(bot, currentPrice) {\n    const pos = this.positions.get(bot.id);\n    if (!pos) return;\n\n    const scriptCfg = this._scriptConfigs?.get(bot.id);\n    const slPct = parseFloat(scriptCfg?.stopLoss || bot.strategy?.stopLoss || 2) / 100;\n    const tpPct = parseFloat(scriptCfg?.takeProfit || bot.strategy?.takeProfit || 4) / 100;\n\n    // â”€â”€ Trailing Stop Loss Logic â”€â”€\n    // Activates when trailingStop is enabled on the bot or strategy\n    const trailingEnabled = bot.trailingStop || bot.strategy?.trailingStop || scriptCfg?.trailingStop;\n    const trailingPct = parseFloat(bot.trailingStopPct || bot.strategy?.trailingStopPct || scriptCfg?.trailingStopPct || slPct * 100) / 100;\n    const trailingActivation = parseFloat(bot.trailingActivation || bot.strategy?.trailingActivation || scriptCfg?.trailingActivation || 0.5) / 100;\n\n    let sl, effectiveTrailing = false;\n    if (trailingEnabled) {\n      // Track best price since entry\n      if (!pos.bestPrice) pos.bestPrice = pos.entryPrice;\n      if (pos.side === 'buy') {\n        pos.bestPrice = Math.max(pos.bestPrice, currentPrice);\n        // Activate trailing only after price moves X% in profit\n        const profitPct = (currentPrice - pos.entryPrice) / pos.entryPrice;\n        if (profitPct >= trailingActivation) {\n          sl = pos.bestPrice * (1 - trailingPct);\n          effectiveTrailing = true;\n        } else {\n          sl = pos.entryPrice * (1 - slPct); // Use regular SL until activation\n        }\n      } else {\n        pos.bestPrice = Math.min(pos.bestPrice, currentPrice);\n        const profitPct = (pos.entryPrice - currentPrice) / pos.entryPrice;\n        if (profitPct >= trailingActivation) {\n          sl = pos.bestPrice * (1 + trailingPct);\n          effectiveTrailing = true;\n        } else {\n          sl = pos.entryPrice * (1 + slPct);\n        }\n      }\n      // Update position in map with tracked best price\n      this.positions.set(bot.id, pos);\n    } else {\n      sl = pos.side === 'buy'\n        ? pos.entryPrice * (1 - slPct)\n        : pos.entryPrice * (1 + slPct);\n    }\n\n    const tp = pos.side === 'buy'\n      ? pos.entryPrice * (1 + tpPct)\n      : pos.entryPrice * (1 - tpPct);\n\n    const hitSL = pos.side === 'buy' ? currentPrice <= sl : currentPrice >= sl;\n    const hitTP = pos.side === 'buy' ? currentPrice >= tp : currentPrice <= tp;\n\n    // Update live data with trailing info\n    if (effectiveTrailing) {\n      const ld = this.liveData.get(bot.id);\n      if (ld) {\n        ld.trailingStop = sl;\n        ld.bestPrice = pos.bestPrice;\n        this.liveData.set(bot.id, ld);\n      }\n    }\n\n    if (hitSL || hitTP) {\n      const exitSide = pos.side === 'buy' ? 'sell' : 'buy';\n      const reason = hitSL ? (effectiveTrailing ? 'trailing_stop' : 'stop_loss') : 'take_profit';\n      const icon = hitSL ? (effectiveTrailing ? 'ðŸ“ TRAILING-STOP' : 'ðŸ›‘ STOP-LOSS') : 'ðŸŽ¯ TAKE-PROFIT';\n\n      this._log(bot.id, `${icon} a $${currentPrice.toFixed(2)}${effectiveTrailing ? ` (best: $${pos.bestPrice?.toFixed(2)})` : ''}`);\n      await this._closePosition(bot, pos, currentPrice, exitSide, reason);\n    }\n  }\n\n  // â”€â”€â”€ Polling fallback if WebSocket fails â”€â”€â”€\n  _startPollingFallback(bot, apiPair) {\n    const checkInterval = this._getCheckInterval(bot.timeframe);\n    this._log(bot.id, `â±ï¸ Polling cada ${checkInterval / 1000}s`);\n\n    const monitor = async () => {\n      if (!this.activeBots.get(bot.id)?.running) return;\n\n      try {\n        const candles = await marketData.getCandles(apiPair, bot.timeframe, 100);\n        this.candles.set(bot.id, candles);\n        const closes = candles.map(c => c.close);\n        const currentPrice = closes[closes.length - 1];\n\n        // Heartbeat\n        const pos = this.positions.get(bot.id);\n        if (pos) {\n          const pnl = pos.side === 'buy'\n            ? (currentPrice - pos.entryPrice) * pos.quantity\n            : (pos.entryPrice - currentPrice) * pos.quantity;\n          this._log(bot.id, `ðŸ’“ $${currentPrice.toFixed(2)} | ${pos.side.toUpperCase()} @ $${pos.entryPrice.toFixed(2)} | P&L: ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`);\n        } else {\n          this._log(bot.id, `ðŸ’“ $${currentPrice.toFixed(2)} â€” Esperando seÃ±al...`);\n        }\n\n        // Evaluate\n        const signal = this._evaluateStrategy(bot.strategy, candles, closes, bot.id);\n        if (signal) {\n          await this._handleSignal(bot, signal, currentPrice);\n        } else {\n          this._logIndicatorStatus(bot, closes);\n        }\n\n        // Check SL/TP\n        await this._checkStopLossTakeProfit(bot, currentPrice);\n      } catch (err) {\n        this._log(bot.id, `âŒ Error: ${err.message}`);\n      }\n    };\n\n    monitor();\n    const interval = setInterval(monitor, checkInterval);\n    this.streams.set(bot.id, { interval });\n  }\n\n  // â”€â”€â”€ Stop a bot â”€â”€â”€\n  stopBot(botId) {\n    const active = this.activeBots.get(botId);\n    if (active) {\n      active.running = false;\n      this.activeBots.delete(botId);\n    }\n\n    // Close WebSocket or clear polling interval\n    const stream = this.streams.get(botId);\n    if (stream) {\n      if (stream.ws) {\n        try { stream.ws.close(); } catch {}\n      }\n      if (stream.reconnectTimeout) clearTimeout(stream.reconnectTimeout);\n      if (stream.interval) clearInterval(stream.interval);\n      this.streams.delete(botId);\n    }\n\n    // Clear runtime data (keep logs for review)\n    this.positions.delete(botId);\n    this.candles.delete(botId);\n    this.lastHeartbeat.delete(botId);\n    this.callbacks.delete(botId);\n    this.liveData.delete(botId);\n  }\n\n  // â”€â”€â”€ Evaluate strategy rules â”€â”€â”€\n  _evaluateStrategy(strategy, candles, closes, botId) {\n    // Custom Kairos Script\n    if (strategy?.type === 'custom_script' && strategy?.code) {\n      const result = executeScript(strategy.code, candles);\n\n      // Surface script logs to the user\n      if (result.logs?.length > 0) {\n        result.logs.forEach(l => this._log(botId, `ðŸ“ ${l}`));\n      }\n\n      if (result.error) {\n        this._log(botId, `âŒ Script error: ${result.error}`);\n        return null;\n      }\n\n      // Store script config for SL/TP\n      if (result.config && botId) {\n        this._scriptConfigs = this._scriptConfigs || new Map();\n        this._scriptConfigs.set(botId, result.config);\n      }\n\n      if (result.signal) {\n        this._log(botId, `ðŸŽ¯ Script seÃ±al: ${result.signal.type.toUpperCase()}`);\n      }\n      return result.signal;\n    }\n\n    if (!strategy?.entry?.indicator) return null;\n\n    const len = closes.length;\n    if (len < 50) return null; // Need enough data for indicators\n    const indicator = strategy.entry.indicator;\n\n    switch (indicator) {\n      case 'ema_cross':\n      case 'ema_cross_rsi': {\n        const fast = strategy.entry.params?.fastEma || strategy.entry.params?.fast || 9;\n        const slow = strategy.entry.params?.slowEma || strategy.entry.params?.slow || 21;\n        const emaFast = calculateEMA(closes, fast);\n        const emaSlow = calculateEMA(closes, slow);\n        const cross = detectCrossover(emaFast, emaSlow, len - 1);\n\n        if (indicator === 'ema_cross_rsi') {\n          const rsiPeriod = strategy.entry.params?.rsiPeriod || 14;\n          const rsi = calculateRSI(closes, rsiPeriod);\n          const currentRSI = rsi[len - 1];\n          const oversold = strategy.entry.params?.rsiOversold || 35;\n          const overbought = strategy.exit?.params?.rsiOverbought || 65;\n\n          if (cross === 'bullish_cross' && currentRSI < oversold) return { type: 'buy' };\n          if (cross === 'bearish_cross' && currentRSI > overbought) return { type: 'sell' };\n          if (currentRSI > overbought) return { type: 'sell' };\n          if (currentRSI < oversold) return { type: 'buy' };\n        } else {\n          if (cross === 'bullish_cross') return { type: 'buy' };\n          if (cross === 'bearish_cross') return { type: 'sell' };\n        }\n        break;\n      }\n\n      case 'rsi': {\n        const period = strategy.entry.params?.period || 14;\n        const rsi = calculateRSI(closes, period);\n        const current = rsi[len - 1];\n        if (current < (strategy.entry.params?.oversold || 30)) return { type: 'buy' };\n        if (current > (strategy.entry.params?.overbought || 70)) return { type: 'sell' };\n        break;\n      }\n\n      case 'macd_cross': {\n        const { macd, signal } = calculateMACD(closes);\n        const cross = detectCrossover(macd, signal, len - 1);\n        if (cross === 'bullish_cross') return { type: 'buy' };\n        if (cross === 'bearish_cross') return { type: 'sell' };\n        break;\n      }\n\n      default:\n        return null;\n    }\n\n    return null;\n  }\n\n  // â”€â”€â”€ Auto-refresh bot balance from real broker after trade â”€â”€â”€\n  async _refreshBotBalance(bot) {\n    if (!bot.brokerId || !brokerService.connections.has(bot.brokerId)) return;\n    try {\n      const balances = await brokerService.getBalances(bot.brokerId);\n      // Find USDT, USD, USDC â€” whatever the stablecoin balance is\n      const stableNames = ['USDT', 'USD', 'USDC', 'BUSD', 'FDUSD'];\n      const stableBal = balances.find(b => stableNames.includes(b.asset?.toUpperCase()));\n      if (stableBal) {\n        const newBalance = parseFloat(stableBal.free || stableBal.total || 0);\n        if (newBalance > 0 && newBalance !== bot.balance) {\n          this._log(bot.id, `ðŸ’° Balance actualizado: $${bot.balance?.toFixed(2)} â†’ $${newBalance.toFixed(2)}`);\n          bot.balance = newBalance;\n          // Also update in store\n          try {\n            const { default: useStore } = await import('../store/useStore');\n            const store = useStore.getState();\n            const bots = store.bots || [];\n            const updated = bots.map(b => b.id === bot.id ? { ...b, balance: newBalance } : b);\n            useStore.setState({ bots: updated });\n          } catch {}\n        }\n      }\n    } catch (err) {\n      // Non-critical, just log\n      console.warn('[tradingEngine] Balance refresh failed:', err.message);\n    }\n  }\n\n  // â”€â”€â”€ Position sizing â”€â”€â”€\n  _calculatePositionSize(bot, price) {\n    const balance = bot.balance || 1000;\n    const riskPercent = parseFloat(bot.riskPercent || 2) / 100;\n    let usdAmount = balance * riskPercent;\n\n    // Enforce minimum order size ($1.10 for most exchanges)\n    const MIN_ORDER_USD = 1.10;\n    if (usdAmount < MIN_ORDER_USD) {\n      usdAmount = Math.min(MIN_ORDER_USD, balance * 0.95);\n      this._log(bot.id, `âš ï¸ Monto calculado muy bajo ($${(balance * riskPercent).toFixed(2)}), ajustado a $${usdAmount.toFixed(2)}`);\n    }\n\n    // Cap at 95% of balance (leave room for fees)\n    if (usdAmount > balance * 0.95) {\n      usdAmount = balance * 0.95;\n    }\n\n    // Log position size for transparency\n    this._log(bot.id, `ðŸ’° TamaÃ±o orden: $${usdAmount.toFixed(2)} USD (${riskPercent * 100}% de $${balance})`);\n\n    const amount = usdAmount / price;\n    return Math.round(amount * 1e8) / 1e8;\n  }\n\n  // â”€â”€â”€ Get check interval (polling fallback) â”€â”€â”€\n  _getCheckInterval(timeframe) {\n    const intervals = {\n      '1m': 15000,\n      '5m': 30000,\n      '15m': 60000,\n      '1h': 60000,\n      '4h': 120000,\n      '1d': 300000,\n    };\n    return intervals[timeframe] || 60000;\n  }\n\n  // â”€â”€â”€ Get active bots count â”€â”€â”€\n  getActiveBotCount() {\n    return this.activeBots.size;\n  }\n}\n\nexport const tradingEngine = new TradingEngine();\nexport default tradingEngine;\n"],"file":"assets/tradingEngine-BgafOV-j.js"}