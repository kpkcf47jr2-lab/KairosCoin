const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DW-pNAtM.js","assets/ui-CUucduZ3.js","assets/vendor-B3xyLMQT.js","assets/index-DmOKH9R0.css"])))=>i.map(i=>d[i]);
import{_ as I,b as C,f as q,e as L}from"./index-DW-pNAtM.js";import{c as T,d as E,e as R,g as U}from"./indicators-DJQYQkcq.js";import{m as M}from"./marketData-K1zKCjjj.js";import{b as k}from"./broker-c0z0ZlB1.js";import{e as N}from"./kairosScript-DOo_Z8wV.js";const O=["wss://stream.binance.us:9443/ws","wss://stream.binance.com:9443/ws"];class V{constructor(){this.activeBots=new Map,this.streams=new Map,this.positions=new Map,this.candles=new Map,this.lastHeartbeat=new Map,this.logs=new Map,this.callbacks=new Map,this.liveData=new Map}_log(e,i){var n,s,r;const t=this.logs.get(e)||[],a=this.activeBots.get(e);t.push({message:i,time:Date.now(),botName:((n=a==null?void 0:a.bot)==null?void 0:n.name)||"Bot"}),t.length>150&&t.splice(0,50),this.logs.set(e,t);try{(r=(s=this.callbacks.get(e))==null?void 0:s.onLog)==null||r.call(s,i)}catch{}}_onTrade(e,i){var t,a;try{(a=(t=this.callbacks.get(e))==null?void 0:t.onTrade)==null||a.call(t,i)}catch{}}async _syncPositionToStore(e,i,t,a,n){try{const s=(await I(async()=>{const{default:p}=await import("./index-DW-pNAtM.js").then(o=>o.b6);return{default:p}},__vite__mapDeps([0,1,2,3]))).default,r=s.getState();r.positions.filter(p=>p.botId===e.id).forEach(p=>r.closePosition(p.id)),s.getState().addPosition({pair:e.pair,side:t,quantity:a,entryPrice:i,currentPrice:i,stopLoss:n.stopLoss?parseFloat(n.stopLoss.toFixed(2)):null,takeProfit:n.takeProfit?parseFloat(n.takeProfit.toFixed(2)):null,botId:e.id,botName:e.name,time:Date.now()})}catch{}}async _removePositionFromStore(e){try{const t=(await I(async()=>{const{default:n}=await import("./index-DW-pNAtM.js").then(s=>s.b6);return{default:n}},__vite__mapDeps([0,1,2,3]))).default.getState();t.positions.filter(n=>n.botId===e).forEach(n=>t.closePosition(n.id))}catch{}}setCallbacks(e,i,t){this.callbacks.set(e,{onTrade:i,onLog:t})}getLogs(e){return this.logs.get(e)||[]}getAllLogs(){const e=[];for(const[i,t]of this.logs)e.push(...t.map(a=>({...a,botId:i})));return e.sort((i,t)=>i.time-t.time).slice(-100)}async _ensureBrokerConnected(e){if(!e.brokerId)return!1;if(k.connections.has(e.brokerId))return!0;try{const t=(await I(async()=>{const{default:a}=await import("./index-DW-pNAtM.js").then(n=>n.b6);return{default:a}},__vite__mapDeps([0,1,2,3]))).default.getState().brokers.find(a=>a.id===e.brokerId);if(t&&t.connected)return await k.connect(t),!0}catch(i){console.warn("Auto-reconnect failed:",i.message)}return!1}async startBot(e,i,t){var o;if(this.activeBots.has(e.id))return;this.callbacks.set(e.id,{onTrade:i,onLog:t}),this.activeBots.set(e.id,{bot:e,running:!0}),this._log(e.id,`ü§ñ Bot "${e.name}" iniciado en ${e.pair}`);const a=await this._ensureBrokerConnected(e);e.brokerId?this._log(e.id,a?"üîó Broker conectado ‚Äî modo REAL activado":"‚ö†Ô∏è Broker no disponible ‚Äî modo DEMO"):this._log(e.id,"üìã Modo DEMO ‚Äî Conecta un broker para operar en real");const n=C(e.pair);let s;try{s=await M.getCandles(n,e.timeframe,100),this.candles.set(e.id,s);const l=(o=s[s.length-1])==null?void 0:o.close;this._log(e.id,`üìä ${s.length} velas cargadas | Precio: $${l==null?void 0:l.toFixed(2)} | TF: ${e.timeframe}`)}catch(l){this._log(e.id,`‚ùå Error cargando datos: ${l.message}`),this._log(e.id,"‚è±Ô∏è Cambiando a modo polling..."),this._startPollingFallback(e,n);return}const r=s.map(l=>l.close),_=r[r.length-1],p=this._evaluateStrategy(e.strategy,s,r,e.id);p?(this._log(e.id,`üìä Se√±al inicial: ${p.type.toUpperCase()} a $${_.toFixed(2)}`),await this._handleSignal(e,p,_)):this._logIndicatorStatus(e,r),this._connectBotStream(e,n)}_logIndicatorStatus(e,i){var n,s,r,_,p,o,l,d,u,f,F,$,S,v,w,m,P,g;const t=i.length,a=(s=(n=e.strategy)==null?void 0:n.entry)==null?void 0:s.indicator;try{if(a==="ema_cross"||a==="ema_cross_rsi"){const h=((r=e.strategy.entry.params)==null?void 0:r.fastEma)||((_=e.strategy.entry.params)==null?void 0:_.fast)||20,c=((p=e.strategy.entry.params)==null?void 0:p.slowEma)||((o=e.strategy.entry.params)==null?void 0:o.slow)||50,y=T(i,h),x=T(i,c),B=((y[t-1]-x[t-1])/x[t-1]*100).toFixed(3);let D=`üìà EMA${h}: $${(l=y[t-1])==null?void 0:l.toFixed(2)} | EMA${c}: $${(d=x[t-1])==null?void 0:d.toFixed(2)} | Diff: ${B}%`;if(a==="ema_cross_rsi"){const A=E(i,((u=e.strategy.entry.params)==null?void 0:u.rsiPeriod)||14);D+=` | RSI: ${(f=A[t-1])==null?void 0:f.toFixed(1)}`}this._log(e.id,`${D} ‚Äî Sin se√±al, monitoreando...`)}else if(a==="rsi"){const h=E(i,((F=e.strategy.entry.params)==null?void 0:F.period)||14);this._log(e.id,`üìà RSI: ${($=h[t-1])==null?void 0:$.toFixed(1)} ‚Äî Sin se√±al, monitoreando...`)}else if(a==="macd_cross"){const{macd:h,signal:c}=R(i);this._log(e.id,`üìà MACD: ${(S=h[t-1])==null?void 0:S.toFixed(2)} | Signal: ${(v=c[t-1])==null?void 0:v.toFixed(2)} ‚Äî Sin se√±al, monitoreando...`)}else if(((w=e.strategy)==null?void 0:w.type)==="custom_script"){const h=T(i,9),c=T(i,21),y=E(i,14),x=i[t-1],B=((h[t-1]-c[t-1])/c[t-1]*100).toFixed(3);this._log(e.id,`üìà $${x==null?void 0:x.toFixed(2)} | EMA9: $${(m=h[t-1])==null?void 0:m.toFixed(2)} | EMA21: $${(P=c[t-1])==null?void 0:P.toFixed(2)} (${B}%) | RSI: ${(g=y[t-1])==null?void 0:g.toFixed(1)} ‚Äî Sin se√±al`)}else this._log(e.id,"üëÄ Sin se√±al ‚Äî Monitoreando en tiempo real...")}catch{this._log(e.id,"üëÄ Sin se√±al ‚Äî Monitoreando en tiempo real...")}}_connectBotStream(e,i,t=0){var o;if(!((o=this.activeBots.get(e.id))!=null&&o.running))return;const a=i.toLowerCase(),n=e.timeframe||"1m",s=M._wsBase||O[0],r=`${s}/${a}@ticker/${a}@kline_${n}`;this._log(e.id,`üîå Conectando stream: ${i} @ ${n}${t>0?` (intento ${t+1})`:""}...`);let _;try{_=new WebSocket(r)}catch(l){this._log(e.id,`‚ùå Error WebSocket: ${l.message} ‚Äî Cambiando a polling`),this._startPollingFallback(e,i);return}let p=null;_.onopen=()=>{this._log(e.id,"‚ö° Stream EN VIVO conectado ‚Äî Datos instant√°neos activos"),t=0},_.onmessage=l=>{var d;if((d=this.activeBots.get(e.id))!=null&&d.running)try{const u=JSON.parse(l.data);if(u.e==="24hrTicker"){const f=parseFloat(u.c);this._handleTick(e,f)}if(u.e==="kline"){const f=u.k,F={time:Math.floor(f.t/1e3),open:parseFloat(f.o),high:parseFloat(f.h),low:parseFloat(f.l),close:parseFloat(f.c),volume:parseFloat(f.v)};f.x&&this._handleCandleClose(e,F)}}catch(u){console.error(`[Bot ${e.id}] WS parse:`,u)}},_.onerror=l=>{if(console.error(`[Bot ${e.id}] WS error`,l),t===0){const d=s===O[0]?O[1]:O[0];M._wsBase=d,this._log(e.id,"üîÑ Probando endpoint alternativo...");try{_.close()}catch{}this._connectBotStream(e,i,1);return}},_.onclose=()=>{var l;if((l=this.activeBots.get(e.id))!=null&&l.running)if(t<5){const d=Math.min(2e3*(t+1),1e4);this._log(e.id,`üîÑ Reconectando en ${d/1e3}s...`),p=setTimeout(()=>{this._connectBotStream(e,i,t+1)},d)}else this._log(e.id,"‚ö†Ô∏è WebSocket no disponible ‚Äî Modo polling activado"),this._startPollingFallback(e,i)},this.streams.set(e.id,{ws:_,reconnectTimeout:p})}getLiveData(e){return this.liveData.get(e)||null}_handleTick(e,i){const t=this.positions.get(e.id);if(t){const s=t.side==="buy"?(i-t.entryPrice)*t.quantity:(t.entryPrice-i)*t.quantity,r=t.side==="buy"?(i-t.entryPrice)/t.entryPrice*100:(t.entryPrice-i)/t.entryPrice*100;this.liveData.set(e.id,{price:i,unrealizedPnl:s,pnlPercent:r,position:{side:t.side,entryPrice:t.entryPrice,quantity:t.quantity},time:Date.now()})}else this.liveData.set(e.id,{price:i,unrealizedPnl:0,pnlPercent:0,position:null,time:Date.now()});const a=Date.now(),n=this.lastHeartbeat.get(e.id)||0;if(a-n>1e4)if(this.lastHeartbeat.set(e.id,a),t){const s=t.side==="buy"?(i-t.entryPrice)*t.quantity:(t.entryPrice-i)*t.quantity;this._log(e.id,`üíì $${i.toFixed(2)} | ${t.side.toUpperCase()} @ $${t.entryPrice.toFixed(2)} | P&L: ${s>=0?"+":""}$${s.toFixed(2)}`)}else this._log(e.id,`üíì $${i.toFixed(2)} ‚Äî Esperando se√±al...`);this._checkStopLossTakeProfit(e,i)}async _handleCandleClose(e,i){const t=this.candles.get(e.id)||[];t.length>0&&t[t.length-1].time===i.time?t[t.length-1]=i:(t.push(i),t.length>200&&t.shift()),this.candles.set(e.id,t);const a=t.map(r=>r.close),n=i.close;this._log(e.id,`üïØÔ∏è Vela cerrada: O:${i.open.toFixed(2)} H:${i.high.toFixed(2)} L:${i.low.toFixed(2)} C:${i.close.toFixed(2)}`);const s=this._evaluateStrategy(e.strategy,t,a,e.id);s?await this._handleSignal(e,s,n):this._logIndicatorStatus(e,a)}async _handleSignal(e,i,t){const a=this.positions.get(e.id);a&&a.side!==i.type&&await this._closePosition(e,a,t,i.type),this.positions.has(e.id)||await this._openPosition(e,i,t)}async _closePosition(e,i,t,a,n){const s=i.entryPrice,r=i.quantity,_=i.side==="buy"?(t-s)*r:(s-t)*r,p=q.applyVolumeFee(t,r),o=_-p;this._log(e.id,`üìä Cerrando: ${i.side.toUpperCase()} ‚Üí ${a.toUpperCase()} | $${s.toFixed(2)} ‚Üí $${t.toFixed(2)} | P&L: ${o>=0?"+":""}$${o.toFixed(2)}`);const l={symbol:C(e.pair),side:a,type:"market",quantity:r,price:t};if(i.leveraged&&i.positionId&&e.brokerId&&k.connections.has(e.brokerId)){try{const d=e.leverage||i.leverage||1;this._log(e.id,`üîÑ Cerrando posici√≥n APALANCADA ${d}x en Kairos Perps...`);const u=await k.closeLeveragedPosition(e.brokerId,{positionId:i.positionId,symbol:C(e.pair),side:i.side,price:t,leverage:d}),f=u.profit||o;this._log(e.id,`‚úÖ Posici√≥n ${d}x cerrada: P&L ${f>=0?"+":""}$${f.toFixed(4)} [${u.status}]`),this._onTrade(e.id,{...l,...u,profit:f,real:!0,confirmed:!0,action:"close",reason:n,leveraged:!0,leverage:d}),L.notifyTradeClose(e.name,i.side,e.pair,s,t,f,n),this._refreshBotBalance(e)}catch(d){this._log(e.id,`‚ùå Error cerrando posici√≥n apalancada: ${d.message}`),this._onTrade(e.id,{...l,profit:o,status:"error",error:d.message,action:"close",leveraged:!0})}this.positions.delete(e.id),this._removePositionFromStore(e.id);return}if(e.brokerId&&k.connections.has(e.brokerId))try{this._log(e.id,"üîÑ Cerrando posici√≥n REAL en broker...");const d=await k.placeOrder(e.brokerId,l),u=d.confirmed!==!1,f=d.filledPrice&&d.filledPrice>0?d.filledPrice:t,$=(i.side==="buy"?(f-s)*r:(s-f)*r)-p,S=u?"‚úÖ":"‚ö†Ô∏è";this._log(e.id,`${S} Cerrada: P&L ${$>=0?"+":""}$${$.toFixed(4)} [${d.status}] ID:${d.id||"N/A"}`),this._onTrade(e.id,{...l,...d,profit:$,real:!0,confirmed:u,action:"close",reason:n}),L.notifyTradeClose(e.name,i.side,e.pair,s,f,$,n),this._refreshBotBalance(e)}catch(d){this._log(e.id,`‚ùå Error cerrando: ${d.message}`),this._onTrade(e.id,{...l,profit:o,status:"error",error:d.message,action:"close"})}else this._log(e.id,`üìù [DEMO] Cerrada: P&L ${o>=0?"+":""}$${o.toFixed(2)}`),this._onTrade(e.id,{...l,profit:o,status:"filled",simulated:!0,action:"close",reason:n});this.positions.delete(e.id),this._removePositionFromStore(e.id)}async _openPosition(e,i,t){var l,d,u,f,F,$,S,v,w,m,P,g;const a=((l=this._lastOrderFail)==null?void 0:l.get(e.id))||0,n=(d=this._lastFailPermanent)!=null&&d.get(e.id)?6e4:5e3;if(Date.now()-a<n)return;this._log(e.id,`üìä Se√±al: ${i.type.toUpperCase()} a $${t.toFixed(2)}`);const s=this._calculatePositionSize(e,t);if(s*t<.5){this._log(e.id,"‚ö†Ô∏è Balance insuficiente para operar (m√≠nimo ~$1). Necesitas al menos $1.10 de saldo."),this._lastOrderFail=this._lastOrderFail||new Map,this._lastFailPermanent=this._lastFailPermanent||new Map,this._lastOrderFail.set(e.id,Date.now()),this._lastFailPermanent.set(e.id,!0);return}const r=(u=this._scriptConfigs)==null?void 0:u.get(e.id),_=parseFloat((r==null?void 0:r.stopLoss)||((f=e.strategy)==null?void 0:f.stopLoss)||2)/100,p=parseFloat((r==null?void 0:r.takeProfit)||((F=e.strategy)==null?void 0:F.takeProfit)||4)/100,o={symbol:C(e.pair),side:i.type,type:"market",quantity:s,price:t,stopLoss:i.type==="buy"?t*(1-_):t*(1+_),takeProfit:i.type==="buy"?t*(1+p):t*(1-p)};if(e.brokerId&&k.connections.has(e.brokerId)){if(e.executionMode==="leveraged"&&(e.leverage||1)>1)try{const h=e.leverage||3;this._log(e.id,`üîÑ Abriendo posici√≥n APALANCADA ${h}x en Kairos Perps...`);const c=await k.placeLeveragedOrder(e.brokerId,{...o,leverage:h,execRoute:"dex"}),y=c.filledPrice||t;this._log(e.id,`‚úÖ APALANCADO: ${i.type.toUpperCase()} ${h}x | Colateral: $${($=c.quantity)==null?void 0:$.toFixed(2)} | Posici√≥n: $${(S=c.filledQty)==null?void 0:S.toFixed(2)} @ $${y.toFixed(2)}`),c.liquidationPrice&&this._log(e.id,`‚ö†Ô∏è Precio de liquidaci√≥n: $${c.liquidationPrice}`),(v=this._lastOrderFail)==null||v.delete(e.id),(w=this._lastFailPermanent)==null||w.delete(e.id),this.positions.set(e.id,{side:i.type,entryPrice:y,quantity:c.filledQty||s,entryTime:Date.now(),orderId:c.id,leveraged:!0,leverage:h,positionId:c.positionId,liquidationPrice:c.liquidationPrice,collateral:c.quantity}),this._syncPositionToStore(e,y,i.type,c.filledQty||s,o),this._onTrade(e.id,{...o,...c,real:!0,action:"open",leveraged:!0,leverage:h}),L.notifyTradeOpen(e.name,i.type,e.pair,y,c.filledQty||s,`Kairos Perps ${h}x`),this._refreshBotBalance(e);return}catch(h){this._log(e.id,`‚ùå Error orden apalancada: ${h.message}`),this._lastOrderFail=this._lastOrderFail||new Map,this._lastOrderFail.set(e.id,Date.now());const c=h.message.toLowerCase(),y=c.includes("insufficient")||c.includes("collateral")||c.includes("balance")||c.includes("minimum");this._lastFailPermanent=this._lastFailPermanent||new Map,this._lastFailPermanent.set(e.id,y);return}try{this._log(e.id,"üîÑ Ejecutando orden REAL en broker...");const h=await k.placeOrder(e.brokerId,o),c=h.filledPrice||t,y=h.confirmed!==!1,x=y?"‚úÖ":"‚ö†Ô∏è";q.applyVolumeFee(c,h.filledQty||s),this._log(e.id,`${x} REAL: ${(m=h.side)==null?void 0:m.toUpperCase()} ${h.filledQty||s} @ $${c.toFixed(2)} [${h.status}] ID:${h.id||"N/A"}`),y||this._log(e.id,"‚ö†Ô∏è Orden no confirmada por el broker ‚Äî el fill real puede diferir"),(P=this._lastOrderFail)==null||P.delete(e.id),(g=this._lastFailPermanent)==null||g.delete(e.id),this.positions.set(e.id,{side:i.type,entryPrice:c,quantity:h.filledQty||s,entryTime:Date.now(),orderId:h.id}),this._syncPositionToStore(e,c,i.type,h.filledQty||s,o),this._onTrade(e.id,{...o,...h,real:!0,action:"open"}),L.notifyTradeOpen(e.name,i.type,e.pair,c,h.filledQty||s,e.brokerName||e.brokerId),this._refreshBotBalance(e)}catch(h){this._log(e.id,`‚ùå Error orden: ${h.message}`),this._lastOrderFail=this._lastOrderFail||new Map,this._lastOrderFail.set(e.id,Date.now()),this._lastFailPermanent=this._lastFailPermanent||new Map;const c=h.message.toLowerCase(),y=c.includes("insufficient")||c.includes("size")||c.includes("balance")||c.includes("too small")||c.includes("minimum");this._lastFailPermanent.set(e.id,y)}}else q.applyVolumeFee(t,s),this._log(e.id,`üìù [DEMO] ${i.type.toUpperCase()} ${s} @ $${t.toFixed(2)}`),this.positions.set(e.id,{side:i.type,entryPrice:t,quantity:s,entryTime:Date.now(),simulated:!0}),this._syncPositionToStore(e,t,i.type,s,o),this._onTrade(e.id,{...o,status:"filled",simulated:!0,action:"open"})}async _checkStopLossTakeProfit(e,i){var F,$,S,v,w,m,P;const t=this.positions.get(e.id);if(!t)return;const a=(F=this._scriptConfigs)==null?void 0:F.get(e.id),n=parseFloat((a==null?void 0:a.stopLoss)||(($=e.strategy)==null?void 0:$.stopLoss)||2)/100,s=parseFloat((a==null?void 0:a.takeProfit)||((S=e.strategy)==null?void 0:S.takeProfit)||4)/100,r=e.trailingStop||((v=e.strategy)==null?void 0:v.trailingStop)||(a==null?void 0:a.trailingStop),_=parseFloat(e.trailingStopPct||((w=e.strategy)==null?void 0:w.trailingStopPct)||(a==null?void 0:a.trailingStopPct)||n*100)/100,p=parseFloat(e.trailingActivation||((m=e.strategy)==null?void 0:m.trailingActivation)||(a==null?void 0:a.trailingActivation)||.5)/100;let o,l=!1;r?(t.bestPrice||(t.bestPrice=t.entryPrice),t.side==="buy"?(t.bestPrice=Math.max(t.bestPrice,i),(i-t.entryPrice)/t.entryPrice>=p?(o=t.bestPrice*(1-_),l=!0):o=t.entryPrice*(1-n)):(t.bestPrice=Math.min(t.bestPrice,i),(t.entryPrice-i)/t.entryPrice>=p?(o=t.bestPrice*(1+_),l=!0):o=t.entryPrice*(1+n)),this.positions.set(e.id,t)):o=t.side==="buy"?t.entryPrice*(1-n):t.entryPrice*(1+n);const d=t.side==="buy"?t.entryPrice*(1+s):t.entryPrice*(1-s),u=t.side==="buy"?i<=o:i>=o,f=t.side==="buy"?i>=d:i<=d;if(l){const g=this.liveData.get(e.id);g&&(g.trailingStop=o,g.bestPrice=t.bestPrice,this.liveData.set(e.id,g))}if(u||f){const g=t.side==="buy"?"sell":"buy",h=u?l?"trailing_stop":"stop_loss":"take_profit",c=u?l?"üìê TRAILING-STOP":"üõë STOP-LOSS":"üéØ TAKE-PROFIT";this._log(e.id,`${c} a $${i.toFixed(2)}${l?` (best: $${(P=t.bestPrice)==null?void 0:P.toFixed(2)})`:""}`),await this._closePosition(e,t,i,g,h)}}_startPollingFallback(e,i){const t=this._getCheckInterval(e.timeframe);this._log(e.id,`‚è±Ô∏è Polling cada ${t/1e3}s`);const a=async()=>{var s;if((s=this.activeBots.get(e.id))!=null&&s.running)try{const r=await M.getCandles(i,e.timeframe,100);this.candles.set(e.id,r);const _=r.map(d=>d.close),p=_[_.length-1],o=this.positions.get(e.id);if(o){const d=o.side==="buy"?(p-o.entryPrice)*o.quantity:(o.entryPrice-p)*o.quantity;this._log(e.id,`üíì $${p.toFixed(2)} | ${o.side.toUpperCase()} @ $${o.entryPrice.toFixed(2)} | P&L: ${d>=0?"+":""}$${d.toFixed(2)}`)}else this._log(e.id,`üíì $${p.toFixed(2)} ‚Äî Esperando se√±al...`);const l=this._evaluateStrategy(e.strategy,r,_,e.id);l?await this._handleSignal(e,l,p):this._logIndicatorStatus(e,_),await this._checkStopLossTakeProfit(e,p)}catch(r){this._log(e.id,`‚ùå Error: ${r.message}`)}};a();const n=setInterval(a,t);this.streams.set(e.id,{interval:n})}stopBot(e){const i=this.activeBots.get(e);i&&(i.running=!1,this.activeBots.delete(e));const t=this.streams.get(e);if(t){if(t.ws)try{t.ws.close()}catch{}t.reconnectTimeout&&clearTimeout(t.reconnectTimeout),t.interval&&clearInterval(t.interval),this.streams.delete(e)}this.positions.delete(e),this.candles.delete(e),this.lastHeartbeat.delete(e),this.callbacks.delete(e),this.liveData.delete(e)}_evaluateStrategy(e,i,t,a){var r,_,p,o,l,d,u,f,F,$,S,v,w;if((e==null?void 0:e.type)==="custom_script"&&(e!=null&&e.code)){const m=N(e.code,i);return((r=m.logs)==null?void 0:r.length)>0&&m.logs.forEach(P=>this._log(a,`üìù ${P}`)),m.error?(this._log(a,`‚ùå Script error: ${m.error}`),null):(m.config&&a&&(this._scriptConfigs=this._scriptConfigs||new Map,this._scriptConfigs.set(a,m.config)),m.signal&&this._log(a,`üéØ Script se√±al: ${m.signal.type.toUpperCase()}`),m.signal)}if(!((_=e==null?void 0:e.entry)!=null&&_.indicator))return null;const n=t.length;if(n<50)return null;const s=e.entry.indicator;switch(s){case"ema_cross":case"ema_cross_rsi":{const m=((p=e.entry.params)==null?void 0:p.fastEma)||((o=e.entry.params)==null?void 0:o.fast)||9,P=((l=e.entry.params)==null?void 0:l.slowEma)||((d=e.entry.params)==null?void 0:d.slow)||21,g=T(t,m),h=T(t,P),c=U(g,h,n-1);if(s==="ema_cross_rsi"){const y=((u=e.entry.params)==null?void 0:u.rsiPeriod)||14,B=E(t,y)[n-1],D=((f=e.entry.params)==null?void 0:f.rsiOversold)||35,A=(($=(F=e.exit)==null?void 0:F.params)==null?void 0:$.rsiOverbought)||65;if(c==="bullish_cross"&&B<D)return{type:"buy"};if(c==="bearish_cross"&&B>A)return{type:"sell"};if(B>A)return{type:"sell"};if(B<D)return{type:"buy"}}else{if(c==="bullish_cross")return{type:"buy"};if(c==="bearish_cross")return{type:"sell"}}break}case"rsi":{const m=((S=e.entry.params)==null?void 0:S.period)||14,g=E(t,m)[n-1];if(g<(((v=e.entry.params)==null?void 0:v.oversold)||30))return{type:"buy"};if(g>(((w=e.entry.params)==null?void 0:w.overbought)||70))return{type:"sell"};break}case"macd_cross":{const{macd:m,signal:P}=R(t),g=U(m,P,n-1);if(g==="bullish_cross")return{type:"buy"};if(g==="bearish_cross")return{type:"sell"};break}default:return null}return null}async _refreshBotBalance(e){var i;if(!(!e.brokerId||!k.connections.has(e.brokerId)))try{const t=await k.getBalances(e.brokerId),a=["USDT","USD","USDC","BUSD","FDUSD"],n=t.find(s=>{var r;return a.includes((r=s.asset)==null?void 0:r.toUpperCase())});if(n){const s=parseFloat(n.free||n.total||0);if(s>0&&s!==e.balance){this._log(e.id,`üí∞ Balance actualizado: $${(i=e.balance)==null?void 0:i.toFixed(2)} ‚Üí $${s.toFixed(2)}`),e.balance=s;try{const{default:r}=await I(async()=>{const{default:l}=await import("./index-DW-pNAtM.js").then(d=>d.b6);return{default:l}},__vite__mapDeps([0,1,2,3])),o=(r.getState().bots||[]).map(l=>l.id===e.id?{...l,balance:s}:l);r.setState({bots:o})}catch{}}}}catch(t){console.warn("[tradingEngine] Balance refresh failed:",t.message)}}_calculatePositionSize(e,i){const t=e.balance||1e3,a=parseFloat(e.riskPercent||2)/100;let n=t*a;const s=1.1;n<s&&(n=Math.min(s,t*.95),this._log(e.id,`‚ö†Ô∏è Monto calculado muy bajo ($${(t*a).toFixed(2)}), ajustado a $${n.toFixed(2)}`)),n>t*.95&&(n=t*.95),this._log(e.id,`üí∞ Tama√±o orden: $${n.toFixed(2)} USD (${a*100}% de $${t})`);const r=n/i;return Math.round(r*1e8)/1e8}_getCheckInterval(e){return{"1m":15e3,"5m":3e4,"15m":6e4,"1h":6e4,"4h":12e4,"1d":3e5}[e]||6e4}getActiveBotCount(){return this.activeBots.size}}const G=new V;export{G as t};
//# sourceMappingURL=tradingEngine-Bbc5KPIQ.js.map
