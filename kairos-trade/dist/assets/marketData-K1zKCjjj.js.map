{"version":3,"file":"marketData-K1zKCjjj.js","sources":["../../src/services/marketData.js"],"sourcesContent":["// Kairos Trade — Market Data Service (WebSocket + REST)\n// Cascade: Binance.US → Binance.com → CoinGecko (ultimate fallback)\n// Auto-detects geo-restrictions and switches provider seamlessly\n\nconst API_ENDPOINTS = [\n  'https://api.binance.us/api/v3',\n  'https://api.binance.com/api/v3',\n];\n\nconst WS_ENDPOINTS = [\n  'wss://stream.binance.us:9443/ws',\n  'wss://stream.binance.com:9443/ws',\n];\n\nconst COINGECKO_API = 'https://api.coingecko.com/api/v3';\n\n// ─── Binance symbol → CoinGecko ID mapping ───\nconst SYMBOL_TO_GECKO = {\n  BTC: 'bitcoin', ETH: 'ethereum', BNB: 'binancecoin', SOL: 'solana',\n  XRP: 'ripple', ADA: 'cardano', DOGE: 'dogecoin', DOT: 'polkadot',\n  AVAX: 'avalanche-2', MATIC: 'matic-network', LINK: 'chainlink',\n  UNI: 'uniswap', SHIB: 'shiba-inu', LTC: 'litecoin', ATOM: 'cosmos',\n  ARB: 'arbitrum', OP: 'optimism', APT: 'aptos', SUI: 'sui',\n  NEAR: 'near', FIL: 'filecoin', ICP: 'internet-computer', TRX: 'tron',\n  PEPE: 'pepe', WIF: 'dogwifcoin', RENDER: 'render-token', FET: 'fetch-ai',\n  INJ: 'injective-protocol', TIA: 'celestia', SEI: 'sei-network',\n  BONK: 'bonk', JUP: 'jupiter-exchange-solana', AAVE: 'aave',\n  MKR: 'maker', CRV: 'curve-dao-token', LDO: 'lido-dao', SAND: 'the-sandbox',\n  MANA: 'decentraland', AXS: 'axie-infinity', GALA: 'gala', ENS: 'ethereum-name-service',\n  FTM: 'fantom', ALGO: 'algorand', HBAR: 'hedera-hashgraph', VET: 'vechain',\n  EGLD: 'elrond-erd-2', EOS: 'eos', XLM: 'stellar', XMR: 'monero',\n  BCH: 'bitcoin-cash', ETC: 'ethereum-classic', RUNE: 'thorchain',\n};\n\n// Extract base asset from Binance pair (BTCUSDT → BTC)\nfunction parseBase(symbol) {\n  const quotes = ['USDT', 'BUSD', 'USDC', 'USD', 'BTC', 'ETH', 'BNB'];\n  for (const q of quotes) {\n    if (symbol.endsWith(q) && symbol.length > q.length) {\n      return symbol.slice(0, -q.length);\n    }\n  }\n  return symbol;\n}\n\nfunction getGeckoId(symbol) {\n  const base = parseBase(symbol);\n  return SYMBOL_TO_GECKO[base] || base.toLowerCase();\n}\n\nclass MarketDataService {\n  constructor() {\n    this.ws = null;\n    this.subscribers = new Map();\n    this.reconnectAttempts = 0;\n    this.maxReconnect = 5;\n    this.candleCache = new Map();\n    this._apiBase = null;       // resolved Binance endpoint\n    this._wsBase = null;\n    this._useCoinGecko = false; // true when Binance completely unavailable\n    this._geckoRateLimit = 0;   // timestamp of last CG call (free tier = 10-30/min)\n  }\n\n  // ─── Auto-detect working API endpoint ───\n  async _getAPI() {\n    if (this._useCoinGecko) return 'coingecko';\n    if (this._apiBase) return this._apiBase;\n\n    for (const base of API_ENDPOINTS) {\n      try {\n        const ctrl = new AbortController();\n        const timer = setTimeout(() => ctrl.abort(), 5000);\n        const res = await fetch(`${base}/ping`, { signal: ctrl.signal });\n        clearTimeout(timer);\n        if (res.ok) {\n          this._apiBase = base;\n          this._wsBase = base.includes('binance.us') ? WS_ENDPOINTS[0] : WS_ENDPOINTS[1];\n          return base;\n        }\n      } catch { /* try next */ }\n    }\n\n    // Both Binance endpoints failed → switch to CoinGecko\n    try {\n      const ctrl = new AbortController();\n      const timer = setTimeout(() => ctrl.abort(), 5000);\n      const res = await fetch(`${COINGECKO_API}/ping`, { signal: ctrl.signal });\n      clearTimeout(timer);\n      if (res.ok) {\n        this._useCoinGecko = true;\n        console.log('Kairos MarketData: using CoinGecko fallback');\n        return 'coingecko';\n      }\n    } catch { /* all failed */ }\n\n    // Last resort default\n    this._apiBase = API_ENDPOINTS[0];\n    this._wsBase = WS_ENDPOINTS[0];\n    return this._apiBase;\n  }\n\n  // ─── CoinGecko rate-limited fetch ───\n  async _geckoFetch(path) {\n    const now = Date.now();\n    const wait = Math.max(0, this._geckoRateLimit + 2200 - now); // ~27 req/min\n    if (wait > 0) await new Promise(r => setTimeout(r, wait));\n    this._geckoRateLimit = Date.now();\n\n    const ctrl = new AbortController();\n    const timer = setTimeout(() => ctrl.abort(), 10000);\n    const res = await fetch(`${COINGECKO_API}${path}`, { signal: ctrl.signal });\n    clearTimeout(timer);\n    if (!res.ok) throw new Error(`CoinGecko HTTP ${res.status}`);\n    return res.json();\n  }\n\n  // ─── WebSocket for real-time prices ───\n  connectStream(symbol, callbacks = {}) {\n    const pair = symbol.toLowerCase();\n\n    // Start with auto-detected endpoint, fallback to US\n    const wsBase = this._wsBase || WS_ENDPOINTS[0];\n    const url = `${wsBase}/${pair}@ticker/${pair}@kline_1m`;\n\n    if (this.ws) this.ws.close();\n\n    this.ws = new WebSocket(url);\n\n    this.ws.onopen = () => {\n      this.reconnectAttempts = 0;\n      callbacks.onConnect?.();\n    };\n\n    this.ws.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        if (data.e === '24hrTicker') {\n          callbacks.onTicker?.({\n            symbol: data.s,\n            price: parseFloat(data.c),\n            change: parseFloat(data.p),\n            changePercent: parseFloat(data.P),\n            high: parseFloat(data.h),\n            low: parseFloat(data.l),\n            volume: parseFloat(data.v),\n            quoteVolume: parseFloat(data.q),\n          });\n        }\n        if (data.e === 'kline') {\n          const k = data.k;\n          callbacks.onCandle?.({\n            time: Math.floor(k.t / 1000),\n            open: parseFloat(k.o),\n            high: parseFloat(k.h),\n            low: parseFloat(k.l),\n            close: parseFloat(k.c),\n            volume: parseFloat(k.v),\n            closed: k.x,\n          });\n        }\n      } catch (e) {\n        console.error('WS parse error:', e);\n      }\n    };\n\n    this.ws.onerror = (err) => {\n      console.error('WS error:', err);\n      // Try alternate WS endpoint\n      if (wsBase === WS_ENDPOINTS[1] && this.reconnectAttempts === 0) {\n        this._wsBase = WS_ENDPOINTS[0];\n        this.connectStream(symbol, callbacks);\n        return;\n      }\n      callbacks.onError?.(err);\n    };\n\n    this.ws.onclose = () => {\n      if (this.reconnectAttempts < this.maxReconnect) {\n        this.reconnectAttempts++;\n        setTimeout(() => this.connectStream(symbol, callbacks), 2000 * this.reconnectAttempts);\n      }\n      callbacks.onDisconnect?.();\n    };\n\n    return () => this.disconnect();\n  }\n\n  disconnect() {\n    if (this.ws) {\n      this.ws.close();\n      this.ws = null;\n    }\n  }\n\n  // ─── REST: Get klines/candles ───\n  async getCandles(symbol, interval = '1h', limit = 500) {\n    const cacheKey = `${symbol}_${interval}`;\n    const provider = await this._getAPI();\n\n    // ── CoinGecko OHLC fallback ──\n    if (provider === 'coingecko') {\n      return this._getCandlesCoinGecko(symbol, interval, cacheKey);\n    }\n\n    // ── Binance primary ──\n    try {\n      const candles = await this._getCandlesBinance(provider, symbol, interval, limit);\n      this.candleCache.set(cacheKey, { data: candles, ts: Date.now() });\n      return candles;\n    } catch (err) {\n      // Reset and try alternate Binance endpoint\n      if (this._apiBase) {\n        this._apiBase = null;\n        try {\n          const altBase = await this._getAPI();\n          if (altBase !== 'coingecko') {\n            const candles = await this._getCandlesBinance(altBase, symbol, interval, limit);\n            this.candleCache.set(cacheKey, { data: candles, ts: Date.now() });\n            return candles;\n          }\n        } catch { /* fall through */ }\n      }\n\n      // Try CoinGecko before giving up\n      try {\n        return await this._getCandlesCoinGecko(symbol, interval, cacheKey);\n      } catch { /* fall through */ }\n\n      // Return cached if available\n      const cached = this.candleCache.get(cacheKey);\n      if (cached) return cached.data;\n      throw err;\n    }\n  }\n\n  async _getCandlesBinance(base, symbol, interval, limit) {\n    const ctrl = new AbortController();\n    const timer = setTimeout(() => ctrl.abort(), 10000);\n    const res = await fetch(`${base}/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`, { signal: ctrl.signal });\n    clearTimeout(timer);\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n    const data = await res.json();\n    return data.map(k => ({\n      time: Math.floor(k[0] / 1000),\n      open: parseFloat(k[1]),\n      high: parseFloat(k[2]),\n      low: parseFloat(k[3]),\n      close: parseFloat(k[4]),\n      volume: parseFloat(k[5]),\n    }));\n  }\n\n  async _getCandlesCoinGecko(symbol, interval, cacheKey) {\n    const geckoId = getGeckoId(symbol);\n    // CoinGecko OHLC: days param determines granularity\n    // 1 → 30min candles, 7 → 4h, 30 → 4h, 90/180/365 → 4d\n    const daysMap = { '1m': 1, '5m': 1, '15m': 1, '30m': 1, '1h': 7, '4h': 30, '1d': 365 };\n    const days = daysMap[interval] || 30;\n\n    const data = await this._geckoFetch(`/coins/${geckoId}/ohlc?vs_currency=usd&days=${days}`);\n    const candles = data.map(([t, o, h, l, c]) => ({\n      time: Math.floor(t / 1000),\n      open: o, high: h, low: l, close: c, volume: 0,\n    }));\n    this.candleCache.set(cacheKey, { data: candles, ts: Date.now() });\n    return candles;\n  }\n\n  // ─── REST: Get current price ───\n  async getPrice(symbol) {\n    const provider = await this._getAPI();\n    if (provider === 'coingecko') {\n      const geckoId = getGeckoId(symbol);\n      const data = await this._geckoFetch(`/simple/price?ids=${geckoId}&vs_currencies=usd`);\n      return data[geckoId]?.usd || 0;\n    }\n    try {\n      const res = await fetch(`${provider}/ticker/price?symbol=${symbol}`);\n      const data = await res.json();\n      if (data.price) return parseFloat(data.price);\n      throw new Error('No price');\n    } catch {\n      // Fallback to CoinGecko\n      const geckoId = getGeckoId(symbol);\n      const data = await this._geckoFetch(`/simple/price?ids=${geckoId}&vs_currencies=usd`);\n      return data[geckoId]?.usd || 0;\n    }\n  }\n\n  // ─── REST: Get 24hr ticker ───\n  async get24hrTicker(symbol) {\n    const provider = await this._getAPI();\n    if (provider === 'coingecko') {\n      return this._get24hrTickerCoinGecko(symbol);\n    }\n    try {\n      const res = await fetch(`${provider}/ticker/24hr?symbol=${symbol}`);\n      const data = await res.json();\n      if (!data.lastPrice) throw new Error('No data');\n      return {\n        symbol: data.symbol,\n        price: parseFloat(data.lastPrice),\n        change: parseFloat(data.priceChange),\n        changePercent: parseFloat(data.priceChangePercent),\n        high: parseFloat(data.highPrice),\n        low: parseFloat(data.lowPrice),\n        volume: parseFloat(data.volume),\n        quoteVolume: parseFloat(data.quoteVolume),\n      };\n    } catch {\n      return this._get24hrTickerCoinGecko(symbol);\n    }\n  }\n\n  async _get24hrTickerCoinGecko(symbol) {\n    const geckoId = getGeckoId(symbol);\n    const data = await this._geckoFetch(\n      `/coins/${geckoId}?localization=false&tickers=false&community_data=false&developer_data=false`\n    );\n    const md = data.market_data;\n    return {\n      symbol,\n      price: md.current_price?.usd || 0,\n      change: md.price_change_24h || 0,\n      changePercent: md.price_change_percentage_24h || 0,\n      high: md.high_24h?.usd || 0,\n      low: md.low_24h?.usd || 0,\n      volume: md.total_volume?.usd || 0,\n      quoteVolume: md.total_volume?.usd || 0,\n    };\n  }\n\n  // ─── REST: Get order book ───\n  async getOrderBook(symbol, limit = 20) {\n    const provider = await this._getAPI();\n    if (provider === 'coingecko') {\n      // CoinGecko has no order book — return empty\n      return { bids: [], asks: [] };\n    }\n    try {\n      const res = await fetch(`${provider}/depth?symbol=${symbol}&limit=${limit}`);\n      const data = await res.json();\n      return {\n        bids: data.bids.map(([price, qty]) => ({ price: parseFloat(price), quantity: parseFloat(qty) })),\n        asks: data.asks.map(([price, qty]) => ({ price: parseFloat(price), quantity: parseFloat(qty) })),\n      };\n    } catch {\n      return { bids: [], asks: [] };\n    }\n  }\n\n  // ─── REST: Search symbols ───\n  async searchSymbols(query) {\n    const provider = await this._getAPI();\n    if (provider === 'coingecko') {\n      const data = await this._geckoFetch(`/search?query=${encodeURIComponent(query)}`);\n      return (data.coins || []).slice(0, 20).map(c => ({\n        symbol: `${c.symbol.toUpperCase()}USDT`,\n        base: c.symbol.toUpperCase(),\n        quote: 'USDT',\n      }));\n    }\n    try {\n      const res = await fetch(`${provider}/exchangeInfo`);\n      const data = await res.json();\n      const q = query.toUpperCase();\n      return data.symbols\n        .filter(s => s.status === 'TRADING' && (s.symbol.includes(q) || s.baseAsset.includes(q)))\n        .slice(0, 20)\n        .map(s => ({\n          symbol: s.symbol,\n          base: s.baseAsset,\n          quote: s.quoteAsset,\n        }));\n    } catch {\n      // Fallback to CoinGecko search\n      const data = await this._geckoFetch(`/search?query=${encodeURIComponent(query)}`);\n      return (data.coins || []).slice(0, 20).map(c => ({\n        symbol: `${c.symbol.toUpperCase()}USDT`,\n        base: c.symbol.toUpperCase(),\n        quote: 'USDT',\n      }));\n    }\n  }\n}\n\nexport const marketData = new MarketDataService();\nexport default marketData;\n"],"names":["API_ENDPOINTS","WS_ENDPOINTS","COINGECKO_API","SYMBOL_TO_GECKO","parseBase","symbol","quotes","q","getGeckoId","base","MarketDataService","ctrl","timer","res","path","now","wait","callbacks","pair","wsBase","url","_a","event","_b","data","k","e","err","interval","limit","cacheKey","provider","candles","altBase","cached","geckoId","days","t","o","h","l","c","_c","_d","_e","md","price","qty","query","s","marketData"],"mappings":"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"}