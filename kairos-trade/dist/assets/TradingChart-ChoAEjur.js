import{j as a,a2 as U,T as $}from"./ui-CNhabBHP.js";import{a as c}from"./vendor-CUCP814w.js";import{V as H,a as Q,I as q}from"./charts-UjLl1g-4.js";import{u as _,b as B,c as w,P as G,T as J}from"./index-P-WH05qf.js";import{c as I,a as K,b as X}from"./indicators-DJQYQkcq.js";import{m as y}from"./marketData-K1zKCjjj.js";function le(){const j=c.useRef(null),u=c.useRef(null),f=c.useRef(null),p=c.useRef(null),x=c.useRef([]),b=c.useRef(null),{selectedPair:h,selectedTimeframe:g,setSelectedPair:T,setSelectedTimeframe:z,setCurrentPrice:E,setPriceChange24h:F}=_(),[N,v]=c.useState(!0),[k,S]=c.useState(null),[D,R]=c.useState(!1),[V,L]=c.useState(""),[C,W]=c.useState(["ema20"]);c.useEffect(()=>{const e=j.current;if(!e)return;const n=e.getBoundingClientRect(),t=n.width||e.clientWidth||800,i=n.height||e.clientHeight||500,l=H(e,{width:t,height:i,layout:{background:{type:q.Solid,color:"#0B0E11"},textColor:"#848E9C",fontFamily:"Inter, sans-serif",fontSize:11},grid:{vertLines:{color:"#1E222D"},horzLines:{color:"#1E222D"}},crosshair:{mode:Q.Normal,vertLine:{color:"#3B82F6",width:1,style:2,labelBackgroundColor:"#3B82F6"},horzLine:{color:"#3B82F6",width:1,style:2,labelBackgroundColor:"#3B82F6"}},timeScale:{borderColor:"#1E222D",timeVisible:!0,secondsVisible:!1,rightOffset:5,barSpacing:8},rightPriceScale:{borderColor:"#1E222D",scaleMargins:{top:.05,bottom:.2}},handleScroll:{mouseWheel:!0,pressedMouseMove:!0},handleScale:{axisPressedMouseMove:!0,mouseWheel:!0,pinch:!0}}),s=l.addCandlestickSeries({upColor:"#0ECB81",downColor:"#F6465D",borderUpColor:"#0ECB81",borderDownColor:"#F6465D",wickUpColor:"#0ECB81",wickDownColor:"#F6465D"}),r=l.addHistogramSeries({color:"#3B82F622",priceFormat:{type:"volume"},priceScaleId:"volume"});l.priceScale("volume").applyOptions({scaleMargins:{top:.8,bottom:0}}),u.current=l,f.current=s,p.current=r;const o=()=>{const m=e.getBoundingClientRect();m.width>0&&m.height>0&&l.applyOptions({width:m.width,height:m.height})};requestAnimationFrame(o),setTimeout(o,100),setTimeout(o,300);const d=new ResizeObserver(m=>{if(!m||!m[0])return;const{width:P,height:A}=m[0].contentRect;P>0&&A>0&&l.applyOptions({width:P,height:A})});return d.observe(e),()=>{d.disconnect(),l.remove(),u.current=null,f.current=null,p.current=null}},[]),c.useEffect(()=>{let e=!1;return(async()=>{v(!0),S(null);try{const t=B(h),[i,l]=await Promise.all([y.getCandles(t,g,500),y.get24hrTicker(t)]);if(e)return;if(!i||i.length===0){S("No se recibieron datos de Binance"),v(!1);return}f.current&&f.current.setData(i),p.current&&p.current.setData(i.map(s=>({time:s.time,value:s.volume||0,color:s.close>=s.open?"rgba(14,203,129,0.2)":"rgba(246,70,93,0.2)"}))),E(l.price),F(l.changePercent);try{M(i)}catch(s){console.warn("Indicator error (non-fatal):",s)}u.current&&u.current.timeScale().fitContent()}catch(t){console.error("Chart data load error:",t),e||S(`Error cargando datos: ${t.message}`)}e||v(!1)})(),b.current&&b.current(),b.current=y.connectStream(B(h),{onTicker:t=>{E(t.price),F(t.changePercent)},onCandle:t=>{f.current&&f.current.update(t),p.current&&p.current.update({time:t.time,value:t.volume||0,color:t.close>=t.open?"rgba(14,203,129,0.2)":"rgba(246,70,93,0.2)"})}}),()=>{e=!0,b.current&&(b.current(),b.current=null)}},[h,g]);const M=e=>{if(!u.current)return;x.current.forEach(i=>{var l;try{(l=u.current)==null||l.removeSeries(i)}catch{}}),x.current=[];const n=e.map(i=>i.close),t=e.map(i=>i.time);C.forEach(i=>{try{if(i==="ema20"){const s=I(n,20).map((r,o)=>r!=null&&isFinite(r)?{time:t[o],value:r}:null).filter(Boolean);if(s.length>0){const r=u.current.addLineSeries({color:"#3B82F6",lineWidth:1.5,title:"EMA 20",lastValueVisible:!1,priceLineVisible:!1});r.setData(s),x.current.push(r)}}if(i==="ema50"){const s=I(n,50).map((r,o)=>r!=null&&isFinite(r)?{time:t[o],value:r}:null).filter(Boolean);if(s.length>0){const r=u.current.addLineSeries({color:"#8B5CF6",lineWidth:1.5,title:"EMA 50",lastValueVisible:!1,priceLineVisible:!1});r.setData(s),x.current.push(r)}}if(i==="sma200"){const s=K(n,200).map((r,o)=>r!=null&&isFinite(r)?{time:t[o],value:r}:null).filter(Boolean);if(s.length>0){const r=u.current.addLineSeries({color:"#FF6D00",lineWidth:1,title:"SMA 200",lastValueVisible:!1,priceLineVisible:!1});r.setData(s),x.current.push(r)}}if(i==="bb"){const l=X(n),s=l.upper.map((o,d)=>o!=null&&isFinite(o)?{time:t[d],value:o}:null).filter(Boolean),r=l.lower.map((o,d)=>o!=null&&isFinite(o)?{time:t[d],value:o}:null).filter(Boolean);if(s.length>0){const o=u.current.addLineSeries({color:"#9C27B0",lineWidth:1,lineStyle:2,title:"BB Upper",lastValueVisible:!1,priceLineVisible:!1}),d=u.current.addLineSeries({color:"#9C27B0",lineWidth:1,lineStyle:2,title:"BB Lower",lastValueVisible:!1,priceLineVisible:!1});o.setData(s),d.setData(r),x.current.push(o,d)}}}catch(l){console.warn(`Indicator ${i} error:`,l)}})};c.useEffect(()=>{if(!f.current)return;(async()=>{try{const n=await y.getCandles(B(h),g,500);M(n)}catch{}})()},[C]);const O=e=>{W(n=>n.includes(e)?n.filter(t=>t!==e):[...n,e])};return a.jsxs("div",{className:"flex flex-col w-full flex-1 min-h-0",children:[a.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 shrink-0 flex-wrap",style:{borderBottom:"1px solid var(--border)"},children:[a.jsxs("div",{className:"relative",children:[a.jsxs("button",{onClick:()=>R(!D),className:"flex items-center gap-1.5 px-3 py-1.5 bg-[var(--dark-3)] rounded-lg text-sm font-bold hover:bg-[var(--dark-4)] transition-colors",children:[a.jsx(U,{size:13,className:"text-[var(--text-dim)]"}),w(h)]}),D&&a.jsxs("div",{className:"absolute top-full left-0 mt-1 w-64 bg-[var(--dark-3)] border border-[var(--border)] rounded-xl shadow-xl z-50 p-2",children:[a.jsx("input",{type:"text",value:V,onChange:e=>L(e.target.value.toUpperCase()),placeholder:"Buscar par...",className:"w-full text-sm mb-2",autoFocus:!0}),a.jsx("div",{className:"max-h-48 overflow-y-auto space-y-0.5",children:G.filter(e=>e.includes(V)).map(e=>a.jsx("button",{onClick:()=>{T(e),R(!1),L("")},className:`w-full text-left px-3 py-1.5 text-sm rounded-lg transition-colors
                        ${e===h?"bg-[var(--gold)]/15 text-[var(--gold)]":"text-[var(--text-dim)] hover:bg-[var(--dark-4)] hover:text-[var(--text)]"}`,children:w(e)},e))})]})]}),a.jsx("div",{className:"flex items-center gap-0.5 bg-[var(--dark-3)] rounded-lg p-0.5",children:J.map(e=>a.jsx("button",{onClick:()=>z(e.value),className:`px-2.5 py-1 text-xs rounded-md transition-colors
                ${g===e.value?"bg-[var(--gold)] text-white font-bold":"text-[var(--text-dim)] hover:text-[var(--text)]"}`,children:e.label},e.value))}),a.jsxs("div",{className:"flex items-center gap-1 ml-auto",children:[a.jsx($,{size:13,className:"text-[var(--text-dim)]"}),[{id:"ema20",label:"EMA 20",color:"#3B82F6"},{id:"ema50",label:"EMA 50",color:"#8B5CF6"},{id:"sma200",label:"SMA 200",color:"#FF6D00"},{id:"bb",label:"BB",color:"#9C27B0"}].map(e=>a.jsx("button",{onClick:()=>O(e.id),className:`px-2 py-0.5 text-[11px] rounded transition-all
                ${C.includes(e.id)?"font-semibold":"text-[var(--text-dim)] hover:text-[var(--text)]"}`,style:C.includes(e.id)?{color:e.color,background:`${e.color}15`}:{},children:e.label},e.id))]})]}),a.jsxs("div",{ref:j,className:"relative",style:{flex:"1 1 0%",minHeight:0,overflow:"hidden"},children:[N&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-20",style:{background:"rgba(11,14,17,0.85)"},children:a.jsxs("div",{className:"flex flex-col items-center gap-2",children:[a.jsx("div",{className:"w-8 h-8 border-2 border-[var(--gold)] border-t-transparent rounded-full animate-spin"}),a.jsxs("span",{className:"text-xs text-[var(--text-dim)]",children:["Cargando ",w(h),"..."]})]})}),k&&!N&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-20",style:{background:"rgba(11,14,17,0.9)"},children:a.jsxs("div",{className:"text-center",children:[a.jsx("p",{className:"text-sm text-[var(--red)] mb-2",children:k}),a.jsx("button",{onClick:()=>{S(null),v(!0)},className:"px-4 py-2 text-xs bg-[var(--gold)] text-white rounded-lg font-semibold",children:"Reintentar"})]})})]})]})}export{le as default};
